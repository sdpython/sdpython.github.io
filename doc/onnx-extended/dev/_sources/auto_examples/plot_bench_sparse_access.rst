
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "auto_examples/plot_bench_sparse_access.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_auto_examples_plot_bench_sparse_access.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_examples_plot_bench_sparse_access.py:


Evaluating random access for sparse
===================================

Whenever computing the prediction of a tree with a sparse tensor,
is it faster to density first and then to compute the prediction or to
keep the tensor in its sparse representation and do look up?
The parameter *nrnd* can be seen as the depth of a tree.

.. GENERATED FROM PYTHON SOURCE LINES 11-45

.. code-block:: Python


    import itertools
    import numpy as np
    from tqdm import tqdm
    import matplotlib.pyplot as plt
    from pandas import DataFrame
    from onnx_extended.ext_test_case import unit_test_going
    from onnx_extended.args import get_parsed_args
    from onnx_extended.validation.cpu._validation import evaluate_sparse


    expose = "repeat,warmup,nrows,ncols,sparsity,nrnd,ntimes"
    script_args = get_parsed_args(
        "plot_bench_sparse_access",
        description=__doc__,
        nrows=(10 if unit_test_going() else 100, "number of rows"),
        ncols=(10 if unit_test_going() else 100000, "number of columns"),
        ntimes=(
            "1" if unit_test_going() else "2,4,8",
            "number of times to do nrnd random accesses per row",
        ),
        sparsity=(
            "0.1,0.2" if unit_test_going() else "0.75,0.8,0.9,0.95,0.99,0.999,0.9999",
            "sparsities to try",
        ),
        repeat=2 if unit_test_going() else 5,
        warmup=1 if unit_test_going() else 3,
        nrnd=(10, "number of random features to access"),
        expose=expose,
    )

    for att in sorted(expose.split(",")):
        print(f"{att}={getattr(script_args, att)}")





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    ncols=100000
    nrnd=10
    nrows=100
    ntimes=2,4,8
    repeat=5
    sparsity=0.75,0.8,0.9,0.95,0.99,0.999,0.9999
    warmup=3




.. GENERATED FROM PYTHON SOURCE LINES 46-48

Sparse tensor
+++++++++++++

.. GENERATED FROM PYTHON SOURCE LINES 48-67

.. code-block:: Python



    def make_sparse_random_tensor(n_rows: int, n_cols: int, sparsity: float):
        t = np.random.rand(n_rows, n_cols).astype(np.float32)
        m = np.random.rand(n_rows, n_cols).astype(np.float32)
        t[m <= sparsity] = 0
        return t


    sparsity = list(map(float, script_args.sparsity.split(",")))
    ntimes = list(map(int, script_args.ntimes.split(",")))
    t = make_sparse_random_tensor(script_args.nrows, script_args.ncols, sparsity[0])
    ev = evaluate_sparse(t, script_args.nrnd, ntimes[0], script_args.repeat, 3)
    print(f"dense:  initialization:{ev[0][0]:1.3g}")
    print(f"                access:{ev[0][1]:1.3g}")
    print(f"sparse: initialization:{ev[1][0]:1.3g}")
    print(f"                access:{ev[1][1]:1.3g}")
    print(f"Ratio sparse/dense: {ev[1][1] / ev[0][1]}")





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    dense:  initialization:0.0117
                    access:3.75e-05
    sparse: initialization:0.00517
                    access:0.000336
    Ratio sparse/dense: 8.975695705102195




.. GENERATED FROM PYTHON SOURCE LINES 68-69

If > 1, sparse is slower.

.. GENERATED FROM PYTHON SOURCE LINES 71-74

Try sparsity
++++++++++++


.. GENERATED FROM PYTHON SOURCE LINES 74-100

.. code-block:: Python


    tries = list(itertools.product(ntimes, sparsity))

    data = []
    for nt, sp in tqdm(tries):
        t = make_sparse_random_tensor(script_args.nrows, script_args.ncols, sp)
        ev = evaluate_sparse(t, script_args.nrnd, nt, script_args.repeat, 3)
        obs = dict(
            dense0=ev[0][0],
            dense1=ev[0][1],
            dense=ev[0][0] + ev[0][1],
            sparse0=ev[1][0],
            sparse1=ev[1][1],
            sparse=ev[1][0] + ev[1][1],
            sparsity=sp,
            rows=t.shape[0],
            cols=t.shape[1],
            repeat=script_args.repeat,
            random=script_args.nrnd,
            ntimes=nt,
        )
        data.append(obs)

    df = DataFrame(data)
    print(df)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

      0%|          | 0/21 [00:00<?, ?it/s]      5%|▍         | 1/21 [00:00<00:06,  2.87it/s]     10%|▉         | 2/21 [00:00<00:06,  3.05it/s]     14%|█▍        | 3/21 [00:00<00:05,  3.40it/s]     19%|█▉        | 4/21 [00:01<00:04,  3.66it/s]     24%|██▍       | 5/21 [00:01<00:03,  4.01it/s]     29%|██▊       | 6/21 [00:01<00:03,  4.16it/s]     33%|███▎      | 7/21 [00:01<00:03,  4.23it/s]     38%|███▊      | 8/21 [00:02<00:03,  3.62it/s]     43%|████▎     | 9/21 [00:02<00:03,  3.52it/s]     48%|████▊     | 10/21 [00:02<00:03,  3.60it/s]     52%|█████▏    | 11/21 [00:02<00:02,  3.76it/s]     57%|█████▋    | 12/21 [00:03<00:02,  3.95it/s]     62%|██████▏   | 13/21 [00:03<00:01,  4.18it/s]     67%|██████▋   | 14/21 [00:03<00:01,  4.31it/s]     71%|███████▏  | 15/21 [00:04<00:01,  3.61it/s]     76%|███████▌  | 16/21 [00:04<00:01,  3.44it/s]     81%|████████  | 17/21 [00:04<00:01,  3.48it/s]     86%|████████▌ | 18/21 [00:04<00:00,  3.61it/s]     90%|█████████ | 19/21 [00:05<00:00,  3.83it/s]     95%|█████████▌| 20/21 [00:05<00:00,  4.08it/s]    100%|██████████| 21/21 [00:05<00:00,  4.26it/s]    100%|██████████| 21/21 [00:05<00:00,  3.81it/s]
          dense0    dense1     dense   sparse0   sparse1    sparse  sparsity  rows    cols  repeat  random  ntimes
    0   0.010824  0.000040  0.010864  0.005495  0.000419  0.005914    0.7500   100  100000       5      10       2
    1   0.009619  0.000038  0.009657  0.005270  0.000329  0.005599    0.8000   100  100000       5      10       2
    2   0.008503  0.000034  0.008537  0.002187  0.000242  0.002428    0.9000   100  100000       5      10       2
    3   0.008125  0.000033  0.008158  0.000994  0.000180  0.001174    0.9500   100  100000       5      10       2
    4   0.006356  0.000024  0.006379  0.000210  0.000122  0.000332    0.9900   100  100000       5      10       2
    5   0.006218  0.000023  0.006241  0.000023  0.000076  0.000099    0.9990   100  100000       5      10       2
    6   0.007061  0.000027  0.007088  0.000005  0.000036  0.000041    0.9999   100  100000       5      10       2
    7   0.011380  0.000057  0.011437  0.005039  0.000666  0.005705    0.7500   100  100000       5      10       4
    8   0.008784  0.000046  0.008830  0.004285  0.000695  0.004980    0.8000   100  100000       5      10       4
    9   0.009036  0.000057  0.009093  0.002002  0.000401  0.002403    0.9000   100  100000       5      10       4
    10  0.008621  0.000050  0.008671  0.001315  0.000453  0.001769    0.9500   100  100000       5      10       4
    11  0.006264  0.000044  0.006308  0.000198  0.000248  0.000446    0.9900   100  100000       5      10       4
    12  0.005708  0.000036  0.005744  0.000022  0.000154  0.000176    0.9990   100  100000       5      10       4
    13  0.005816  0.000033  0.005850  0.000005  0.000082  0.000086    0.9999   100  100000       5      10       4
    14  0.011334  0.000094  0.011428  0.006454  0.001380  0.007834    0.7500   100  100000       5      10       8
    15  0.009724  0.000143  0.009867  0.004547  0.001348  0.005895    0.8000   100  100000       5      10       8
    16  0.009492  0.000102  0.009594  0.002541  0.000865  0.003406    0.9000   100  100000       5      10       8
    17  0.009029  0.000089  0.009118  0.001009  0.000639  0.001648    0.9500   100  100000       5      10       8
    18  0.006462  0.000060  0.006523  0.000198  0.000485  0.000683    0.9900   100  100000       5      10       8
    19  0.005834  0.000057  0.005891  0.000024  0.000333  0.000357    0.9990   100  100000       5      10       8
    20  0.006190  0.000056  0.006246  0.000004  0.000164  0.000168    0.9999   100  100000       5      10       8




.. GENERATED FROM PYTHON SOURCE LINES 101-102

Plots

.. GENERATED FROM PYTHON SOURCE LINES 102-120

.. code-block:: Python


    nts = list(sorted(set(df.ntimes)))

    fig, ax = plt.subplots(len(nts), 2, figsize=(3 * len(nts), 10))
    for i, nt in enumerate(nts):
        sub = df[df.ntimes == nt]
        sub[["sparsity", "dense", "sparse"]].set_index("sparsity").plot(
            title=f"Dense vs Sparsity, ntimes={nt}",
            logy=True,
            ax=ax[0] if len(ax.shape) == 1 else ax[i, 0],
        )
        sub[["sparsity", "dense1", "sparse1"]].set_index("sparsity").plot(
            title="Dense vs Sparsity (access only)",
            logy=True,
            ax=ax[1] if len(ax.shape) == 1 else ax[i, 0],
        )
    fig.tight_layout()
    fig.savefig("plot_bench_sparse_access.png")



.. image-sg:: /auto_examples/images/sphx_glr_plot_bench_sparse_access_001.png
   :alt: Dense vs Sparsity (access only), Dense vs Sparsity (access only), Dense vs Sparsity (access only)
   :srcset: /auto_examples/images/sphx_glr_plot_bench_sparse_access_001.png
   :class: sphx-glr-single-img






.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 6.888 seconds)


.. _sphx_glr_download_auto_examples_plot_bench_sparse_access.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: plot_bench_sparse_access.ipynb <plot_bench_sparse_access.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: plot_bench_sparse_access.py <plot_bench_sparse_access.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: plot_bench_sparse_access.zip <plot_bench_sparse_access.zip>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_


<!DOCTYPE html>


<html lang="fr" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Threads &#8212; Documentation teachpyx 0.3.0</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b76e3c8a" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css?v=7f9a90b1" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=61a4c737" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css?v=e5fbc548" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=83beb07c"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/translations.js?v=d99ca74e"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'c_parallelisation/thread';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Recherche" href="../search.html" />
    <link rel="next" title="Interfaces graphiques" href="../c_gui/index.html" />
    <link rel="prev" title="Parallélisation" href="index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="fr"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Passer au contenu principal</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/project_ico.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/project_ico.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
    
  </div>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Navigation du site">
    Navigation du site
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../introduction.html">
                        Introduction
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../c_lang/index.html">
                        Variables et fonctions
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../c_classes/index.html">
                        Classes
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../c_exception/index.html">
                        Exceptions
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../c_module/index.html">
                        Entrées, Sorties, Modules
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../c_regex/index.html">
                        Expression régulières
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        Parallélisation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../c_gui/index.html">
                        Interfaces graphiques
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../c_data/index.html">
                        Matrices et DataFrames
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../c_resume/index.html">
                        Précis
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api/index.html">
                        Code inclus dans cette librairie
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../articles/index.html">
                        Collections d’articles inclassables
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../i_ex.html">
                        Exemples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../i_faq.html">
                        FAQ
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../auto_examples/index.html">
                        Bouts de code à conserver
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../defthe_index.html">
                        Syntaxes, Définitions
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../license.html">
                        License
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../CHANGELOGS.html">
                        Change Logs
                      </a>
                    </li>
                
                </div>
            </div>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Recherche" aria-label="Recherche" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="clair/sombre" aria-label="clair/sombre" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Recherche" aria-label="Recherche" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Navigation du site">
    Navigation du site
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../introduction.html">
                        Introduction
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../c_lang/index.html">
                        Variables et fonctions
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../c_classes/index.html">
                        Classes
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../c_exception/index.html">
                        Exceptions
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../c_module/index.html">
                        Entrées, Sorties, Modules
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../c_regex/index.html">
                        Expression régulières
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        Parallélisation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../c_gui/index.html">
                        Interfaces graphiques
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../c_data/index.html">
                        Matrices et DataFrames
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../c_resume/index.html">
                        Précis
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api/index.html">
                        Code inclus dans cette librairie
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../articles/index.html">
                        Collections d’articles inclassables
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../i_ex.html">
                        Exemples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../i_faq.html">
                        FAQ
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../auto_examples/index.html">
                        Bouts de code à conserver
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../defthe_index.html">
                        Syntaxes, Définitions
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../license.html">
                        License
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../CHANGELOGS.html">
                        Change Logs
                      </a>
                    </li>
                
                </div>
            </div>
            
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="clair/sombre" aria-label="clair/sombre" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><nav class="bd-docs-nav bd-links"
     aria-label="Navigation de la section">
  <p class="bd-links__title" role="heading" aria-level="1">Navigation de la section</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Threads</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Fils d'Ariane">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Fil d'Ariane">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Acceuil">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Parallélisation</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Threads</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="threads">
<span id="l-thread"></span><h1>Threads<a class="headerlink" href="#threads" title="Lien permanent vers cette rubrique">#</a></h1>
<nav class="contents local" id="sommaire">
<ul class="simple">
<li><p><a class="reference internal" href="#premier-thread" id="id3">Premier thread</a></p></li>
<li><p><a class="reference internal" href="#synchronisation" id="id4">Synchronisation</a></p>
<ul>
<li><p><a class="reference internal" href="#attente" id="id5">Attente</a></p></li>
<li><p><a class="reference internal" href="#partage-d-informations" id="id6">Partage d’informations</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#interface-graphique" id="id7">Interface graphique</a></p></li>
<li><p><a class="reference internal" href="#files-de-messages" id="id8">Files de messages</a></p></li>
<li><p><a class="reference internal" href="#multithreading-plus-simple" id="id9">Multithreading plus simple</a></p>
<ul>
<li><p><a class="reference internal" href="#concurrent-futures" id="id10">concurrent.futures</a></p></li>
<li><p><a class="reference internal" href="#notion-de-futures" id="id11">Notion de futures</a></p></li>
<li><p><a class="reference internal" href="#un-probleme-de-blocage" id="id12">Un problème de blocage</a></p></li>
<li><p><a class="reference internal" href="#async-await-asyncio" id="id13">async - await - asyncio</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#gil-global-interpreter-lock" id="id14">GIL - Global Interpreter Lock</a></p>
<ul>
<li><p><a class="reference internal" href="#cython-un-melange-de-python-et-c" id="id15">cython : un mélange de python et C</a></p></li>
<li><p><a class="reference internal" href="#c-java" id="id16">C#, Java</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#bibliographie" id="id17">Bibliographie</a></p></li>
</ul>
</nav>
<p id="index-0">Jusqu’aux années 2003-2004, l’évolution des microprocesseurs
était une course vers une augmentation de la puissance, autant en terme
de nombre de transistors qu’en fréquence de fonctionnement. Arrivant
aux limites de la technologie actuelle, cette évolution s’est tournée
maintenant vers la construction de processeurs multicoeurs, c’est-à-dire des
machines capables d’exécuter des programmes simultanément, de maintenir
plusieurs <em>fils d’exécution</em> en parallèle.</p>
<p>Les <a class="reference external" href="https://fr.wikipedia.org/wiki/Thread_(informatique)">threads</a>
ou fils d’exécution ont trois usages principaux. Le premier est
relié au <a class="reference external" href="https://fr.wikipedia.org/wiki/Calcul_distribu%C3%A9">calcul distribué</a> ou calcul parallèle.
Par exemple, le calcul d’une intégrale sur un intervalle peut être effectué sur
deux intervalles disjoints. Le résultat final est la somme des
deux résultats sur chacun des intervalles. De plus, ces deux calculs
sont indépendants et peuvent être menés de front. Le calcul intégral
sera donc deux fois plus rapide puisque les deux intervalles seront
traités en même temps. C’est la parallélisation des calculs : les deux calculs
sur chaque intervalle seront affectés à deux threads simultanés.</p>
<p>Le second usage est couplé aux interfaces graphiques. Lorsque
l’utilisateur entame un processus long après avoir cliqué sur un bouton,
l’interface graphique ne réagit plus jusqu’à ce que ce processus s’achève.
Afin d’éviter cet inconvénient, l’interface graphique va commencer un
thread qui va exécuter ce processus. L’interface graphique n’a plus
qu’à attendre la fin du thread, et pendant tout ce temps, elle sera
également capable de traiter tout autre événement provenant de l’utilisateur.</p>
<p>Le dernier usage concerne la communication entre ordinateurs ou plus généralement
la communication Internet. C’est une communication
<a class="reference external" href="https://fr.wikipedia.org/wiki/Asynchronisme">asynchrone</a> :
l’ordinateur effectue des tâches en même temps qu’il écoute
un <a class="reference external" href="https://fr.wikipedia.org/wiki/Port_(logiciel)">port</a>
par lequel d’autres ordinateurs communiquent avec lui. Plus précisément,
le programme suit deux fils d’exécution : le fil principal et un
thread qui ne fait qu’attendre et traiter les messages qu’il
reçoit via un port.</p>
<p>La synchronisation est un point commun à ces trois usages. Ce terme
désigne la dépendance entre les threads. Lors d’un calcul distribué,
le résultat final dépend des résultats retournés par chaque thread,
il faut donc attendre que les deux fils d’exécution aient produit
le résultat attendu : il faut que les deux fils d’exécution se synchronisent.</p>
<section id="premier-thread">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Premier thread</a><a class="headerlink" href="#premier-thread" title="Lien permanent vers cette rubrique">#</a></h2>
<p>Le premier exemple consiste à exécuter un thread uniquement
destiné à faire des affichages. Deux fils d’exécution vont être
lancés en parallèle affichant chacun un message différent.
Les affichages vont s’entremêler. Il existe plusieurs manières
d’exécuter un thread, une seule sera présentée en utilisant la
classe <code class="docutils literal notranslate"><span class="pre">Thread</span></code> du module <code class="docutils literal notranslate"><span class="pre">threading</span></code>.
Pour créer un thread, il suffit de surcharger la méthode <code class="docutils literal notranslate"><span class="pre">run</span></code> de la classe
<code class="docutils literal notranslate"><span class="pre">Thread</span></code>. Si le thread a besoin de données lors de son exécution,
il faut surcharger son constructeur sans oublier d’appeler le
constructeur de la classe mère. L’exécution de thread commence par
la création d’une instance et l’appel à la méthode <code class="docutils literal notranslate"><span class="pre">start</span></code>.
En résumé, il faut retenir les éléments suivants :</p>
<ol class="arabic simple">
<li><p>surcharger la classe <code class="docutils literal notranslate"><span class="pre">threading.Thread</span></code>,</p></li>
<li><p>surcharger le constructeur sans oublier d’appeler le constructeur
<code class="docutils literal notranslate"><span class="pre">threading.Thread.__init__</span></code>,</p></li>
<li><p>surcharger la méthode <code class="docutils literal notranslate"><span class="pre">run</span></code>, c’est le code que devra exécuter le thread,</p></li>
<li><p>créer une instance de la nouvelle classe et appeler la méthode
<code class="docutils literal notranslate"><span class="pre">start</span></code> pour lancer le thread secondaire qui formera le second fil d’exécution.</p></li>
</ol>
<p>Le programme principal est appelé le thread principal. Voici ce que cela donne dans un exemple :</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">threading</span><span class="o">,</span> <span class="nn">time</span>


<span class="k">class</span> <span class="nc">MonThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jusqua</span><span class="p">):</span>  <span class="c1"># jusqua = donnée supplémentaire</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># ne pas oublier cette ligne</span>
        <span class="c1"># (appel au constructeur de la classe mère)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jusqua</span> <span class="o">=</span> <span class="n">jusqua</span>  <span class="c1"># donnée supplémentaire ajoutée à la classe</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jusqua</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;thread &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.08</span><span class="p">)</span>  <span class="c1"># attend 100 millisecondes sans rien faire</span>
            <span class="c1"># facilite la lecture de l&#39;affichage</span>


<span class="n">m</span> <span class="o">=</span> <span class="n">MonThread</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># crée le thread</span>
<span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>  <span class="c1"># démarre le thread,</span>
<span class="c1"># l&#39;instruction est exécutée en quelques millisecondes</span>
<span class="c1"># quelque soit la durée du thread</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;programme &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># attend 100 millisecondes sans rien faire</span>
    <span class="c1"># facilite la lecture de l&#39;affichage</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">thread</span>  <span class="mi">0</span>
    <span class="n">programme</span>  <span class="mi">0</span>
    <span class="n">thread</span>  <span class="mi">1</span>
    <span class="n">programme</span>  <span class="mi">1</span>
    <span class="n">thread</span>  <span class="mi">2</span>
    <span class="n">programme</span>  <span class="mi">2</span>
    <span class="n">thread</span>  <span class="mi">3</span>
    <span class="n">programme</span>  <span class="mi">3</span>
    <span class="n">thread</span>  <span class="mi">4</span>
    <span class="n">thread</span>  <span class="mi">5</span>
    <span class="n">programme</span>  <span class="mi">4</span>
    <span class="n">thread</span>  <span class="mi">6</span>
    <span class="n">programme</span>  <span class="mi">5</span>
    <span class="n">thread</span>  <span class="mi">7</span>
    <span class="n">programme</span>  <span class="mi">6</span>
    <span class="n">thread</span>  <span class="mi">8</span>
    <span class="n">programme</span>  <span class="mi">7</span>
    <span class="n">thread</span>  <span class="mi">9</span>
    <span class="n">programme</span>  <span class="mi">8</span>
    <span class="n">programme</span>  <span class="mi">9</span>
</pre></div>
</div>
<p>Le programme affiche des lignes qui proviennent du thread principal et du
thread secondaire dont les affichages diffèrent.</p>
<p>Le précédent programme a été adapté pour lancer deux threads secondaires
en plus du thread principal. Les lignes modifiées
par rapport au programme précédent sont commentées.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">threading</span><span class="o">,</span> <span class="nn">time</span>


<span class="k">class</span> <span class="nc">MonThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jusqua</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jusqua</span> <span class="o">=</span> <span class="n">jusqua</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jusqua</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;thread &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot; : &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.09</span><span class="p">)</span>


<span class="n">m</span> <span class="o">=</span> <span class="n">MonThread</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="n">m2</span> <span class="o">=</span> <span class="n">MonThread</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">)</span>  <span class="c1"># crée un second thread</span>
<span class="n">m2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>  <span class="c1"># démarre le thread,</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;programme &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">thread</span>  <span class="n">A</span>  <span class="p">:</span>  <span class="mi">0</span>
    <span class="n">thread</span>  <span class="n">B</span>  <span class="p">:</span>  <span class="mi">0</span>
    <span class="n">programme</span>  <span class="mi">0</span>
    <span class="n">thread</span>  <span class="n">A</span>  <span class="p">:</span>  <span class="mi">1</span>
    <span class="n">thread</span>  <span class="n">B</span>  <span class="p">:</span>  <span class="mi">1</span>
    <span class="n">programme</span>  <span class="mi">1</span>
    <span class="n">thread</span>  <span class="n">A</span>  <span class="p">:</span>  <span class="mi">2</span>
    <span class="n">thread</span>  <span class="n">B</span>  <span class="p">:</span>  <span class="mi">2</span>
    <span class="n">programme</span>  <span class="mi">2</span>
    <span class="n">thread</span>  <span class="n">A</span>  <span class="p">:</span>  <span class="mi">3</span>
    <span class="n">thread</span>  <span class="n">B</span>  <span class="p">:</span>  <span class="mi">3</span>
    <span class="n">programme</span>  <span class="mi">3</span>
    <span class="n">thread</span>  <span class="n">A</span>  <span class="p">:</span>  <span class="mi">4</span>
    <span class="n">thread</span>  <span class="n">B</span>  <span class="p">:</span>  <span class="mi">4</span>
    <span class="n">programme</span>  <span class="mi">4</span>
    <span class="n">thread</span>  <span class="n">A</span>  <span class="p">:</span>  <span class="mi">5</span>
    <span class="n">thread</span>  <span class="n">B</span>  <span class="p">:</span>  <span class="mi">5</span>
    <span class="n">programme</span>  <span class="mi">5</span>
    <span class="n">thread</span>  <span class="n">A</span>  <span class="p">:</span>  <span class="mi">6</span>
    <span class="n">thread</span>  <span class="n">B</span>  <span class="p">:</span>  <span class="mi">6</span>
    <span class="n">programme</span>  <span class="mi">6</span>
    <span class="n">thread</span>  <span class="n">A</span>  <span class="p">:</span>  <span class="mi">7</span>
    <span class="n">thread</span>  <span class="n">B</span>  <span class="p">:</span>  <span class="mi">7</span>
    <span class="n">programme</span>  <span class="mi">7</span>
    <span class="n">thread</span>  <span class="n">A</span>  <span class="p">:</span>  <span class="mi">8</span>
    <span class="n">thread</span>  <span class="n">B</span>  <span class="p">:</span>  <span class="mi">8</span>
    <span class="n">programme</span>  <span class="mi">8</span>
    <span class="n">thread</span>  <span class="n">A</span>  <span class="p">:</span>  <span class="mi">9</span>
    <span class="n">thread</span>  <span class="n">B</span>  <span class="p">:</span>  <span class="mi">9</span>
    <span class="n">programme</span>  <span class="mi">9</span>
</pre></div>
</div>
<p>Tous les exemples présentés dans ce chapitre font souvent intervenir
l’instruction <a class="reference external" href="https://docs.python.org/3/library/time.html#time.sleep">time.sleep(…)</a>.
A moins que ce ne soit explicitement précisé, elle sert la plupart du
temps à ralentir l’exécution du programme cité en exemple afin que celle-ci
soit humainement observable ou pour exagérer un défaut de synchronisation.
Cette fonction est d’ordinaire beaucoup moins fréquente.</p>
</section>
<section id="synchronisation">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Synchronisation</a><a class="headerlink" href="#synchronisation" title="Lien permanent vers cette rubrique">#</a></h2>
<section id="attente">
<h3><a class="toc-backref" href="#id5" role="doc-backlink">Attente</a><a class="headerlink" href="#attente" title="Lien permanent vers cette rubrique">#</a></h3>
<p>La première situation dans laquelle on a besoin de synchroniser
deux threads est l’attente d’un thread secondaire par le thread principal.
Et pour ce faire, on a besoin de l’accès par les deux fils d’exécution
à une même variable qui indiquera l’état du thread. Dans le programme suivant,
on ajoute l’attribut <code class="docutils literal notranslate"><span class="pre">etat</span></code> à la classe <code class="docutils literal notranslate"><span class="pre">MonThread</span></code> qui va indiquer l’état du thread :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">True</span></code> pour en marche</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">False</span></code> pour à l’arrêt</p></li>
</ul>
<p>Le thread principal va simplement vérifier l’état du thread
de temps en temps. Le premier point important est tout d’abord
d’attendre que le thread se lance car sans la première boucle,
le thread pourrait passer à l’état <code class="docutils literal notranslate"><span class="pre">True</span></code> après être passé dans la
seconde boucle d’attente.
Le second point important est de ne pas oublier d’insérer la fonction
<a class="reference external" href="https://docs.python.org/3/library/time.html#time.sleep">sleep</a> afin de permettre au thread principal de temporiser.
Dans le cas contraire, le thread principal passe l’essentiel de son temps à
vérifier l’état du thread secondaire, ce faisant, il ralentit
l’ordinateur par la répétition inutile de la même action un trop grand nombre
de fois. Ici, le thread principal vérifie l’état du thread secondaire
tous les 100 millisecondes. Cette durée dépend de ce que fait le thread secondaire.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">threading</span><span class="o">,</span> <span class="nn">time</span>


<span class="k">class</span> <span class="nc">MonThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jusqua</span><span class="p">):</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jusqua</span> <span class="o">=</span> <span class="n">jusqua</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etat</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># l&#39;état du thread est soit False (à l&#39;arrêt)</span>
        <span class="c1"># soit True (en marche)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etat</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># on passe en mode marche</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jusqua</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;thread itération &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etat</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># on revient en mode arrêt</span>


<span class="n">m</span> <span class="o">=</span> <span class="n">MonThread</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># crée un thread</span>
<span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>  <span class="c1"># démarre le thread,</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;début&quot;</span><span class="p">)</span>

<span class="k">while</span> <span class="n">m</span><span class="o">.</span><span class="n">etat</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
    <span class="c1"># on attend que le thread démarre</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># voir remarque ci-dessous</span>

<span class="k">while</span> <span class="n">m</span><span class="o">.</span><span class="n">etat</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
    <span class="c1"># on attend que le thread s&#39;arrête</span>
    <span class="c1"># il faut introduire l&#39;instruction time.sleep pour temporiser, il n&#39;est pas</span>
    <span class="c1"># nécessaire de vérifier sans cesse que le thread est toujours en marche</span>
    <span class="c1"># il suffit de le vérifier tous les 100 millisecondes</span>
    <span class="c1"># dans le cas contraire, la machine passe son temps à vérifier au lieu</span>
    <span class="c1"># de se consacrer à l&#39;exécution du thread</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;fin&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">thread</span> <span class="n">itération</span>  <span class="mi">0</span>
    <span class="n">début</span>
    <span class="n">thread</span> <span class="n">itération</span>  <span class="mi">1</span>
    <span class="n">thread</span> <span class="n">itération</span>  <span class="mi">2</span>
    <span class="n">thread</span> <span class="n">itération</span>  <span class="mi">3</span>
    <span class="n">thread</span> <span class="n">itération</span>  <span class="mi">4</span>
    <span class="n">thread</span> <span class="n">itération</span>  <span class="mi">5</span>
    <span class="n">thread</span> <span class="n">itération</span>  <span class="mi">6</span>
    <span class="n">thread</span> <span class="n">itération</span>  <span class="mi">7</span>
    <span class="n">thread</span> <span class="n">itération</span>  <span class="mi">8</span>
    <span class="n">thread</span> <span class="n">itération</span>  <span class="mi">9</span>
    <span class="n">fin</span>
</pre></div>
</div>
<p id="index-2">Ce mécanisme d’attente peut également être codé en utilisation les
objets <a class="reference external" href="https://docs.python.org/3/library/threading.html?highlight=condition#threading.Condition">Condition</a>
et <a class="reference external" href="https://docs.python.org/3/library/threading.html?highlight=event#threading.Event">Event</a>.
Ces deux objets permettent d’éviter l’utilisation de la méthode <a class="reference external" href="https://docs.python.org/3/library/time.html#time.sleep">sleep</a>.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">threading</span><span class="o">,</span> <span class="nn">time</span>


<span class="k">class</span> <span class="nc">MonThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jusqua</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>  <span class="c1"># event = objet Event</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1">#       = donnée supplémentaire</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jusqua</span> <span class="o">=</span> <span class="n">jusqua</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">event</span>  <span class="c1"># on garde un accès à l&#39;objet Event</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jusqua</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;thread itération &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>  <span class="c1"># on indique qu&#39;on a fini :</span>
        <span class="c1"># on active l&#39;object self.event</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;début&quot;</span><span class="p">)</span>

<span class="n">event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>  <span class="c1"># on crée un objet de type Event</span>
<span class="n">event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># on désactive l&#39;ojet Event</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">MonThread</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>  <span class="c1"># crée un thread</span>
<span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>  <span class="c1"># démarre le thread,</span>
<span class="n">event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>  <span class="c1"># on attend jusqu&#39;à ce que l&#39;objet soit activé</span>
<span class="c1"># event.wait (0.1) : n&#39;attend qu&#39;un</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;fin&quot;</span><span class="p">)</span>  <span class="c1"># seulement 1 dizième de seconde</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">début</span>
    <span class="n">thread</span> <span class="n">itération</span>  <span class="mi">0</span>
    <span class="n">thread</span> <span class="n">itération</span>  <span class="mi">1</span>
    <span class="n">thread</span> <span class="n">itération</span>  <span class="mi">2</span>
    <span class="n">thread</span> <span class="n">itération</span>  <span class="mi">3</span>
    <span class="n">thread</span> <span class="n">itération</span>  <span class="mi">4</span>
    <span class="n">thread</span> <span class="n">itération</span>  <span class="mi">5</span>
    <span class="n">thread</span> <span class="n">itération</span>  <span class="mi">6</span>
    <span class="n">thread</span> <span class="n">itération</span>  <span class="mi">7</span>
    <span class="n">thread</span> <span class="n">itération</span>  <span class="mi">8</span>
    <span class="n">thread</span> <span class="n">itération</span>  <span class="mi">9</span>
    <span class="n">fin</span>
</pre></div>
</div>
<p>La méthode <a class="reference external" href="https://docs.python.org/3.5/library/threading.html?highlight=condition#threading.Event.wait">wait</a>
de l’objet <a class="reference external" href="https://docs.python.org/3/library/threading.html?highlight=event#threading.Event">Event</a> attend que l’objet soit activé. Elle peut attendre
indéfiniment ou attendre pendant une durée donnée seulement.
Pour afficher la durée d’attente, on pourrait utiliser une boucle comme la suivante :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">start</span> <span class="p">()</span>
<span class="k">while</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;j&#39;attends&quot;</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">wait</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;fin&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>La méthode <a class="reference external" href="https://docs.python.org/3.5/library/threading.html?highlight=condition#threading.Event.is_set">is_set</a>
permet de savoir si l’événement est bloquant ou non. Le programme affiche
<code class="docutils literal notranslate"><span class="pre">&quot;j'attends&quot;</span></code> puis attend le thread un dixième de secondes.
Au delà de cette durée, il vérifie l’état de l’événement puis recommence si le thread n’est pas fini.</p>
<p>Ces objets de synchronisation sont plus efficaces que le mécanisme décrit
dans le premier programme car il fait appel aux fonctions du système d’exploitation.</p>
</section>
<section id="partage-d-informations">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">Partage d’informations</a><a class="headerlink" href="#partage-d-informations" title="Lien permanent vers cette rubrique">#</a></h3>
<p>La seconde situation dans laquelle on a besoin de synchroniser est
l’accès par deux fils d’exécution aux mêmes informations ou plutôt
aux mêmes variables. Un problème survient quand parfois un thread lit
ou modifie en même temps qu’un autre modifie la même variable.
Le second cas de synchronisation est l’ajout de verrous qui permettent
de protéger une partie du code d’un programme contre plusieurs accès
simultanés.indexfrr{thread}{verrou} Ce verrou est également un objet du module
<code class="docutils literal notranslate"><span class="pre">threading</span></code> : <a class="reference external" href="https://docs.python.org/3/library/threading.html?highlight=condition#threading.Lock">Lock</a>.</p>
<p>Dans cet exemple, l’information partagée est la chaîne de caractères
<code class="docutils literal notranslate"><span class="pre">message</span></code>, le verrou sert à protéger la fonction <code class="docutils literal notranslate"><span class="pre">ajoute</span></code> contre des
ajouts simultanés. Si les deux threads veulent modifier <code class="docutils literal notranslate"><span class="pre">message</span></code> en même temps,
un thread va entrer dans la fonction <code class="docutils literal notranslate"><span class="pre">ajoute</span></code> alors que l’autre n’en est
pas encore sorti. Les résultats seraient imprévisibles car cette fonction
modifie la variable qu’ils utilisent. On aboutit à l’exemple suivant :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">début</span>
    <span class="n">longueur</span>  <span class="mi">20</span>
    <span class="n">message</span> <span class="o">=</span>  <span class="mi">11111111112222222222</span>
</pre></div>
</div>
<p>Les trois instructions protégées pourraient être résumées en une seule :
<code class="docutils literal notranslate"><span class="pre">message</span> <span class="pre">+=</span> <span class="pre">c</span></code> ; le résultat resterait inchangé.
En revanche, en commentant les instructions
<a class="reference external" href="https://docs.python.org/3.5/library/threading.html?highlight=condition#threading.Lock.acquire">verrou.acquire()</a>
et <a class="reference external" href="https://docs.python.org/3.5/library/threading.html?highlight=condition#threading.Lock.release">verrou.release()</a>
de ce programme (marquées d’une étoile).
La longueur du résultat final <code class="docutils literal notranslate"><span class="pre">message</span></code> est variable alors qu’elle devrait être de 20
puisque les deux threads appellent chacun 10 fois dans la fonction
<code class="docutils literal notranslate"><span class="pre">ajoute</span></code>. Le tableau suivant montre l’évolution des variables
<code class="docutils literal notranslate"><span class="pre">message</span></code>, <code class="docutils literal notranslate"><span class="pre">c</span></code>, <code class="docutils literal notranslate"><span class="pre">s</span></code> durant deux premiers appels qui s’entremêlent.
Le résultat devrait être <code class="docutils literal notranslate"><span class="pre">&quot;12&quot;</span></code> pour message mais un caractère a été perdu.
Il faut retenir que si la variable <code class="docutils literal notranslate"><span class="pre">message</span></code> est globale,
les deux autres <code class="docutils literal notranslate"><span class="pre">c</span></code>, <code class="docutils literal notranslate"><span class="pre">s</span></code> sont locales et donc différentes pour les deux threads.</p>
<table class="table">
<colgroup>
<col style="width: 16.7%" />
<col style="width: 16.7%" />
<col style="width: 16.7%" />
<col style="width: 16.7%" />
<col style="width: 16.7%" />
<col style="width: 16.7%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>ordre</p></th>
<th class="head"><p>thread 1</p></th>
<th class="head"><p>thread 2</p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">message</span></code></p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">c</span></code></p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">s</span></code></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">s</span> <span class="pre">=</span> <span class="pre">message</span> <span class="pre">+</span> <span class="pre">c</span></code></p></td>
<td></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;1&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;1&quot;</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td></td>
<td><p><code class="docutils literal notranslate"><span class="pre">s</span> <span class="pre">=</span> <span class="pre">message</span> <span class="pre">+</span> <span class="pre">c</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;2&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;2&quot;</span></code></p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">time.sleep</span> <span class="pre">(0.001)</span></code></p></td>
<td></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;1&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;1&quot;</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td></td>
<td><p><code class="docutils literal notranslate"><span class="pre">time.sleep</span> <span class="pre">(0.001)</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;2&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;2&quot;</span></code></p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">message</span> <span class="pre">=</span> <span class="pre">s</span></code></p></td>
<td></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;1&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;1&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;1&quot;</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td></td>
<td><p><code class="docutils literal notranslate"><span class="pre">message</span> <span class="pre">=</span> <span class="pre">s</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;2&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;2&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;2&quot;</span></code></p></td>
</tr>
</tbody>
</table>
<p>Le verrou empêche d’exécuter une même portion de code en même temps,
un code qui modifie des données partagées. C’est pourquoi le verrou
est souvent déclaré au même endroit que les données qu’il protège.
Le verrou de type <a class="reference external" href="https://docs.python.org/3/library/threading.html?highlight=condition#threading.Lock">Lock</a> n’autorise qu’un seul thread à la fois à
l’intérieur de la portion de code protégée ce qui aboutit au schéma suivant :</p>
<table class="table">
<colgroup>
<col style="width: 16.7%" />
<col style="width: 16.7%" />
<col style="width: 16.7%" />
<col style="width: 16.7%" />
<col style="width: 16.7%" />
<col style="width: 16.7%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>ordre</p></th>
<th class="head"><p>thread 1</p></th>
<th class="head"><p>thread 2</p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">message</span></code></p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">c</span></code></p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">s</span></code></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">s</span> <span class="pre">=</span> <span class="pre">message</span> <span class="pre">+</span> <span class="pre">c</span></code></p></td>
<td></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;1&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;1&quot;</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">time.sleep</span> <span class="pre">(0.001)</span></code></p></td>
<td></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;1&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;1&quot;</span></code></p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">message</span> <span class="pre">=</span> <span class="pre">s</span></code></p></td>
<td></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;1&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;1&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;1&quot;</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td></td>
<td><p><code class="docutils literal notranslate"><span class="pre">s</span> <span class="pre">=</span> <span class="pre">message</span> <span class="pre">+</span> <span class="pre">c</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;1&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;2&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;12&quot;</span></code></p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td></td>
<td><p><code class="docutils literal notranslate"><span class="pre">time.sleep</span> <span class="pre">(0.001)</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;1&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;2&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;12&quot;</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td></td>
<td><p><code class="docutils literal notranslate"><span class="pre">message</span> <span class="pre">=</span> <span class="pre">s</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;12&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;2&quot;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;12&quot;</span></code></p></td>
</tr>
</tbody>
</table>
<p>Le verrou de type <a class="reference external" href="https://docs.python.org/3.5/library/threading.html?highlight=condition#threading.Semaphore">Semaphore</a>
autorise un nombre maximal de thread à parcourir le même code. Ce procédé est parfois utile si
le code en question permet d’imprimer un document. Cela permet de limiter sans
interdire les accès simultanés aux ressources de l’ordinateur.</p>
<p>Ce mécanisme de verrou peut aboutir à des blocages avec deux threads et
deux portions de code protégées. Chaque thread est « coincé » dans une section
attendant que l’autre libère la sienne. Dans ce cas de figure, il est conseillé d’utiliser
le même verrou pour protéger les deux sections. Ainsi, chaque thread ne pourra pas entrer dans
l’une ou l’autre des portions de code protégées tant que l’une d’entre
elles est visitée par l’autre thread.</p>
</section>
</section>
<section id="interface-graphique">
<span id="thread-interface-graphique"></span><h2><a class="toc-backref" href="#id7" role="doc-backlink">Interface graphique</a><a class="headerlink" href="#interface-graphique" title="Lien permanent vers cette rubrique">#</a></h2>
<p>Un programme bâti autour d’une interface graphique inclut nécessairement une
boucle de message. Celle-ci attend les messages en provenance de l’interface.
Lorsqu’un de ceux-ci lui commande de lancer un traitement long, l’interface
graphique n’est plus en mesure de réagir aux événements qui lui viennent pendant ce temps.
Afin de remédier cela, il suffit d’insérer le traitement dans un thread.
A la fin de ce dernier, un événement sera envoyé à l’interface afin de lui signifier
la fin du traitement.</p>
<p>Le paragraphe <a class="reference internal" href="../c_gui/tkinter.html#parag-graph-bind"><span class="std std-ref">Associer n’importe quel événement à un objet</span></a> a montré comment associer un événement
particulier à une fenêtre. La différence ici est que l’événement accroché à la
fenêtre n’est pas prédéfini par le module
<a class="reference external" href="https://docs.python.org/3.5/library/tkinter.html?highlight=tkinter#module-tkinter">Tkinter</a>
mais par le programme lui-même - dans cet exemple <code class="docutils literal notranslate"><span class="pre">&lt;&lt;thread_fini&gt;&gt;</span></code> -.
Les symboles <code class="docutils literal notranslate"><span class="pre">&lt;&lt;&gt;&gt;</span></code> au début et à la fin du nom de l’événement sont la seule contrainte.
La méthode <code class="docutils literal notranslate"><span class="pre">event_generate</span></code> permet d’insérer un message dans la boucle de
messages de façon à ce que celui-ci soit traité au même titre qu’un clic de souris, la pression d’une touche, …</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">threading</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">copy</span>

<span class="c1"># définition du thread</span>
<span class="k">class</span> <span class="nc">MonThread</span> <span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">win</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span> <span class="o">=</span> <span class="n">win</span>  <span class="c1"># on mémorise une référence sur la fenêtre</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">run</span> <span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;thread &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

          <span class="c1"># afin que le thread retourne un résultat</span>
          <span class="c1"># self.res désigne thread_resultat qui reçoit un nombre de plus</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="n">h</span><span class="p">)</span>

          <span class="c1"># on lance un événement &lt;&lt;thread_fini&gt;&gt; à la fenêtre principale</span>
          <span class="c1"># pour lui dire que le thread est fini, l&#39;événement est ensuite</span>
          <span class="c1"># géré par la boucle principale de messages</span>
          <span class="c1"># on peut transmettre également le résultat lors de l&#39;envoi du message</span>
          <span class="c1"># en utilisant un attribut de la classe Event pour son propre compte</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">event_generate</span> <span class="p">(</span><span class="s2">&quot;&lt;&lt;thread_fini&gt;&gt;&quot;</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">h</span><span class="p">)</span>

<span class="n">thread_resultat</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">lance_thread</span> <span class="p">()</span> <span class="p">:</span>
    <span class="k">global</span> <span class="n">thread_resultat</span>
      <span class="c1"># fonction appelée lors de la pression du bouton</span>
      <span class="c1"># on change la légnde de la zone de texte</span>
    <span class="n">text</span> <span class="o">.</span><span class="n">config</span> <span class="p">(</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;thread démarré&quot;</span><span class="p">)</span>
    <span class="n">text2</span><span class="o">.</span><span class="n">config</span> <span class="p">(</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;thread démarré&quot;</span><span class="p">)</span>
      <span class="c1"># on désactive le bouton pour éviter de lancer deux threads en même temps</span>
    <span class="n">bouton</span><span class="o">.</span><span class="n">config</span> <span class="p">(</span><span class="n">state</span> <span class="o">=</span> <span class="n">TK</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">)</span>
      <span class="c1"># on lance le thread</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">MonThread</span> <span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">thread_resultat</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">start</span> <span class="p">()</span>

<span class="k">def</span> <span class="nf">thread_fini_fonction</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">global</span> <span class="n">thread_resultat</span>
      <span class="c1"># fonction appelée lorsque le thread est fini</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;la fenêtre sait que le thread est fini&quot;</span><span class="p">)</span>
      <span class="c1"># on change la légende de la zone de texte</span>
    <span class="n">text</span> <span class="o">.</span><span class="n">config</span> <span class="p">(</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;thread fini + résultat &quot;</span> <span class="o">+</span> <span class="nb">str</span> <span class="p">(</span><span class="n">thread_resultat</span><span class="p">))</span>
    <span class="n">text2</span><span class="o">.</span><span class="n">config</span> <span class="p">(</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;thread fini + résultat (e.x) &quot;</span> <span class="o">+</span> <span class="nb">str</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>
      <span class="c1"># on réactive le bouton de façon à pouvoir lancer un autre thread</span>
    <span class="n">bouton</span><span class="o">.</span><span class="n">config</span> <span class="p">(</span><span class="n">state</span> <span class="o">=</span> <span class="n">TK</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">tkinter</span> <span class="k">as</span> <span class="nn">TK</span>

<span class="c1"># on crée la fenêtre</span>
<span class="n">root</span>   <span class="o">=</span> <span class="n">TK</span><span class="o">.</span><span class="n">Tk</span> <span class="p">()</span>
<span class="n">bouton</span> <span class="o">=</span> <span class="n">TK</span><span class="o">.</span><span class="n">Button</span> <span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;thread départ&quot;</span><span class="p">,</span> <span class="n">command</span> <span class="o">=</span> <span class="n">lance_thread</span><span class="p">)</span>
<span class="n">text</span>   <span class="o">=</span> <span class="n">TK</span><span class="o">.</span><span class="n">Label</span> <span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;rien&quot;</span><span class="p">)</span>
<span class="n">text2</span>  <span class="o">=</span> <span class="n">TK</span><span class="o">.</span><span class="n">Label</span> <span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;rien&quot;</span><span class="p">)</span>
<span class="n">bouton</span><span class="o">.</span><span class="n">pack</span> <span class="p">()</span>
<span class="n">text</span><span class="o">.</span><span class="n">pack</span> <span class="p">()</span>
<span class="n">text2</span><span class="o">.</span><span class="n">pack</span> <span class="p">()</span>

<span class="c1"># on associe une fonction à un événement &lt;&lt;thread_fini&gt;&gt; propre au programme</span>
<span class="n">root</span><span class="o">.</span><span class="n">bind</span> <span class="p">(</span><span class="s2">&quot;&lt;&lt;thread_fini&gt;&gt;&quot;</span><span class="p">,</span> <span class="n">thread_fini_fonction</span><span class="p">)</span>

<span class="c1"># on active la boucle principale de message</span>
<span class="n">root</span><span class="o">.</span><span class="n">mainloop</span> <span class="p">()</span>
</pre></div>
</div>
<p>L’image suivante est la fenêtre affichée par le programme
lorsqu’elle attend la pression du bouton qui lance le thread
et lorsqu’elle attend la fin de l’exécution de ce thread.</p>
<table class="table">
<colgroup>
<col style="width: 50.0%" />
<col style="width: 50.0%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><img alt="../_images/threadim1.png" src="../_images/threadim1.png" />
</td>
<td><img alt="../_images/threadim2.png" src="../_images/threadim2.png" />
</td>
</tr>
</tbody>
</table>
<p>Le programme précédent utilise une astuce pour retourner un résultat
autrement qu’un utilisant un paramètre global. On peut
adjoindre lors de l’appel à la méthode <code class="docutils literal notranslate"><span class="pre">event_generate</span></code>
quelques informations supplémentaires attachées à l’événement
en utilisant les attributs prédéfinis de la classe <a class="reference external" href="https://docs.python.org/3/library/threading.html?highlight=event#threading.Event">Event</a>.
Dans cet exemple, on utilise l’attribut <code class="docutils literal notranslate"><span class="pre">x</span></code> pour retourner
le dernier entier tiré aléatoirement.</p>
<p>La première image est la fenêtre après trois exécutions du thread.
La liste <code class="docutils literal notranslate"><span class="pre">thread_resultat</span></code> contient
trois nombres. Une fois l’unique bouton pressé, la fenêtre change d’aspect pour devenir comme la seconde image.
Cette transition est assurée par la fonction <code class="docutils literal notranslate"><span class="pre">lance_thread</span></code> reliée au bouton.
La transition inverse est assurée par la fonction <code class="docutils literal notranslate"><span class="pre">thread_fini_fonction</span></code>
qui est reliée à l’événement que génère le thread lorsqu’il a terminé.</p>
</section>
<section id="files-de-messages">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">Files de messages</a><a class="headerlink" href="#files-de-messages" title="Lien permanent vers cette rubrique">#</a></h2>
<p>Les trois usages principaux des threads sont le calcul distribué,
la conception d’une interface graphique réactive et l’attente
permanente d’événements. En ce qui concernent les deux premiers usages,
on peut considérer qu’il existe un thread principal qui lance
et attend l’exécution de threads secondaires. Les échanges
d’informations ont lieu au début et à la fin de chaque thread.
Il n’est pas toujours nécessaire de partager des variables en cours
d’exécution : l’usage de verrous est peu fréquent pour ces deux schémas
sauf pour partager des informations en cours d’exécution. Ils ralentissent
considérablement l’exécution d’un programme.</p>
<p>En ce qui concerne le troisième usage, c’est un cas où tout au long
du programme, il y a constamment au moins deux threads actifs :
un thread principal et un thread qui attend. Dans ce cas,
l’échange et la synchronisation d’informations est inévitable et
il est souvent fastidieux de concevoir la synchronisation.
C’est pourquoi on la conçoit presque toujours sous forme de messages
que les threads s’envoient.</p>
<p>Il existe un objet <a class="reference external" href="https://docs.python.org/3.5/library/queue.html?highlight=queu#queue.Queue">Queue</a>
qui facilite cet aspect. C’est une liste qui possède son propre
verrou de sorte que n’importe quel thread peut ajouter ou retirer
des éléments de cette liste. Elle est utilisée principalement
via quatre méthodes. Deux méthodes
<a class="reference external" href="https://docs.python.org/3.5/library/queue.html?highlight=queu#queue.Queue.get">get</a>
sont utilisées au sein du thread qui possède la pile.
Deux méthodes <a class="reference external" href="https://docs.python.org/3.5/library/queue.html?highlight=queu#queue.Queue.put">put</a>
sont appelées par des threads étrangers.</p>
<table class="table">
<colgroup>
<col style="width: 25.0%" />
<col style="width: 75.0%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">get([timeout=...]</span></code></p></td>
<td><p>Retourne un élément de la liste ou attend qu’il y en ait un,
le supprime si elle en trouve un. Si <code class="docutils literal notranslate"><span class="pre">timeout</span></code> est renseigné,
la fonction attend au plus <code class="docutils literal notranslate"><span class="pre">timeout</span></code> secondes, sinon,
elle déclenche l’exception <a class="reference external" href="https://docs.python.org/3.5/library/queue.html?highlight=queu#queue.Empty">Empty</a>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">get_nowait()</span></code></p></td>
<td><p>Retourne un élément de la liste s’il y a en un, dans ce cas,
cet élément est supprimé. Dans le cas contraire, la méthode déclenche
l’exception <a class="reference external" href="https://docs.python.org/3.5/library/queue.html?highlight=queu#queue.Empty">Empty</a>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">put(e[,timeout=...])</span></code></p></td>
<td><p>Ajoute l’élément <code class="docutils literal notranslate"><span class="pre">e</span></code> à la liste ou attend qu’une place se
libère si la liste est pleine. Si <code class="docutils literal notranslate"><span class="pre">timeout</span></code> est renseigné,
la fonction attend au plus <code class="docutils literal notranslate"><span class="pre">timeout</span></code> secondes, sinon,
elle déclenche l’exception
<a class="reference external" href="https://docs.python.org/3.5/library/queue.html?highlight=queu#queue.Full">Full</a>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">put_nowait(e)</span></code></p></td>
<td><p>Ajoute l’élément <code class="docutils literal notranslate"><span class="pre">e</span></code> à la liste ou déclenche l’exception
<a class="reference external" href="https://docs.python.org/3.5/library/queue.html?highlight=queu#queue.Full">Full</a> si la liste est pleine.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">qsize()</span></code></p></td>
<td><p>Retourne la taille de la pile.</p></td>
</tr>
</tbody>
</table>
<p id="index-4">Cette pile est utilisée dans l’exemple qui suit pour simuler deux joueurs
qui essaye de découvrir le nombre que l’autre joueur a tiré au hasard.
A chaque essai, un joueur envoie un message de type <code class="docutils literal notranslate"><span class="pre">(&quot;essai&quot;,</span> <span class="pre">n)</span></code>
à l’autre joueur pour dire qu’il joue le nombre <code class="docutils literal notranslate"><span class="pre">n</span></code>. Ce joueur lui répond
avec des messages de type <code class="docutils literal notranslate"><span class="pre">(&quot;dessous&quot;,</span> <span class="pre">n)</span></code>, <code class="docutils literal notranslate"><span class="pre">(&quot;dessus&quot;,</span> <span class="pre">n)</span></code>, <code class="docutils literal notranslate"><span class="pre">(&quot;gagne&quot;,</span> <span class="pre">n)</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">A</span>  <span class="p">:</span> <span class="n">je</span> <span class="n">joue</span> <span class="p">(</span> <span class="mi">10</span> <span class="p">)</span>
    <span class="n">B</span>  <span class="p">:</span> <span class="n">je</span> <span class="n">joue</span> <span class="p">(</span> <span class="mi">8</span> <span class="p">)</span>
    <span class="n">A</span>  <span class="p">:</span> <span class="n">je</span> <span class="n">tente</span>  <span class="mi">10</span>  <span class="n">écart</span>  <span class="mi">10</span>  <span class="n">à</span> <span class="n">traiter</span>  <span class="mi">0</span>
    <span class="n">A</span>  <span class="p">:</span> <span class="n">je</span> <span class="n">tente</span>  <span class="mi">2</span>  <span class="n">écart</span>  <span class="mi">10</span>  <span class="n">à</span> <span class="n">traiter</span>  <span class="mi">0</span>
    <span class="n">B</span>  <span class="p">:</span> <span class="n">je</span> <span class="n">tente</span>  <span class="mi">4</span>  <span class="n">écart</span>  <span class="mi">10</span>  <span class="n">à</span> <span class="n">traiter</span>  <span class="mi">1</span>
    <span class="n">A</span>  <span class="p">:</span> <span class="n">je</span> <span class="n">tente</span>  <span class="mi">8</span>  <span class="n">écart</span>  <span class="mi">9</span>  <span class="n">à</span> <span class="n">traiter</span>  <span class="mi">0</span>
    <span class="n">A</span>  <span class="p">:</span> <span class="n">je</span> <span class="n">tente</span>  <span class="mi">4</span>  <span class="n">écart</span>  <span class="mi">9</span>  <span class="n">à</span> <span class="n">traiter</span>  <span class="mi">0</span>
    <span class="n">B</span>  <span class="p">:</span> <span class="n">je</span> <span class="n">tente</span>  <span class="mi">9</span>  <span class="n">écart</span>  <span class="mi">10</span>  <span class="n">à</span> <span class="n">traiter</span>  <span class="mi">3</span>
    <span class="n">A</span>  <span class="p">:</span> <span class="n">je</span> <span class="n">tente</span>  <span class="mi">4</span>  <span class="n">écart</span>  <span class="mi">6</span>  <span class="n">à</span> <span class="n">traiter</span>  <span class="mi">0</span>
    <span class="n">A</span>  <span class="p">:</span> <span class="n">je</span> <span class="n">tente</span>  <span class="mi">8</span>  <span class="n">écart</span>  <span class="mi">6</span>  <span class="n">à</span> <span class="n">traiter</span>  <span class="mi">0</span>
    <span class="n">A</span>  <span class="p">:</span> <span class="n">je</span> <span class="n">tente</span>  <span class="mi">5</span>  <span class="n">écart</span>  <span class="mi">6</span>  <span class="n">à</span> <span class="n">traiter</span>  <span class="mi">0</span>
    <span class="n">A</span>  <span class="p">:</span> <span class="n">je</span> <span class="n">tente</span>  <span class="mi">6</span>  <span class="n">écart</span>  <span class="mi">6</span>  <span class="n">à</span> <span class="n">traiter</span>  <span class="mi">0</span>
    <span class="n">A</span>  <span class="p">:</span> <span class="n">je</span> <span class="n">tente</span>  <span class="mi">5</span>  <span class="n">écart</span>  <span class="mi">6</span>  <span class="n">à</span> <span class="n">traiter</span>  <span class="mi">0</span>
    <span class="n">B</span>  <span class="p">:</span> <span class="n">j</span><span class="s1">&#39;ai perdu après  2  essais</span>
    <span class="n">B</span>  <span class="p">:</span> <span class="n">j</span><span class="s1">&#39;arrête</span>
    <span class="n">A</span>  <span class="p">:</span> <span class="n">j</span><span class="s1">&#39;ai gagné en  9  essais, solution  8</span>
    <span class="n">A</span>  <span class="p">:</span> <span class="n">j</span><span class="s1">&#39;arrête</span>
</pre></div>
</div>
<p>Les affichages se chevauchent parfois, il faudrait pour éviter cela synchroniser
l’affichage à l’aide d’un verrou.</p>
</section>
<section id="multithreading-plus-simple">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Multithreading plus simple</a><a class="headerlink" href="#multithreading-plus-simple" title="Lien permanent vers cette rubrique">#</a></h2>
<p>Le module <a class="reference external" href="https://docs.python.org/3/library/threading.html">threading</a>
a beaucoup été utilisé mais d’autres modules ont été ajoutés à la
distribution standard de python.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.python.org/3/library/concurrent.futures.html#module-concurrent.futures" title="(disponible dans Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">concurrent.futures</span></code></a> :
le module propose une interface similaire pour paralléliser avec des threads ou des processus.
La création des threads s’écrit plus rapidement.</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/asyncio.html#module-asyncio" title="(disponible dans Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code></a> : ce module fonctionne avec les mots-clés
<a class="reference external" href="https://docs.python.org/3/library/asyncio-task.html#example-hello-world-coroutine">async, await</a>
et il est particulièrement adapté à la parallélisation à des accès aux ressources.</p></li>
</ul>
<p>Le premier module est plus adapté à la parallélisation des calculs,
le second est particulière utile pour écrire des applications non bloquantes
qui gère pas mal d’accès à Internet.</p>
<section id="concurrent-futures">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">concurrent.futures</a><a class="headerlink" href="#concurrent-futures" title="Lien permanent vers cette rubrique">#</a></h3>
<p>Le module <a class="reference external" href="https://docs.python.org/3/library/concurrent.futures.html#module-concurrent.futures" title="(disponible dans Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">concurrent.futures</span></code></a>
implémente une classe <a class="reference external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor" title="(disponible dans Python v3.11)"><code class="xref py py-class docutils literal notranslate"><span class="pre">concurrent.futures.Executor</span></code></a>
qui définit une interface pour l’exécution en parallèle. On peut soit :</p>
<ul class="simple">
<li><p>soumettre l’exécution d’une fonction avec
<a class="reference external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.submit" title="(disponible dans Python v3.11)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">concurrent.futures.Executor.submit()</span></code></a></p></li>
<li><p>ou soumettre l’exécution de la même fonction appliquée à séquence de jeux de paramètres
avec <a class="reference external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.map" title="(disponible dans Python v3.11)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">concurrent.futures.Executor.map()</span></code></a></p></li>
</ul>
<p>Cette classe est dérivée en un
<a class="reference external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.ThreadPoolExecutor" title="(disponible dans Python v3.11)"><code class="xref py py-class docutils literal notranslate"><span class="pre">concurrent.futures.ThreadPoolExecutor</span></code></a>
dont le principal argument <em>max_works</em> définit le nombre de threads à exécuter en parallèle.
Je reproduis ici l”<a class="reference external" href="https://docs.python.org/3/library/concurrent.futures.html#processpoolexecutor-example">exemple</a>
de la documentation de <em>Python</em> qui détermine si un nombre est premier.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">concurrent.futures</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="n">PRIMES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">112272535095293</span><span class="p">,</span>
    <span class="mi">112582705942171</span><span class="p">,</span>
    <span class="mi">112272535095293</span><span class="p">,</span>
    <span class="mi">115280095190773</span><span class="p">,</span>
    <span class="mi">115797848077099</span><span class="p">,</span>
    <span class="mi">1099726899285419</span><span class="p">,</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">is_prime</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">sqrt_n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">sqrt_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">number</span><span class="p">,</span> <span class="n">prime</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">PRIMES</span><span class="p">,</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">is_prime</span><span class="p">,</span> <span class="n">PRIMES</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> is prime: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">prime</span><span class="p">))</span>


<span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="mi">112272535095293</span> <span class="ow">is</span> <span class="n">prime</span><span class="p">:</span> <span class="kc">True</span>
    <span class="mi">112582705942171</span> <span class="ow">is</span> <span class="n">prime</span><span class="p">:</span> <span class="kc">True</span>
    <span class="mi">112272535095293</span> <span class="ow">is</span> <span class="n">prime</span><span class="p">:</span> <span class="kc">True</span>
    <span class="mi">115280095190773</span> <span class="ow">is</span> <span class="n">prime</span><span class="p">:</span> <span class="kc">True</span>
    <span class="mi">115797848077099</span> <span class="ow">is</span> <span class="n">prime</span><span class="p">:</span> <span class="kc">True</span>
    <span class="mi">1099726899285419</span> <span class="ow">is</span> <span class="n">prime</span><span class="p">:</span> <span class="kc">False</span>
</pre></div>
</div>
<p>Débugger un programme en parallèle n’est pas chose facile car les exécutions s’entremêlent
et les instructions <em>print</em> si elles sont insérées dans la fonction parallélisée produisent
des résultats indéchiffrables.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">concurrent.futures</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="n">PRIMES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">112272535095293</span><span class="p">,</span>
    <span class="mi">112582705942171</span><span class="p">,</span>
    <span class="mi">112272535095293</span><span class="p">,</span>
    <span class="mi">115280095190773</span><span class="p">,</span>
    <span class="mi">115797848077099</span><span class="p">,</span>
    <span class="mi">1099726899285419</span><span class="p">,</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">is_prime</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">sqrt_n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">sqrt_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="s2">&quot;#&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">number</span><span class="p">,</span> <span class="n">prime</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">PRIMES</span><span class="p">,</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">is_prime</span><span class="p">,</span> <span class="n">PRIMES</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> is prime: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">prime</span><span class="p">))</span>


<span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">start</span> <span class="mi">112272535095293</span> <span class="o">*</span>
    <span class="n">start</span> <span class="mi">112582705942171</span> <span class="o">*</span>
    <span class="n">end</span> <span class="mi">112272535095293</span> <span class="c1">#</span>
    <span class="n">start</span> <span class="mi">112272535095293</span> <span class="o">*</span>
    <span class="mi">112272535095293</span> <span class="ow">is</span> <span class="n">prime</span><span class="p">:</span> <span class="kc">True</span>
    <span class="n">end</span> <span class="mi">112582705942171</span> <span class="c1">#</span>
    <span class="n">start</span> <span class="mi">115280095190773</span> <span class="o">*</span>
    <span class="mi">112582705942171</span> <span class="ow">is</span> <span class="n">prime</span><span class="p">:</span> <span class="kc">True</span>
    <span class="n">end</span> <span class="mi">112272535095293</span> <span class="c1">#</span>
    <span class="n">start</span> <span class="mi">115797848077099</span> <span class="o">*</span>
    <span class="mi">112272535095293</span> <span class="ow">is</span> <span class="n">prime</span><span class="p">:</span> <span class="kc">True</span>
    <span class="n">end</span> <span class="mi">115280095190773</span> <span class="c1">#</span>
    <span class="n">start</span> <span class="mi">1099726899285419</span> <span class="o">*</span>
    <span class="mi">115280095190773</span> <span class="ow">is</span> <span class="n">prime</span><span class="p">:</span> <span class="kc">True</span>
    <span class="n">end</span> <span class="mi">115797848077099</span> <span class="c1">#</span>
    <span class="mi">115797848077099</span> <span class="ow">is</span> <span class="n">prime</span><span class="p">:</span> <span class="kc">True</span>
    <span class="mi">1099726899285419</span> <span class="ow">is</span> <span class="n">prime</span><span class="p">:</span> <span class="kc">False</span>
</pre></div>
</div>
<p>Pour débugger, il faut utiliser le module <a class="reference external" href="https://docs.python.org/3/library/logging.html#module-logging">logging</a>
(voir aussi <a class="reference external" href="http://sametmax.com/ecrire-des-logs-en-python/">Ecrire des logs en Python</a>).
L’exemple suivant construit un <em>logger</em> par thread</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">concurrent.futures</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="n">loggers</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span> <span class="nf">get_logger</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">loggers</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">loggers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(threadName)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>

    <span class="c1"># Pour un affiche sur la sortie standard mais cela s&#39;entremêle parfois.</span>
    <span class="c1"># ch = logging.StreamHandler(sys.stdout)</span>
    <span class="c1"># ch.setFormatter(formatter)</span>
    <span class="c1"># logger.addHandler(ch)</span>

    <span class="c1"># Pour une sortie dans un fichier.</span>
    <span class="c1"># Le mode &quot;w&quot; signifie que les logs de l&#39;exécution précédente</span>
    <span class="c1"># seront effacés.</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

    <span class="n">loggers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">logger</span>
    <span class="k">return</span> <span class="n">loggers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>


<span class="n">PRIMES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">112272535095293</span><span class="p">,</span>
    <span class="mi">112582705942171</span><span class="p">,</span>
    <span class="mi">112272535095293</span><span class="p">,</span>
    <span class="mi">115280095190773</span><span class="p">,</span>
    <span class="mi">115797848077099</span><span class="p">,</span>
    <span class="mi">1099726899285419</span><span class="p">,</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">is_prime</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;start </span><span class="si">{}</span><span class="s2">*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;end1 </span><span class="si">{}</span><span class="s2">*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">sqrt_n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">sqrt_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;end2 </span><span class="si">{}</span><span class="s2">*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;end3 </span><span class="si">{}</span><span class="s2">*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;thread&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">number</span><span class="p">,</span> <span class="n">prime</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">PRIMES</span><span class="p">,</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">is_prime</span><span class="p">,</span> <span class="n">PRIMES</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> is prime: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">prime</span><span class="p">))</span>


<span class="n">main</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;thread_0.log&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;thread_1.log&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="mi">112272535095293</span> <span class="ow">is</span> <span class="n">prime</span><span class="p">:</span> <span class="kc">True</span>
    <span class="mi">112582705942171</span> <span class="ow">is</span> <span class="n">prime</span><span class="p">:</span> <span class="kc">True</span>
    <span class="mi">112272535095293</span> <span class="ow">is</span> <span class="n">prime</span><span class="p">:</span> <span class="kc">True</span>
    <span class="mi">115280095190773</span> <span class="ow">is</span> <span class="n">prime</span><span class="p">:</span> <span class="kc">True</span>
    <span class="mi">115797848077099</span> <span class="ow">is</span> <span class="n">prime</span><span class="p">:</span> <span class="kc">True</span>
    <span class="mi">1099726899285419</span> <span class="ow">is</span> <span class="n">prime</span><span class="p">:</span> <span class="kc">False</span>
    <span class="o">-----</span>
    <span class="mi">2023</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">02</span> <span class="mi">22</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">54</span><span class="p">,</span><span class="mi">512</span> <span class="o">-</span> <span class="n">thread_0</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span> <span class="n">start</span> <span class="mi">112272535095293</span><span class="o">*</span>
    <span class="mi">2023</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">02</span> <span class="mi">22</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">57</span><span class="p">,</span><span class="mi">306</span> <span class="o">-</span> <span class="n">thread_0</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span> <span class="n">end3</span> <span class="mi">112272535095293</span><span class="o">*</span>
    <span class="mi">2023</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">02</span> <span class="mi">22</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">57</span><span class="p">,</span><span class="mi">312</span> <span class="o">-</span> <span class="n">thread_0</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span> <span class="n">start</span> <span class="mi">115280095190773</span><span class="o">*</span>
    <span class="mi">2023</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">02</span> <span class="mi">22</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="p">,</span><span class="mi">475</span> <span class="o">-</span> <span class="n">thread_0</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span> <span class="n">end3</span> <span class="mi">115280095190773</span><span class="o">*</span>
    <span class="mi">2023</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">02</span> <span class="mi">22</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="p">,</span><span class="mi">481</span> <span class="o">-</span> <span class="n">thread_0</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span> <span class="n">start</span> <span class="mi">1099726899285419</span><span class="o">*</span>
    <span class="mi">2023</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">02</span> <span class="mi">23</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span><span class="mi">228</span> <span class="o">-</span> <span class="n">thread_0</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span> <span class="n">end2</span> <span class="mi">1099726899285419</span><span class="o">*</span>
    
    <span class="o">-----</span>
    <span class="mi">2023</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">02</span> <span class="mi">22</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">54</span><span class="p">,</span><span class="mi">513</span> <span class="o">-</span> <span class="n">thread_1</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span> <span class="n">start</span> <span class="mi">112582705942171</span><span class="o">*</span>
    <span class="mi">2023</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">02</span> <span class="mi">22</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">57</span><span class="p">,</span><span class="mi">305</span> <span class="o">-</span> <span class="n">thread_1</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span> <span class="n">end3</span> <span class="mi">112582705942171</span><span class="o">*</span>
    <span class="mi">2023</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">02</span> <span class="mi">22</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">57</span><span class="p">,</span><span class="mi">306</span> <span class="o">-</span> <span class="n">thread_1</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span> <span class="n">start</span> <span class="mi">112272535095293</span><span class="o">*</span>
    <span class="mi">2023</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">02</span> <span class="mi">22</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="p">,</span><span class="mi">427</span> <span class="o">-</span> <span class="n">thread_1</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span> <span class="n">end3</span> <span class="mi">112272535095293</span><span class="o">*</span>
    <span class="mi">2023</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">02</span> <span class="mi">22</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="p">,</span><span class="mi">433</span> <span class="o">-</span> <span class="n">thread_1</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span> <span class="n">start</span> <span class="mi">115797848077099</span><span class="o">*</span>
    <span class="mi">2023</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">02</span> <span class="mi">23</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span><span class="p">,</span><span class="mi">248</span> <span class="o">-</span> <span class="n">thread_1</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span> <span class="n">end3</span> <span class="mi">115797848077099</span><span class="o">*</span>
</pre></div>
</div>
</section>
<section id="notion-de-futures">
<h3><a class="toc-backref" href="#id11" role="doc-backlink">Notion de futures</a><a class="headerlink" href="#notion-de-futures" title="Lien permanent vers cette rubrique">#</a></h3>
<p id="index-5">Ce concept est apparu récemment dans les langages de programmation, non pas
qu’il n’est jamais été utilisé avant l’an 2000 mais l’usage de plus en plus
fréquent de la programmation parallélisée fait que certains concept sont
nommés et intègres les langages.
Les <a class="reference external" href="https://fr.wikipedia.org/wiki/Futures_(informatique)">futures ou promesses</a>
font référence à un résultat dont le calcul est géré par un autre thread ou
processus. Le résultat n’est pas prêt au moment où ce second thread démarre mais il
le sera bientôt d’où son nom. On les retrouve en C#
<a class="reference external" href="https://msdn.microsoft.com/fr-fr/library/hh191443(v=vs.120).aspx">Programmation asynchrone avec Async et Await</a>
ou C++ <a class="reference external" href="http://en.cppreference.com/w/cpp/thread/async">std::async</a>.
Il y a deux objets <em>futures</em> en Python qui sont produits par différents
jeux de fonctions. On ne créé jamais un <em>futures</em>, c’est toujours une fonction
qui le fait.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Future" title="(disponible dans Python v3.11)"><code class="xref py py-class docutils literal notranslate"><span class="pre">concurrent.futures.Future</span></code></a> : ils sont créés par le module <a class="reference external" href="https://docs.python.org/3/library/concurrent.futures.html#module-concurrent.futures" title="(disponible dans Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">concurrent.futures</span></code></a>.</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/asyncio-task.html#future">asyncio.future</a> :
ils sont créés par le module <a class="reference external" href="https://docs.python.org/3/library/asyncio.html#module-asyncio" title="(disponible dans Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code></a>.</p></li>
</ul>
<p>Les deux objets possèdent la même interface et sont presque compatibles.
Cela dit, il vaut mieux éviter de les mélanger. Je cite la documentation :</p>
<blockquote>
<div><p>This class is not compatible with the
<a class="reference external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.wait">wait()</a> and
<a class="reference external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.as_completed">as_completed()</a>
functions in the concurrent.futures package.</p>
</div></blockquote>
<p>Distribuer l’exécution d’une fonction est relativement facile. Les choses se compliquent
quand il s’agit de distribuer un calcul qui dépend d’un autre calcul distribué.
Il faut enchaîner ces fonctions qu’on dit
<a class="reference external" href="https://en.wikipedia.org/wiki/Synchronous_programming_language">asynchrones</a>
puisque leur exécution n’est plus inscrite dans une seule et même séquence
mais dans plusieurs fils d’exécution parallèles.</p>
</section>
<section id="un-probleme-de-blocage">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">Un problème de blocage</a><a class="headerlink" href="#un-probleme-de-blocage" title="Lien permanent vers cette rubrique">#</a></h3>
<p>La fonction distribue le calcul de la somme des éléments d’un tableau.
et elle est récursive.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">concurrent.futures</span> <span class="k">as</span> <span class="nn">cf</span>


<span class="k">def</span> <span class="nf">parallel_numpy_dot</span><span class="p">(</span><span class="n">va</span><span class="p">,</span> <span class="n">vb</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">cf</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">va</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">,</span> <span class="n">va</span><span class="p">[:</span><span class="n">m</span><span class="p">],</span> <span class="n">vb</span><span class="p">[:</span><span class="n">m</span><span class="p">])</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">,</span> <span class="n">va</span><span class="p">[</span><span class="n">m</span><span class="p">:],</span> <span class="n">vb</span><span class="p">[</span><span class="n">m</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">f1</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="o">+</span> <span class="n">f2</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>


<span class="n">va</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">vb</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">parallel_numpy_dot</span><span class="p">(</span><span class="n">va</span><span class="p">,</span> <span class="n">vb</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="o">-</span><span class="mf">419.9963277987386</span>
</pre></div>
</div>
<p>Il faut voir l’objet <em>executor</em> comme un objet qui empile les fonctions
à exécuter. Le problème dans l’exemple précédent est que la fonction
<em>distribute_sum</em> est déjà dans la pile d’exécution et attend l’exécution
de deux autres appels à la même fonction placée après elle dans la pile d’exécution.</p>
<img alt="../_images/pool.png" src="../_images/pool.png" />
<p>Si chaque appel à la fonction était effectué sur un thread différent,
cela pourrait fonctionner. Mais ce n’est pas le cas pour cette implémentation.
L’appel 1 attend la fin de 2 et 3 qui ne peuvent pas être exécutés tant
que 1 n’est pas fini. Pour résoudre le problème dans ce cas ci, il faut
remplacer le commentaire par la ligne suivante :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">executor</span> <span class="o">=</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="async-await-asyncio">
<h3><a class="toc-backref" href="#id13" role="doc-backlink">async - await - asyncio</a><a class="headerlink" href="#async-await-asyncio" title="Lien permanent vers cette rubrique">#</a></h3>
<p><a class="reference external" href="https://docs.python.org/3/library/asyncio.html">asyncio</a> a fait émerger
les mots-clés <a class="reference external" href="https://docs.python.org/3/whatsnew/3.5.html?highlight=async#whatsnew-pep-492">async and await</a>
qui font partie du langage depuis la version 3.5 tout comme elles font partie
d’autres langages comme <a class="reference external" href="https://docs.microsoft.com/en-us/dotnet/csharp/async">C#/async</a>
ou <a class="reference external" href="http://www.cplusplus.com/reference/future/async/">C++</a>.</p>
<p>Concrètement, ce n’est pas si difficile d’écrire une fonction
qui a vocation à être parallélisée. Ce qui devient compliqué est d’avoir
à sa disposition plein de fonctions à paralléliser. Il faut
synchroniser. Ces deux mots-clés permettent de définir une fonction
à vocation parallèle (<code class="docutils literal notranslate"><span class="pre">async</span></code>) et une façon d’attendre
qu’elles aient retourné un résultat (<code class="docutils literal notranslate"><span class="pre">await</span></code>).
Ces deux mots-clés sont une façon élégant de créer
des assemblages de fonctions indépendantes et parallélisées.</p>
<p>Les interfaces graphiques ne contiennent qu’un seul <em>await</em>
ou une seule boucle de messages qui attend inlassablement que
quelque chose se passe. Le mot-clé <em>async</em> agit comme un aiguillage.
Une action est enclenchée. Elle signalera sa fin et son résultat plus tard.</p>
<img alt="../_images/asyncapi.png" src="../_images/asyncapi.png" />
<p>Le mot-clés <em>await</em> sert à chaîner les fonctions parallélisées.</p>
</section>
</section>
<section id="gil-global-interpreter-lock">
<h2><a class="toc-backref" href="#id14" role="doc-backlink">GIL - Global Interpreter Lock</a><a class="headerlink" href="#gil-global-interpreter-lock" title="Lien permanent vers cette rubrique">#</a></h2>
<p>Le <a class="reference external" href="https://en.wikipedia.org/wiki/Global_interpreter_lock">Global Interpreter Lock</a>
est un verrou qui évite à plusieurs threads de modifier le même objet en même temps.
Dans les langages bas niveau, on fait la distrinction entre un tableau ou une liste
qui supporte les accès concurrentiels ou non. Si elle ne les supporte pas, les accès
sont plus rapides mais suppose que le dévelopeur s’occupe de gérer les problèmes
de synchronisation si besoin.</p>
<p>Le langage Python protège listes et dictionnaires par l’intermédiaire de ce verrou
qui est unique pour toutes les listes afin de pouvoir gérer efficacement le
<a class="reference external" href="https://fr.wikipedia.org/wiki/Ramasse-miettes_(informatique)">garbage collector</a>
(voir module <a class="reference external" href="https://docs.python.org/3/library/gc.html">gc</a>). En conséquence,
si le langage Python est multithread par design, dans les faits, il ne l’est presque
pas car le <em>GIL</em> est sans cesse utilisé. Le notebook <a class="reference internal" href="../auto_examples/plot_gil_example.html#gilexamplerst"><span class="std std-ref">Le GIL</span></a> finira
de vous convaincre.</p>
<section id="cython-un-melange-de-python-et-c">
<h3><a class="toc-backref" href="#id15" role="doc-backlink">cython : un mélange de python et C</a><a class="headerlink" href="#cython-un-melange-de-python-et-c" title="Lien permanent vers cette rubrique">#</a></h3>
<p>Tout est possible avec le langage C même si
<a class="reference external" href="http://cython.org/">cython</a>
est un mélange des de <em>python</em> et <em>C</em>. Le contexte
<a class="reference external" href="http://cython.readthedocs.io/en/latest/src/userguide/external_C_code.html#releasing-the-gil">nogil</a>
permet de relâcher la contrainte sur GIL pour une fonction ou une partie de code.
Plus de liberté veut dire aussi plus d’attention à apporter au code.
La page <a class="reference external" href="http://cython.readthedocs.io/en/latest/src/userguide/parallelism.html?highlight=nogil#using-parallelism">Using parallelism</a>
donne quelques exemples simples de parallélisation.
Il est plus facile de paralléliser Python avec un autre langage
(voir aussi <a class="reference external" href="https://gist.github.com/perrygeo/2f1b52149f285c00c500">Parallelizing numpy array loops with Cython and OpenMP</a>).</p>
</section>
<section id="c-java">
<h3><a class="toc-backref" href="#id16" role="doc-backlink">C#, Java</a><a class="headerlink" href="#c-java" title="Lien permanent vers cette rubrique">#</a></h3>
<p>L’intégration de langage C est supportée par Python car l’interpéteur
est implémenté en C. Utiliser d’autres langages peut se faire via une
interface en C et celle-ci existe pour certains langages.
C’est le cas du <a class="reference external" href="https://fr.wikipedia.org/wiki/C_sharp">C#</a>
qui peut être utilisé via le module
<a class="reference external" href="https://github.com/pythonnet/pythonnet">pythonnet</a> ou encore
<a class="reference external" href="https://fr.wikipedia.org/wiki/Java">Java</a> via
<a class="reference external" href="https://www.py4j.org/">py4j</a>,
<a class="reference external" href="https://github.com/kivy/pyjnius">pyjnius</a>.
Les threads sont plus faciles à implémenter dans ces langages
même si le <a class="reference external" href="https://fr.wikipedia.org/wiki/Ramasse-miettes_(informatique)">garbage collector</a>
peut nuire aux performances.</p>
</section>
</section>
<section id="bibliographie">
<h2><a class="toc-backref" href="#id17" role="doc-backlink">Bibliographie</a><a class="headerlink" href="#bibliographie" title="Lien permanent vers cette rubrique">#</a></h2>
<p><em>articles</em></p>
<ul class="simple">
<li><p><a class="reference external" href="https://stevedower.id.au/blog/async-api-for-python">Async API for Python</a></p></li>
</ul>
</section>
</section>


                </article>
              
              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="index.html"
       title="page précédente">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">précédent</p>
        <p class="prev-next-title">Parallélisation</p>
      </div>
    </a>
    <a class="right-next"
       href="../c_gui/index.html"
       title="page suivante">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">suivant</p>
        <p class="prev-next-title">Interfaces graphiques</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Sur cette page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#premier-thread">Premier thread</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synchronisation">Synchronisation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#attente">Attente</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#partage-d-informations">Partage d’informations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interface-graphique">Interface graphique</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#files-de-messages">Files de messages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#multithreading-plus-simple">Multithreading plus simple</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#concurrent-futures">concurrent.futures</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#notion-de-futures">Notion de futures</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#un-probleme-de-blocage">Un problème de blocage</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#async-await-asyncio">async - await - asyncio</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gil-global-interpreter-lock">GIL - Global Interpreter Lock</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cython-un-melange-de-python-et-c">cython : un mélange de python et C</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#c-java">C#, Java</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bibliographie">Bibliographie</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div class="tocsection sourcelink">
    <a href="../_sources/c_parallelisation/thread.rst">
      <i class="fa-solid fa-file-lines"></i> Montrer le code source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      © Copyright 2016-2023, Xavier Dupré.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Créé en utilisant <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.1.2.
    <br/>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Construit avec le <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">Thème PyData Sphinx</a> 0.13.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>
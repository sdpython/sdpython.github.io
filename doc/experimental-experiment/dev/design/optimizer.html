<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="API" href="../api/index.html" /><link rel="prev" title="Design" href="index.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2024.01.29 -->
        <title>Pattern Optimizer - experimental-experiment 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b76e3c8a" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css?v=7f9a90b1" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=61a4c737" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">experimental-experiment 0.1.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/logo.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">experimental-experiment 0.1.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorial/index.html">Tutorial</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Tutorial</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../tutorial/pytorch.html">pytorch and onnx</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of pytorch and onnx</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../auto_examples/plot_torch_linreg_101.html">101: Linear Regression and export to ONNX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_examples/plot_torch_custom_backend_101.html">101: A custom backend for torch</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_examples/plot_optimize_101.html">101: Graph Optimization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_examples/plot_convolutation_matmul_102.html">102: Convolution and Matrix Multiplication</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_examples/plot_llama_bench_102.html">102: Measure LLAMA speed</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_examples/plot_torch_export_201.html">201: Evaluate different ways to export a torch model to ONNX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_examples/plot_torch_dort_201.html">201: Evaluate DORT</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_examples/plot_torch_aot_201.html">201: Evaluate DORT Training</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_examples/plot_llama_diff_export_301.html">301: Compares LLAMA exporters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_examples/plot_llama_diff_dort_301.html">301: Compares LLAMA exporters for onnxrt backend</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../tutorial/onnx.html">onnx</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of onnx</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../auto_examples/plot_profile_existing_onnx_101.html">101: Profile an existing model with onnxruntime</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Design</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Design</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Pattern Optimizer</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api/index.html">API</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of API</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/gradient.html">gradient</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/reference.html">reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/graph_builder.html">graph_builder</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/graph_builder_pattern.html">graph_builder_optim</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/interpreter.html">interpreter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/onnx_export.html">onnx_export</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/aten_function.html">aten_functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/aten_method.html">aten_methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/convert.html">convert</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/torch_helper.html">torch_helper</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/torch_dynamo.html">torch_dynamo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/misc.html">Othersâ€¦</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../auto_examples/index.html">Example gallery</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Example gallery</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../auto_examples/plot_optimize_101.html">101: Graph Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auto_examples/plot_profile_existing_onnx_101.html">101: Profile an existing model with onnxruntime</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auto_examples/plot_torch_linreg_101.html">101: Linear Regression and export to ONNX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auto_examples/plot_torch_custom_backend_101.html">101: A custom backend for torch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auto_examples/plot_convolutation_matmul_102.html">102: Convolution and Matrix Multiplication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auto_examples/plot_llama_diff_export_301.html">301: Compares LLAMA exporters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auto_examples/plot_llama_bench_102.html">102: Measure LLAMA speed</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auto_examples/plot_llama_diff_dort_301.html">301: Compares LLAMA exporters for onnxrt backend</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auto_examples/plot_torch_aot_201.html">201: Evaluate DORT Training</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auto_examples/plot_torch_dort_201.html">201: Evaluate DORT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auto_examples/plot_torch_export_201.html">201: Evaluate different ways to export a torch model to ONNX</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">More</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../CHANGELOGS.html">Change Logs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../long_outputs.html">Long Outputs uneasy to read</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="pattern-optimizer">
<h1>Pattern Optimizer<a class="headerlink" href="#pattern-optimizer" title="Link to this heading">#</a></h1>
<p>The pattern optimizer is implemented by class <a class="reference internal" href="../api/graph_builder_pattern.html#experimental_experiment.xoptim.GraphBuilderPatternOptimization" title="experimental_experiment.xoptim.GraphBuilderPatternOptimization"><code class="xref py py-class docutils literal notranslate"><span class="pre">GraphBuilderPatternOptimization</span></code></a>.
It searches for a specific sequence of nodes in the graph and
replaces it by another one without changing the inputs or the long_outputs
of the graph. The goal of the optimizer is to make the whole computation
graph more efficient. The goal of this implementation is to make this
optimization as fast as possible.
Assuming the nodes in an onnx graph are ordered in a way every input of a
node was created by previous nodes, the optimizer must not require
any global reordering. The cost should be in <img class="math" src="../_images/math/ee2fa8e8c79fa606e3168c3d6332beb096b05426.svg" alt="O(N P I)"/> in the worst
case where <em>N</em> is the number of nodes, <em>P</em> is the number of patterns,
<em>I</em> is the number of iterations.</p>
<p>It is difficult to foresee what a pattern needs in order to rewrite a part
of the graph. This API tries to give as much freedom as it can without
leaving too much to do to the developper which tries to add a new pattern.</p>
<section id="patterns">
<h2>Patterns<a class="headerlink" href="#patterns" title="Link to this heading">#</a></h2>
<p>Patterns must inherit from class:<cite>PatternOptimization
&lt;experimental_experiment.xoptim.patterns.PatternOptimization&gt;</cite>.
This class defines two methods.</p>
<section id="patternoptimization-match">
<h3>PatternOptimization.match<a class="headerlink" href="#patternoptimization-match" title="Link to this heading">#</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">match</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">g</span><span class="p">:</span> <span class="s2">&quot;GraphBuilderPatternOptimization&quot;</span><span class="p">,</span>  <span class="c1"># noqa: F821</span>
    <span class="n">node</span><span class="p">:</span> <span class="n">NodeProto</span><span class="p">,</span>
    <span class="n">matched</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MatchResult</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MatchResult</span><span class="p">]:</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">g</span></code> is a <a class="reference internal" href="../api/graph_builder_pattern.html#experimental_experiment.xoptim.GraphBuilderPatternOptimization" title="experimental_experiment.xoptim.GraphBuilderPatternOptimization"><code class="xref py py-class docutils literal notranslate"><span class="pre">GraphBuilderPatternOptimization</span></code></a>,
it holds all the existing nodes, is able to return any information
about type, shape, the node before, the node after another one.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">node</span></code>: the matching must determine if some nodes around this one
are part of set of nodes this pattern optmizer can rewrite.
From there, the function explores wherever it needs,
checking any condition it needs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">matched</span></code>: usually unused, it returns of nodes already matching
a pattern</p></li>
</ul>
<p>The method must not modify the graph.
The method returns None if no match is found or an instance of class <a class="reference internal" href="../api/graph_builder_pattern.html#experimental_experiment.xoptim.patterns.MatchResult" title="experimental_experiment.xoptim.patterns.MatchResult"><code class="xref py py-class docutils literal notranslate"><span class="pre">MatchResult</span></code></a>. It must contain:</p>
<ul class="simple">
<li><p>a list of nodes involved in the rewriting. It does not mean all of them will be
removed but all of them are needed to do the rewriting and must
not be impacted by other pattern optimizer.</p></li>
<li><p>A function doing the rewriting (usually method <em>apply</em> of the pattern class).</p></li>
<li><p>An existing node where the rewritten nodes can be inserted.
Knowing it makes it faster to rewriter. If not specified, the optimizer
will automatically determine the position of the new nodes.</p></li>
</ul>
<p><em>Debugging: method none</em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">none</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">node</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NodeProto</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">lineno</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">):</span>
</pre></div>
</div>
<p>It may be useful which reason made a pattern matching fail.
Instead of returning None, method <em>match</em> can return the following
expression:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">none</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">)</span>
</pre></div>
</div>
<p>By setting the verbosity (see next Section), the user may then know
which lines in the code returned None and which condition failed.</p>
</section>
<section id="patternoptimization-apply">
<h3>PatternOptimization.apply<a class="headerlink" href="#patternoptimization-apply" title="Link to this heading">#</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">apply</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">g</span><span class="p">:</span> <span class="s2">&quot;GraphBuilder&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">nodes</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">NodeProto</span><span class="p">]</span>  <span class="c1"># noqa: F821</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">NodeProto</span><span class="p">]:</span>
</pre></div>
</div>
<p>The method does the rewriting. It assumes it can happen.
It takes a list of nodes impacted by the rewriting assumes no other
pattern optimizer will be modify them. It receives the list of nodes
returned by method <em>apply</em>. Since it is a list of argument, method
<em>match</em> can include None values. The method returns the new nodes.
The optimizer considers that any node given to this function is removed
from the graph, and any node returned by it are added.
If a received node must be kept, it must be added to the list of returned node.</p>
</section>
</section>
<section id="optimization-algorithm">
<h2>Optimization Algorithm<a class="headerlink" href="#optimization-algorithm" title="Link to this heading">#</a></h2>
<p>It is implemented in method <a class="reference internal" href="../api/graph_builder_pattern.html#experimental_experiment.xoptim.GraphBuilderPatternOptimization.optimize" title="experimental_experiment.xoptim.GraphBuilderPatternOptimization.optimize"><code class="xref py py-meth docutils literal notranslate"><span class="pre">optimize</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">remove_identity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</pre></div>
</div>
<p>The algorithm runs multiple iteration until the graph is not evolving
or <cite>max_iter</cite> is reached. By default, it is equal to the number of nodes.
An iteration is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">builds</span> <span class="nb">all</span> <span class="n">successors</span> <span class="ow">and</span> <span class="n">predecessors</span>

<span class="c1"># Step 1: match</span>

<span class="k">for</span> <span class="nb">all</span> <span class="n">patterns</span> <span class="n">P</span><span class="p">:</span>

    <span class="k">for</span> <span class="nb">all</span> <span class="n">nodes</span> <span class="n">n</span><span class="p">:</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">no</span> <span class="n">node</span> <span class="n">already</span> <span class="n">scheduled</span> <span class="n">to</span> <span class="n">be</span> <span class="n">rewritten</span> <span class="n">by</span> <span class="n">another</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="c1"># Step 2: apply</span>

<span class="k">for</span> <span class="nb">all</span> <span class="n">matches</span> <span class="n">r</span><span class="p">:</span>
    <span class="n">apply</span> <span class="n">the</span> <span class="n">match</span> <span class="n">r</span>

<span class="c1"># Step 3: clean</span>

<span class="n">remove</span> <span class="n">unused</span> <span class="n">nodes</span>
<span class="n">remove</span> <span class="n">identity</span> <span class="n">nodes</span>
</pre></div>
</div>
<p>This algorithm may apply more than one rewriting at each iteration
but it guarantees the local structure when applying the rewriting was
not altered by another one.</p>
</section>
<section id="adding-a-pattern">
<h2>Adding a pattern<a class="headerlink" href="#adding-a-pattern" title="Link to this heading">#</a></h2>
<p>See <a class="reference external" href="https://github.com/sdpython/experimental-experiment/pull/80">#80</a> about the addition of a new pattern.</p>
</section>
<section id="example">
<h2>Example<a class="headerlink" href="#example" title="Link to this heading">#</a></h2>
<section id="simple-api">
<h3>Simple API<a class="headerlink" href="#simple-api" title="Link to this heading">#</a></h3>
<p>We consider the following simple model:</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">onnx_array_api.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">experimental_experiment.xbuilder</span> <span class="kn">import</span> <span class="n">OptimizationOptions</span>
<span class="kn">from</span> <span class="nn">experimental_experiment.torch_interpreter</span> <span class="kn">import</span> <span class="n">to_onnx</span>


<span class="k">class</span> <span class="nc">MLP</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span>
    <span class="n">MLP</span><span class="p">(),</span> <span class="p">(</span><span class="n">x</span><span class="p">,),</span> <span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">options</span><span class="o">=</span><span class="n">OptimizationOptions</span><span class="p">(</span><span class="n">patterns</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;temp_doc_mlp.onnx&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">onx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">18</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;x&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;arg0_1&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;arg1_1&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">32</span><span class="p">,)</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;arg2_1&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;arg3_1&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mf">0.17433323</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">Transpose</span><span class="p">(</span><span class="n">arg0_1</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">t</span>
      <span class="n">Gemm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">arg1_1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.00</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">1.00</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">addmm</span>
        <span class="n">Relu</span><span class="p">(</span><span class="n">addmm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">relu</span>
    <span class="n">Transpose</span><span class="p">(</span><span class="n">arg2_1</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">t_1</span>
      <span class="n">Gemm</span><span class="p">(</span><span class="n">relu</span><span class="p">,</span> <span class="n">t_1</span><span class="p">,</span> <span class="n">arg3_1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.00</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">1.00</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">output_0</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;output_0&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<p>Which we can renders as follows:</p>
<div class="graphviz"><img src="../_images/graphviz-0f5af8437b36c2c95e1ca7b6af91a7b29cea67e9.png" alt="digraph{
  orientation=portrait;
  nodesep=0.05;
  size=7;
  ranksep=0.25;

  x [shape=box color=red label=&quot;x\nTensorProto.FLOAT\nshape=[3, 10]&quot; fontsize=10];

  output_0 [shape=box color=green label=&quot;output_0\nTensorProto.FLOAT\nshape=[3, 1]&quot; fontsize=10];

  arg0_1 [shape=box label=&quot;arg0_1\nfloat32((32, 10))\n[[ 0.28628516 -0.30411345  0.10380709  0.23441277 ...&quot; fontsize=10];
  arg1_1 [shape=box label=&quot;arg1_1\nfloat32((32,))\n[ 0.14889693  0.10432336  0.19803037 -0.2808711   ...&quot; fontsize=10];
  arg2_1 [shape=box label=&quot;arg2_1\nfloat32((1, 32))\n[[-0.05102209 -0.09125797 -0.05087801  0.13667786 ...&quot; fontsize=10];
  arg3_1 [shape=box label=&quot;arg3_1\nfloat32((1,))\n[0.17433323]&quot; fontsize=10];

  t [shape=box label=&quot;t&quot; fontsize=10];
  t [shape=box style=&quot;filled,rounded&quot; color=orange label=&quot;Transpose\nperm=[1, 0]&quot; fontsize=10];
  arg0_1 -&gt; t;
  t -&gt; t;

  addmm [shape=box label=&quot;addmm&quot; fontsize=10];
  addmm [shape=box style=&quot;filled,rounded&quot; color=orange label=&quot;Gemm\nalpha=1.0\nbeta=1.0&quot; fontsize=10];
  x -&gt; addmm;
  t -&gt; addmm;
  arg1_1 -&gt; addmm;
  addmm -&gt; addmm;

  relu [shape=box label=&quot;relu&quot; fontsize=10];
  Relu [shape=box style=&quot;filled,rounded&quot; color=orange label=&quot;Relu&quot; fontsize=10];
  addmm -&gt; Relu;
  Relu -&gt; relu;

  t_1 [shape=box label=&quot;t_1&quot; fontsize=10];
  t2 [shape=box style=&quot;filled,rounded&quot; color=orange label=&quot;Transpose\nperm=[1, 0]&quot; fontsize=10];
  arg2_1 -&gt; t2;
  t2 -&gt; t_1;

  addmm2 [shape=box style=&quot;filled,rounded&quot; color=orange label=&quot;Gemm\nalpha=1.0\nbeta=1.0&quot; fontsize=10];
  relu -&gt; addmm2;
  t_1 -&gt; addmm2;
  arg3_1 -&gt; addmm2;
  addmm2 -&gt; output_0;
}" class="graphviz" /></div>
<p>We then apply the optimizations by writing the following code:</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">onnx</span>
<span class="kn">from</span> <span class="nn">onnx_array_api.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">experimental_experiment.xbuilder</span> <span class="kn">import</span> <span class="n">GraphBuilder</span>

<span class="n">onx</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;temp_doc_mlp.onnx&quot;</span><span class="p">)</span>

<span class="c1"># The model is placed in a GraphBuilder.</span>
<span class="c1"># It creates dictionnaires to store shapes, ranks, types</span>
<span class="c1"># to make it easier to the optimizers to find the information</span>
<span class="c1"># they need. It still uses NodeProto to store nodes</span>
<span class="n">gr</span> <span class="o">=</span> <span class="n">GraphBuilder</span><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="n">infer_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Let&#39;s optimize.</span>
<span class="n">opt_onx</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;temp_doc_mlp_opt.onnx&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">opt_onx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">opt_onx</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">18</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;x&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;arg0_1&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;arg1_1&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">32</span><span class="p">,)</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;arg2_1&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;arg3_1&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mf">0.17433323</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">Gemm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">arg0_1</span><span class="p">,</span> <span class="n">arg1_1</span><span class="p">,</span> <span class="n">transA</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">transB</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.00</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">1.00</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">addmm</span>
      <span class="n">Relu</span><span class="p">(</span><span class="n">addmm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">relu</span>
        <span class="n">Gemm</span><span class="p">(</span><span class="n">relu</span><span class="p">,</span> <span class="n">arg2_1</span><span class="p">,</span> <span class="n">arg3_1</span><span class="p">,</span> <span class="n">transA</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">transB</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.00</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">1.00</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">output_0</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;output_0&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<p>Which renders as follows:</p>
<div class="graphviz"><img src="../_images/graphviz-d6f391763eaf130ceab5311f073538fff3ca0bc9.png" alt="digraph{
  orientation=portrait;
  nodesep=0.05;
  size=7;
  ranksep=0.25;

  x [shape=box color=red label=&quot;x\nTensorProto.FLOAT\nshape=[3, 10]&quot; fontsize=10];

  output_0 [shape=box color=green label=&quot;output_0\nTensorProto.FLOAT\nshape=[3, 1]&quot; fontsize=10];

  arg0_1 [shape=box label=&quot;arg0_1\nfloat32((32, 10))\n[[ 0.28628516 -0.30411345  0.10380709  0.23441277 ...&quot; fontsize=10];
  arg1_1 [shape=box label=&quot;arg1_1\nfloat32((32,))\n[ 0.14889693  0.10432336  0.19803037 -0.2808711   ...&quot; fontsize=10];
  arg2_1 [shape=box label=&quot;arg2_1\nfloat32((1, 32))\n[[-0.05102209 -0.09125797 -0.05087801  0.13667786 ...&quot; fontsize=10];
  arg3_1 [shape=box label=&quot;arg3_1\nfloat32((1,))\n[0.17433323]&quot; fontsize=10];

  addmm [shape=box label=&quot;addmm&quot; fontsize=10];
  TransposeMatMulPattern__addmm [shape=box style=&quot;filled,rounded&quot; color=orange label=&quot;Gemm\nalpha=1.0\nbeta=1.0\ntransA=0\ntransB=1&quot; fontsize=10];
  x -&gt; TransposeMatMulPattern__addmm;
  arg0_1 -&gt; TransposeMatMulPattern__addmm;
  arg1_1 -&gt; TransposeMatMulPattern__addmm;
  TransposeMatMulPattern__addmm -&gt; addmm;

  relu [shape=box label=&quot;relu&quot; fontsize=10];
  Relu [shape=box style=&quot;filled,rounded&quot; color=orange label=&quot;Relu&quot; fontsize=10];
  addmm -&gt; Relu;
  Relu -&gt; relu;

  TransposeMatMulPattern__addmm2 [shape=box style=&quot;filled,rounded&quot; color=orange label=&quot;Gemm\nalpha=1.0\nbeta=1.0\ntransA=0\ntransB=1&quot; fontsize=10];
  relu -&gt; TransposeMatMulPattern__addmm2;
  arg2_1 -&gt; TransposeMatMulPattern__addmm2;
  arg3_1 -&gt; TransposeMatMulPattern__addmm2;
  TransposeMatMulPattern__addmm2 -&gt; output_0;
}" class="graphviz" /></div>
</section>
<section id="verbosity">
<h3>Verbosity<a class="headerlink" href="#verbosity" title="Link to this heading">#</a></h3>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">onnx</span>
<span class="kn">from</span> <span class="nn">onnx_array_api.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">experimental_experiment.xbuilder</span> <span class="kn">import</span> <span class="n">GraphBuilder</span>

<span class="n">onx</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;temp_doc_mlp.onnx&quot;</span><span class="p">)</span>

<span class="n">gr</span> <span class="o">=</span> <span class="n">GraphBuilder</span><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="n">infer_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">opt_onx</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">start</span> <span class="k">with</span> <span class="mi">5</span> <span class="n">nodes</span> <span class="ow">and</span> <span class="mi">16</span> <span class="n">patterns</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">1</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">CastPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">2</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">ExpandPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">3</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">ExpandBroadcastPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">4</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">ExpandSwapPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">5</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">MulMulMulScalarPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">6</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">ReduceReshapePattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">7</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">ReshapeMatMulReshapePattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">8</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">Reshape2Of3Pattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">9</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">MatMulReshape2Of3Pattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">10</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">ReshapeReshapePattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">11</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">RotaryConcatPartPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">12</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">Sub1MulPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">13</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">TransposeMatMulPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">14</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">TransposeReshapeMatMulPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">15</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">TransposeTransposePattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">16</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">UnsqueezeUnsqueezePattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">iteration</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">5</span> <span class="n">nodes</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">applies</span> <span class="mi">1</span> <span class="n">matches</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">MatchResult</span><span class="p">:</span> <span class="n">TransposeMatMulPattern</span> <span class="n">replaces</span> <span class="p">[</span><span class="s1">&#39;Transpose&#39;</span><span class="p">,</span> <span class="s1">&#39;Gemm&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.000</span> <span class="o">|</span> <span class="n">max_time</span><span class="o">=</span><span class="n">TransposeMatMulPattern</span><span class="p">:</span><span class="mf">0.000</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">iteration</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">4</span> <span class="n">nodes</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">applies</span> <span class="mi">1</span> <span class="n">matches</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">MatchResult</span><span class="p">:</span> <span class="n">TransposeMatMulPattern</span> <span class="n">replaces</span> <span class="p">[</span><span class="s1">&#39;Transpose&#39;</span><span class="p">,</span> <span class="s1">&#39;Gemm&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.000</span> <span class="o">|</span> <span class="n">max_time</span><span class="o">=</span><span class="n">TransposeMatMulPattern</span><span class="p">:</span><span class="mf">0.000</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">iteration</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">3</span> <span class="n">nodes</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">done</span> <span class="n">after</span> <span class="mi">3</span> <span class="n">iterations</span> <span class="k">with</span> <span class="mi">3</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="mf">0.001</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">RYE</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">]</span> <span class="n">onh</span><span class="o">.</span><span class="n">make_graph</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">RYE</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">]</span> <span class="n">onh</span><span class="o">.</span><span class="n">make_model</span>
</pre></div>
</div>
<p>With more verbosity:</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">onnx</span>
<span class="kn">from</span> <span class="nn">onnx_array_api.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">experimental_experiment.xbuilder</span> <span class="kn">import</span> <span class="n">GraphBuilder</span>

<span class="n">onx</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;temp_doc_mlp.onnx&quot;</span><span class="p">)</span>

<span class="n">gr</span> <span class="o">=</span> <span class="n">GraphBuilder</span><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="n">infer_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
<span class="n">opt_onx</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_shape</span><span class="p">]</span> <span class="n">arg0_1</span><span class="p">:(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_rank</span><span class="p">]</span> <span class="n">arg0_1</span><span class="p">:</span><span class="mi">2</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_type</span><span class="p">]</span> <span class="n">arg0_1</span><span class="p">:</span><span class="mi">1</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_shape</span><span class="p">]</span> <span class="n">arg1_1</span><span class="p">:(</span><span class="mi">32</span><span class="p">,)</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_rank</span><span class="p">]</span> <span class="n">arg1_1</span><span class="p">:</span><span class="mi">1</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_type</span><span class="p">]</span> <span class="n">arg1_1</span><span class="p">:</span><span class="mi">1</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_shape</span><span class="p">]</span> <span class="n">arg2_1</span><span class="p">:(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_rank</span><span class="p">]</span> <span class="n">arg2_1</span><span class="p">:</span><span class="mi">2</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_type</span><span class="p">]</span> <span class="n">arg2_1</span><span class="p">:</span><span class="mi">1</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_shape</span><span class="p">]</span> <span class="n">arg3_1</span><span class="p">:(</span><span class="mi">1</span><span class="p">,)</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_rank</span><span class="p">]</span> <span class="n">arg3_1</span><span class="p">:</span><span class="mi">1</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_type</span><span class="p">]</span> <span class="n">arg3_1</span><span class="p">:</span><span class="mi">1</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_type</span><span class="p">]</span> <span class="n">x</span><span class="p">:</span><span class="mi">1</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_shape</span><span class="p">]</span> <span class="n">x</span><span class="p">:(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_rank</span><span class="p">]</span> <span class="n">x</span><span class="p">:</span><span class="mi">2</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_type</span><span class="p">]</span> <span class="n">output_0</span><span class="p">:</span><span class="mi">1</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_shape</span><span class="p">]</span> <span class="n">output_0</span><span class="p">:(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_rank</span><span class="p">]</span> <span class="n">output_0</span><span class="p">:</span><span class="mi">2</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_type</span><span class="p">]</span> <span class="n">t</span><span class="p">:</span><span class="mi">1</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_shape</span><span class="p">]</span> <span class="n">t</span><span class="p">:(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_rank</span><span class="p">]</span> <span class="n">t</span><span class="p">:</span><span class="mi">2</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_type</span><span class="p">]</span> <span class="n">addmm</span><span class="p">:</span><span class="mi">1</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_shape</span><span class="p">]</span> <span class="n">addmm</span><span class="p">:(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_rank</span><span class="p">]</span> <span class="n">addmm</span><span class="p">:</span><span class="mi">2</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_type</span><span class="p">]</span> <span class="n">relu</span><span class="p">:</span><span class="mi">1</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_shape</span><span class="p">]</span> <span class="n">relu</span><span class="p">:(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_rank</span><span class="p">]</span> <span class="n">relu</span><span class="p">:</span><span class="mi">2</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_type</span><span class="p">]</span> <span class="n">t_1</span><span class="p">:</span><span class="mi">1</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_shape</span><span class="p">]</span> <span class="n">t_1</span><span class="p">:(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_rank</span><span class="p">]</span> <span class="n">t_1</span><span class="p">:</span><span class="mi">2</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">start</span> <span class="k">with</span> <span class="mi">5</span> <span class="n">nodes</span> <span class="ow">and</span> <span class="mi">16</span> <span class="n">patterns</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">1</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">CastPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">2</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">ExpandPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">3</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">ExpandBroadcastPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">4</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">ExpandSwapPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">5</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">MulMulMulScalarPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">6</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">ReduceReshapePattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">7</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">ReshapeMatMulReshapePattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">8</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">Reshape2Of3Pattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">9</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">MatMulReshape2Of3Pattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">10</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">ReshapeReshapePattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">11</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">RotaryConcatPartPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">12</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">Sub1MulPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">13</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">TransposeMatMulPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">14</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">TransposeReshapeMatMulPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">15</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">TransposeTransposePattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">16</span><span class="o">/</span><span class="mi">16</span> <span class="o">-</span> <span class="n">UnsqueezeUnsqueezePattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">iteration</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">5</span> <span class="n">nodes</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">match</span><span class="o">=</span><span class="n">MatchResult</span><span class="p">:</span> <span class="n">TransposeMatMulPattern</span> <span class="n">replaces</span> <span class="p">[</span><span class="s1">&#39;Transpose&#39;</span><span class="p">,</span> <span class="s1">&#39;Gemm&#39;</span><span class="p">]</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">applies</span> <span class="mi">1</span> <span class="n">matches</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">MatchResult</span><span class="p">:</span> <span class="n">TransposeMatMulPattern</span> <span class="n">replaces</span> <span class="p">[</span><span class="s1">&#39;Transpose&#39;</span><span class="p">,</span> <span class="s1">&#39;Gemm&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.000</span> <span class="o">|</span> <span class="n">max_time</span><span class="o">=</span><span class="n">TransposeMatMulPattern</span><span class="p">:</span><span class="mf">0.000</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">apply</span> <span class="n">MatchResult</span><span class="p">:</span> <span class="n">TransposeMatMulPattern</span> <span class="n">replaces</span> <span class="p">[</span><span class="s1">&#39;Transpose&#39;</span><span class="p">,</span> <span class="s1">&#39;Gemm&#39;</span><span class="p">],</span> <span class="n">inputs</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;arg0_1&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;arg1_1&#39;</span><span class="p">},</span> <span class="n">outputs</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;addmm&#39;</span><span class="p">}</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_type</span><span class="p">]</span> <span class="n">addmm</span><span class="p">:</span><span class="mi">1</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">apply_match</span><span class="p">]</span> <span class="n">MatchResult</span><span class="p">:</span> <span class="n">TransposeMatMulPattern</span> <span class="n">replaces</span> <span class="p">[</span><span class="s1">&#39;Transpose&#39;</span><span class="p">,</span> <span class="s1">&#39;Gemm&#39;</span><span class="p">]</span>
      <span class="o">-</span> <span class="n">Transpose</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;arg0_1&#39;</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
      <span class="o">-</span> <span class="n">Gemm</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;arg1_1&#39;</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="s1">&#39;addmm&#39;</span><span class="p">]</span>
      <span class="o">+</span> <span class="n">Gemm</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;arg0_1&#39;</span><span class="p">,</span> <span class="s1">&#39;arg1_1&#39;</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="s1">&#39;addmm&#39;</span><span class="p">]</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="o">-</span> <span class="n">add</span> <span class="p">[</span><span class="s1">&#39;Gemm&#39;</span><span class="p">]</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">done</span> <span class="n">MatchResult</span><span class="p">:</span> <span class="n">TransposeMatMulPattern</span> <span class="n">replaces</span> <span class="p">[</span><span class="s1">&#39;Transpose&#39;</span><span class="p">,</span> <span class="s1">&#39;Gemm&#39;</span><span class="p">]:</span> <span class="o">-</span><span class="mi">2</span> <span class="o">+</span><span class="mi">1</span> <span class="n">nodes</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">removed</span> <span class="n">outputs</span> <span class="p">{</span><span class="s1">&#39;t&#39;</span><span class="p">}</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">done</span> <span class="nb">all</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span> <span class="o">+</span><span class="mi">1</span> <span class="n">nodes</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">iteration</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">4</span> <span class="n">nodes</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">match</span><span class="o">=</span><span class="n">MatchResult</span><span class="p">:</span> <span class="n">TransposeMatMulPattern</span> <span class="n">replaces</span> <span class="p">[</span><span class="s1">&#39;Transpose&#39;</span><span class="p">,</span> <span class="s1">&#39;Gemm&#39;</span><span class="p">]</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">applies</span> <span class="mi">1</span> <span class="n">matches</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">MatchResult</span><span class="p">:</span> <span class="n">TransposeMatMulPattern</span> <span class="n">replaces</span> <span class="p">[</span><span class="s1">&#39;Transpose&#39;</span><span class="p">,</span> <span class="s1">&#39;Gemm&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.000</span> <span class="o">|</span> <span class="n">max_time</span><span class="o">=</span><span class="n">TransposeMatMulPattern</span><span class="p">:</span><span class="mf">0.000</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">apply</span> <span class="n">MatchResult</span><span class="p">:</span> <span class="n">TransposeMatMulPattern</span> <span class="n">replaces</span> <span class="p">[</span><span class="s1">&#39;Transpose&#39;</span><span class="p">,</span> <span class="s1">&#39;Gemm&#39;</span><span class="p">],</span> <span class="n">inputs</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;arg2_1&#39;</span><span class="p">,</span> <span class="s1">&#39;t_1&#39;</span><span class="p">,</span> <span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="s1">&#39;arg3_1&#39;</span><span class="p">},</span> <span class="n">outputs</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;output_0&#39;</span><span class="p">,</span> <span class="s1">&#39;t_1&#39;</span><span class="p">}</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">set_type</span><span class="p">]</span> <span class="n">output_0</span><span class="p">:</span><span class="mi">1</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">apply_match</span><span class="p">]</span> <span class="n">MatchResult</span><span class="p">:</span> <span class="n">TransposeMatMulPattern</span> <span class="n">replaces</span> <span class="p">[</span><span class="s1">&#39;Transpose&#39;</span><span class="p">,</span> <span class="s1">&#39;Gemm&#39;</span><span class="p">]</span>
      <span class="o">-</span> <span class="n">Transpose</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;arg2_1&#39;</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="s1">&#39;t_1&#39;</span><span class="p">]</span>
      <span class="o">-</span> <span class="n">Gemm</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="s1">&#39;t_1&#39;</span><span class="p">,</span> <span class="s1">&#39;arg3_1&#39;</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="s1">&#39;output_0&#39;</span><span class="p">]</span>
      <span class="o">+</span> <span class="n">Gemm</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="s1">&#39;arg2_1&#39;</span><span class="p">,</span> <span class="s1">&#39;arg3_1&#39;</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="s1">&#39;output_0&#39;</span><span class="p">]</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="o">-</span> <span class="n">add</span> <span class="p">[</span><span class="s1">&#39;Gemm&#39;</span><span class="p">]</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">done</span> <span class="n">MatchResult</span><span class="p">:</span> <span class="n">TransposeMatMulPattern</span> <span class="n">replaces</span> <span class="p">[</span><span class="s1">&#39;Transpose&#39;</span><span class="p">,</span> <span class="s1">&#39;Gemm&#39;</span><span class="p">]:</span> <span class="o">-</span><span class="mi">2</span> <span class="o">+</span><span class="mi">1</span> <span class="n">nodes</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">removed</span> <span class="n">outputs</span> <span class="p">{</span><span class="s1">&#39;t_1&#39;</span><span class="p">}</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">done</span> <span class="nb">all</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span> <span class="o">+</span><span class="mi">1</span> <span class="n">nodes</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">iteration</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">3</span> <span class="n">nodes</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">done</span> <span class="nb">all</span><span class="p">:</span> <span class="o">-</span><span class="mi">0</span> <span class="o">+</span><span class="mi">0</span> <span class="n">nodes</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">done</span> <span class="n">after</span> <span class="mi">3</span> <span class="n">iterations</span> <span class="k">with</span> <span class="mi">3</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="mf">0.001</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">]</span> <span class="n">onh</span><span class="o">.</span><span class="n">make_graph</span>
    <span class="p">[</span><span class="n">GraphBuilder</span><span class="o">-</span><span class="n">KQQ</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">]</span> <span class="n">onh</span><span class="o">.</span><span class="n">make_model</span>
</pre></div>
</div>
</section>
<section id="select-the-pattern-to-use">
<h3>Select the pattern to use<a class="headerlink" href="#select-the-pattern-to-use" title="Link to this heading">#</a></h3>
<p>Class <a class="reference internal" href="../api/graph_builder.html#experimental_experiment.xbuilder.OptimizationOptions" title="experimental_experiment.xbuilder.OptimizationOptions"><code class="xref py py-class docutils literal notranslate"><span class="pre">OptimizationOptions</span></code></a>
is used to enable or disable patterns.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">onnx</span>
<span class="kn">from</span> <span class="nn">onnx_array_api.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">experimental_experiment.xbuilder</span> <span class="kn">import</span> <span class="n">GraphBuilder</span><span class="p">,</span> <span class="n">OptimizationOptions</span>

<span class="n">onx</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;temp_doc_mlp.onnx&quot;</span><span class="p">)</span>

<span class="n">gr</span> <span class="o">=</span> <span class="n">GraphBuilder</span><span class="p">(</span>
    <span class="n">onx</span><span class="p">,</span>
    <span class="n">infer_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">optimization_options</span><span class="o">=</span><span class="n">OptimizationOptions</span><span class="p">(</span>
        <span class="n">patterns</span><span class="o">=</span><span class="s2">&quot;TransposeTranspose,TransposeMatMul&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="n">opt_onx</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">start</span> <span class="k">with</span> <span class="mi">5</span> <span class="n">nodes</span> <span class="ow">and</span> <span class="mi">2</span> <span class="n">patterns</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">TransposeTransposePattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">2</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">TransposeMatMulPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">iteration</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">5</span> <span class="n">nodes</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">applies</span> <span class="mi">1</span> <span class="n">matches</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">MatchResult</span><span class="p">:</span> <span class="n">TransposeMatMulPattern</span> <span class="n">replaces</span> <span class="p">[</span><span class="s1">&#39;Transpose&#39;</span><span class="p">,</span> <span class="s1">&#39;Gemm&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.000</span> <span class="o">|</span> <span class="n">max_time</span><span class="o">=</span><span class="n">TransposeMatMulPattern</span><span class="p">:</span><span class="mf">0.000</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">iteration</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">4</span> <span class="n">nodes</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">applies</span> <span class="mi">1</span> <span class="n">matches</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">MatchResult</span><span class="p">:</span> <span class="n">TransposeMatMulPattern</span> <span class="n">replaces</span> <span class="p">[</span><span class="s1">&#39;Transpose&#39;</span><span class="p">,</span> <span class="s1">&#39;Gemm&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.000</span> <span class="o">|</span> <span class="n">max_time</span><span class="o">=</span><span class="n">TransposeMatMulPattern</span><span class="p">:</span><span class="mf">0.000</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">iteration</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">3</span> <span class="n">nodes</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">done</span> <span class="n">after</span> <span class="mi">3</span> <span class="n">iterations</span> <span class="k">with</span> <span class="mi">3</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="mf">0.000</span>
</pre></div>
</div>
<p>There exists some predefined lists of patterns:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">default</span></code>: includes all patterns using only standard onnx patterns.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">onnxruntime</span></code>: patterns specific to <a class="reference external" href="https://onnxruntime.ai/">onnxruntime</a>, the final model
may be executed by onnxruntime and possibly only onnxruntime as it may
introduce patterns from <a class="reference external" href="https://github.com/microsoft/onnxruntime/blob/main/docs/OperatorKernels.md">Supported Operators and Data Types</a>
&lt;<a class="reference external" href="https://github.com/microsoft/onnxruntime/blob/main/docs/OperatorKernels.md">https://github.com/microsoft/onnxruntime/blob/main/docs/OperatorKernels.md</a>&gt;`_</p></li>
</ul>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">onnx</span>
<span class="kn">from</span> <span class="nn">onnx_array_api.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">experimental_experiment.xbuilder</span> <span class="kn">import</span> <span class="n">GraphBuilder</span><span class="p">,</span> <span class="n">OptimizationOptions</span>

<span class="n">onx</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;temp_doc_mlp.onnx&quot;</span><span class="p">)</span>

<span class="n">gr</span> <span class="o">=</span> <span class="n">GraphBuilder</span><span class="p">(</span>
    <span class="n">onx</span><span class="p">,</span>
    <span class="n">infer_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">optimization_options</span><span class="o">=</span><span class="n">OptimizationOptions</span><span class="p">(</span><span class="n">patterns</span><span class="o">=</span><span class="s2">&quot;default+onnxruntime&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">opt_onx</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">start</span> <span class="k">with</span> <span class="mi">5</span> <span class="n">nodes</span> <span class="ow">and</span> <span class="mi">18</span> <span class="n">patterns</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">1</span><span class="o">/</span><span class="mi">18</span> <span class="o">-</span> <span class="n">CastPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">2</span><span class="o">/</span><span class="mi">18</span> <span class="o">-</span> <span class="n">ExpandPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">3</span><span class="o">/</span><span class="mi">18</span> <span class="o">-</span> <span class="n">ExpandBroadcastPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">4</span><span class="o">/</span><span class="mi">18</span> <span class="o">-</span> <span class="n">ExpandSwapPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">5</span><span class="o">/</span><span class="mi">18</span> <span class="o">-</span> <span class="n">MulMulMulScalarPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">6</span><span class="o">/</span><span class="mi">18</span> <span class="o">-</span> <span class="n">ReduceReshapePattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">7</span><span class="o">/</span><span class="mi">18</span> <span class="o">-</span> <span class="n">ReshapeMatMulReshapePattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">8</span><span class="o">/</span><span class="mi">18</span> <span class="o">-</span> <span class="n">Reshape2Of3Pattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">9</span><span class="o">/</span><span class="mi">18</span> <span class="o">-</span> <span class="n">MatMulReshape2Of3Pattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">10</span><span class="o">/</span><span class="mi">18</span> <span class="o">-</span> <span class="n">ReshapeReshapePattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">11</span><span class="o">/</span><span class="mi">18</span> <span class="o">-</span> <span class="n">RotaryConcatPartPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">12</span><span class="o">/</span><span class="mi">18</span> <span class="o">-</span> <span class="n">Sub1MulPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">13</span><span class="o">/</span><span class="mi">18</span> <span class="o">-</span> <span class="n">TransposeMatMulPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">14</span><span class="o">/</span><span class="mi">18</span> <span class="o">-</span> <span class="n">TransposeReshapeMatMulPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">15</span><span class="o">/</span><span class="mi">18</span> <span class="o">-</span> <span class="n">TransposeTransposePattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">16</span><span class="o">/</span><span class="mi">18</span> <span class="o">-</span> <span class="n">UnsqueezeUnsqueezePattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">17</span><span class="o">/</span><span class="mi">18</span> <span class="o">-</span> <span class="n">ConstantOfShapeScatterNDPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">use</span> <span class="n">pattern</span> <span class="mi">18</span><span class="o">/</span><span class="mi">18</span> <span class="o">-</span> <span class="n">FusedMatMulPattern</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">iteration</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">5</span> <span class="n">nodes</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">applies</span> <span class="mi">1</span> <span class="n">matches</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">MatchResult</span><span class="p">:</span> <span class="n">TransposeMatMulPattern</span> <span class="n">replaces</span> <span class="p">[</span><span class="s1">&#39;Transpose&#39;</span><span class="p">,</span> <span class="s1">&#39;Gemm&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.000</span> <span class="o">|</span> <span class="n">max_time</span><span class="o">=</span><span class="n">TransposeMatMulPattern</span><span class="p">:</span><span class="mf">0.000</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">iteration</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">4</span> <span class="n">nodes</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">applies</span> <span class="mi">1</span> <span class="n">matches</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">MatchResult</span><span class="p">:</span> <span class="n">TransposeMatMulPattern</span> <span class="n">replaces</span> <span class="p">[</span><span class="s1">&#39;Transpose&#39;</span><span class="p">,</span> <span class="s1">&#39;Gemm&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.000</span> <span class="o">|</span> <span class="n">max_time</span><span class="o">=</span><span class="n">TransposeMatMulPattern</span><span class="p">:</span><span class="mf">0.000</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">iteration</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">3</span> <span class="n">nodes</span>
    <span class="p">[</span><span class="n">GraphBuilderPatternOptimization</span><span class="o">.</span><span class="n">optimize</span><span class="p">]</span> <span class="n">done</span> <span class="n">after</span> <span class="mi">3</span> <span class="n">iterations</span> <span class="k">with</span> <span class="mi">3</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="mf">0.001</span>
</pre></div>
</div>
</section>
<section id="statistics">
<h3>Statistics<a class="headerlink" href="#statistics" title="Link to this heading">#</a></h3>
<p>This can be used to see when a pattern is applied and how long it takes.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">onnx</span>
<span class="kn">from</span> <span class="nn">onnx_array_api.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">experimental_experiment.xbuilder</span> <span class="kn">import</span> <span class="n">GraphBuilder</span><span class="p">,</span> <span class="n">OptimizationOptions</span>

<span class="n">onx</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;temp_doc_mlp.onnx&quot;</span><span class="p">)</span>

<span class="n">gr</span> <span class="o">=</span> <span class="n">GraphBuilder</span><span class="p">(</span>
    <span class="n">onx</span><span class="p">,</span>
    <span class="n">infer_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">optimization_options</span><span class="o">=</span><span class="n">OptimizationOptions</span><span class="p">(</span><span class="n">patterns</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">stat</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">stat</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                      <span class="n">pattern</span>  <span class="n">added</span>  <span class="n">removed</span>  <span class="n">iteration</span>  <span class="n">match_index</span>   <span class="n">time_in</span>
    <span class="mi">0</span>  <span class="n">TransposeMatMulPattern</span>      <span class="mi">1</span>        <span class="mi">2</span>          <span class="mi">0</span>            <span class="mi">0</span>  <span class="mf">0.000030</span>
    <span class="mi">1</span>  <span class="n">TransposeMatMulPattern</span>      <span class="mi">1</span>        <span class="mi">2</span>          <span class="mi">1</span>            <span class="mi">0</span>  <span class="mf">0.000023</span>
</pre></div>
</div>
</section>
</section>
<section id="shape-inference">
<h2>Shape inference<a class="headerlink" href="#shape-inference" title="Link to this heading">#</a></h2>
<p>The optimizers require to know the shape to ensure they can rewrite
some nodes and avoid producing a model which does not return the
same results. If it is missing, some patterns cannot match for sure.
They wonâ€™t match.</p>
<p>This information can be built by running shape inference
on the onnx models. Thatâ€™s what is done is the previous examples.
However, the best case is when this information comes from torch.</p>
<p>Function <a class="reference internal" href="../api/onnx_export.html#experimental_experiment.torch_interpreter.to_onnx" title="experimental_experiment.torch_interpreter.to_onnx"><code class="xref py py-func docutils literal notranslate"><span class="pre">to_onnx</span></code></a>
converts a torch model into ONNX. While doing so, it stores the shape
information coming from torch. There is no need to run shape inference
on the onnx model it generates before optimizing it.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../api/index.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">API</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="index.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Design</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023-2024
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Pattern Optimizer</a><ul>
<li><a class="reference internal" href="#patterns">Patterns</a><ul>
<li><a class="reference internal" href="#patternoptimization-match">PatternOptimization.match</a></li>
<li><a class="reference internal" href="#patternoptimization-apply">PatternOptimization.apply</a></li>
</ul>
</li>
<li><a class="reference internal" href="#optimization-algorithm">Optimization Algorithm</a></li>
<li><a class="reference internal" href="#adding-a-pattern">Adding a pattern</a></li>
<li><a class="reference internal" href="#example">Example</a><ul>
<li><a class="reference internal" href="#simple-api">Simple API</a></li>
<li><a class="reference internal" href="#verbosity">Verbosity</a></li>
<li><a class="reference internal" href="#select-the-pattern-to-use">Select the pattern to use</a></li>
<li><a class="reference internal" href="#statistics">Statistics</a></li>
</ul>
</li>
<li><a class="reference internal" href="#shape-inference">Shape inference</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=a1637f0b"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=32e29ea5"></script>
    </body>
</html>

.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "auto_recipes/plot_exporter_recipes_oe_named_ds_auto.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_auto_recipes_plot_exporter_recipes_oe_named_ds_auto.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_recipes_plot_exporter_recipes_oe_named_ds_auto.py:


.. _l-plot-exporter-recipes-onnx-exporter-modules:

torch.onnx.export: Rename Dynamic Shapes
========================================

Example given in :ref:`l-plot-exporter-dynamic_shapes` can only be exported
with dynamic shapes using ``torch.export.Dim.AUTO``. As a result, the exported
onnx models have dynamic dimensions with unpredictable names.


Model with unpredictable names for dynamic shapes
+++++++++++++++++++++++++++++++++++++++++++++++++

.. GENERATED FROM PYTHON SOURCE LINES 15-31

.. code-block:: Python


    import torch
    from experimental_experiment.helpers import pretty_onnx


    class Model(torch.nn.Module):
        def forward(self, x, y, z):
            return torch.cat((x, y), axis=1) + z


    model = Model()
    x = torch.randn(2, 3)
    y = torch.randn(2, 4)
    z = torch.randn(2, 7)
    model(x, y, z)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none


    tensor([[-1.6513,  1.1737, -1.2368, -1.3783,  0.1198, -0.1255, -0.7514],
            [-0.0431,  2.0627,  0.5756,  0.2171, -3.1869, -0.2709,  1.3927]])



.. GENERATED FROM PYTHON SOURCE LINES 32-33

Let's export it.

.. GENERATED FROM PYTHON SOURCE LINES 33-45

.. code-block:: Python


    batch = torch.export.Dim("batch")
    ep = torch.export.export(
        model,
        (x, y, z),
        dynamic_shapes=(
            {0: batch, 1: torch.export.Dim.AUTO},
            {0: batch, 1: torch.export.Dim.AUTO},
            {0: batch, 1: torch.export.Dim.AUTO},
        ),
    )








.. GENERATED FROM PYTHON SOURCE LINES 46-47

Let's convert it into ONNX.

.. GENERATED FROM PYTHON SOURCE LINES 47-55

.. code-block:: Python


    onx = torch.onnx.export(ep).model_proto

    for inp in onx.graph.input:
        print(f" input: {pretty_onnx(inp)}")
    for out in onx.graph.output:
        print(f"output: {pretty_onnx(out)}")





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    [torch.onnx] Run decomposition...
    [torch.onnx] Run decomposition... ✅
    [torch.onnx] Translate the graph into ONNX...
    [torch.onnx] Translate the graph into ONNX... ✅
     input: EXTERNAL[s0,s1] x
     input: EXTERNAL[s0,s3] y
     input: EXTERNAL[s0,s1 + s3] z
    output: EXTERNAL[s0,s1 + s3] add_3




.. GENERATED FROM PYTHON SOURCE LINES 56-62

Rename the dynamic shapes
+++++++++++++++++++++++++

We just need to give the onnx exporter the same information
:func:`torch.export.export` was given but we replace ``AUTO``
by the name this dimension should have.

.. GENERATED FROM PYTHON SOURCE LINES 62-77

.. code-block:: Python


    onx = torch.onnx.export(
        ep,
        dynamic_shapes=(
            {0: batch, 1: "dx"},
            {0: batch, 1: "dy"},
            {0: batch, 1: "dx+dy"},
        ),
    ).model_proto

    for inp in onx.graph.input:
        print(f" input: {pretty_onnx(inp)}")
    for out in onx.graph.output:
        print(f"output: {pretty_onnx(out)}")





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    [torch.onnx] Run decomposition...
    [torch.onnx] Run decomposition... ✅
    [torch.onnx] Translate the graph into ONNX...
    [torch.onnx] Translate the graph into ONNX... ✅
     input: EXTERNAL[s0,s1] x
     input: EXTERNAL[s0,s3] y
     input: EXTERNAL[s0,s1 + s3] z
    output: EXTERNAL[s0,s1 + s3] add_3




.. GENERATED FROM PYTHON SOURCE LINES 78-80

A model with an unknown output shape
++++++++++++++++++++++++++++++++++++

.. GENERATED FROM PYTHON SOURCE LINES 80-91

.. code-block:: Python



    class UnknownOutputModel(torch.nn.Module):
        def forward(self, x):
            return torch.nonzero(x)


    model = UnknownOutputModel()
    x = torch.randint(0, 2, (10, 2))
    model(x)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none


    tensor([[0, 0],
            [0, 1],
            [1, 0],
            [1, 1],
            [2, 0],
            [2, 1],
            [4, 1],
            [5, 0],
            [5, 1],
            [6, 0],
            [6, 1],
            [7, 0],
            [7, 1],
            [8, 0],
            [9, 1]])



.. GENERATED FROM PYTHON SOURCE LINES 92-93

Let's export it.

.. GENERATED FROM PYTHON SOURCE LINES 93-97

.. code-block:: Python


    ep = torch.export.export(model, (x,), dynamic_shapes=({0: batch, 1: torch.export.Dim.AUTO},))
    print(ep)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    ExportedProgram:
        class GraphModule(torch.nn.Module):
            def forward(self, x: "i64[s0, s1]"):
                 # File: /home/xadupre/github/experimental-experiment/_doc/recipes/plot_exporter_recipes_oe_named_ds_auto.py:84 in forward, code: return torch.nonzero(x)
                nonzero: "i64[u0, 2]" = torch.ops.aten.nonzero.default(x);  x = None
            
                 # 
                sym_size_int_3: "Sym(u0)" = torch.ops.aten.sym_size.int(nonzero, 0)
                sym_constrain_range_for_size_default = torch.ops.aten.sym_constrain_range_for_size.default(sym_size_int_3);  sym_constrain_range_for_size_default = None
            
                 # File: /home/xadupre/github/experimental-experiment/_doc/recipes/plot_exporter_recipes_oe_named_ds_auto.py:84 in forward, code: return torch.nonzero(x)
                ge_1: "Sym(u0 >= 0)" = sym_size_int_3 >= 0;  sym_size_int_3 = None
                _assert_scalar_default = torch.ops.aten._assert_scalar.default(ge_1, "Runtime assertion failed for expression u0 >= 0 on node 'ge_1'");  ge_1 = _assert_scalar_default = None
                return (nonzero,)
            
    Graph signature: ExportGraphSignature(input_specs=[InputSpec(kind=<InputKind.USER_INPUT: 1>, arg=TensorArgument(name='x'), target=None, persistent=None)], output_specs=[OutputSpec(kind=<OutputKind.USER_OUTPUT: 1>, arg=TensorArgument(name='nonzero'), target=None)])
    Range constraints: {u0: VR[0, 9223372036854775806], u1: VR[0, 9223372036854775806], s0: VR[0, int_oo], s1: VR[2, int_oo]}





.. GENERATED FROM PYTHON SOURCE LINES 98-99

Let's export it into ONNX.

.. GENERATED FROM PYTHON SOURCE LINES 99-107

.. code-block:: Python


    onx = torch.onnx.export(ep, dynamic_shapes=({0: batch, 1: "dx"},)).model_proto

    for inp in onx.graph.input:
        print(f" input: {pretty_onnx(inp)}")
    for out in onx.graph.output:
        print(f"output: {pretty_onnx(out)}")





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    [torch.onnx] Run decomposition...
    [torch.onnx] Run decomposition... ✅
    [torch.onnx] Translate the graph into ONNX...
    [torch.onnx] Translate the graph into ONNX... ✅
     input: INT64[s0,s1] x
    output: INT64[u0,2] nonzero




.. GENERATED FROM PYTHON SOURCE LINES 108-114

The exporter has detected a dimension could not be infered
from the input shape somewhere in the graph and introduced a
new dimension name.
Let's rename it as well. Let's also change the output name
because the functionality may not be implemented yet when
the output dynamic shapes are given as a tuple.

.. GENERATED FROM PYTHON SOURCE LINES 114-134

.. code-block:: Python


    try:
        onx = torch.onnx.export(
            ep,
            dynamic_shapes=({0: batch, 1: "dx"},),
            output_dynamic_shapes={"zeros": {0: "num_zeros"}},
            output_names=["zeros"],
        ).model_proto
        raise AssertionError(
            "able to rename output dynamic dimensions, please update the tutorial"
        )
    except torch.onnx._internal.exporter._errors.ConversionError as e:
        print(f"unable to rename output dynamic dimensions due to {e}")
        onx = None

    if onx is not None:
        for inp in onx.graph.input:
            print(f" input: {pretty_onnx(inp)}")
        for out in onx.graph.output:
            print(f"output: {pretty_onnx(out)}")




.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    [torch.onnx] Run decomposition...
    [torch.onnx] Run decomposition... ❌
    unable to rename output dynamic dimensions due to Failed to decompose the FX graph for ONNX compatibility. This is step 2/3 of exporting the model to ONNX. Next steps:
    - Create an issue in the PyTorch GitHub repository against the *torch.export* component and attach the full error stack as well as reproduction scripts.
    - Create an error report with `torch.onnx.export(..., report=True)`, and save the ExportedProgram as a pt2 file. Create an issue in the PyTorch GitHub repository against the *onnx* component. Attach the error report and the pt2 model.

    ## Exception summary

    <class 'torch.fx.experimental.symbolic_shapes.PendingUnbackedSymbolNotFound'>: Pending unbacked symbols {u4} not in returned outputs [FakeTensor(..., size=(s0, s1), dtype=torch.int64)] .
    Did you accidentally call new_dynamic_size() or item() more times than you needed to in your fake implementation?
    For more help, see https://docs.google.com/document/d/1RWrH-3wLEpzR9kCS6gGBNen_-Fs-8PVbWWFE5AcgeWE/edit

    (Refer to the full stack trace above for more information.)





.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 2.064 seconds)


.. _sphx_glr_download_auto_recipes_plot_exporter_recipes_oe_named_ds_auto.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: plot_exporter_recipes_oe_named_ds_auto.ipynb <plot_exporter_recipes_oe_named_ds_auto.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: plot_exporter_recipes_oe_named_ds_auto.py <plot_exporter_recipes_oe_named_ds_auto.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: plot_exporter_recipes_oe_named_ds_auto.zip <plot_exporter_recipes_oe_named_ds_auto.zip>`


.. include:: plot_exporter_recipes_oe_named_ds_auto.recommendations


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_

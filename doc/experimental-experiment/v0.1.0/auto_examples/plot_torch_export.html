<!doctype html>
<html class="no-js" lang="en" data-content_root="">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Change Logs" href="../CHANGELOGS.html" /><link rel="prev" title="Example gallery" href="index.html" />

    <!-- Generated with Sphinx 7.1.2 and Furo 2023.09.10 -->
        <title>Evaluate different ways to export a torch model to ONNX - experimental-experiment 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b76e3c8a" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css?v=7f9a90b1" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=61a4c737" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">experimental-experiment 0.1.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/logo.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">experimental-experiment 0.1.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../tutorial/index.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Example gallery</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Example gallery</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Evaluate different ways to export a torch model to ONNX</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">More</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../CHANGELOGS.html">Change Logs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">License</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-auto-examples-plot-torch-export-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="evaluate-different-ways-to-export-a-torch-model-to-onnx">
<span id="sphx-glr-auto-examples-plot-torch-export-py"></span><h1>Evaluate different ways to export a torch model to ONNX<a class="headerlink" href="#evaluate-different-ways-to-export-a-torch-model-to-onnx" title="Permalink to this heading">#</a></h1>
<p>The example evaluates the performance of onnxruntime of a simple
torch model after it was converted into ONNX through different processes:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://pytorch.org/docs/stable/onnx.html#torchscript-based-onnx-exporter">TorchScript-based ONNX Exporter</a>,
let’s call it <strong>script</strong></p></li>
<li><p><a class="reference external" href="https://pytorch.org/docs/stable/onnx.html#torchdynamo-based-onnx-exporter">TorchDynamo-based ONNX Exporter</a>,
let’s call it <strong>dynamo</strong></p></li>
<li><p>if available, the previous model but optimized, <strong>dynopt</strong></p></li>
<li><p>a custom exporter <strong>cus_p0</strong>, this exporter supports a very limited
set of models, as <strong>dynamo</strong>, it relies on
<a class="reference external" href="https://pytorch.org/docs/stable/fx.html">torch.fx</a> but the design is closer to
what tensorflow-onnx does.</p></li>
<li><p>the same exporter but unused nodes were removed and constants were folded, <strong>cus_p2</strong></p></li>
</ul>
<p>To run the script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">_doc</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">plot_torch_export</span> <span class="o">--</span><span class="n">help</span>
</pre></div>
</div>
<p>The script takes around 12 with a larger models.</p>
<section id="some-helpers">
<h2>Some helpers<a class="headerlink" href="#some-helpers" title="Permalink to this heading">#</a></h2>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">cProfile</span>
<span class="kn">import</span> <span class="nn">pstats</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">pstats</span> <span class="kn">import</span> <span class="n">SortKey</span>

<span class="k">try</span><span class="p">:</span>
    <span class="k">with</span> <a href="https://docs.python.org/3/library/warnings.html#warnings.catch_warnings" title="warnings.catch_warnings" class="sphx-glr-backref-module-warnings sphx-glr-backref-type-py-class"><span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span></a><span class="p">():</span>
        <a href="https://docs.python.org/3/library/warnings.html#warnings.simplefilter" title="warnings.simplefilter" class="sphx-glr-backref-module-warnings sphx-glr-backref-type-py-function"><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span></a><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">onnxruntime</span>

        <a href="https://docs.python.org/3/library/functions.html#bool" title="builtins.bool" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">has_cuda</span></a> <span class="o">=</span> <span class="s2">&quot;CUDAExecutionProvider&quot;</span> <span class="ow">in</span> <span class="n">onnxruntime</span><span class="o">.</span><span class="n">get_available_providers</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;onnxruntime not available.&quot;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">sys</span>

    <a href="https://docs.python.org/3/library/sys.html#sys.exit" title="sys.exit" class="sphx-glr-backref-module-sys sphx-glr-backref-type-py-function"><span class="n">sys</span><span class="o">.</span><span class="n">exit</span></a><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">onnx</span>
<span class="kn">from</span> <span class="nn">onnx_array_api.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">onnx_array_api.profiling</span> <span class="kn">import</span> <span class="n">profile2graph</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">import</span> <span class="nn">experimental_experiment</span>
<span class="kn">from</span> <span class="nn">experimental_experiment.torch_exp.onnx_export</span> <span class="kn">import</span> <span class="n">to_onnx</span>
<span class="kn">from</span> <span class="nn">experimental_experiment.plotting.memory</span> <span class="kn">import</span> <span class="n">memory_peak_plot</span>
<span class="kn">from</span> <span class="nn">experimental_experiment.ext_test_case</span> <span class="kn">import</span> <span class="n">get_parsed_args</span><span class="p">,</span> <span class="n">measure_time</span>
<span class="kn">from</span> <span class="nn">experimental_experiment.memory_peak</span> <span class="kn">import</span> <span class="n">start_spying_on</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<a href="https://docs.python.org/3/library/logging.html#logging.disable" title="logging.disable" class="sphx-glr-backref-module-logging sphx-glr-backref-type-py-function"><span class="n">logging</span><span class="o">.</span><span class="n">disable</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span></a><span class="p">)</span>


<span class="k">def</span> <span class="nf">system_info</span><span class="p">():</span>
    <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a> <span class="o">=</span> <span class="p">{}</span>
    <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">[</span><span class="s2">&quot;processor&quot;</span><span class="p">]</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/platform.html#platform.processor" title="platform.processor" class="sphx-glr-backref-module-platform sphx-glr-backref-type-py-function"><span class="n">platform</span><span class="o">.</span><span class="n">processor</span></a><span class="p">()</span>
    <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">[</span><span class="s2">&quot;cores&quot;</span><span class="p">]</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/multiprocessing.html#multiprocessing.cpu_count" title="multiprocessing.cpu_count" class="sphx-glr-backref-module-multiprocessing sphx-glr-backref-type-py-function"><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span></a><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">[</span><span class="s2">&quot;cuda&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <a href="https://pytorch.org/docs/stable/generated/torch.cuda.is_available.html#torch.cuda.is_available" title="torch.cuda.is_available" class="sphx-glr-backref-module-torch-cuda sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span></a><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span>
        <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">[</span><span class="s2">&quot;cuda_count&quot;</span><span class="p">]</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.cuda.device_count.html#torch.cuda.device_count" title="torch.cuda.device_count" class="sphx-glr-backref-module-torch-cuda sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span></a><span class="p">()</span>
        <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">[</span><span class="s2">&quot;cuda_name&quot;</span><span class="p">]</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.cuda.get_device_name.html#torch.cuda.get_device_name" title="torch.cuda.get_device_name" class="sphx-glr-backref-module-torch-cuda sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_name</span></a><span class="p">()</span>
        <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">[</span><span class="s2">&quot;cuda_capa&quot;</span><span class="p">]</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.cuda.get_device_capability.html#torch.cuda.get_device_capability" title="torch.cuda.get_device_capability" class="sphx-glr-backref-module-torch-cuda sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_capability</span></a><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">):</span>
        <span class="c1"># no cuda</span>
        <span class="k">pass</span>
    <span class="k">return</span> <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a>


<a href="https://docs.python.org/3/library/pprint.html#pprint.pprint" title="pprint.pprint" class="sphx-glr-backref-module-pprint sphx-glr-backref-type-py-function"><span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span></a><span class="p">(</span><span class="n">system_info</span><span class="p">())</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[2023-12-15 18:31:25,053] [INFO] [real_accelerator.py:158:get_accelerator] Setting ds_accelerator to cuda (auto detect)
{&#39;cores&#39;: 8,
 &#39;cuda&#39;: 1,
 &#39;cuda_capa&#39;: (6, 1),
 &#39;cuda_count&#39;: 1,
 &#39;cuda_name&#39;: &#39;NVIDIA GeForce GTX 1060&#39;,
 &#39;processor&#39;: &#39;x86_64&#39;}
</pre></div>
</div>
<p>Scripts arguments</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/argparse.html#argparse.Namespace" title="argparse.Namespace" class="sphx-glr-backref-module-argparse sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">script_args</span></a> <span class="o">=</span> <span class="n">get_parsed_args</span><span class="p">(</span>
    <span class="s2">&quot;plot_torch_export&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="p">,</span>
    <span class="n">scenarios</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;small&quot;</span><span class="p">:</span> <span class="s2">&quot;small model to test&quot;</span><span class="p">,</span>
        <span class="s2">&quot;middle&quot;</span><span class="p">:</span> <span class="s2">&quot;55Mb model&quot;</span><span class="p">,</span>
        <span class="s2">&quot;large&quot;</span><span class="p">:</span> <span class="s2">&quot;1Gb model&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">warmup</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">repeat</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">maxtime</span><span class="o">=</span><span class="p">(</span>
        <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;maximum time to run a model to measure the computation time, &quot;</span>
        <span class="s2">&quot;it is 0.1 when scenario is small&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">expose</span><span class="o">=</span><span class="s2">&quot;scenarios,repeat,warmup&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">if</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">script_args</span><span class="o">.</span><span class="n">scenario</span></a> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;small&quot;</span><span class="p">):</span>
    <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">script_args</span><span class="o">.</span><span class="n">maxtime</span></a> <span class="o">=</span> <span class="mf">0.1</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;scenario=</span><span class="si">{</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">script_args</span><span class="o">.</span><span class="n">scenario</span></a><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;small&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;warmup=</span><span class="si">{</span><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">script_args</span><span class="o">.</span><span class="n">warmup</span></a><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;repeat=</span><span class="si">{</span><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">script_args</span><span class="o">.</span><span class="n">repeat</span></a><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;maxtime=</span><span class="si">{</span><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">script_args</span><span class="o">.</span><span class="n">maxtime</span></a><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>scenario=middle
warmup=5
repeat=5
maxtime=2
</pre></div>
</div>
</section>
<section id="the-model">
<h2>The model<a class="headerlink" href="#the-model" title="Permalink to this heading">#</a></h2>
<p>A simple model to convert.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyModelClass</span><span class="p">(</span><a href="https://pytorch.org/docs/stable/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Module</span></a><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="o">=</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">script_args</span><span class="o">.</span><span class="n">scenario</span></a><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><a href="https://pytorch.org/docs/stable/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">MyModelClass</span></a><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">scenario</span> <span class="o">==</span> <span class="s2">&quot;middle&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">large</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Conv2d.html#torch.nn.Conv2d" title="torch.nn.Conv2d" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span></a><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Conv2d.html#torch.nn.Conv2d" title="torch.nn.Conv2d" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span></a><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear" title="torch.nn.Linear" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span></a><span class="p">(</span><span class="mi">13456</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fcs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear" title="torch.nn.Linear" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span></a><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear" title="torch.nn.Linear" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span></a><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;small&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">large</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Conv2d.html#torch.nn.Conv2d" title="torch.nn.Conv2d" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span></a><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Conv2d.html#torch.nn.Conv2d" title="torch.nn.Conv2d" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span></a><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear" title="torch.nn.Linear" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span></a><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fcs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear" title="torch.nn.Linear" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span></a><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear" title="torch.nn.Linear" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span></a><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;large&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">large</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Conv2d.html#torch.nn.Conv2d" title="torch.nn.Conv2d" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span></a><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Conv2d.html#torch.nn.Conv2d" title="torch.nn.Conv2d" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span></a><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear" title="torch.nn.Linear" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span></a><span class="p">(</span><span class="mi">13456</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
            <span class="c1"># torch script does not support loops.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fca</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear" title="torch.nn.Linear" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span></a><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fcb</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear" title="torch.nn.Linear" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span></a><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fcc</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear" title="torch.nn.Linear" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span></a><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fcd</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear" title="torch.nn.Linear" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span></a><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fce</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear" title="torch.nn.Linear" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span></a><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fcf</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear" title="torch.nn.Linear" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span></a><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fcg</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear" title="torch.nn.Linear" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span></a><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fch</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear" title="torch.nn.Linear" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span></a><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fci</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear" title="torch.nn.Linear" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span></a><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fck</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear" title="torch.nn.Linear" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span></a><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fcl</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear" title="torch.nn.Linear" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span></a><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fcm</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear" title="torch.nn.Linear" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span></a><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fcn</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear" title="torch.nn.Linear" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span></a><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
            <span class="c1"># end of the unfolded loop.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear" title="torch.nn.Linear" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span></a><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear" title="torch.nn.Linear" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span></a><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported scenario=</span><span class="si">{</span><span class="n">scenario</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.functional.max_pool2d.html#torch.nn.functional.max_pool2d" title="torch.nn.functional.max_pool2d" class="sphx-glr-backref-module-torch-nn-functional sphx-glr-backref-type-py-function"><span class="n">F</span><span class="o">.</span><span class="n">max_pool2d</span></a><span class="p">(</span><a href="https://pytorch.org/docs/stable/generated/torch.nn.functional.relu.html#torch.nn.functional.relu" title="torch.nn.functional.relu" class="sphx-glr-backref-module-torch-nn-functional sphx-glr-backref-type-py-function"><span class="n">F</span><span class="o">.</span><span class="n">relu</span></a><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.functional.max_pool2d.html#torch.nn.functional.max_pool2d" title="torch.nn.functional.max_pool2d" class="sphx-glr-backref-module-torch-nn-functional sphx-glr-backref-type-py-function"><span class="n">F</span><span class="o">.</span><span class="n">max_pool2d</span></a><span class="p">(</span><a href="https://pytorch.org/docs/stable/generated/torch.nn.functional.relu.html#torch.nn.functional.relu" title="torch.nn.functional.relu" class="sphx-glr-backref-module-torch-nn-functional sphx-glr-backref-type-py-function"><span class="n">F</span><span class="o">.</span><span class="n">relu</span></a><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.flatten.html#torch.flatten" title="torch.flatten" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">flatten</span></a><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.functional.relu.html#torch.nn.functional.relu" title="torch.nn.functional.relu" class="sphx-glr-backref-module-torch-nn-functional sphx-glr-backref-type-py-function"><span class="n">F</span><span class="o">.</span><span class="n">relu</span></a><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">large</span><span class="p">:</span>
            <span class="c1"># loop</span>
            <span class="n">x</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.functional.relu.html#torch.nn.functional.relu" title="torch.nn.functional.relu" class="sphx-glr-backref-module-torch-nn-functional sphx-glr-backref-type-py-function"><span class="n">F</span><span class="o">.</span><span class="n">relu</span></a><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fca</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.functional.relu.html#torch.nn.functional.relu" title="torch.nn.functional.relu" class="sphx-glr-backref-module-torch-nn-functional sphx-glr-backref-type-py-function"><span class="n">F</span><span class="o">.</span><span class="n">relu</span></a><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fcb</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.functional.relu.html#torch.nn.functional.relu" title="torch.nn.functional.relu" class="sphx-glr-backref-module-torch-nn-functional sphx-glr-backref-type-py-function"><span class="n">F</span><span class="o">.</span><span class="n">relu</span></a><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fcc</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.functional.relu.html#torch.nn.functional.relu" title="torch.nn.functional.relu" class="sphx-glr-backref-module-torch-nn-functional sphx-glr-backref-type-py-function"><span class="n">F</span><span class="o">.</span><span class="n">relu</span></a><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fcd</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.functional.relu.html#torch.nn.functional.relu" title="torch.nn.functional.relu" class="sphx-glr-backref-module-torch-nn-functional sphx-glr-backref-type-py-function"><span class="n">F</span><span class="o">.</span><span class="n">relu</span></a><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fce</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.functional.relu.html#torch.nn.functional.relu" title="torch.nn.functional.relu" class="sphx-glr-backref-module-torch-nn-functional sphx-glr-backref-type-py-function"><span class="n">F</span><span class="o">.</span><span class="n">relu</span></a><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fcf</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.functional.relu.html#torch.nn.functional.relu" title="torch.nn.functional.relu" class="sphx-glr-backref-module-torch-nn-functional sphx-glr-backref-type-py-function"><span class="n">F</span><span class="o">.</span><span class="n">relu</span></a><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fcg</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.functional.relu.html#torch.nn.functional.relu" title="torch.nn.functional.relu" class="sphx-glr-backref-module-torch-nn-functional sphx-glr-backref-type-py-function"><span class="n">F</span><span class="o">.</span><span class="n">relu</span></a><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fch</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.functional.relu.html#torch.nn.functional.relu" title="torch.nn.functional.relu" class="sphx-glr-backref-module-torch-nn-functional sphx-glr-backref-type-py-function"><span class="n">F</span><span class="o">.</span><span class="n">relu</span></a><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fci</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.functional.relu.html#torch.nn.functional.relu" title="torch.nn.functional.relu" class="sphx-glr-backref-module-torch-nn-functional sphx-glr-backref-type-py-function"><span class="n">F</span><span class="o">.</span><span class="n">relu</span></a><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fck</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.functional.relu.html#torch.nn.functional.relu" title="torch.nn.functional.relu" class="sphx-glr-backref-module-torch-nn-functional sphx-glr-backref-type-py-function"><span class="n">F</span><span class="o">.</span><span class="n">relu</span></a><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fcl</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.functional.relu.html#torch.nn.functional.relu" title="torch.nn.functional.relu" class="sphx-glr-backref-module-torch-nn-functional sphx-glr-backref-type-py-function"><span class="n">F</span><span class="o">.</span><span class="n">relu</span></a><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fcm</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.functional.relu.html#torch.nn.functional.relu" title="torch.nn.functional.relu" class="sphx-glr-backref-module-torch-nn-functional sphx-glr-backref-type-py-function"><span class="n">F</span><span class="o">.</span><span class="n">relu</span></a><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fcn</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="c1"># end of the loop</span>
        <span class="n">x</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.functional.relu.html#torch.nn.functional.relu" title="torch.nn.functional.relu" class="sphx-glr-backref-module-torch-nn-functional sphx-glr-backref-type-py-function"><span class="n">F</span><span class="o">.</span><span class="n">relu</span></a><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span> <span class="nf">create_model_and_input</span><span class="p">(</span><span class="n">scenario</span><span class="o">=</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">script_args</span><span class="o">.</span><span class="n">scenario</span></a><span class="p">):</span>
    <span class="k">if</span> <span class="n">scenario</span> <span class="o">==</span> <span class="s2">&quot;middle&quot;</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;small&quot;</span><span class="p">):</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">scenario</span> <span class="o">==</span> <span class="s2">&quot;large&quot;</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported scenario=</span><span class="si">{</span><span class="n">scenario</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <a href="https://pytorch.org/docs/stable/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">input_tensor</span></a> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.rand.html#torch.rand" title="torch.rand" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">rand</span></a><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://pytorch.org/docs/stable/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">torch</span><span class="o">.</span><span class="n">float32</span></a><span class="p">)</span>
    <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">MyModelClass</span></a><span class="p">(</span><span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">)</span>
    <span class="k">assert</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">(</span><a href="https://pytorch.org/docs/stable/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">input_tensor</span></a><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">return</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">,</span> <a href="https://pytorch.org/docs/stable/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">input_tensor</span></a>


<span class="k">def</span> <span class="nf">torch_model_size</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">):</span>
    <span class="n">size_model</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span><span class="o">.</span><span class="n">parameters</span></a><span class="p">():</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data</span></a><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">bits</span> <span class="o">/</span> <span class="mi">8</span>
        <span class="n">size_model</span> <span class="o">+=</span> <span class="n">size</span>
    <span class="k">return</span> <span class="n">size_model</span>


<a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">,</span> <a href="https://pytorch.org/docs/stable/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">input_tensor</span></a> <span class="o">=</span> <span class="n">create_model_and_input</span><span class="p">()</span>
<a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model_size</span></a> <span class="o">=</span> <span class="n">torch_model_size</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;model size=</span><span class="si">{</span><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model_size</span></a><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">20</span><span class="si">}</span><span class="s2"> Mb&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>model size=53.279884338378906 Mb
</pre></div>
</div>
</section>
<section id="the-exporters">
<h2>The exporters<a class="headerlink" href="#the-exporters" title="Permalink to this heading">#</a></h2>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">export_script</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">filename</span></a><span class="p">,</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">with</span> <a href="https://docs.python.org/3/library/contextlib.html#contextlib.redirect_stdout" title="contextlib.redirect_stdout" class="sphx-glr-backref-module-contextlib sphx-glr-backref-type-py-function"><span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stdout</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/io.html#io.StringIO" title="io.StringIO" class="sphx-glr-backref-module-io sphx-glr-backref-type-py-class"><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span></a><span class="p">()):</span>
        <span class="k">with</span> <a href="https://docs.python.org/3/library/warnings.html#warnings.catch_warnings" title="warnings.catch_warnings" class="sphx-glr-backref-module-warnings sphx-glr-backref-type-py-class"><span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span></a><span class="p">():</span>
            <a href="https://docs.python.org/3/library/warnings.html#warnings.simplefilter" title="warnings.simplefilter" class="sphx-glr-backref-module-warnings sphx-glr-backref-type-py-function"><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span></a><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <a href="https://pytorch.org/docs/stable/onnx_torchscript.html#torch.onnx.export" title="torch.onnx.export" class="sphx-glr-backref-module-torch-onnx sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span><span class="n">export</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">filename</span></a><span class="p">,</span> <span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">export_dynamo</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">filename</span></a><span class="p">,</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">with</span> <a href="https://docs.python.org/3/library/contextlib.html#contextlib.redirect_stdout" title="contextlib.redirect_stdout" class="sphx-glr-backref-module-contextlib sphx-glr-backref-type-py-function"><span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stdout</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/io.html#io.StringIO" title="io.StringIO" class="sphx-glr-backref-module-io sphx-glr-backref-type-py-class"><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span></a><span class="p">()):</span>
        <span class="k">with</span> <a href="https://docs.python.org/3/library/warnings.html#warnings.catch_warnings" title="warnings.catch_warnings" class="sphx-glr-backref-module-warnings sphx-glr-backref-type-py-class"><span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span></a><span class="p">():</span>
            <a href="https://docs.python.org/3/library/warnings.html#warnings.simplefilter" title="warnings.simplefilter" class="sphx-glr-backref-module-warnings sphx-glr-backref-type-py-function"><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span></a><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">export_output</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/onnx_dynamo.html#torch.onnx.dynamo_export" title="torch.onnx.dynamo_export" class="sphx-glr-backref-module-torch-onnx sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span><span class="n">dynamo_export</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="n">export_output</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">filename</span></a><span class="p">)</span>


<span class="k">def</span> <span class="nf">export_dynopt</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">filename</span></a><span class="p">,</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">with</span> <a href="https://docs.python.org/3/library/contextlib.html#contextlib.redirect_stdout" title="contextlib.redirect_stdout" class="sphx-glr-backref-module-contextlib sphx-glr-backref-type-py-function"><span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stdout</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/io.html#io.StringIO" title="io.StringIO" class="sphx-glr-backref-module-io sphx-glr-backref-type-py-class"><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span></a><span class="p">()):</span>
        <span class="k">with</span> <a href="https://docs.python.org/3/library/warnings.html#warnings.catch_warnings" title="warnings.catch_warnings" class="sphx-glr-backref-module-warnings sphx-glr-backref-type-py-class"><span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span></a><span class="p">():</span>
            <a href="https://docs.python.org/3/library/warnings.html#warnings.simplefilter" title="warnings.simplefilter" class="sphx-glr-backref-module-warnings sphx-glr-backref-type-py-function"><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span></a><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">export_output</span> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/onnx_dynamo.html#torch.onnx.dynamo_export" title="torch.onnx.dynamo_export" class="sphx-glr-backref-module-torch-onnx sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span><span class="n">dynamo_export</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="n">model_onnx</span> <span class="o">=</span> <span class="n">export_output</span><span class="o">.</span><span class="n">model_proto</span>

            <span class="kn">from</span> <span class="nn">onnxrewriter.optimizer</span> <span class="kn">import</span> <span class="n">optimize</span>

            <span class="n">optimized_model</span> <span class="o">=</span> <span class="n">optimize</span><span class="p">(</span><span class="n">model_onnx</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">filename</span></a><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">optimized_model</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">export_cus_p0</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">filename</span></a><span class="p">,</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">onx</span></a> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">])</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">filename</span></a><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">onx</span></a><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">export_cus_p2</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">filename</span></a><span class="p">,</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">onx</span></a> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span>
        <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">,</span>
        <span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">),</span>
        <span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">],</span>
        <span class="n">remove_unused</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">constant_folding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">filename</span></a><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">onx</span></a><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
</pre></div>
</div>
<p>Let’s check they are working.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">export_functions</span></a> <span class="o">=</span> <span class="p">[</span>
    <span class="n">export_script</span><span class="p">,</span>
    <span class="n">export_dynamo</span><span class="p">,</span>
    <span class="n">export_dynopt</span><span class="p">,</span>
    <span class="n">export_cus_p0</span><span class="p">,</span>
    <span class="n">export_cus_p2</span><span class="p">,</span>
<span class="p">]</span>

<a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">exporters</span></a> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;export_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">export_functions</span></a><span class="p">}</span>

<a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">supported_exporters</span></a> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">k</span></a><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">exporters</span></a><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run exporter </span><span class="si">{</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">k</span></a><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">filename</span></a> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;plot_torch_export_</span><span class="si">{</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">k</span></a><span class="si">}</span><span class="s2">.onnx&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">v</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">filename</span></a><span class="p">,</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">,</span> <a href="https://pytorch.org/docs/stable/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">input_tensor</span></a><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;skipped due to </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)[:</span><span class="mi">1000</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">continue</span>
    <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">supported_exporters</span></a><span class="p">[</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">k</span></a><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;done. size=</span><span class="si">{</span><a href="https://docs.python.org/3/library/os.html#os.stat" title="os.stat" class="sphx-glr-backref-module-os sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">stat</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">filename</span></a><span class="p">)</span><span class="o">.</span><span class="n">st_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">20</span><span class="si">:</span><span class="s2">1.0f</span><span class="si">}</span><span class="s2"> Mb&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>run exporter script
done. size=53 Mb
run exporter dynamo
done. size=53 Mb
run exporter dynopt
done. size=54 Mb
run exporter cus_p0
done. size=53 Mb
run exporter cus_p2
done. size=53 Mb
</pre></div>
</div>
</section>
<section id="exporter-memory">
<h2>Exporter memory<a class="headerlink" href="#exporter-memory" title="Permalink to this heading">#</a></h2>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="n">ps</span><span class="p">):</span>
    <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="s2">&quot;cpu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;gpus&quot;</span> <span class="ow">in</span> <span class="n">ps</span><span class="p">:</span>
        <span class="k">for</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="s2">&quot;gpus&quot;</span><span class="p">]):</span>
            <span class="k">for</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">k</span></a><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;gpu</span><span class="si">{</span><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a><span class="si">}</span><span class="s2">_</span><span class="si">{</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">k</span></a><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a>


<a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data</span></a> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">k</span></a><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">supported_exporters</span></a><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run exporter for memory </span><span class="si">{</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">k</span></a><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">filename</span></a> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;plot_torch_export_</span><span class="si">{</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">k</span></a><span class="si">}</span><span class="s2">.onnx&quot;</span>
    <span class="k">if</span> <a href="https://docs.python.org/3/library/functions.html#bool" title="builtins.bool" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">has_cuda</span></a><span class="p">:</span>
        <a href="https://pytorch.org/docs/stable/generated/torch.cuda.set_device.html#torch.cuda.set_device" title="torch.cuda.set_device" class="sphx-glr-backref-module-torch-cuda sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">set_device</span></a><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">stat</span> <span class="o">=</span> <span class="n">start_spying_on</span><span class="p">(</span><span class="n">cuda</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <a href="https://docs.python.org/3/library/functions.html#bool" title="builtins.bool" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">has_cuda</span></a> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">v</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">filename</span></a><span class="p">,</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">,</span> <a href="https://pytorch.org/docs/stable/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">input_tensor</span></a><span class="p">)</span>
    <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a> <span class="o">=</span> <span class="n">flatten</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">stop</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done.&quot;</span><span class="p">)</span>
    <a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">onx</span></a> <span class="o">=</span> <a href="https://onnx.ai/onnx/api/serialization.html#onnx.load" title="onnx.load" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-function"><span class="n">onnx</span><span class="o">.</span><span class="n">load</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">filename</span></a><span class="p">)</span>
    <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">nodes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">onx</span></a><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">),</span> <span class="n">export</span><span class="o">=</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">k</span></a><span class="p">))</span>
    <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data</span></a><span class="o">.</span><span class="n">append</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">)</span>

<span class="n">stat</span> <span class="o">=</span> <span class="n">start_spying_on</span><span class="p">(</span><span class="n">cuda</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <a href="https://docs.python.org/3/library/functions.html#bool" title="builtins.bool" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">has_cuda</span></a> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
<a href="https://pytorch.org/docs/stable/export.html#torch.export.ExportedProgram" title="torch.export.ExportedProgram" class="sphx-glr-backref-module-torch-export sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">exported_mod</span></a> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/export.html#torch.export.export" title="torch.export.export" class="sphx-glr-backref-module-torch-export sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">export</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">,</span> <span class="p">(</span><a href="https://pytorch.org/docs/stable/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">input_tensor</span></a><span class="p">,))</span>
<a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a> <span class="o">=</span> <span class="n">flatten</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">stop</span><span class="p">())</span>
<a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">export</span><span class="o">=</span><span class="s2">&quot;torch.fx&quot;</span><span class="p">))</span>
<a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data</span></a><span class="o">.</span><span class="n">append</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>run exporter for memory script
done.
run exporter for memory dynamo
done.
run exporter for memory dynopt
done.
run exporter for memory cus_p0
done.
run exporter for memory cus_p2
done.
</pre></div>
</div>
<p>The result.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df1</span></a> <span class="o">=</span> <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class"><span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data</span></a><span class="p">)</span>
<a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.to_csv.html#pandas.DataFrame.to_csv" title="pandas.DataFrame.to_csv" class="sphx-glr-backref-module-pandas sphx-glr-backref-type-py-method"><span class="n">df1</span><span class="o">.</span><span class="n">to_csv</span></a><span class="p">(</span><span class="s2">&quot;plot_torch_export_memory.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.to_excel.html#pandas.DataFrame.to_excel" title="pandas.DataFrame.to_excel" class="sphx-glr-backref-module-pandas sphx-glr-backref-type-py-method"><span class="n">df1</span><span class="o">.</span><span class="n">to_excel</span></a><span class="p">(</span><span class="s2">&quot;plot_torch_export_memory.xlsx&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df1</span></a><span class="p">)</span>

<a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ax</span></a> <span class="o">=</span> <span class="n">memory_peak_plot</span><span class="p">(</span>
    <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data</span></a><span class="p">,</span>
    <span class="n">bars</span><span class="o">=</span><span class="p">[</span><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model_size</span></a> <span class="o">*</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a> <span class="o">/</span> <span class="mi">2</span><span class="o">**</span><span class="mi">20</span> <span class="k">for</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)],</span>
    <span class="n">suptitle</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Memory Consumption of the Export</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="sa">f</span><span class="s2">&quot;model size=</span><span class="si">{</span><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model_size</span></a><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="o">**</span><span class="mi">20</span><span class="si">:</span><span class="s2">1.0f</span><span class="si">}</span><span class="s2"> Mb&quot;</span><span class="p">,</span>
<span class="p">)</span>
<a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ax</span></a><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;plot_torch_export_memory.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_torch_export_001.png" srcset="../_images/sphx_glr_plot_torch_export_001.png" alt="Memory Consumption of the Export model size=53 Mb, Memory peak (Mb), Memory peak - memory begin (Mb), Memory average - memory begin (Mb), GPU Memory peak (Mb), GPU Memory peak - memory begin (Mb), GPU Memory average - memory begin (Mb)" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>          peak         mean         n  ...  gpu0_end  nodes    export
0  1027.609375   933.630637  0.000075  ...      98.0   12.0    script
1  1222.003906  1020.962477  0.000162  ...      98.0   13.0    dynamo
2  1221.832031  1044.219524  0.000212  ...      98.0   13.0    dynopt
3  1119.531250   973.389644  0.000190  ...      98.0   27.0    cus_p0
4  1117.082031   968.897749  0.000168  ...      98.0   12.0    cus_p2
5   907.882812   907.782586  0.000036  ...      98.0    NaN  torch.fx

[6 rows x 12 columns]
</pre></div>
</div>
</section>
<section id="exporter-speed">
<h2>Exporter speed<a class="headerlink" href="#exporter-speed" title="Permalink to this heading">#</a></h2>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data</span></a> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">k</span></a><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">supported_exporters</span></a><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run exporter </span><span class="si">{</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">k</span></a><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">filename</span></a> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;plot_torch_export_</span><span class="si">{</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">k</span></a><span class="si">}</span><span class="s2">.onnx&quot;</span>
    <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">times</span></a> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">script_args</span><span class="o">.</span><span class="n">repeat</span></a><span class="p">):</span>
        <a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">begin</span></a> <span class="o">=</span> <a href="https://docs.python.org/3/library/time.html#time.perf_counter" title="time.perf_counter" class="sphx-glr-backref-module-time sphx-glr-backref-type-py-function"><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span></a><span class="p">()</span>
        <span class="n">v</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">filename</span></a><span class="p">,</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">,</span> <a href="https://pytorch.org/docs/stable/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">input_tensor</span></a><span class="p">)</span>
        <a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">duration</span></a> <span class="o">=</span> <a href="https://docs.python.org/3/library/time.html#time.perf_counter" title="time.perf_counter" class="sphx-glr-backref-module-time sphx-glr-backref-type-py-function"><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span></a><span class="p">()</span> <span class="o">-</span> <a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">begin</span></a>
        <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">times</span></a><span class="o">.</span><span class="n">append</span><span class="p">(</span><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">duration</span></a><span class="p">)</span>
    <a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">onx</span></a> <span class="o">=</span> <a href="https://onnx.ai/onnx/api/serialization.html#onnx.load" title="onnx.load" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-function"><span class="n">onnx</span><span class="o">.</span><span class="n">load</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">filename</span></a><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done.&quot;</span><span class="p">)</span>
    <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data</span></a><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="nb">dict</span><span class="p">(</span>
            <span class="n">export</span><span class="o">=</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">k</span></a><span class="p">,</span>
            <span class="n">time</span><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.mean.html#numpy.mean" title="numpy.mean" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">mean</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">times</span></a><span class="p">),</span>
            <span class="nb">min</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">times</span></a><span class="p">),</span>
            <span class="nb">max</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">times</span></a><span class="p">),</span>
            <span class="n">first</span><span class="o">=</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">times</span></a><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">last</span><span class="o">=</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">times</span></a><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">std</span><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.std.html#numpy.std" title="numpy.std" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">std</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">times</span></a><span class="p">),</span>
            <span class="n">nodes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">onx</span></a><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>run exporter script
done.
run exporter dynamo
done.
run exporter dynopt
done.
run exporter cus_p0
done.
run exporter cus_p2
done.
</pre></div>
</div>
<p>The last export to measure time torch spends in export the model
before any other export can begin the translation
except the first one.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">times</span></a> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">script_args</span><span class="o">.</span><span class="n">repeat</span></a><span class="p">):</span>
    <a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">begin</span></a> <span class="o">=</span> <a href="https://docs.python.org/3/library/time.html#time.perf_counter" title="time.perf_counter" class="sphx-glr-backref-module-time sphx-glr-backref-type-py-function"><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span></a><span class="p">()</span>
    <a href="https://pytorch.org/docs/stable/export.html#torch.export.ExportedProgram" title="torch.export.ExportedProgram" class="sphx-glr-backref-module-torch-export sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">exported_mod</span></a> <span class="o">=</span> <a href="https://pytorch.org/docs/stable/export.html#torch.export.export" title="torch.export.export" class="sphx-glr-backref-module-torch-export sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">export</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">,</span> <span class="p">(</span><a href="https://pytorch.org/docs/stable/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">input_tensor</span></a><span class="p">,))</span>
    <a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">duration</span></a> <span class="o">=</span> <a href="https://docs.python.org/3/library/time.html#time.perf_counter" title="time.perf_counter" class="sphx-glr-backref-module-time sphx-glr-backref-type-py-function"><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span></a><span class="p">()</span> <span class="o">-</span> <a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">begin</span></a>
    <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">times</span></a><span class="o">.</span><span class="n">append</span><span class="p">(</span><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">duration</span></a><span class="p">)</span>
<a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data</span></a><span class="o">.</span><span class="n">append</span><span class="p">(</span>
    <span class="nb">dict</span><span class="p">(</span>
        <span class="n">export</span><span class="o">=</span><span class="s2">&quot;torch.fx&quot;</span><span class="p">,</span>
        <span class="n">time</span><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.mean.html#numpy.mean" title="numpy.mean" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">mean</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">times</span></a><span class="p">),</span>
        <span class="nb">min</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">times</span></a><span class="p">),</span>
        <span class="nb">max</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">times</span></a><span class="p">),</span>
        <span class="n">first</span><span class="o">=</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">times</span></a><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">last</span><span class="o">=</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">times</span></a><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">std</span><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.std.html#numpy.std" title="numpy.std" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">std</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">times</span></a><span class="p">),</span>
        <span class="n">nodes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">onx</span></a><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The result.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df1</span></a> <span class="o">=</span> <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class"><span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data</span></a><span class="p">)</span>
<a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.to_csv.html#pandas.DataFrame.to_csv" title="pandas.DataFrame.to_csv" class="sphx-glr-backref-module-pandas sphx-glr-backref-type-py-method"><span class="n">df1</span><span class="o">.</span><span class="n">to_csv</span></a><span class="p">(</span><span class="s2">&quot;plot_torch_export_time.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.to_excel.html#pandas.DataFrame.to_excel" title="pandas.DataFrame.to_excel" class="sphx-glr-backref-module-pandas sphx-glr-backref-type-py-method"><span class="n">df1</span><span class="o">.</span><span class="n">to_excel</span></a><span class="p">(</span><span class="s2">&quot;plot_torch_export_time.xlsx&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df1</span></a><span class="p">)</span>

<a href="https://matplotlib.org/stable/api/figure_api.html#matplotlib.figure.Figure" title="matplotlib.figure.Figure" class="sphx-glr-backref-module-matplotlib-figure sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">fig</span></a><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ax</span></a> <span class="o">=</span> <a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots" class="sphx-glr-backref-module-matplotlib-pyplot sphx-glr-backref-type-py-function"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dfi</span></a> <span class="o">=</span> <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df1</span></a><span class="p">[[</span><span class="s2">&quot;export&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;export&quot;</span><span class="p">)</span>
<a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dfi</span></a><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ax</span></a><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ax</span></a><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Export time&quot;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dfi</span></a><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">],</span> <span class="n">rot</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<a href="https://matplotlib.org/stable/api/figure_api.html#matplotlib.figure.Figure.tight_layout" title="matplotlib.figure.Figure.tight_layout" class="sphx-glr-backref-module-matplotlib-figure sphx-glr-backref-type-py-method"><span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span></a><span class="p">()</span>
<a href="https://matplotlib.org/stable/api/figure_api.html#matplotlib.figure.Figure.savefig" title="matplotlib.figure.Figure.savefig" class="sphx-glr-backref-module-matplotlib-figure sphx-glr-backref-type-py-method"><span class="n">fig</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s2">&quot;plot_torch_export_time.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_torch_export_002.png" srcset="../_images/sphx_glr_plot_torch_export_002.png" alt="Export time" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>     export      time       min        max     first      last       std  nodes
0    script  0.630711  0.569053   0.720278  0.599305  0.569053  0.051155     12
1    dynamo  1.136863  0.980626   1.236567  1.236567  0.980626  0.088417     13
2    dynopt  3.781047  1.647411  11.226399  1.647411  1.940694  3.730814     13
3    cus_p0  0.901334  0.769643   1.054844  0.769643  1.054844  0.123914     27
4    cus_p2  2.001572  0.963601   4.183167  1.261833  4.183167  1.167262     12
5  torch.fx  1.020345  0.558656   1.844504  0.570205  1.248700  0.483106     12
</pre></div>
</div>
</section>
<section id="exporter-profiling">
<h2>Exporter Profiling<a class="headerlink" href="#exporter-profiling" title="Permalink to this heading">#</a></h2>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">clean_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">pathes</span> <span class="o">=</span> <span class="p">[</span>
        <a href="https://docs.python.org/3/library/os.path.html#os.path.abspath" title="os.path.abspath" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span></a><span class="p">(</span>
            <a href="https://docs.python.org/3/library/os.path.html#os.path.normpath" title="os.path.normpath" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/os.path.html#os.path.join" title="os.path.join" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/os.path.html#os.path.dirname" title="os.path.dirname" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span></a><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&quot;..&quot;</span><span class="p">))</span>
        <span class="p">),</span>
        <a href="https://docs.python.org/3/library/os.path.html#os.path.abspath" title="os.path.abspath" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span></a><span class="p">(</span>
            <a href="https://docs.python.org/3/library/os.path.html#os.path.normpath" title="os.path.normpath" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/os.path.html#os.path.join" title="os.path.join" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/os.path.html#os.path.dirname" title="os.path.dirname" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span></a><span class="p">(</span><span class="n">onnx</span><span class="o">.</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&quot;..&quot;</span><span class="p">))</span>
        <span class="p">),</span>
        <a href="https://docs.python.org/3/library/os.path.html#os.path.abspath" title="os.path.abspath" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span></a><span class="p">(</span>
            <a href="https://docs.python.org/3/library/os.path.html#os.path.normpath" title="os.path.normpath" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span></a><span class="p">(</span>
                <a href="https://docs.python.org/3/library/os.path.html#os.path.join" title="os.path.join" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/os.path.html#os.path.dirname" title="os.path.dirname" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span></a><span class="p">(</span><span class="n">experimental_experiment</span><span class="o">.</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&quot;..&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">),</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pathes</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;experimental_experiment&quot;</span><span class="p">,</span> <span class="s2">&quot;experimental_experiment&quot;</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">text</span>


<span class="k">def</span> <span class="nf">profile_function</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">export_function</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;profile </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">export_function</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">pr</span> <span class="o">=</span> <span class="n">cProfile</span><span class="o">.</span><span class="n">Profile</span><span class="p">()</span>
    <span class="n">pr</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
    <span class="k">for</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">script_args</span><span class="o">.</span><span class="n">repeat</span></a><span class="p">):</span>
        <span class="n">export_function</span><span class="p">(</span><span class="s2">&quot;dummyc.onnx&quot;</span><span class="p">,</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">,</span> <a href="https://pytorch.org/docs/stable/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">input_tensor</span></a><span class="p">)</span>
    <span class="n">pr</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
    <span class="n">s</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/io.html#io.StringIO" title="io.StringIO" class="sphx-glr-backref-module-io sphx-glr-backref-type-py-class"><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span></a><span class="p">()</span>
    <span class="n">sortby</span> <span class="o">=</span> <span class="n">SortKey</span><span class="o">.</span><span class="n">CUMULATIVE</span>
    <span class="n">ps</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/profile.html#pstats.Stats" title="pstats.Stats" class="sphx-glr-backref-module-pstats sphx-glr-backref-type-py-class"><span class="n">pstats</span><span class="o">.</span><span class="n">Stats</span></a><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">sort_stats</span><span class="p">(</span><span class="n">sortby</span><span class="p">)</span>
    <span class="n">ps</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>

    <span class="n">raw</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[:</span><span class="mi">200</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;plot_torch_export_profile_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>

    <span class="n">root</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">profile2graph</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="n">clean_text</span><span class="o">=</span><span class="n">clean_text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">to_text</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;plot_torch_export_profile_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_h.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done.&quot;</span><span class="p">)</span>


<span class="n">profile_function</span><span class="p">(</span><span class="s2">&quot;custom0&quot;</span><span class="p">,</span> <span class="n">export_cus_p0</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">profile_function</span><span class="p">(</span><span class="s2">&quot;custom2&quot;</span><span class="p">,</span> <span class="n">export_cus_p2</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>profile custom0: &lt;function export_cus_p0 at 0x7f07cc957ac0&gt;
         1328612 function calls (1263267 primitive calls) in 12.506 seconds

   Ordered by: cumulative time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
        5    0.047    0.009   12.717    2.543 /home/xadupre/github/experimental-experiment/_doc/examples/plot_torch_export.py:261(export_cus_p0)
        5    0.074    0.015   11.234    2.247 /home/xadupre/github/experimental-experiment/experimental_experiment/torch_exp/onnx_export.py:94(to_onnx)
        5    0.001    0.000    8.526    1.705 /home/xadupre/github/experimental-experiment/experimental_experiment/torch_exp/onnx_export.py:36(_make_builder_interpreter)
        5    0.000    0.000    8.523    1.705 /home/xadupre/.local/lib/python3.10/site-packages/torch/export/__init__.py:346(export)
        5    0.000    0.000    8.523    1.705 /home/xadupre/.local/lib/python3.10/site-packages/torch/_export/__init__.py:230(export__RC__)
        5    0.000    0.000    8.523    1.705 /home/xadupre/.local/lib/python3.10/site-packages/torch/export/exported_program.py:74(wrapper)
        5    0.011    0.002    8.522    1.704 /home/xadupre/.local/lib/python3.10/site-packages/torch/_export/__init__.py:731(_export)
    15/10    0.001    0.000    7.058    0.706 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/utils.py:237(time_wrapper)
    20/10    0.001    0.000    6.334    0.633 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/eval_frame.py:454(_fn)
   115/55    0.001    0.000    5.581    0.101 /home/xadupre/.local/lib/python3.10/site-packages/torch/nn/modules/module.py:1507(_wrapped_call_impl)
   115/55    0.002    0.000    5.581    0.101 /home/xadupre/.local/lib/python3.10/site-packages/torch/nn/modules/module.py:1513(_call_impl)
        5    0.001    0.000    4.341    0.868 /home/xadupre/.local/lib/python3.10/site-packages/torch/_export/__init__.py:486(_export_to_torch_ir)
        5    0.003    0.001    4.339    0.868 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/eval_frame.py:1230(inner)
3705/1925    0.038    0.000    4.209    0.002 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_stats.py:15(wrapper)
        5    0.001    0.000    3.948    0.790 /home/xadupre/.local/lib/python3.10/site-packages/torch/_export/__init__.py:648(_export_non_strict)
        5    0.000    0.000    3.831    0.766 /home/xadupre/.local/lib/python3.10/site-packages/torch/_export/__init__.py:908(_aot_export_strict)
        5    0.001    0.000    3.692    0.738 /home/xadupre/.local/lib/python3.10/site-packages/torch/_functorch/aot_autograd.py:910(aot_export_module)
        5    0.000    0.000    3.686    0.737 /home/xadupre/.local/lib/python3.10/site-packages/torch/_functorch/aot_autograd.py:1160(_aot_export_function)
        5    0.003    0.001    3.681    0.736 /home/xadupre/.local/lib/python3.10/site-packages/torch/_functorch/aot_autograd.py:385(create_aot_dispatcher_function)
2960/2080    0.051    0.000    3.598    0.002 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/fake_tensor.py:1385(__torch_dispatch__)
2960/2080    0.427    0.000    3.527    0.002 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/fake_tensor.py:1417(dispatch)
        5    0.010    0.002    3.396    0.679 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/eval_frame.py:606(catch_errors)
        5    0.001    0.000    3.383    0.677 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/convert_frame.py:272(_convert_frame_assert)
        5    0.001    0.000    3.378    0.676 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/convert_frame.py:476(_compile)
        5    0.001    0.000    3.373    0.675 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/convert_frame.py:551(compile_inner)
3285/1575    0.019    0.000    3.044    0.002 /home/xadupre/.local/lib/python3.10/site-packages/torch/_ops.py:508(__call__)
    15/10    0.000    0.000    2.928    0.293 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/external_utils.py:15(inner)
        5    0.000    0.000    2.639    0.528 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/bytecode_transformation.py:1025(transform_code_object)
      610    0.064    0.000    2.627    0.004 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/functional_tensor.py:220(__torch_dispatch__)
       15    0.006    0.000    2.586    0.172 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/interpreter.py:99(run)
        5    0.002    0.000    2.575    0.515 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/convert_frame.py:136(_fn)
        5    0.001    0.000    2.570    0.514 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/convert_frame.py:505(transform)
      210    0.005    0.000    2.567    0.012 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/interpreter.py:177(run_node)
        5    0.000    0.000    2.545    0.509 /home/xadupre/github/experimental-experiment/experimental_experiment/torch_exp/graph_builder.py:584(to_onnx)
       10    0.001    0.000    2.520    0.252 /home/xadupre/.local/lib/python3.10/site-packages/torch/_functorch/_aot_autograd/utils.py:156(flat_fn)
       10    0.001    0.000    2.516    0.252 /home/xadupre/.local/lib/python3.10/site-packages/torch/_functorch/_aot_autograd/traced_function_transforms.py:593(functional_call)
        5    0.000    0.000    2.400    0.480 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/symbolic_convert.py:2120(run)
        5    0.002    0.000    2.400    0.480 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/symbolic_convert.py:811(run)
      280    0.017    0.000    2.397    0.009 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/symbolic_convert.py:709(step)
        5    0.000    0.000    2.367    0.473 /home/xadupre/.local/lib/python3.10/site-packages/torch/_functorch/_aot_autograd/runtime_wrappers.py:392(aot_wrapper_dedupe)
        5    0.000    0.000    2.366    0.473 /home/xadupre/.local/lib/python3.10/site-packages/torch/_functorch/_aot_autograd/runtime_wrappers.py:611(aot_wrapper_synthetic_base)
        5    0.000    0.000    2.364    0.473 /home/xadupre/.local/lib/python3.10/site-packages/torch/_functorch/_aot_autograd/dispatch_and_compile_graph.py:37(aot_dispatch_base_graph)
        5    0.000    0.000    2.228    0.446 /home/xadupre/.local/lib/python3.10/site-packages/torch/_functorch/_aot_autograd/dispatch_and_compile_graph.py:30(_create_graph)
        5    0.001    0.000    2.227    0.445 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:773(wrapped)
        5    0.000    0.000    2.217    0.443 /home/xadupre/.local/lib/python3.10/site-packages/torch/_compile.py:20(inner)
        5    0.000    0.000    2.213    0.443 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:477(dispatch_trace)
        5    0.001    0.000    2.125    0.425 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/_symbolic_trace.py:699(trace)
        5    0.000    0.000    2.063    0.413 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:511(wrapped)
       60    0.002    0.000    1.946    0.032 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/symbolic_convert.py:460(wrapper)
       60    0.001    0.000    1.940    0.032 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/symbolic_convert.py:1209(CALL_FUNCTION)
       60    0.002    0.000    1.935    0.032 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/symbolic_convert.py:632(call_function)
       60    0.001    0.000    1.898    0.032 /home/xadupre/.local/lib/python3.10/site-packages/torch/nn/modules/linear.py:115(forward)
       60    0.077    0.001    1.897    0.032 {built-in method torch._C._nn.linear}
       65    0.009    0.000    1.828    0.028 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/variables/builder.py:1288(wrap_fx_proxy)
       65    0.007    0.000    1.819    0.028 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/variables/builder.py:1348(wrap_fx_proxy_cls)
        5    0.000    0.000    1.811    0.362 /home/xadupre/.local/lib/python3.10/site-packages/torch/_functorch/_aot_autograd/traced_function_transforms.py:465(fwd_helper)
        5    0.000    0.000    1.811    0.362 /home/xadupre/.local/lib/python3.10/site-packages/torch/_functorch/_aot_autograd/traced_function_transforms.py:345(_functionalized_f_helper)
        5    0.000    0.000    1.653    0.331 /home/xadupre/.local/lib/python3.10/site-packages/torch/_functorch/_aot_autograd/traced_function_transforms.py:66(inner_fn)
  895/435    0.013    0.000    1.623    0.004 /home/xadupre/.local/lib/python3.10/site-packages/torch/_prims_common/wrappers.py:242(_fn)
       90    0.000    0.000    1.620    0.018 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/utils.py:1025(wrap_fake_exception)
       60    0.005    0.000    1.615    0.027 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/utils.py:1440(get_fake_value)
2710/2090    0.028    0.000    1.521    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_pytree.py:600(tree_map)
       50    0.001    0.000    1.467    0.029 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/interpreter.py:291(call_module)
      545    0.010    0.000    1.394    0.003 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:593(__torch_dispatch__)
       25    0.002    0.000    1.381    0.055 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/variables/nn_module.py:238(call_function)
      545    0.004    0.000    1.341    0.002 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:624(inner_torch_dispatch)
       75    0.013    0.000    1.294    0.017 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:258(proxy_call)
       60    0.003    0.000    1.207    0.020 /home/xadupre/.local/lib/python3.10/site-packages/torch/_decomp/decompositions.py:50(inner)
2710/2090    0.016    0.000    1.164    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_pytree.py:602(&lt;listcomp&gt;)
        5    0.003    0.001    1.102    0.220 /home/xadupre/.local/lib/python3.10/site-packages/torch/_functorch/_aot_autograd/collect_metadata_analysis.py:91(inner)
       70    0.001    0.000    0.969    0.014 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/interpreter.py:249(call_function)
        5    0.000    0.000    0.958    0.192 /home/xadupre/github/onnx/onnx/helper.py:279(make_model)
       15    0.000    0.000    0.958    0.064 /home/xadupre/.local/lib/python3.10/site-packages/google/protobuf/message.py:118(CopyFrom)
       15    0.958    0.064    0.958    0.064 {method &#39;MergeFrom&#39; of &#39;google._upb._message.Message&#39; objects}
       25    0.000    0.000    0.920    0.037 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/_symbolic_trace.py:789(module_call_wrapper)
       25    0.000    0.000    0.917    0.037 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:437(call_module)
       25    0.000    0.000    0.917    0.037 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/_symbolic_trace.py:791(forward)
  310/260    0.037    0.000    0.889    0.003 {method &#39;detach&#39; of &#39;torch._C.TensorBase&#39; objects}
       60    0.017    0.000    0.861    0.014 /home/xadupre/.local/lib/python3.10/site-packages/torch/_decomp/decompositions.py:1311(addmm)
      155    0.816    0.005    0.840    0.005 {method &#39;extend&#39; of &#39;google._upb._message.RepeatedCompositeContainer&#39; objects}
        5    0.000    0.000    0.810    0.162 /home/xadupre/github/onnx/onnx/helper.py:192(make_graph)
       25    0.001    0.000    0.799    0.032 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/utils.py:1036(deepcopy_to_fake_tensor)
  520/145    0.016    0.000    0.798    0.006 /usr/lib/python3.10/copy.py:259(_reconstruct)
       25    0.000    0.000    0.797    0.032 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/utils.py:1038(&lt;lambda&gt;)
  1475/30    0.021    0.000    0.797    0.027 /usr/lib/python3.10/copy.py:128(deepcopy)
       80    0.001    0.000    0.782    0.010 /home/xadupre/.local/lib/python3.10/site-packages/torch/nn/functional.py:1462(relu)
       80    0.025    0.000    0.781    0.010 {built-in method torch.relu}
       25    0.004    0.000    0.780    0.031 /usr/lib/python3.10/copy.py:227(_deepcopy_dict)
        5    0.072    0.014    0.773    0.155 /home/xadupre/github/experimental-experiment/experimental_experiment/torch_exp/graph_builder.py:554(_build_initializers)
       60    0.000    0.000    0.770    0.013 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/utils.py:1487(&lt;lambda&gt;)
       60    0.001    0.000    0.769    0.013 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/utils.py:1551(run_node)
       35    0.747    0.021    0.747    0.021 {method &#39;SerializeToString&#39; of &#39;google._upb._message.Message&#39; objects}
        5    0.001    0.000    0.732    0.146 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/guards.py:956(__init__)
       50    0.004    0.000    0.725    0.015 /home/xadupre/.local/lib/python3.10/site-packages/torch/nn/parameter.py:55(__deepcopy__)
        5    0.001    0.000    0.714    0.143 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/eval_frame.py:1277(result_capturing_wrapper)
      250    0.004    0.000    0.704    0.003 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/fake_tensor.py:1962(__torch_function__)
       50    0.261    0.005    0.700    0.014 /home/xadupre/github/experimental-experiment/experimental_experiment/torch_exp/graph_builder.py:516(from_array)
        5    0.003    0.001    0.646    0.129 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/guards.py:1025(compile_check_fn)
        5    0.000    0.000    0.623    0.125 /home/xadupre/.local/lib/python3.10/site-packages/torch/_functorch/functional_call.py:10(functional_call)
        5    0.000    0.000    0.623    0.125 /home/xadupre/.local/lib/python3.10/site-packages/torch/nn/utils/stateless.py:229(_functional_call)
     4095    0.023    0.000    0.622    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_pytree.py:531(tree_flatten)
        5    0.000    0.000    0.615    0.123 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/graph_module.py:737(call_wrapped)
        5    0.000    0.000    0.615    0.123 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/graph_module.py:299(__call__)
  420/260    0.030    0.000    0.609    0.002 /home/xadupre/.local/lib/python3.10/site-packages/torch/_prims_common/wrappers.py:115(_fn)
       50    0.003    0.000    0.608    0.012 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/graph_module.py:708(recompile)
       80    0.000    0.000    0.602    0.008 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:184(track_tensor_tree)
   155/80    0.003    0.000    0.601    0.008 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:185(wrap_with_proxy)
14690/4095    0.160    0.000    0.599    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_pytree.py:516(_tree_flatten_helper)
     1530    0.018    0.000    0.596    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_pytree.py:705(tree_map_only)
  200/150    0.012    0.000    0.558    0.004 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/fake_tensor.py:1167(__torch_dispatch__)
       35    0.006    0.000    0.547    0.016 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/variables/torch.py:209(call_function)
       50    0.001    0.000    0.544    0.011 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/graph.py:1268(python_code)
231455/226965    0.447    0.000    0.543    0.000 {built-in method builtins.isinstance}
      150    0.003    0.000    0.540    0.004 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:146(set_meta)
        5    0.523    0.105    0.523    0.105 {method &#39;write&#39; of &#39;_io.BufferedWriter&#39; objects}
  170/150    0.002    0.000    0.518    0.003 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:117(extract_val)
      160    0.001    0.000    0.516    0.003 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:114(snapshot_fake)
       50    0.002    0.000    0.511    0.010 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/graph.py:1330(_python_code)
       50    0.072    0.001    0.509    0.010 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/graph.py:360(_gen_python_code)
  290/240    0.226    0.001    0.500    0.002 {method &#39;clone&#39; of &#39;torch._C.TensorBase&#39; objects}
       40    0.000    0.000    0.497    0.012 /home/xadupre/.local/lib/python3.10/site-packages/torch/_jit_internal.py:489(fn)
       40    0.001    0.000    0.497    0.012 /home/xadupre/.local/lib/python3.10/site-packages/torch/nn/functional.py:774(_max_pool2d)
       40    0.021    0.001    0.495    0.012 {built-in method torch.max_pool2d}
      895    0.007    0.000    0.432    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/fake_tensor.py:1770(wrap_meta_outputs_with_default_device_logic)
       40    0.001    0.000    0.427    0.011 /home/xadupre/.local/lib/python3.10/site-packages/torch/nn/modules/conv.py:459(forward)
       40    0.010    0.000    0.426    0.011 /home/xadupre/.local/lib/python3.10/site-packages/torch/nn/modules/conv.py:451(_conv_forward)
       40    0.015    0.000    0.416    0.010 {built-in method torch.conv2d}
7630/2650    0.038    0.000    0.405    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_pytree.py:526(&lt;listcomp&gt;)
        5    0.003    0.001    0.405    0.081 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/guards.py:1223(build_guard_function)
       50    0.011    0.000    0.387    0.008 /home/xadupre/.local/lib/python3.10/site-packages/torch/nn/parameter.py:34(__new__)
      935    0.024    0.000    0.363    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/fake_tensor.py:1777(wrap)
      110    0.001    0.000    0.340    0.003 /home/xadupre/.local/lib/python3.10/site-packages/torch/_functorch/_aot_autograd/functional_utils.py:23(to_fun)
      110    0.004    0.000    0.337    0.003 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/functional_tensor.py:155(to_functional)
      225    0.002    0.000    0.337    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/fake_tensor.py:385(__call__)
      225    0.004    0.000    0.335    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/fake_tensor.py:307(from_real_tensor)
14415/4040    0.212    0.000    0.332    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_pytree.py:540(tree_unflatten)
 5600/330    0.045    0.000    0.326    0.001 /usr/lib/python3.10/ast.py:414(visit)
      275    0.013    0.000    0.316    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/proxy.py:171(create_proxy)
      165    0.008    0.000    0.314    0.002 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/meta_utils.py:633(__call__)
      165    0.049    0.000    0.303    0.002 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/meta_utils.py:181(meta_tensor)
       80    0.001    0.000    0.296    0.004 /home/xadupre/.local/lib/python3.10/site-packages/torch/_refs/nn/functional/__init__.py:134(_fn)
      320    0.019    0.000    0.296    0.001 {method &#39;to&#39; of &#39;torch._C.TensorBase&#39; objects}
14140/13440    0.049    0.000    0.287    0.000 {built-in method builtins.next}
       55    0.283    0.005    0.283    0.005 {method &#39;tobytes&#39; of &#39;numpy.ndarray&#39; objects}
       80    0.001    0.000    0.269    0.003 /home/xadupre/.local/lib/python3.10/site-packages/torch/_refs/nn/functional/__init__.py:246(relu)
     5150    0.035    0.000    0.265    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/node.py:672(map_arg)
    19025    0.073    0.000    0.257    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_pytree.py:464(_is_leaf)
       75    0.002    0.000    0.254    0.003 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/variables/builder.py:237(__call__)
    27835    0.077    0.000    0.247    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_pytree.py:457(_get_node_type)
       75    0.010    0.000    0.241    0.003 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/variables/builder.py:367(_wrap)
       20    0.002    0.000    0.238    0.012 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/graph_module.py:354(__init__)
  380/320    0.006    0.000    0.236    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/nn/modules/module.py:1690(__setattr__)
      180    0.001    0.000    0.230    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/_decomp/decompositions.py:60(increase_prec)
      935    0.020    0.000    0.229    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/fake_tensor.py:368(from_meta_and_device)
       20    0.000    0.000    0.226    0.011 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/graph_module.py:462(graph)
      165    0.002    0.000    0.226    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/fake_tensor.py:1859(from_tensor)
      140    0.006    0.000    0.224    0.002 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/guards.py:1036(add_code_part)
10190/5155    0.094    0.000    0.224    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/node.py:680(map_aggregate)
     1085    0.035    0.000    0.218    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/graph.py:515(emit_node)
       65    0.002    0.000    0.210    0.003 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/symbolic_convert.py:1301(LOAD_ATTR)
      690    0.007    0.000    0.209    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/guards.py:150(_ast_unparse)
      690    0.004    0.000    0.201    0.000 /usr/lib/python3.10/ast.py:1679(unparse)
       20    0.008    0.000    0.199    0.010 {built-in method torch.flatten}
      140    0.004    0.000    0.197    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_traceback.py:170(summary)
      690    0.004    0.000    0.194    0.000 /usr/lib/python3.10/ast.py:811(visit)
      285    0.028    0.000    0.193    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/proxy.py:115(create_node)
        1    0.000    0.000    0.193    0.193 &lt;eval_with_key&gt;.396:4(forward)
       65    0.010    0.000    0.192    0.003 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/variables/builtin.py:475(call_function)
      110    0.001    0.000    0.189    0.002 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/guards.py:1230(replace)
 3295/690    0.023    0.000    0.189    0.000 /usr/lib/python3.10/ast.py:801(traverse)
       10    0.012    0.001    0.188    0.019 /home/xadupre/.local/lib/python3.10/site-packages/torch/_decomp/decompositions_for_rng.py:129(reset)
      110    0.002    0.000    0.188    0.002 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/guards.py:925(replace)
       55    0.001    0.000    0.188    0.003 /home/xadupre/.local/lib/python3.10/site-packages/torch/_functorch/_aot_autograd/collect_metadata_analysis.py:81(_to_fun)
      220    0.012    0.000    0.188    0.001 {built-in method torch._mirror_autograd_meta_to}
4130/3850    0.025    0.000    0.185    0.000 /usr/lib/python3.10/contextlib.py:130(__enter__)
        5    0.000    0.000    0.185    0.037 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/eval_frame.py:1001(rewrite_signature)
      200    0.005    0.000    0.180    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/_refs/__init__.py:1008(_ref)
      280    0.044    0.000    0.175    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/functional_tensor.py:61(__new__)
       30    0.000    0.000    0.173    0.006 /home/xadupre/.local/lib/python3.10/site-packages/torch/_decomp/decompositions_for_rng.py:71(__init__)
       30    0.001    0.000    0.173    0.006 /home/xadupre/.local/lib/python3.10/site-packages/torch/_decomp/decompositions_for_rng.py:74(reset)
       60    0.012    0.000    0.173    0.003 {built-in method torch.tensor}
        5    0.002    0.000    0.171    0.034 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/guards.py:920(count)
    27835    0.135    0.000    0.169    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_pytree.py:446(_is_namedtuple_instance)
        5    0.001    0.000    0.167    0.033 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/symbolic_convert.py:2038(__init__)
      140    0.029    0.000    0.166    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_traceback.py:246(_extract_symbolized_tb)
      340    0.017    0.000    0.162    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/_prims/__init__.py:338(_prim_elementwise_meta)
 1440/110    0.013    0.000    0.160    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/guards.py:867(visit)
      340    0.007    0.000    0.158    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/_refs/__init__.py:410(_maybe_broadcast)
 1440/110    0.021    0.000    0.157    0.001 /usr/lib/python3.10/ast.py:420(generic_visit)
        1    0.000    0.000    0.151    0.151 &lt;eval_with_key&gt;.406:4(forward)
        5    0.000    0.000    0.150    0.030 /home/xadupre/.local/lib/python3.10/site-packages/torch/export/exported_program.py:98(__init__)
      305    0.007    0.000    0.146    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/graph.py:865(create_node)
     6935    0.021    0.000    0.142    0.000 /usr/lib/python3.10/traceback.py:259(__init__)
       60    0.004    0.000    0.142    0.002 {built-in method torch.mm}
4130/3850    0.033    0.000    0.142    0.000 /usr/lib/python3.10/contextlib.py:139(__exit__)
done.
profile custom2: &lt;function export_cus_p2 at 0x7f07cc957b50&gt;
done.
</pre></div>
</div>
<p>Same with dynamo-exporter.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">profile_function</span><span class="p">(</span><span class="s2">&quot;dynamo&quot;</span><span class="p">,</span> <span class="n">export_dynamo</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">if</span> <span class="s2">&quot;dynopt&quot;</span> <span class="ow">in</span> <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">supported_exporters</span></a><span class="p">:</span>
    <span class="n">profile_function</span><span class="p">(</span><span class="s2">&quot;dynopt&quot;</span><span class="p">,</span> <span class="n">export_dynopt</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>profile dynamo: &lt;function export_dynamo at 0x7f07cc9579a0&gt;
         2096383 function calls (2016493 primitive calls) in 10.390 seconds

   Ordered by: cumulative time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
        5    0.002    0.000   10.599    2.120 /home/xadupre/github/experimental-experiment/_doc/examples/plot_torch_export.py:239(export_dynamo)
        5    0.000    0.000    9.500    1.900 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/exporter.py:1294(dynamo_export)
        5    0.032    0.006    8.562    1.712 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/exporter.py:1126(export)
        5    0.001    0.000    4.387    0.877 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/fx/dynamo_graph_extractor.py:180(generate_fx)
        5    0.594    0.119    3.910    0.782 /home/xadupre/github/onnx-script/onnxscript/function_libs/torch_lib/graph_building.py:938(to_model_proto)
    30/15    0.001    0.000    3.403    0.227 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/eval_frame.py:454(_fn)
   605/35    0.026    0.000    2.726    0.078 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/diagnostics/infra/decorator.py:71(wrapper)
        5    0.000    0.000    2.556    0.511 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/fx/dynamo_graph_extractor.py:225(pre_export_passes)
        5    0.001    0.000    2.556    0.511 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/exporter.py:1402(common_pre_export_passes)
3735/1440    0.017    0.000    2.524    0.002 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_stats.py:15(wrapper)
       30    0.001    0.000    2.498    0.083 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/fx/_pass.py:240(run)
        5    0.000    0.000    2.219    0.444 /home/xadupre/github/onnx/onnx/shape_inference.py:20(infer_shapes)
    25/15    0.000    0.000    2.082    0.139 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/external_utils.py:15(inner)
       20    0.007    0.000    1.942    0.097 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/interpreter.py:99(run)
2880/1780    0.030    0.000    1.922    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/fake_tensor.py:1385(__torch_dispatch__)
2880/1780    0.225    0.000    1.882    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/fake_tensor.py:1417(dispatch)
      490    0.006    0.000    1.868    0.004 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/interpreter.py:177(run_node)
        5    0.001    0.000    1.824    0.365 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/eval_frame.py:1230(inner)
 2940/980    0.011    0.000    1.727    0.002 /home/xadupre/.local/lib/python3.10/site-packages/torch/_ops.py:508(__call__)
       10    0.001    0.000    1.706    0.171 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:773(wrapped)
        5    0.000    0.000    1.706    0.341 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/fx/dynamo_graph_extractor.py:159(wrapped)
       10    0.000    0.000    1.699    0.170 /home/xadupre/.local/lib/python3.10/site-packages/torch/_compile.py:20(inner)
       10    0.000    0.000    1.693    0.169 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:477(dispatch_trace)
       10    0.001    0.000    1.597    0.160 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/_symbolic_trace.py:699(trace)
        5    1.585    0.317    1.585    0.317 {built-in method onnx.onnx_cpp2py_export.shape_inference.infer_shapes}
       10    0.001    0.000    1.559    0.156 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:511(wrapped)
       10    0.000    0.000    1.526    0.153 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/fx/passes/_utils.py:28(wrapped)
      575    0.007    0.000    1.435    0.002 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:593(__torch_dispatch__)
      575    0.003    0.000    1.406    0.002 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:624(inner_torch_dispatch)
      190    0.018    0.000    1.385    0.007 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:258(proxy_call)
      265    0.002    0.000    1.360    0.005 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/interpreter.py:249(call_function)
       20    0.001    0.000    1.312    0.066 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/eval_frame.py:606(catch_errors)
       15    0.001    0.000    1.308    0.087 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/convert_frame.py:272(_convert_frame_assert)
        5    0.000    0.000    1.305    0.261 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/convert_frame.py:476(_compile)
     10/5    0.000    0.000    1.303    0.261 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/utils.py:237(time_wrapper)
        5    0.000    0.000    1.302    0.260 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/convert_frame.py:551(compile_inner)
       15    1.232    0.082    1.232    0.082 {method &#39;SerializeToString&#39; of &#39;google._upb._message.Message&#39; objects}
        5    0.000    0.000    1.096    0.219 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/exporter.py:912(save)
        5    0.022    0.004    1.061    0.212 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/exporter.py:587(serialize)
        5    0.000    0.000    0.942    0.188 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/fx/passes/decomp.py:32(_run)
        5    0.001    0.000    0.936    0.187 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/exporter.py:358(__init__)
        5    0.000    0.000    0.933    0.187 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/bytecode_transformation.py:1025(transform_code_object)
    80/55    0.000    0.000    0.926    0.017 /home/xadupre/.local/lib/python3.10/site-packages/torch/nn/modules/module.py:1507(_wrapped_call_impl)
    80/55    0.001    0.000    0.926    0.017 /home/xadupre/.local/lib/python3.10/site-packages/torch/nn/modules/module.py:1513(_call_impl)
 1035/460    0.007    0.000    0.919    0.002 /home/xadupre/.local/lib/python3.10/site-packages/torch/_prims_common/wrappers.py:242(_fn)
        5    0.001    0.000    0.911    0.182 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/convert_frame.py:136(_fn)
        5    0.000    0.000    0.908    0.182 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/convert_frame.py:505(transform)
        5    0.003    0.001    0.872    0.174 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/fx/decomposition_table.py:80(create_onnx_friendly_decomposition_table)
        5    0.000    0.000    0.868    0.174 /home/xadupre/github/onnx/onnx/checker.py:136(check_model)
        5    0.155    0.031    0.864    0.173 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/fx/decomposition_table.py:18(_create_onnx_supports_op_overload_table)
        5    0.000    0.000    0.861    0.172 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/symbolic_convert.py:2120(run)
        5    0.001    0.000    0.861    0.172 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/symbolic_convert.py:811(run)
      280    0.005    0.000    0.859    0.003 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/symbolic_convert.py:709(step)
        5    0.000    0.000    0.853    0.171 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/fx/passes/functionalization.py:101(_run)
        5    0.000    0.000    0.723    0.145 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/fx/passes/functionalization.py:80(wrapped)
       60    0.001    0.000    0.686    0.011 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/symbolic_convert.py:460(wrapper)
       75    0.002    0.000    0.685    0.009 /home/xadupre/.local/lib/python3.10/site-packages/torch/_decomp/decompositions.py:50(inner)
       60    0.000    0.000    0.683    0.011 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/symbolic_convert.py:1209(CALL_FUNCTION)
       60    0.001    0.000    0.682    0.011 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/symbolic_convert.py:632(call_function)
        5    0.000    0.000    0.664    0.133 /home/xadupre/github/onnx/onnx/__init__.py:276(save_model)
       45    0.001    0.000    0.663    0.015 /home/xadupre/.local/lib/python3.10/site-packages/torch/nn/modules/linear.py:115(forward)
       45    0.012    0.000    0.662    0.015 {built-in method torch._C._nn.linear}
     2775    0.016    0.000    0.657    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_pytree.py:600(tree_map)
       65    0.000    0.000    0.641    0.010 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/variables/builder.py:1288(wrap_fx_proxy)
       65    0.005    0.000    0.640    0.010 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/variables/builder.py:1348(wrap_fx_proxy_cls)
       60    0.003    0.000    0.579    0.010 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/utils.py:1440(get_fake_value)
       90    0.000    0.000    0.560    0.006 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/utils.py:1025(wrap_fake_exception)
       25    0.001    0.000    0.505    0.020 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/variables/nn_module.py:238(call_function)
       75    0.010    0.000    0.483    0.006 /home/xadupre/.local/lib/python3.10/site-packages/torch/_decomp/decompositions.py:1311(addmm)
        5    0.443    0.089    0.443    0.089 {built-in method onnx.onnx_cpp2py_export.checker.check_model}
    35630    0.061    0.000    0.427    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/exporter.py:252(is_registered_op)
       60    0.001    0.000    0.412    0.007 /home/xadupre/.local/lib/python3.10/site-packages/torch/nn/functional.py:1462(relu)
  360/310    0.012    0.000    0.411    0.001 {method &#39;detach&#39; of &#39;torch._C.TensorBase&#39; objects}
       60    0.007    0.000    0.411    0.007 {built-in method torch.relu}
     2775    0.008    0.000    0.408    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_pytree.py:602(&lt;listcomp&gt;)
       25    0.000    0.000    0.407    0.016 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/interpreter.py:291(call_module)
       25    0.000    0.000    0.406    0.016 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/_symbolic_trace.py:789(module_call_wrapper)
       25    0.000    0.000    0.404    0.016 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:437(call_module)
       25    0.000    0.000    0.404    0.016 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/_symbolic_trace.py:791(forward)
        5    0.000    0.000    0.402    0.080 /home/xadupre/github/onnx/onnx/serialization.py:97(serialize_proto)
       35    0.000    0.000    0.396    0.011 /home/xadupre/github/onnx/onnx/__init__.py:238(load_model_from_string)
       35    0.001    0.000    0.396    0.011 /home/xadupre/github/onnx/onnx/serialization.py:113(deserialize_proto)
       35    0.395    0.011    0.395    0.011 {method &#39;ParseFromString&#39; of &#39;google._upb._message.Message&#39; objects}
        5    0.001    0.000    0.389    0.078 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/eval_frame.py:1277(result_capturing_wrapper)
        5    0.000    0.000    0.387    0.077 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/fx/passes/type_promotion.py:1712(_run)
        5    0.375    0.075    0.375    0.075 {method &#39;ByteSize&#39; of &#39;google._upb._message.Message&#39; objects}
    35705    0.092    0.000    0.368    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/exporter.py:229(get_op_functions)
        5    0.001    0.000    0.366    0.073 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/guards.py:956(__init__)
     4650    0.011    0.000    0.356    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_pytree.py:531(tree_flatten)
  525/325    0.015    0.000    0.355    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/_prims_common/wrappers.py:115(_fn)
      175    0.002    0.000    0.353    0.002 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/fx/passes/type_promotion.py:1630(run_node)
      200    0.001    0.000    0.350    0.002 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:184(track_tensor_tree)
  250/200    0.003    0.000    0.349    0.002 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:185(wrap_with_proxy)
15970/4650    0.093    0.000    0.345    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_pytree.py:516(_tree_flatten_helper)
        5    0.000    0.000    0.334    0.067 /home/xadupre/.local/lib/python3.10/site-packages/torch/_functorch/functional_call.py:10(functional_call)
        5    0.000    0.000    0.334    0.067 /home/xadupre/.local/lib/python3.10/site-packages/torch/nn/utils/stateless.py:229(_functional_call)
       70    0.002    0.000    0.330    0.005 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/graph_module.py:708(recompile)
        5    0.000    0.000    0.329    0.066 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/graph_module.py:737(call_wrapped)
        5    0.000    0.000    0.329    0.066 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/graph_module.py:299(__call__)
302890/296010    0.247    0.000    0.328    0.000 {built-in method builtins.isinstance}
        5    0.001    0.000    0.320    0.064 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/guards.py:1025(compile_check_fn)
      240    0.003    0.000    0.304    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:146(set_meta)
       70    0.002    0.000    0.297    0.004 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/graph.py:1268(python_code)
       60    0.000    0.000    0.297    0.005 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/utils.py:1487(&lt;lambda&gt;)
       60    0.001    0.000    0.296    0.005 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/utils.py:1551(run_node)
  280/240    0.002    0.000    0.292    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:117(extract_val)
      260    0.001    0.000    0.289    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:114(snapshot_fake)
       70    0.003    0.000    0.278    0.004 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/graph.py:1330(_python_code)
       70    0.026    0.000    0.275    0.004 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/graph.py:360(_gen_python_code)
        5    0.001    0.000    0.273    0.055 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/fx/passes/modularization.py:821(_run)
  780/405    0.005    0.000    0.263    0.001 /usr/lib/python3.10/copy.py:259(_reconstruct)
     1200    0.007    0.000    0.262    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/fake_tensor.py:1770(wrap_meta_outputs_with_default_device_logic)
        5    0.000    0.000    0.259    0.052 /home/xadupre/github/onnx/onnx/__init__.py:150(_save_bytes)
  1595/50    0.011    0.000    0.258    0.005 /usr/lib/python3.10/copy.py:128(deepcopy)
       25    0.001    0.000    0.257    0.010 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/utils.py:1036(deepcopy_to_fake_tensor)
       25    0.000    0.000    0.256    0.010 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/utils.py:1038(&lt;lambda&gt;)
       55    0.003    0.000    0.256    0.005 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/graph_module.py:354(__init__)
       50    0.002    0.000    0.253    0.005 /usr/lib/python3.10/copy.py:227(_deepcopy_dict)
  965/800    0.009    0.000    0.248    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/nn/modules/module.py:1690(__setattr__)
      365    0.004    0.000    0.247    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/proxy.py:171(create_proxy)
     9330    0.027    0.000    0.238    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/node.py:672(map_arg)
       50    0.002    0.000    0.232    0.005 /home/xadupre/.local/lib/python3.10/site-packages/torch/nn/parameter.py:55(__deepcopy__)
       55    0.001    0.000    0.228    0.004 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/graph_module.py:462(graph)
8515/3235    0.022    0.000    0.226    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_pytree.py:526(&lt;listcomp&gt;)
      250    0.002    0.000    0.226    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/fake_tensor.py:1962(__torch_function__)
     30/5    0.003    0.000    0.221    0.044 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/fx/fx_onnx_interpreter.py:453(run)
        5    0.216    0.043    0.216    0.043 {method &#39;write&#39; of &#39;_io.BufferedWriter&#39; objects}
   220/80    0.003    0.000    0.207    0.003 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/fx/fx_onnx_interpreter.py:371(run_node)
18360/9335    0.099    0.000    0.204    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/node.py:680(map_aggregate)
        5    0.002    0.000    0.203    0.041 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/guards.py:1223(build_guard_function)
     1250    0.014    0.000    0.201    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/fake_tensor.py:1777(wrap)
     30/5    0.004    0.000    0.199    0.040 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/fx/passes/modularization.py:591(build_module)
    57045    0.087    0.000    0.188    0.000 {method &#39;get&#39; of &#39;dict&#39; objects}
15640/4410    0.116    0.000    0.183    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_pytree.py:540(tree_unflatten)
      655    0.004    0.000    0.180    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_pytree.py:705(tree_map_only)
      100    0.001    0.000    0.179    0.002 /home/xadupre/.local/lib/python3.10/site-packages/torch/_refs/nn/functional/__init__.py:134(_fn)
  280/230    0.004    0.000    0.178    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/fake_tensor.py:1167(__torch_dispatch__)
       35    0.004    0.000    0.173    0.005 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/variables/torch.py:209(call_function)
      400    0.011    0.000    0.169    0.000 {method &#39;to&#39; of &#39;torch._C.TensorBase&#39; objects}
      760    0.010    0.000    0.165    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/graph.py:865(create_node)
 5600/330    0.018    0.000    0.161    0.000 /usr/lib/python3.10/ast.py:414(visit)
      100    0.001    0.000    0.158    0.002 /home/xadupre/.local/lib/python3.10/site-packages/torch/_refs/nn/functional/__init__.py:246(relu)
22810/21220    0.039    0.000    0.157    0.000 {built-in method builtins.next}
       30    0.000    0.000    0.153    0.005 /home/xadupre/.local/lib/python3.10/site-packages/torch/nn/modules/conv.py:459(forward)
       30    0.000    0.000    0.152    0.005 /home/xadupre/.local/lib/python3.10/site-packages/torch/nn/modules/conv.py:451(_conv_forward)
       30    0.006    0.000    0.152    0.005 {built-in method torch.conv2d}
      480    0.011    0.000    0.152    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/proxy.py:115(create_node)
    21945    0.084    0.000    0.151    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/fx/registration.py:58(from_qualified_name)
    33195    0.056    0.000    0.146    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_pytree.py:457(_get_node_type)
    22415    0.040    0.000    0.142    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_pytree.py:464(_is_leaf)
       25    0.001    0.000    0.140    0.006 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/fx/fx_onnx_interpreter.py:722(call_module)
       85    0.002    0.000    0.137    0.002 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/fx/fx_onnx_interpreter.py:605(call_function)
    90/50    0.006    0.000    0.133    0.003 {built-in method torch._ops.aten.}
       30    0.000    0.000    0.133    0.004 /home/xadupre/.local/lib/python3.10/site-packages/torch/_jit_internal.py:489(fn)
       30    0.000    0.000    0.133    0.004 /home/xadupre/.local/lib/python3.10/site-packages/torch/nn/functional.py:774(_max_pool2d)
       30    0.004    0.000    0.132    0.004 {built-in method torch.max_pool2d}
     1250    0.015    0.000    0.129    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/fake_tensor.py:368(from_meta_and_device)
11440/11075    0.016    0.000    0.125    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/node.py:686(&lt;genexpr&gt;)
       50    0.000    0.000    0.124    0.002 /home/xadupre/.local/lib/python3.10/site-packages/torch/nn/parameter.py:34(__new__)
      225    0.001    0.000    0.123    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/_decomp/decompositions.py:60(increase_prec)
 1570/745    0.014    0.000    0.120    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/_symbolic_trace.py:299(create_arg)
      250    0.004    0.000    0.113    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/_refs/__init__.py:1008(_ref)
 1240/490    0.009    0.000    0.112    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/experimental/proxy_tensor.py:446(create_arg)
      140    0.003    0.000    0.112    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/guards.py:1036(add_code_part)
      275    0.001    0.000    0.111    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/fake_tensor.py:385(__call__)
      275    0.002    0.000    0.110    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/fake_tensor.py:307(from_real_tensor)
     1275    0.015    0.000    0.108    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/graph.py:515(emit_node)
        5    0.000    0.000    0.107    0.021 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/eval_frame.py:1001(rewrite_signature)
    35725    0.060    0.000    0.106    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/fx/registration.py:44(from_name_parts)
  175/125    0.005    0.000    0.105    0.001 {method &#39;clone&#39; of &#39;torch._C.TensorBase&#39; objects}
 1570/745    0.015    0.000    0.104    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/proxy.py:238(create_arg)
7845/7115    0.017    0.000    0.103    0.000 /usr/lib/python3.10/contextlib.py:130(__enter__)
      125    0.001    0.000    0.101    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/fake_tensor.py:1859(from_tensor)
      690    0.003    0.000    0.099    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/guards.py:150(_ast_unparse)
      110    0.001    0.000    0.097    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/guards.py:1230(replace)
      140    0.002    0.000    0.096    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_traceback.py:170(summary)
      110    0.001    0.000    0.096    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/_dynamo/guards.py:925(replace)
      690    0.002    0.000    0.096    0.000 /usr/lib/python3.10/ast.py:1679(unparse)
      425    0.012    0.000    0.096    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/_prims/__init__.py:338(_prim_elementwise_meta)
      810    0.009    0.000    0.095    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/node.py:156(__init__)
      105    0.004    0.000    0.094    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/meta_utils.py:633(__call__)
1425/1065    0.003    0.000    0.094    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/fx/proxy.py:256(&lt;genexpr&gt;)
    40035    0.061    0.000    0.093    0.000 &lt;string&gt;:2(__hash__)
      690    0.002    0.000    0.092    0.000 /usr/lib/python3.10/ast.py:811(visit)
    33195    0.065    0.000    0.090    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_pytree.py:446(_is_namedtuple_instance)
      105    0.012    0.000    0.090    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/_subclasses/meta_utils.py:181(meta_tensor)
 3295/690    0.010    0.000    0.089    0.000 /usr/lib/python3.10/ast.py:801(traverse)
       10    0.001    0.000    0.086    0.009 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/fx/passes/_utils.py:83(replace_placeholder_name_and_target)
6445/2125    0.027    0.000    0.086    0.000 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_pytree.py:574(_tree_leaves_helper)
        1    0.000    0.000    0.085    0.085 /home/xadupre/github/experimental-experiment/_doc/examples/plot_torch_export.py:174(forward)
      140    0.014    0.000    0.083    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/utils/_traceback.py:246(_extract_symbolized_tb)
      100    0.004    0.000    0.083    0.001 {built-in method torch.where}
    74275    0.080    0.000    0.083    0.000 {built-in method builtins.getattr}
       75    0.000    0.000    0.083    0.001 /home/xadupre/.local/lib/python3.10/site-packages/torch/onnx/_internal/fx/onnxfunction_dispatcher.py:111(dispatch)
7845/7115    0.021    0.000    0.082    0.000 /usr/lib/python3.10/contextlib.py:139(__exit__)
done.
profile dynopt: &lt;function export_dynopt at 0x7f07cc957a30&gt;
done.
</pre></div>
</div>
</section>
<section id="benchmark-exported-models-with-ort">
<h2>Benchmark exported models with ORT<a class="headerlink" href="#benchmark-exported-models-with-ort" title="Permalink to this heading">#</a></h2>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">benchmark</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">onnxruntime</span> <span class="kn">import</span> <span class="n">InferenceSession</span><span class="p">,</span> <span class="n">SessionOptions</span><span class="p">,</span> <span class="n">GraphOptimizationLevel</span>

    <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data</span></a> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data_mem_load</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data_mem_first_run</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data_mem_run</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">confs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <a href="https://docs.python.org/3/library/itertools.html#itertools.product" title="itertools.product" class="sphx-glr-backref-module-itertools sphx-glr-backref-type-py-function"><span class="n">itertools</span><span class="o">.</span><span class="n">product</span></a><span class="p">(</span>
            <span class="p">[</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <a href="https://docs.python.org/3/library/os.html#os.listdir" title="os.listdir" class="sphx-glr-backref-module-os sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">listdir</span></a><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;.onnx&quot;</span> <span class="ow">in</span> <span class="n">_</span> <span class="ow">and</span> <span class="n">_</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;plot_torch&quot;</span><span class="p">)],</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="s2">&quot;CPUExecutionProvider&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s2">&quot;CUDAExecutionProvider&quot;</span><span class="p">,</span> <span class="s2">&quot;CPUExecutionProvider&quot;</span><span class="p">],</span>
            <span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">confs</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;number of experiments: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">ps</span><span class="p">,</span> <span class="n">aot</span> <span class="ow">in</span> <span class="n">loop</span><span class="p">:</span>
        <span class="n">root</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/os.path.html#os.path.split" title="os.path.split" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span></a><span class="p">(</span><span class="n">name</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/os.path.html#os.path.splitext" title="os.path.splitext" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span></a><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="o">!=</span> <span class="s2">&quot;.onnx&quot;</span><span class="p">:</span>
            <span class="k">continue</span>

        <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># system_info()</span>
        <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">[</span><span class="s2">&quot;providers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="s2">&quot;CUDA&quot;</span> <span class="k">if</span> <span class="s2">&quot;CUDA&quot;</span> <span class="ow">in</span> <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">[</span><span class="s2">&quot;providers&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;CPU&quot;</span>
        <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">[</span><span class="s2">&quot;compute&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
        <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">[</span><span class="s2">&quot;aot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">aot</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="k">else</span> <span class="mi">0</span>
        <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">[</span><span class="s2">&quot;export&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;plot_torch_export_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.onnx&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">onx</span></a> <span class="o">=</span> <a href="https://onnx.ai/onnx/api/serialization.html#onnx.load" title="onnx.load" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-function"><span class="n">onnx</span><span class="o">.</span><span class="n">load</span></a><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">[</span><span class="s2">&quot;n_nodes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">onx</span></a><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">[</span><span class="s2">&quot;n_function&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">onx</span></a><span class="o">.</span><span class="n">functions</span> <span class="ow">or</span> <span class="p">[])</span>
        <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">[</span><span class="s2">&quot;n_sub&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">onx</span></a><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">node</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">op_type</span> <span class="o">==</span> <span class="s2">&quot;Sub&quot;</span><span class="p">])</span>
        <span class="n">obs1</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">short_obs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
            <span class="n">aot</span><span class="o">=</span><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">[</span><span class="s2">&quot;aot&quot;</span><span class="p">],</span>
            <span class="n">providers</span><span class="o">=</span><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">[</span><span class="s2">&quot;providers&quot;</span><span class="p">],</span>
            <span class="n">export</span><span class="o">=</span><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">[</span><span class="s2">&quot;export&quot;</span><span class="p">],</span>
            <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">compute</span></a><span class="o">=</span><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">[</span><span class="s2">&quot;compute&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">opts</span> <span class="o">=</span> <span class="n">SessionOptions</span><span class="p">()</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">add_session_config_entry</span><span class="p">(</span><span class="s2">&quot;session.disable_aot_function_inlining&quot;</span><span class="p">,</span> <span class="n">aot</span><span class="p">)</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">graph_optimization_level</span> <span class="o">=</span> <span class="n">GraphOptimizationLevel</span><span class="o">.</span><span class="n">ORT_ENABLE_ALL</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">optimized_model_filepath</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ort-</span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.onnx&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">-&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;aot</span><span class="si">{</span><span class="mi">1</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">aot</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mi">0</span><span class="si">}</span><span class="s2">.onnx&quot;</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">InferenceSession</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">providers</span><span class="o">=</span><span class="n">ps</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">loop</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR-load: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">e</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="s2">&quot;run&quot;</span><span class="p">})</span>
            <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data</span></a><span class="o">.</span><span class="n">append</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">opts</span> <span class="o">=</span> <span class="n">SessionOptions</span><span class="p">()</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">add_session_config_entry</span><span class="p">(</span><span class="s2">&quot;session.disable_aot_function_inlining&quot;</span><span class="p">,</span> <span class="n">aot</span><span class="p">)</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">graph_optimization_level</span> <span class="o">=</span> <span class="n">GraphOptimizationLevel</span><span class="o">.</span><span class="n">ORT_ENABLE_ALL</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="n">start_spying_on</span><span class="p">(</span><span class="n">cuda</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <a href="https://docs.python.org/3/library/functions.html#bool" title="builtins.bool" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">has_cuda</span></a> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">providers</span><span class="o">=</span><span class="n">ps</span><span class="p">)</span>
        <span class="n">memobs</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">stop</span><span class="p">())</span>
        <span class="n">memobs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">short_obs</span><span class="p">)</span>
        <span class="n">data_mem_load</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">memobs</span><span class="p">)</span>

        <span class="n">input_name</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="n">feeds</span> <span class="o">=</span> <span class="p">{</span><span class="n">input_name</span><span class="p">:</span> <a href="https://numpy.org/doc/stable/reference/random/generated/numpy.random.rand.html#numpy.random.rand" title="numpy.random.rand" class="sphx-glr-backref-module-numpy-random sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span></a><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.float32" title="numpy.float32" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><span class="n">np</span><span class="o">.</span><span class="n">float32</span></a><span class="p">)}</span>

        <span class="n">stat</span> <span class="o">=</span> <span class="n">start_spying_on</span><span class="p">(</span><span class="n">cuda</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <a href="https://docs.python.org/3/library/functions.html#bool" title="builtins.bool" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">has_cuda</span></a> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">feeds</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">loop</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR-run: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">e</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="s2">&quot;load&quot;</span><span class="p">})</span>
            <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data</span></a><span class="o">.</span><span class="n">append</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">)</span>
            <span class="n">stat</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">continue</span>
        <span class="n">memobs</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">stop</span><span class="p">())</span>
        <span class="n">memobs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">short_obs</span><span class="p">)</span>
        <span class="n">data_mem_first_run</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">memobs</span><span class="p">)</span>

        <span class="c1"># memory consumption</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="n">start_spying_on</span><span class="p">(</span><span class="n">cuda</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <a href="https://docs.python.org/3/library/functions.html#bool" title="builtins.bool" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">has_cuda</span></a> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">script_args</span><span class="o">.</span><span class="n">warmup</span></a><span class="p">):</span>
            <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">feeds</span><span class="p">)</span>
        <span class="n">memobs</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">stop</span><span class="p">())</span>
        <span class="n">memobs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">short_obs</span><span class="p">)</span>
        <span class="n">data_mem_run</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">memobs</span><span class="p">)</span>

        <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">measure_time</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">feeds</span><span class="p">),</span>
                <span class="n">max_time</span><span class="o">=</span><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">script_args</span><span class="o">.</span><span class="n">maxtime</span></a><span class="p">,</span>
                <span class="n">repeat</span><span class="o">=</span><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">script_args</span><span class="o">.</span><span class="n">repeat</span></a><span class="p">,</span>
                <span class="n">number</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">loop</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">[</span><span class="s1">&#39;average&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ps</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data</span></a><span class="o">.</span><span class="n">append</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">obs</span></a><span class="p">)</span>

        <span class="c1"># check first run</span>
        <span class="n">obs1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">measure_time</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">providers</span><span class="o">=</span><span class="n">ps</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">feeds</span><span class="p">),</span>
                <span class="n">max_time</span><span class="o">=</span><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">script_args</span><span class="o">.</span><span class="n">maxtime</span></a><span class="p">,</span>
                <span class="n">repeat</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">script_args</span><span class="o">.</span><span class="n">repeat</span></a> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">number</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">data1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs1</span><span class="p">)</span>

    <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df</span></a> <span class="o">=</span> <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class"><span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data</span></a><span class="p">)</span>
    <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.to_csv.html#pandas.DataFrame.to_csv" title="pandas.DataFrame.to_csv" class="sphx-glr-backref-module-pandas sphx-glr-backref-type-py-method"><span class="n">df</span><span class="o">.</span><span class="n">to_csv</span></a><span class="p">(</span><span class="s2">&quot;plot_torch_export_ort_time.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.to_excel.html#pandas.DataFrame.to_excel" title="pandas.DataFrame.to_excel" class="sphx-glr-backref-module-pandas sphx-glr-backref-type-py-method"><span class="n">df</span><span class="o">.</span><span class="n">to_excel</span></a><span class="p">(</span><span class="s2">&quot;plot_torch_export_ort_time.xlsx&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df1</span></a> <span class="o">=</span> <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class"><span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span></a><span class="p">(</span><span class="n">data1</span><span class="p">)</span>
    <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.to_csv.html#pandas.DataFrame.to_csv" title="pandas.DataFrame.to_csv" class="sphx-glr-backref-module-pandas sphx-glr-backref-type-py-method"><span class="n">df1</span><span class="o">.</span><span class="n">to_csv</span></a><span class="p">(</span><span class="s2">&quot;plot_torch_export_ort_time1_init.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.to_excel.html#pandas.DataFrame.to_excel" title="pandas.DataFrame.to_excel" class="sphx-glr-backref-module-pandas sphx-glr-backref-type-py-method"><span class="n">df1</span><span class="o">.</span><span class="n">to_excel</span></a><span class="p">(</span><span class="s2">&quot;plot_torch_export_ort_time1_init.xlsx&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dfmem</span></a> <span class="o">=</span> <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class"><span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span></a><span class="p">(</span><span class="n">data_mem_load</span><span class="p">)</span>
    <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.to_csv.html#pandas.DataFrame.to_csv" title="pandas.DataFrame.to_csv" class="sphx-glr-backref-module-pandas sphx-glr-backref-type-py-method"><span class="n">dfmem</span><span class="o">.</span><span class="n">to_csv</span></a><span class="p">(</span><span class="s2">&quot;plot_torch_export_ort_load_mem.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.to_excel.html#pandas.DataFrame.to_excel" title="pandas.DataFrame.to_excel" class="sphx-glr-backref-module-pandas sphx-glr-backref-type-py-method"><span class="n">dfmem</span><span class="o">.</span><span class="n">to_excel</span></a><span class="p">(</span><span class="s2">&quot;plot_torch_export_ort_load_mem.xlsx&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dfmemr</span></a> <span class="o">=</span> <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class"><span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span></a><span class="p">(</span><span class="n">data_mem_run</span><span class="p">)</span>
    <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.to_csv.html#pandas.DataFrame.to_csv" title="pandas.DataFrame.to_csv" class="sphx-glr-backref-module-pandas sphx-glr-backref-type-py-method"><span class="n">dfmemr</span><span class="o">.</span><span class="n">to_csv</span></a><span class="p">(</span><span class="s2">&quot;plot_torch_export_ort_run_mem.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.to_excel.html#pandas.DataFrame.to_excel" title="pandas.DataFrame.to_excel" class="sphx-glr-backref-module-pandas sphx-glr-backref-type-py-method"><span class="n">dfmemr</span><span class="o">.</span><span class="n">to_excel</span></a><span class="p">(</span><span class="s2">&quot;plot_torch_export_ort_run_mem.xlsx&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dfmemfr</span></a> <span class="o">=</span> <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class"><span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span></a><span class="p">(</span><span class="n">data_mem_first_run</span><span class="p">)</span>
    <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.to_csv.html#pandas.DataFrame.to_csv" title="pandas.DataFrame.to_csv" class="sphx-glr-backref-module-pandas sphx-glr-backref-type-py-method"><span class="n">dfmemfr</span><span class="o">.</span><span class="n">to_csv</span></a><span class="p">(</span><span class="s2">&quot;plot_torch_export_ort_first_run_mem.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.to_excel.html#pandas.DataFrame.to_excel" title="pandas.DataFrame.to_excel" class="sphx-glr-backref-module-pandas sphx-glr-backref-type-py-method"><span class="n">dfmemfr</span><span class="o">.</span><span class="n">to_excel</span></a><span class="p">(</span><span class="s2">&quot;plot_torch_export_ort_first_run_mem.xlsx&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df</span></a><span class="p">,</span> <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df1</span></a><span class="p">,</span> <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dfmem</span></a><span class="p">,</span> <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dfmemfr</span></a><span class="p">,</span> <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dfmemr</span></a>


<a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df</span></a><span class="p">,</span> <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df_init</span></a><span class="p">,</span> <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dfmem</span></a><span class="p">,</span> <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dfmemfr</span></a><span class="p">,</span> <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dfmemr</span></a> <span class="o">=</span> <span class="n">benchmark</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><a href="https://pytorch.org/docs/stable/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">input_tensor</span></a><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df</span></a><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/20 [00:00&lt;?, ?it/s]number of experiments: 20

0.017358635897436123 plot_torch_export_cus_p2.onnx [&#39;CPUExecutionProvider&#39;]:   0%|          | 0/20 [00:05&lt;?, ?it/s]
0.017358635897436123 plot_torch_export_cus_p2.onnx [&#39;CPUExecutionProvider&#39;]:   5%|▌         | 1/20 [00:08&lt;02:49,  8.93s/it]
0.05351874255317872 plot_torch_export_cus_p2.onnx [&#39;CPUExecutionProvider&#39;]:   5%|▌         | 1/20 [00:31&lt;02:49,  8.93s/it]
0.05351874255317872 plot_torch_export_cus_p2.onnx [&#39;CPUExecutionProvider&#39;]:  10%|█         | 2/20 [00:35&lt;05:43, 19.10s/it]
0.001729264156862936 plot_torch_export_cus_p2.onnx [&#39;CUDAExecutionProvider&#39;, &#39;CPUExecutionProvider&#39;]:  10%|█         | 2/20 [01:15&lt;05:43, 19.10s/it]
0.001729264156862936 plot_torch_export_cus_p2.onnx [&#39;CUDAExecutionProvider&#39;, &#39;CPUExecutionProvider&#39;]:  15%|█▌        | 3/20 [01:17&lt;08:27, 29.86s/it]
0.002042465762974309 plot_torch_export_cus_p2.onnx [&#39;CUDAExecutionProvider&#39;, &#39;CPUExecutionProvider&#39;]:  15%|█▌        | 3/20 [01:22&lt;08:27, 29.86s/it]
0.002042465762974309 plot_torch_export_cus_p2.onnx [&#39;CUDAExecutionProvider&#39;, &#39;CPUExecutionProvider&#39;]:  20%|██        | 4/20 [01:24&lt;05:33, 20.85s/it]
0.04589157619048343 plot_torch_export_script.onnx [&#39;CPUExecutionProvider&#39;]:  20%|██        | 4/20 [01:31&lt;05:33, 20.85s/it]
0.04589157619048343 plot_torch_export_script.onnx [&#39;CPUExecutionProvider&#39;]:  25%|██▌       | 5/20 [01:34&lt;04:12, 16.80s/it]
0.00895900238095504 plot_torch_export_script.onnx [&#39;CPUExecutionProvider&#39;]:  25%|██▌       | 5/20 [01:41&lt;04:12, 16.80s/it]
0.00895900238095504 plot_torch_export_script.onnx [&#39;CPUExecutionProvider&#39;]:  30%|███       | 6/20 [01:43&lt;03:19, 14.24s/it]
0.0023229153005456344 plot_torch_export_script.onnx [&#39;CUDAExecutionProvider&#39;, &#39;CPUExecutionProvider&#39;]:  30%|███       | 6/20 [01:49&lt;03:19, 14.24s/it]
0.0023229153005456344 plot_torch_export_script.onnx [&#39;CUDAExecutionProvider&#39;, &#39;CPUExecutionProvider&#39;]:  35%|███▌      | 7/20 [01:52&lt;02:40, 12.32s/it]
0.0035195598705508326 plot_torch_export_script.onnx [&#39;CUDAExecutionProvider&#39;, &#39;CPUExecutionProvider&#39;]:  35%|███▌      | 7/20 [01:57&lt;02:40, 12.32s/it]
0.0035195598705508326 plot_torch_export_script.onnx [&#39;CUDAExecutionProvider&#39;, &#39;CPUExecutionProvider&#39;]:  40%|████      | 8/20 [02:00&lt;02:11, 10.93s/it]
0.03423662933333617 plot_torch_export_cus_p0.onnx [&#39;CPUExecutionProvider&#39;]:  40%|████      | 8/20 [02:06&lt;02:11, 10.93s/it]
0.03423662933333617 plot_torch_export_cus_p0.onnx [&#39;CPUExecutionProvider&#39;]:  45%|████▌     | 9/20 [02:10&lt;01:56, 10.63s/it]
0.03802194736841046 plot_torch_export_cus_p0.onnx [&#39;CPUExecutionProvider&#39;]:  45%|████▌     | 9/20 [02:15&lt;01:56, 10.63s/it]
0.03802194736841046 plot_torch_export_cus_p0.onnx [&#39;CPUExecutionProvider&#39;]:  50%|█████     | 10/20 [02:18&lt;01:38,  9.82s/it]
0.00344050130246017 plot_torch_export_cus_p0.onnx [&#39;CUDAExecutionProvider&#39;, &#39;CPUExecutionProvider&#39;]:  50%|█████     | 10/20 [02:22&lt;01:38,  9.82s/it]
0.00344050130246017 plot_torch_export_cus_p0.onnx [&#39;CUDAExecutionProvider&#39;, &#39;CPUExecutionProvider&#39;]:  55%|█████▌    | 11/20 [02:25&lt;01:20,  8.95s/it]
0.00269915181159438 plot_torch_export_cus_p0.onnx [&#39;CUDAExecutionProvider&#39;, &#39;CPUExecutionProvider&#39;]:  55%|█████▌    | 11/20 [02:29&lt;01:20,  8.95s/it]
0.00269915181159438 plot_torch_export_cus_p0.onnx [&#39;CUDAExecutionProvider&#39;, &#39;CPUExecutionProvider&#39;]:  60%|██████    | 12/20 [02:31&lt;01:05,  8.21s/it]
0.03053380493827403 plot_torch_export_dynopt.onnx [&#39;CPUExecutionProvider&#39;]:  60%|██████    | 12/20 [02:36&lt;01:05,  8.21s/it]
0.03053380493827403 plot_torch_export_dynopt.onnx [&#39;CPUExecutionProvider&#39;]:  65%|██████▌   | 13/20 [02:39&lt;00:56,  8.02s/it]
0.06814250303031341 plot_torch_export_dynopt.onnx [&#39;CPUExecutionProvider&#39;]:  65%|██████▌   | 13/20 [02:43&lt;00:56,  8.02s/it]
0.06814250303031341 plot_torch_export_dynopt.onnx [&#39;CPUExecutionProvider&#39;]:  70%|███████   | 14/20 [02:45&lt;00:45,  7.63s/it]
0.003485001446946556 plot_torch_export_dynopt.onnx [&#39;CUDAExecutionProvider&#39;, &#39;CPUExecutionProvider&#39;]:  70%|███████   | 14/20 [02:50&lt;00:45,  7.63s/it]
0.003485001446946556 plot_torch_export_dynopt.onnx [&#39;CUDAExecutionProvider&#39;, &#39;CPUExecutionProvider&#39;]:  75%|███████▌  | 15/20 [02:53&lt;00:38,  7.66s/it]
0.003646422338567865 plot_torch_export_dynopt.onnx [&#39;CUDAExecutionProvider&#39;, &#39;CPUExecutionProvider&#39;]:  75%|███████▌  | 15/20 [02:58&lt;00:38,  7.66s/it]
0.003646422338567865 plot_torch_export_dynopt.onnx [&#39;CUDAExecutionProvider&#39;, &#39;CPUExecutionProvider&#39;]:  80%|████████  | 16/20 [03:01&lt;00:30,  7.60s/it]
0.030020866197183995 plot_torch_export_dynamo.onnx [&#39;CPUExecutionProvider&#39;]:  80%|████████  | 16/20 [03:06&lt;00:30,  7.60s/it]
0.030020866197183995 plot_torch_export_dynamo.onnx [&#39;CPUExecutionProvider&#39;]:  85%|████████▌ | 17/20 [03:10&lt;00:24,  8.28s/it]
0.056911792307696135 plot_torch_export_dynamo.onnx [&#39;CPUExecutionProvider&#39;]:  85%|████████▌ | 17/20 [03:15&lt;00:24,  8.28s/it]
0.056911792307696135 plot_torch_export_dynamo.onnx [&#39;CPUExecutionProvider&#39;]:  90%|█████████ | 18/20 [03:17&lt;00:15,  7.89s/it]
0.0023565079954954576 plot_torch_export_dynamo.onnx [&#39;CUDAExecutionProvider&#39;, &#39;CPUExecutionProvider&#39;]:  90%|█████████ | 18/20 [03:22&lt;00:15,  7.89s/it]
0.0023565079954954576 plot_torch_export_dynamo.onnx [&#39;CUDAExecutionProvider&#39;, &#39;CPUExecutionProvider&#39;]:  95%|█████████▌| 19/20 [03:25&lt;00:07,  7.83s/it]
0.005320288376752361 plot_torch_export_dynamo.onnx [&#39;CUDAExecutionProvider&#39;, &#39;CPUExecutionProvider&#39;]:  95%|█████████▌| 19/20 [03:29&lt;00:07,  7.83s/it]
0.005320288376752361 plot_torch_export_dynamo.onnx [&#39;CUDAExecutionProvider&#39;, &#39;CPUExecutionProvider&#39;]: 100%|██████████| 20/20 [03:32&lt;00:00,  7.44s/it]
0.005320288376752361 plot_torch_export_dynamo.onnx [&#39;CUDAExecutionProvider&#39;, &#39;CPUExecutionProvider&#39;]: 100%|██████████| 20/20 [03:32&lt;00:00, 10.60s/it]
                             name  ... warmup_time
0   plot_torch_export_cus_p2.onnx  ...    0.012240
1   plot_torch_export_cus_p2.onnx  ...    0.012898
2   plot_torch_export_cus_p2.onnx  ...    0.002005
3   plot_torch_export_cus_p2.onnx  ...    0.002305
4   plot_torch_export_script.onnx  ...    0.009864
5   plot_torch_export_script.onnx  ...    0.007992
6   plot_torch_export_script.onnx  ...    0.009453
7   plot_torch_export_script.onnx  ...    0.004072
8   plot_torch_export_cus_p0.onnx  ...    0.028006
9   plot_torch_export_cus_p0.onnx  ...    0.040153
10  plot_torch_export_cus_p0.onnx  ...    0.003765
11  plot_torch_export_cus_p0.onnx  ...    0.002546
12  plot_torch_export_dynopt.onnx  ...    0.026943
13  plot_torch_export_dynopt.onnx  ...    0.046982
14  plot_torch_export_dynopt.onnx  ...    0.028628
15  plot_torch_export_dynopt.onnx  ...    0.003839
16  plot_torch_export_dynamo.onnx  ...    0.028666
17  plot_torch_export_dynamo.onnx  ...    0.137925
18  plot_torch_export_dynamo.onnx  ...    0.002540
19  plot_torch_export_dynamo.onnx  ...    0.007033

[20 rows x 17 columns]
</pre></div>
</div>
<p>Other view</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">view_time</span><span class="p">(</span><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df</span></a><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">):</span>
    <span class="n">piv</span> <span class="o">=</span> <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.pivot_table.html#pandas.pivot_table" title="pandas.pivot_table" class="sphx-glr-backref-module-pandas sphx-glr-backref-type-py-function"><span class="n">pandas</span><span class="o">.</span><span class="n">pivot_table</span></a><span class="p">(</span>
        <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df</span></a><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s2">&quot;export&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;compute&quot;</span><span class="p">,</span> <span class="s2">&quot;aot&quot;</span><span class="p">],</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;average&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">piv</span><span class="p">)</span>
    <span class="n">piv</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;plot_torch_export_ort_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">_compute.csv&quot;</span><span class="p">)</span>
    <span class="n">piv</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;plot_torch_export_ort_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">_compute.xlsx&quot;</span><span class="p">)</span>

    <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">piv_gpu</span></a> <span class="o">=</span> <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.pivot_table.html#pandas.pivot_table" title="pandas.pivot_table" class="sphx-glr-backref-module-pandas sphx-glr-backref-type-py-function"><span class="n">pandas</span><span class="o">.</span><span class="n">pivot_table</span></a><span class="p">(</span>
        <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df</span></a><span class="p">[</span><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.html#pandas.Series" title="pandas.core.series.Series" class="sphx-glr-backref-module-pandas-core-series sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df</span><span class="o">.</span><span class="n">compute</span></a> <span class="o">==</span> <span class="s2">&quot;CUDA&quot;</span><span class="p">],</span>
        <span class="n">index</span><span class="o">=</span><span class="s2">&quot;export&quot;</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;compute&quot;</span><span class="p">,</span> <span class="s2">&quot;aot&quot;</span><span class="p">],</span>
        <span class="n">values</span><span class="o">=</span><span class="s2">&quot;average&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">piv_cpu</span></a> <span class="o">=</span> <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.pivot_table.html#pandas.pivot_table" title="pandas.pivot_table" class="sphx-glr-backref-module-pandas sphx-glr-backref-type-py-function"><span class="n">pandas</span><span class="o">.</span><span class="n">pivot_table</span></a><span class="p">(</span>
        <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df</span></a><span class="p">[</span><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.html#pandas.Series" title="pandas.core.series.Series" class="sphx-glr-backref-module-pandas-core-series sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df</span><span class="o">.</span><span class="n">compute</span></a> <span class="o">==</span> <span class="s2">&quot;CPU&quot;</span><span class="p">],</span>
        <span class="n">index</span><span class="o">=</span><span class="s2">&quot;export&quot;</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;compute&quot;</span><span class="p">,</span> <span class="s2">&quot;aot&quot;</span><span class="p">],</span>
        <span class="n">values</span><span class="o">=</span><span class="s2">&quot;average&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <a href="https://matplotlib.org/stable/api/figure_api.html#matplotlib.figure.Figure" title="matplotlib.figure.Figure" class="sphx-glr-backref-module-matplotlib-figure sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">fig</span></a><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ax</span></a> <span class="o">=</span> <a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots" class="sphx-glr-backref-module-matplotlib-pyplot sphx-glr-backref-type-py-function"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <a href="https://matplotlib.org/stable/api/figure_api.html#matplotlib.figure.Figure.suptitle" title="matplotlib.figure.Figure.suptitle" class="sphx-glr-backref-module-matplotlib-figure sphx-glr-backref-type-py-method"><span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span></a><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">piv_cpu</span></a><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ax</span></a><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ax</span></a><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;CPU&quot;</span><span class="p">)</span>
    <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">piv_gpu</span></a><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ax</span></a><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ax</span></a><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;CUDA&quot;</span><span class="p">)</span>
    <a href="https://matplotlib.org/stable/api/figure_api.html#matplotlib.figure.Figure.tight_layout" title="matplotlib.figure.Figure.tight_layout" class="sphx-glr-backref-module-matplotlib-figure sphx-glr-backref-type-py-method"><span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span></a><span class="p">()</span>
    <a href="https://matplotlib.org/stable/api/figure_api.html#matplotlib.figure.Figure.savefig" title="matplotlib.figure.Figure.savefig" class="sphx-glr-backref-module-matplotlib-figure sphx-glr-backref-type-py-method"><span class="n">fig</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;plot_torch_export_ort_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
    <span class="k">return</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ax</span></a>


<span class="n">view_time</span><span class="p">(</span><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df</span></a><span class="p">,</span> <span class="s2">&quot;Compares onnxruntime time on exported models&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_torch_export_003.png" srcset="../_images/sphx_glr_plot_torch_export_003.png" alt="Compares onnxruntime time on exported models, CPU, CUDA" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>compute       CPU                CUDA
aot             0         1         0         1
export
cus_p0   0.038022  0.034237  0.002699  0.003441
cus_p2   0.053519  0.017359  0.002042  0.001729
dynamo   0.056912  0.030021  0.005320  0.002357
dynopt   0.068143  0.030534  0.003646  0.003485
script   0.008959  0.045892  0.003520  0.002323

array([&lt;Axes: title={&#39;center&#39;: &#39;CPU&#39;}, ylabel=&#39;export&#39;&gt;,
       &lt;Axes: title={&#39;center&#39;: &#39;CUDA&#39;}, ylabel=&#39;export&#39;&gt;], dtype=object)
</pre></div>
</div>
<p>New graph without the very long times.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">piv_cpu</span></a> <span class="o">=</span> <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.pivot_table.html#pandas.pivot_table" title="pandas.pivot_table" class="sphx-glr-backref-module-pandas sphx-glr-backref-type-py-function"><span class="n">pandas</span><span class="o">.</span><span class="n">pivot_table</span></a><span class="p">(</span>
    <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df</span></a><span class="p">[</span>
        <span class="p">(</span><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.html#pandas.Series" title="pandas.core.series.Series" class="sphx-glr-backref-module-pandas-core-series sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df</span><span class="o">.</span><span class="n">compute</span></a> <span class="o">==</span> <span class="s2">&quot;CPU&quot;</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">((</span><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.html#pandas.Series" title="pandas.core.series.Series" class="sphx-glr-backref-module-pandas-core-series sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df</span><span class="o">.</span><span class="n">aot</span></a> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.html#pandas.Series" title="pandas.core.series.Series" class="sphx-glr-backref-module-pandas-core-series sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df</span><span class="o">.</span><span class="n">export</span></a> <span class="o">!=</span> <span class="s2">&quot;dynamo&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.html#pandas.Series" title="pandas.core.series.Series" class="sphx-glr-backref-module-pandas-core-series sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df</span><span class="o">.</span><span class="n">export</span></a> <span class="o">!=</span> <span class="s2">&quot;dynopt&quot;</span><span class="p">)))</span>
    <span class="p">],</span>
    <span class="n">index</span><span class="o">=</span><span class="s2">&quot;export&quot;</span><span class="p">,</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;compute&quot;</span><span class="p">,</span> <span class="s2">&quot;aot&quot;</span><span class="p">],</span>
    <span class="n">values</span><span class="o">=</span><span class="s2">&quot;average&quot;</span><span class="p">,</span>
<span class="p">)</span>

<a href="https://matplotlib.org/stable/api/figure_api.html#matplotlib.figure.Figure" title="matplotlib.figure.Figure" class="sphx-glr-backref-module-matplotlib-figure sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">fig</span></a><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ax</span></a> <span class="o">=</span> <a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots" class="sphx-glr-backref-module-matplotlib-pyplot sphx-glr-backref-type-py-function"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<a href="https://matplotlib.org/stable/api/figure_api.html#matplotlib.figure.Figure.suptitle" title="matplotlib.figure.Figure.suptitle" class="sphx-glr-backref-module-matplotlib-figure sphx-glr-backref-type-py-method"><span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span></a><span class="p">(</span><span class="s2">&quot;Compares onnxruntime time on exported models</span><span class="se">\n</span><span class="s2">Hide dynamo without AOT&quot;</span><span class="p">)</span>
<a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">piv_cpu</span></a><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ax</span></a><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ax</span></a><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;CPU&quot;</span><span class="p">)</span>
<span class="k">if</span> <a href="https://docs.python.org/3/library/functions.html#bool" title="builtins.bool" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">has_cuda</span></a><span class="p">:</span>
    <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">piv_gpu</span></a> <span class="o">=</span> <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.pivot_table.html#pandas.pivot_table" title="pandas.pivot_table" class="sphx-glr-backref-module-pandas sphx-glr-backref-type-py-function"><span class="n">pandas</span><span class="o">.</span><span class="n">pivot_table</span></a><span class="p">(</span>
        <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df</span></a><span class="p">[</span><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.html#pandas.Series" title="pandas.core.series.Series" class="sphx-glr-backref-module-pandas-core-series sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df</span><span class="o">.</span><span class="n">compute</span></a> <span class="o">==</span> <span class="s2">&quot;CUDA&quot;</span><span class="p">],</span>
        <span class="n">index</span><span class="o">=</span><span class="s2">&quot;export&quot;</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;compute&quot;</span><span class="p">,</span> <span class="s2">&quot;aot&quot;</span><span class="p">],</span>
        <span class="n">values</span><span class="o">=</span><span class="s2">&quot;average&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">piv_gpu</span></a><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ax</span></a><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ax</span></a><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;CUDA&quot;</span><span class="p">)</span>
<a href="https://matplotlib.org/stable/api/figure_api.html#matplotlib.figure.Figure.tight_layout" title="matplotlib.figure.Figure.tight_layout" class="sphx-glr-backref-module-matplotlib-figure sphx-glr-backref-type-py-method"><span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span></a><span class="p">()</span>
<a href="https://matplotlib.org/stable/api/figure_api.html#matplotlib.figure.Figure.savefig" title="matplotlib.figure.Figure.savefig" class="sphx-glr-backref-module-matplotlib-figure sphx-glr-backref-type-py-method"><span class="n">fig</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s2">&quot;plot_torch_export_ort_time_2.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_torch_export_004.png" srcset="../_images/sphx_glr_plot_torch_export_004.png" alt="Compares onnxruntime time on exported models Hide dynamo without AOT, CPU, CUDA" class = "sphx-glr-single-img"/><p>Let’s do the same with the loading time + the first run.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">view_time</span><span class="p">(</span>
    <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">df_init</span></a><span class="p">,</span>
    <span class="s2">&quot;Compares onnxruntime loading time and first run on exported models&quot;</span><span class="p">,</span>
    <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;time1_init&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_torch_export_005.png" srcset="../_images/sphx_glr_plot_torch_export_005.png" alt="Compares onnxruntime loading time and first run on exported models, CPU, CUDA" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>compute       CPU                CUDA
aot             0         1         0         1
export
cus_p0   0.357512  0.365667  0.290639  0.291234
cus_p2   0.492500  0.452996  0.406053  0.214212
dynamo   0.291705  1.106154  0.290298  0.638572
dynopt   0.354285  0.246997  0.297984  0.377956
script   0.260157  0.543113  0.400631  0.368194

array([&lt;Axes: title={&#39;center&#39;: &#39;CPU&#39;}, ylabel=&#39;export&#39;&gt;,
       &lt;Axes: title={&#39;center&#39;: &#39;CUDA&#39;}, ylabel=&#39;export&#39;&gt;], dtype=object)
</pre></div>
</div>
</section>
<section id="memory-loading-time-ort">
<h2>Memory Loading Time (ORT)<a class="headerlink" href="#memory-loading-time-ort" title="Permalink to this heading">#</a></h2>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">compute</span></a> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;CPU&quot;</span><span class="p">,</span> <span class="s2">&quot;CUDA&quot;</span><span class="p">]:</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ax</span></a> <span class="o">=</span> <span class="n">memory_peak_plot</span><span class="p">(</span>
        <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dfmem</span></a><span class="p">[</span><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.html#pandas.Series" title="pandas.core.series.Series" class="sphx-glr-backref-module-pandas-core-series sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dfmem</span><span class="o">.</span><span class="n">compute</span></a> <span class="o">==</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">compute</span></a><span class="p">],</span>
        <span class="p">(</span><span class="s2">&quot;export&quot;</span><span class="p">,</span> <span class="s2">&quot;aot&quot;</span><span class="p">),</span>
        <span class="n">suptitle</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Memory Consumption of onnxruntime loading time&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">running on </span><span class="si">{</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">compute</span></a><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">bars</span><span class="o">=</span><span class="p">[</span><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model_size</span></a> <span class="o">*</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a> <span class="o">/</span> <span class="mi">2</span><span class="o">**</span><span class="mi">20</span> <span class="k">for</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)],</span>
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
    <span class="p">)</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ax</span></a><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;plot_torch_export_ort_load_mem_</span><span class="si">{</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">compute</span></a><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="sphx-glr-horizontal">
<li><img src="../_images/sphx_glr_plot_torch_export_006.png" srcset="../_images/sphx_glr_plot_torch_export_006.png" alt="Memory Consumption of onnxruntime loading time running on CPU, Memory peak (Mb), Memory peak - memory begin (Mb), Memory average - memory begin (Mb), GPU Memory peak (Mb), GPU Memory peak - memory begin (Mb), GPU Memory average - memory begin (Mb)" class = "sphx-glr-multi-img"/></li>
<li><img src="../_images/sphx_glr_plot_torch_export_007.png" srcset="../_images/sphx_glr_plot_torch_export_007.png" alt="Memory Consumption of onnxruntime loading time running on CUDA, Memory peak (Mb), Memory peak - memory begin (Mb), Memory average - memory begin (Mb), GPU Memory peak (Mb), GPU Memory peak - memory begin (Mb), GPU Memory average - memory begin (Mb)" class = "sphx-glr-multi-img"/></li>
</ul>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:21: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;peak-begin&quot;] = df1[&quot;peak&quot;] - df1[&quot;begin&quot;]
/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:22: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;mean-begin&quot;] = df1[&quot;mean&quot;] - df1[&quot;begin&quot;]
/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:24: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;gpu0_peak-begin&quot;] = df1[&quot;gpu0_peak&quot;] - df1[&quot;gpu0_begin&quot;]
/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:25: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;gpu0_mean-begin&quot;] = df1[&quot;gpu0_mean&quot;] - df1[&quot;gpu0_begin&quot;]
/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:21: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;peak-begin&quot;] = df1[&quot;peak&quot;] - df1[&quot;begin&quot;]
/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:22: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;mean-begin&quot;] = df1[&quot;mean&quot;] - df1[&quot;begin&quot;]
/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:24: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;gpu0_peak-begin&quot;] = df1[&quot;gpu0_peak&quot;] - df1[&quot;gpu0_begin&quot;]
/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:25: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;gpu0_mean-begin&quot;] = df1[&quot;gpu0_mean&quot;] - df1[&quot;gpu0_begin&quot;]
</pre></div>
</div>
</section>
<section id="memory-first-running-time-ort">
<h2>Memory First Running Time (ORT)<a class="headerlink" href="#memory-first-running-time-ort" title="Permalink to this heading">#</a></h2>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">compute</span></a> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;CPU&quot;</span><span class="p">,</span> <span class="s2">&quot;CUDA&quot;</span><span class="p">]:</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ax</span></a> <span class="o">=</span> <span class="n">memory_peak_plot</span><span class="p">(</span>
        <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dfmemfr</span></a><span class="p">[</span><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.html#pandas.Series" title="pandas.core.series.Series" class="sphx-glr-backref-module-pandas-core-series sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dfmemfr</span><span class="o">.</span><span class="n">compute</span></a> <span class="o">==</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">compute</span></a><span class="p">],</span>
        <span class="p">(</span><span class="s2">&quot;export&quot;</span><span class="p">,</span> <span class="s2">&quot;aot&quot;</span><span class="p">),</span>
        <span class="n">suptitle</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Memory Consumption of onnxruntime first running time&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">running on </span><span class="si">{</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">compute</span></a><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">bars</span><span class="o">=</span><span class="p">[</span><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model_size</span></a> <span class="o">*</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a> <span class="o">/</span> <span class="mi">2</span><span class="o">**</span><span class="mi">20</span> <span class="k">for</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)],</span>
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
    <span class="p">)</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ax</span></a><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;plot_torch_export_ort_first_run_mem_</span><span class="si">{</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">compute</span></a><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="sphx-glr-horizontal">
<li><img src="../_images/sphx_glr_plot_torch_export_008.png" srcset="../_images/sphx_glr_plot_torch_export_008.png" alt="Memory Consumption of onnxruntime first running time running on CPU, Memory peak (Mb), Memory peak - memory begin (Mb), Memory average - memory begin (Mb), GPU Memory peak (Mb), GPU Memory peak - memory begin (Mb), GPU Memory average - memory begin (Mb)" class = "sphx-glr-multi-img"/></li>
<li><img src="../_images/sphx_glr_plot_torch_export_009.png" srcset="../_images/sphx_glr_plot_torch_export_009.png" alt="Memory Consumption of onnxruntime first running time running on CUDA, Memory peak (Mb), Memory peak - memory begin (Mb), Memory average - memory begin (Mb), GPU Memory peak (Mb), GPU Memory peak - memory begin (Mb), GPU Memory average - memory begin (Mb)" class = "sphx-glr-multi-img"/></li>
</ul>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:21: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;peak-begin&quot;] = df1[&quot;peak&quot;] - df1[&quot;begin&quot;]
/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:22: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;mean-begin&quot;] = df1[&quot;mean&quot;] - df1[&quot;begin&quot;]
/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:24: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;gpu0_peak-begin&quot;] = df1[&quot;gpu0_peak&quot;] - df1[&quot;gpu0_begin&quot;]
/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:25: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;gpu0_mean-begin&quot;] = df1[&quot;gpu0_mean&quot;] - df1[&quot;gpu0_begin&quot;]
/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:21: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;peak-begin&quot;] = df1[&quot;peak&quot;] - df1[&quot;begin&quot;]
/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:22: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;mean-begin&quot;] = df1[&quot;mean&quot;] - df1[&quot;begin&quot;]
/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:24: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;gpu0_peak-begin&quot;] = df1[&quot;gpu0_peak&quot;] - df1[&quot;gpu0_begin&quot;]
/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:25: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;gpu0_mean-begin&quot;] = df1[&quot;gpu0_mean&quot;] - df1[&quot;gpu0_begin&quot;]
</pre></div>
</div>
</section>
<section id="memory-running-time-ort">
<h2>Memory Running Time (ORT)<a class="headerlink" href="#memory-running-time-ort" title="Permalink to this heading">#</a></h2>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">compute</span></a> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;CPU&quot;</span><span class="p">,</span> <span class="s2">&quot;CUDA&quot;</span><span class="p">]:</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ax</span></a> <span class="o">=</span> <span class="n">memory_peak_plot</span><span class="p">(</span>
        <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.core.frame.DataFrame" class="sphx-glr-backref-module-pandas-core-frame sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dfmemr</span></a><span class="p">[</span><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.html#pandas.Series" title="pandas.core.series.Series" class="sphx-glr-backref-module-pandas-core-series sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dfmemr</span><span class="o">.</span><span class="n">compute</span></a> <span class="o">==</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">compute</span></a><span class="p">],</span>
        <span class="p">(</span><span class="s2">&quot;export&quot;</span><span class="p">,</span> <span class="s2">&quot;aot&quot;</span><span class="p">),</span>
        <span class="n">suptitle</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Memory Consumption of onnxruntime running time&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">running on </span><span class="si">{</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">compute</span></a><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">bars</span><span class="o">=</span><span class="p">[</span><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model_size</span></a> <span class="o">*</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a> <span class="o">/</span> <span class="mi">2</span><span class="o">**</span><span class="mi">20</span> <span class="k">for</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)],</span>
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
    <span class="p">)</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ax</span></a><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;plot_torch_export_ort_run_mem_</span><span class="si">{</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">compute</span></a><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="sphx-glr-horizontal">
<li><img src="../_images/sphx_glr_plot_torch_export_010.png" srcset="../_images/sphx_glr_plot_torch_export_010.png" alt="Memory Consumption of onnxruntime running time running on CPU, Memory peak (Mb), Memory peak - memory begin (Mb), Memory average - memory begin (Mb), GPU Memory peak (Mb), GPU Memory peak - memory begin (Mb), GPU Memory average - memory begin (Mb)" class = "sphx-glr-multi-img"/></li>
<li><img src="../_images/sphx_glr_plot_torch_export_011.png" srcset="../_images/sphx_glr_plot_torch_export_011.png" alt="Memory Consumption of onnxruntime running time running on CUDA, Memory peak (Mb), Memory peak - memory begin (Mb), Memory average - memory begin (Mb), GPU Memory peak (Mb), GPU Memory peak - memory begin (Mb), GPU Memory average - memory begin (Mb)" class = "sphx-glr-multi-img"/></li>
</ul>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:21: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;peak-begin&quot;] = df1[&quot;peak&quot;] - df1[&quot;begin&quot;]
/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:22: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;mean-begin&quot;] = df1[&quot;mean&quot;] - df1[&quot;begin&quot;]
/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:24: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;gpu0_peak-begin&quot;] = df1[&quot;gpu0_peak&quot;] - df1[&quot;gpu0_begin&quot;]
/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:25: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;gpu0_mean-begin&quot;] = df1[&quot;gpu0_mean&quot;] - df1[&quot;gpu0_begin&quot;]
/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:21: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;peak-begin&quot;] = df1[&quot;peak&quot;] - df1[&quot;begin&quot;]
/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:22: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;mean-begin&quot;] = df1[&quot;mean&quot;] - df1[&quot;begin&quot;]
/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:24: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;gpu0_peak-begin&quot;] = df1[&quot;gpu0_peak&quot;] - df1[&quot;gpu0_begin&quot;]
/home/xadupre/github/experimental-experiment/experimental_experiment/plotting/memory.py:25: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df1[&quot;gpu0_mean-begin&quot;] = df1[&quot;gpu0_mean&quot;] - df1[&quot;gpu0_begin&quot;]
</pre></div>
</div>
</section>
<section id="show-the-interesting-models-for-cpu">
<h2>Show the interesting models for CPU<a class="headerlink" href="#show-the-interesting-models-for-cpu" title="Permalink to this heading">#</a></h2>
<section id="script">
<h3>script<a class="headerlink" href="#script" title="Permalink to this heading">#</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a> <span class="o">=</span> <span class="s2">&quot;ort-plot_torch_export_cus_p2-cpu-aot0.onnx&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><a href="https://onnx.ai/onnx/api/serialization.html#onnx.load" title="onnx.load" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-function"><span class="n">onnx</span><span class="o">.</span><span class="n">load</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">)))</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>opset: domain=&#39;&#39; version=18
opset: domain=&#39;ai.onnx.ml&#39; version=4
opset: domain=&#39;ai.onnx.training&#39; version=1
opset: domain=&#39;ai.onnx.preview.training&#39; version=1
opset: domain=&#39;com.microsoft&#39; version=1
opset: domain=&#39;com.microsoft.experimental&#39; version=1
opset: domain=&#39;com.microsoft.nchwc&#39; version=1
opset: domain=&#39;org.pytorch.aten&#39; version=1
input: name=&#39;input&#39; type=dtype(&#39;float32&#39;) shape=[1, 1, 128, 128]
init: name=&#39;reorder&#39; type=dtype(&#39;float32&#39;) shape=(128, 1, 5, 5)
init: name=&#39;arg1_1&#39; type=dtype(&#39;float32&#39;) shape=(128,)
init: name=&#39;reorder_token_11&#39; type=dtype(&#39;float32&#39;) shape=(16, 128, 5, 5)
init: name=&#39;arg3_1&#39; type=dtype(&#39;float32&#39;) shape=(16,)
init: name=&#39;arg5_1&#39; type=dtype(&#39;float32&#39;) shape=(1024,)
init: name=&#39;arg7_1&#39; type=dtype(&#39;float32&#39;) shape=(128,)
init: name=&#39;arg9_1&#39; type=dtype(&#39;float32&#39;) shape=(10,)
init: name=&#39;ortshared_7_1_2_0_token_8&#39; type=dtype(&#39;int64&#39;) shape=(2,) -- array([    1, 13456])
init: name=&#39;t&#39; type=dtype(&#39;float32&#39;) shape=(13456, 1024)
init: name=&#39;t_1&#39; type=dtype(&#39;float32&#39;) shape=(1024, 128)
init: name=&#39;t_2&#39; type=dtype(&#39;float32&#39;) shape=(128, 10)
Conv[com.microsoft.nchwc](input, reorder, arg1_1, activation=b&#39;Relu&#39;, dilations=[1,1], group=1, strides=[1,1], pads=[0,0,0,0], auto_pad=b&#39;NOTSET&#39;) -&gt; reorder_token_10
  ReorderOutput[com.microsoft.nchwc](reorder_token_10, channels_last=0, channels=128) -&gt; relu
    MaxPool(relu, storage_order=0, auto_pad=b&#39;NOTSET&#39;, ceil_mode=0, dilations=[1,1], kernel_shape=[2,2], pads=[0,0,0,0], strides=[2,2]) -&gt; _onx_maxpool0, _onx_maxpool1
      ReorderInput[com.microsoft.nchwc](_onx_maxpool0, channels_last=0) -&gt; reorder_token_12
        Conv[com.microsoft.nchwc](reorder_token_12, reorder_token_11, arg3_1, activation=b&#39;Relu&#39;, dilations=[1,1], group=1, strides=[1,1], pads=[0,0,0,0], auto_pad=b&#39;NOTSET&#39;) -&gt; reorder_token_13
          ReorderOutput[com.microsoft.nchwc](reorder_token_13, channels_last=0, channels=16) -&gt; relu_1
            MaxPool(relu_1, storage_order=0, auto_pad=b&#39;NOTSET&#39;, ceil_mode=0, dilations=[1,1], kernel_shape=[2,2], pads=[0,0,0,0], strides=[2,2]) -&gt; _onx_maxpool03, _onx_maxpool13
              Reshape(_onx_maxpool03, ortshared_7_1_2_0_token_8, allowzero=0) -&gt; view
                FusedGemm[com.microsoft](view, t, arg5_1, activation=b&#39;Relu&#39;, transB=0, transA=0, alpha=1.00, beta=1.00) -&gt; relu_2
                  FusedGemm[com.microsoft](relu_2, t_1, arg7_1, activation=b&#39;Relu&#39;, transB=0, transA=0, alpha=1.00, beta=1.00) -&gt; relu_3
                    Gemm(relu_3, t_2, arg9_1, transB=0, transA=0, alpha=1.00, beta=1.00) -&gt; output
output: name=&#39;output&#39; type=dtype(&#39;float32&#39;) shape=[1, 10]
</pre></div>
</div>
</section>
<section id="cus-p2">
<h3>cus_p2<a class="headerlink" href="#cus-p2" title="Permalink to this heading">#</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a> <span class="o">=</span> <span class="s2">&quot;ort-plot_torch_export_cus_p2-cpu-aot0.onnx&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><a href="https://onnx.ai/onnx/api/serialization.html#onnx.load" title="onnx.load" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-function"><span class="n">onnx</span><span class="o">.</span><span class="n">load</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">)))</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>opset: domain=&#39;&#39; version=18
opset: domain=&#39;ai.onnx.ml&#39; version=4
opset: domain=&#39;ai.onnx.training&#39; version=1
opset: domain=&#39;ai.onnx.preview.training&#39; version=1
opset: domain=&#39;com.microsoft&#39; version=1
opset: domain=&#39;com.microsoft.experimental&#39; version=1
opset: domain=&#39;com.microsoft.nchwc&#39; version=1
opset: domain=&#39;org.pytorch.aten&#39; version=1
input: name=&#39;input&#39; type=dtype(&#39;float32&#39;) shape=[1, 1, 128, 128]
init: name=&#39;reorder&#39; type=dtype(&#39;float32&#39;) shape=(128, 1, 5, 5)
init: name=&#39;arg1_1&#39; type=dtype(&#39;float32&#39;) shape=(128,)
init: name=&#39;reorder_token_11&#39; type=dtype(&#39;float32&#39;) shape=(16, 128, 5, 5)
init: name=&#39;arg3_1&#39; type=dtype(&#39;float32&#39;) shape=(16,)
init: name=&#39;arg5_1&#39; type=dtype(&#39;float32&#39;) shape=(1024,)
init: name=&#39;arg7_1&#39; type=dtype(&#39;float32&#39;) shape=(128,)
init: name=&#39;arg9_1&#39; type=dtype(&#39;float32&#39;) shape=(10,)
init: name=&#39;ortshared_7_1_2_0_token_8&#39; type=dtype(&#39;int64&#39;) shape=(2,) -- array([    1, 13456])
init: name=&#39;t&#39; type=dtype(&#39;float32&#39;) shape=(13456, 1024)
init: name=&#39;t_1&#39; type=dtype(&#39;float32&#39;) shape=(1024, 128)
init: name=&#39;t_2&#39; type=dtype(&#39;float32&#39;) shape=(128, 10)
Conv[com.microsoft.nchwc](input, reorder, arg1_1, activation=b&#39;Relu&#39;, dilations=[1,1], group=1, strides=[1,1], pads=[0,0,0,0], auto_pad=b&#39;NOTSET&#39;) -&gt; reorder_token_10
  ReorderOutput[com.microsoft.nchwc](reorder_token_10, channels_last=0, channels=128) -&gt; relu
    MaxPool(relu, storage_order=0, auto_pad=b&#39;NOTSET&#39;, ceil_mode=0, dilations=[1,1], kernel_shape=[2,2], pads=[0,0,0,0], strides=[2,2]) -&gt; _onx_maxpool0, _onx_maxpool1
      ReorderInput[com.microsoft.nchwc](_onx_maxpool0, channels_last=0) -&gt; reorder_token_12
        Conv[com.microsoft.nchwc](reorder_token_12, reorder_token_11, arg3_1, activation=b&#39;Relu&#39;, dilations=[1,1], group=1, strides=[1,1], pads=[0,0,0,0], auto_pad=b&#39;NOTSET&#39;) -&gt; reorder_token_13
          ReorderOutput[com.microsoft.nchwc](reorder_token_13, channels_last=0, channels=16) -&gt; relu_1
            MaxPool(relu_1, storage_order=0, auto_pad=b&#39;NOTSET&#39;, ceil_mode=0, dilations=[1,1], kernel_shape=[2,2], pads=[0,0,0,0], strides=[2,2]) -&gt; _onx_maxpool03, _onx_maxpool13
              Reshape(_onx_maxpool03, ortshared_7_1_2_0_token_8, allowzero=0) -&gt; view
                FusedGemm[com.microsoft](view, t, arg5_1, activation=b&#39;Relu&#39;, transB=0, transA=0, alpha=1.00, beta=1.00) -&gt; relu_2
                  FusedGemm[com.microsoft](relu_2, t_1, arg7_1, activation=b&#39;Relu&#39;, transB=0, transA=0, alpha=1.00, beta=1.00) -&gt; relu_3
                    Gemm(relu_3, t_2, arg9_1, transB=0, transA=0, alpha=1.00, beta=1.00) -&gt; output
output: name=&#39;output&#39; type=dtype(&#39;float32&#39;) shape=[1, 10]
</pre></div>
</div>
</section>
<section id="dynopt">
<h3>dynopt<a class="headerlink" href="#dynopt" title="Permalink to this heading">#</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a> <span class="o">=</span> <span class="s2">&quot;ort-plot_torch_export_dynopt-cpu-aot1.onnx&quot;</span>
<span class="k">if</span> <a href="https://docs.python.org/3/library/os.path.html#os.path.exists" title="os.path.exists" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><a href="https://onnx.ai/onnx/api/serialization.html#onnx.load" title="onnx.load" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-function"><span class="n">onnx</span><span class="o">.</span><span class="n">load</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">)))</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>opset: domain=&#39;pkg.onnxscript.torch_lib&#39; version=1
opset: domain=&#39;pkg.torch.2.2.0.dev20231205+cu118&#39; version=1
opset: domain=&#39;&#39; version=18
opset: domain=&#39;pkg.onnxscript.torch_lib.common&#39; version=1
opset: domain=&#39;ai.onnx.ml&#39; version=4
opset: domain=&#39;ai.onnx.training&#39; version=1
opset: domain=&#39;ai.onnx.preview.training&#39; version=1
opset: domain=&#39;com.microsoft&#39; version=1
opset: domain=&#39;com.microsoft.experimental&#39; version=1
opset: domain=&#39;com.microsoft.nchwc&#39; version=1
opset: domain=&#39;org.pytorch.aten&#39; version=1
input: name=&#39;l_x_&#39; type=dtype(&#39;float32&#39;) shape=[1, 1, 128, 128]
init: name=&#39;reorder_token_37&#39; type=dtype(&#39;float32&#39;) shape=(16, 128, 5, 5)
init: name=&#39;conv1.bias&#39; type=dtype(&#39;float32&#39;) shape=(128,)
init: name=&#39;reorder&#39; type=dtype(&#39;float32&#39;) shape=(128, 1, 5, 5)
init: name=&#39;conv2.bias&#39; type=dtype(&#39;float32&#39;) shape=(16,)
init: name=&#39;fc1.weight&#39; type=dtype(&#39;float32&#39;) shape=(1024, 13456)
init: name=&#39;fc1.bias&#39; type=dtype(&#39;float32&#39;) shape=(1024,)
init: name=&#39;_inlfunc_torch_nn_modules_linear_Linear_fc3_1|folded_0|inlined_0|folded_0_t_2&#39; type=dtype(&#39;float32&#39;) shape=(128, 10)
init: name=&#39;fc2.bias&#39; type=dtype(&#39;float32&#39;) shape=(128,)
init: name=&#39;ortshared_7_1_2_1_token_33&#39; type=dtype(&#39;int64&#39;) shape=(2,) -- array([    1, 13456])
init: name=&#39;fc3.bias&#39; type=dtype(&#39;float32&#39;) shape=(10,)
init: name=&#39;_inlfunc_torch_nn_modules_linear_Linear_fc2_1|folded_0|inlined_0|folded_0_t_1&#39; type=dtype(&#39;float32&#39;) shape=(1024, 128)
init: name=&#39;ortshared_7_1_2_3_token_35&#39; type=dtype(&#39;int64&#39;) shape=(2,) -- array([2, 3])
init: name=&#39;ortshared_7_1_2_0_token_32&#39; type=dtype(&#39;int64&#39;) shape=(2,) -- array([0, 0])
init: name=&#39;ortshared_7_1_2_2_token_34&#39; type=dtype(&#39;int64&#39;) shape=(2,) -- array([1, 1])
Conv[com.microsoft.nchwc](l_x_, reorder, conv1.bias, activation=b&#39;Relu&#39;, dilations=[1,1], group=1, strides=[1,1], pads=[0,0,0,0], auto_pad=b&#39;NOTSET&#39;) -&gt; reorder_token_36
  ReorderOutput[com.microsoft.nchwc](reorder_token_36, channels_last=0, channels=128) -&gt; relu
    MaxPool(relu, storage_order=0, auto_pad=b&#39;NOTSET&#39;, ceil_mode=0, dilations=[1,1], kernel_shape=[2,2], pads=[0,0,0,0], strides=[2,2]) -&gt; _inlfunc__aten_max_pool_with_indices_onnx|folded_0|folded_0_pool_result, _inlfunc__aten_max_pool_with_indices_onnx|folded_0|folded_0_indices
      ReorderInput[com.microsoft.nchwc](_inlfunc__aten_max_pool_with_indices_onnx|folded_0|folded_0_pool_result, channels_last=0) -&gt; reorder_token_38
        Conv[com.microsoft.nchwc](reorder_token_38, reorder_token_37, conv2.bias, activation=b&#39;Relu&#39;, dilations=[1,1], group=1, strides=[1,1], pads=[0,0,0,0], auto_pad=b&#39;NOTSET&#39;) -&gt; reorder_token_39
          ReorderOutput[com.microsoft.nchwc](reorder_token_39, channels_last=0, channels=16) -&gt; relu_1
            MaxPool(relu_1, storage_order=0, auto_pad=b&#39;NOTSET&#39;, ceil_mode=0, dilations=[1,1], kernel_shape=[2,2], pads=[0,0,0,0], strides=[2,2]) -&gt; _inlfunc__aten_max_pool_with_indices_onnx|folded_1|folded_0_pool_result, _inlfunc__aten_max_pool_with_indices_onnx|folded_1|folded_0_indices
              Reshape(_inlfunc__aten_max_pool_with_indices_onnx|folded_1|folded_0_pool_result, ortshared_7_1_2_1_token_33, allowzero=0) -&gt; view
                FusedGemm[com.microsoft](view, fc1.weight, fc1.bias, activation=b&#39;Relu&#39;, beta=1.00, transB=1, alpha=1.00, transA=0) -&gt; relu_2
                  FusedGemm[com.microsoft](relu_2, _inlfunc_torch_nn_modules_linear_Linear_fc2_1|folded_0|inlined_0|folded_0_t_1, fc2.bias, activation=b&#39;Relu&#39;, transB=0, transA=0, alpha=1.00, beta=1.00) -&gt; relu_3
                    Gemm(relu_3, _inlfunc_torch_nn_modules_linear_Linear_fc3_1|folded_0|inlined_0|folded_0_t_2, fc3.bias, transB=0, transA=0, alpha=1.00, beta=1.00) -&gt; fc3_1
            MaxPool(relu_1, auto_pad=b&#39;NOTSET&#39;, dilations=[1,1], ceil_mode=0, kernel_shape=[1,1], storage_order=0, strides=[1,1]) -&gt; _inlfunc__aten_max_pool_with_indices_onnx|folded_1|folded_0__, _inlfunc__aten_max_pool_with_indices_onnx|folded_1|folded_0_flatten_indices
              Slice(_inlfunc__aten_max_pool_with_indices_onnx|folded_1|folded_0_flatten_indices, ortshared_7_1_2_0_token_32, ortshared_7_1_2_2_token_34, ortshared_7_1_2_3_token_35) -&gt; _inlfunc__aten_max_pool_with_indices_onnx|folded_1|folded_0_delta
              Sub(_inlfunc__aten_max_pool_with_indices_onnx|folded_1|folded_0_indices, _inlfunc__aten_max_pool_with_indices_onnx|folded_1|folded_0_delta) -&gt; _inlfunc__aten_max_pool_with_indices_onnx|folded_1|folded_0_indices_3
    MaxPool(relu, auto_pad=b&#39;NOTSET&#39;, dilations=[1,1], ceil_mode=0, kernel_shape=[1,1], storage_order=0, strides=[1,1]) -&gt; _inlfunc__aten_max_pool_with_indices_onnx|folded_0|folded_0__, _inlfunc__aten_max_pool_with_indices_onnx|folded_0|folded_0_flatten_indices
      Slice(_inlfunc__aten_max_pool_with_indices_onnx|folded_0|folded_0_flatten_indices, ortshared_7_1_2_0_token_32, ortshared_7_1_2_2_token_34, ortshared_7_1_2_3_token_35) -&gt; _inlfunc__aten_max_pool_with_indices_onnx|folded_0|folded_0_delta
      Sub(_inlfunc__aten_max_pool_with_indices_onnx|folded_0|folded_0_indices, _inlfunc__aten_max_pool_with_indices_onnx|folded_0|folded_0_delta) -&gt; _inlfunc__aten_max_pool_with_indices_onnx|folded_0|folded_0_indices_3
output: name=&#39;fc3_1&#39; type=dtype(&#39;float32&#39;) shape=[1, 10]
</pre></div>
</div>
</section>
<section id="dynamo">
<h3>dynamo<a class="headerlink" href="#dynamo" title="Permalink to this heading">#</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a> <span class="o">=</span> <span class="s2">&quot;ort-plot_torch_export_dynamo-cpu-aot1.onnx&quot;</span>
<span class="k">if</span> <a href="https://docs.python.org/3/library/os.path.html#os.path.exists" title="os.path.exists" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><a href="https://onnx.ai/onnx/api/serialization.html#onnx.load" title="onnx.load" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-function"><span class="n">onnx</span><span class="o">.</span><span class="n">load</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">)))</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>opset: domain=&#39;pkg.onnxscript.torch_lib&#39; version=1
opset: domain=&#39;pkg.torch.2.2.0.dev20231205+cu118&#39; version=1
opset: domain=&#39;&#39; version=18
opset: domain=&#39;pkg.onnxscript.torch_lib.common&#39; version=1
opset: domain=&#39;ai.onnx.ml&#39; version=4
opset: domain=&#39;ai.onnx.training&#39; version=1
opset: domain=&#39;ai.onnx.preview.training&#39; version=1
opset: domain=&#39;com.microsoft&#39; version=1
opset: domain=&#39;com.microsoft.experimental&#39; version=1
opset: domain=&#39;com.microsoft.nchwc&#39; version=1
opset: domain=&#39;org.pytorch.aten&#39; version=1
input: name=&#39;l_x_&#39; type=dtype(&#39;float32&#39;) shape=[1, 1, 128, 128]
init: name=&#39;reorder&#39; type=dtype(&#39;float32&#39;) shape=(128, 1, 5, 5)
init: name=&#39;conv1.bias&#39; type=dtype(&#39;float32&#39;) shape=(128,)
init: name=&#39;reorder_token_60&#39; type=dtype(&#39;float32&#39;) shape=(16, 128, 5, 5)
init: name=&#39;conv2.bias&#39; type=dtype(&#39;float32&#39;) shape=(16,)
init: name=&#39;ortshared_7_1_2_0_token_55&#39; type=dtype(&#39;int64&#39;) shape=(2,) -- array([0, 0])
init: name=&#39;fc1.bias&#39; type=dtype(&#39;float32&#39;) shape=(1024,)
init: name=&#39;_inlfunc_torch_nn_modules_linear_Linear_fc1_1_t&#39; type=dtype(&#39;float32&#39;) shape=(13456, 1024)
init: name=&#39;fc2.bias&#39; type=dtype(&#39;float32&#39;) shape=(128,)
init: name=&#39;ortshared_7_1_2_1_token_56&#39; type=dtype(&#39;int64&#39;) shape=(2,) -- array([2, 3])
init: name=&#39;fc3.bias&#39; type=dtype(&#39;float32&#39;) shape=(10,)
init: name=&#39;ortshared_7_1_2_2_token_57&#39; type=dtype(&#39;int64&#39;) shape=(2,) -- array([    1, 13456])
init: name=&#39;_inlfunc_torch_nn_modules_linear_Linear_fc3_1_t_2&#39; type=dtype(&#39;float32&#39;) shape=(128, 10)
init: name=&#39;ortshared_7_1_2_3_token_58&#39; type=dtype(&#39;int64&#39;) shape=(2,) -- array([1, 1])
init: name=&#39;_inlfunc_torch_nn_modules_linear_Linear_fc2_1_t_1&#39; type=dtype(&#39;float32&#39;) shape=(1024, 128)
Conv[com.microsoft.nchwc](l_x_, reorder, conv1.bias, activation=b&#39;Relu&#39;, dilations=[1,1], group=1, strides=[1,1], pads=[0,0,0,0], auto_pad=b&#39;NOTSET&#39;) -&gt; reorder_token_59
  ReorderOutput[com.microsoft.nchwc](reorder_token_59, channels_last=0, channels=128) -&gt; relu
    MaxPool(relu, storage_order=0, auto_pad=b&#39;NOTSET&#39;, ceil_mode=0, dilations=[1,1], kernel_shape=[2,2], pads=[0,0,0,0], strides=[2,2]) -&gt; _inlfunc__aten_max_pool_with_indices_onnx_pool_result, _inlfunc__aten_max_pool_with_indices_onnx_indices
      ReorderInput[com.microsoft.nchwc](_inlfunc__aten_max_pool_with_indices_onnx_pool_result, channels_last=0) -&gt; reorder_token_61
        Conv[com.microsoft.nchwc](reorder_token_61, reorder_token_60, conv2.bias, activation=b&#39;Relu&#39;, dilations=[1,1], group=1, strides=[1,1], pads=[0,0,0,0], auto_pad=b&#39;NOTSET&#39;) -&gt; reorder_token_62
          ReorderOutput[com.microsoft.nchwc](reorder_token_62, channels_last=0, channels=16) -&gt; relu_1
            MaxPool(relu_1, storage_order=0, auto_pad=b&#39;NOTSET&#39;, ceil_mode=0, dilations=[1,1], kernel_shape=[2,2], pads=[0,0,0,0], strides=[2,2]) -&gt; _inlfunc__aten_max_pool_with_indices_onnx_token_1_pool_result, _inlfunc__aten_max_pool_with_indices_onnx_token_1_indices
              Reshape(_inlfunc__aten_max_pool_with_indices_onnx_token_1_pool_result, ortshared_7_1_2_2_token_57, allowzero=0) -&gt; view
                FusedGemm[com.microsoft](view, _inlfunc_torch_nn_modules_linear_Linear_fc1_1_t, fc1.bias, activation=b&#39;Relu&#39;, transB=0, transA=0, alpha=1.00, beta=1.00) -&gt; relu_2
                  FusedGemm[com.microsoft](relu_2, _inlfunc_torch_nn_modules_linear_Linear_fc2_1_t_1, fc2.bias, activation=b&#39;Relu&#39;, transB=0, transA=0, alpha=1.00, beta=1.00) -&gt; relu_3
                    Gemm(relu_3, _inlfunc_torch_nn_modules_linear_Linear_fc3_1_t_2, fc3.bias, transB=0, transA=0, alpha=1.00, beta=1.00) -&gt; fc3_1
            MaxPool(relu_1, auto_pad=b&#39;NOTSET&#39;, dilations=[1,1], ceil_mode=0, kernel_shape=[1,1], storage_order=0, strides=[1,1]) -&gt; _inlfunc__aten_max_pool_with_indices_onnx_token_1__, _inlfunc__aten_max_pool_with_indices_onnx_token_1_flatten_indices
              Slice(_inlfunc__aten_max_pool_with_indices_onnx_token_1_flatten_indices, ortshared_7_1_2_0_token_55, ortshared_7_1_2_3_token_58, ortshared_7_1_2_1_token_56) -&gt; _inlfunc__aten_max_pool_with_indices_onnx_token_1_delta
              Sub(_inlfunc__aten_max_pool_with_indices_onnx_token_1_indices, _inlfunc__aten_max_pool_with_indices_onnx_token_1_delta) -&gt; _inlfunc__aten_max_pool_with_indices_onnx_token_1_indices_3
    MaxPool(relu, auto_pad=b&#39;NOTSET&#39;, dilations=[1,1], ceil_mode=0, kernel_shape=[1,1], storage_order=0, strides=[1,1]) -&gt; _inlfunc__aten_max_pool_with_indices_onnx__, _inlfunc__aten_max_pool_with_indices_onnx_flatten_indices
      Slice(_inlfunc__aten_max_pool_with_indices_onnx_flatten_indices, ortshared_7_1_2_0_token_55, ortshared_7_1_2_3_token_58, ortshared_7_1_2_1_token_56) -&gt; _inlfunc__aten_max_pool_with_indices_onnx_delta
      Sub(_inlfunc__aten_max_pool_with_indices_onnx_indices, _inlfunc__aten_max_pool_with_indices_onnx_delta) -&gt; _inlfunc__aten_max_pool_with_indices_onnx_indices_3
output: name=&#39;fc3_1&#39; type=dtype(&#39;float32&#39;) shape=[1, 10]
</pre></div>
</div>
</section>
</section>
<section id="show-the-interesting-models-for-cuda">
<h2>Show the interesting models for CUDA<a class="headerlink" href="#show-the-interesting-models-for-cuda" title="Permalink to this heading">#</a></h2>
<section id="id1">
<h3>script<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a> <span class="o">=</span> <span class="s2">&quot;ort-plot_torch_export_cus_p2-cuda-aot0.onnx&quot;</span>
<span class="k">if</span> <a href="https://docs.python.org/3/library/os.path.html#os.path.exists" title="os.path.exists" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><a href="https://onnx.ai/onnx/api/serialization.html#onnx.load" title="onnx.load" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-function"><span class="n">onnx</span><span class="o">.</span><span class="n">load</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">)))</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>opset: domain=&#39;&#39; version=18
opset: domain=&#39;ai.onnx.ml&#39; version=4
opset: domain=&#39;ai.onnx.training&#39; version=1
opset: domain=&#39;ai.onnx.preview.training&#39; version=1
opset: domain=&#39;com.microsoft&#39; version=1
opset: domain=&#39;com.microsoft.experimental&#39; version=1
opset: domain=&#39;com.microsoft.nchwc&#39; version=1
opset: domain=&#39;org.pytorch.aten&#39; version=1
input: name=&#39;input&#39; type=dtype(&#39;float32&#39;) shape=[1, 1, 128, 128]
init: name=&#39;arg0_1&#39; type=dtype(&#39;float32&#39;) shape=(128, 1, 5, 5)
init: name=&#39;arg1_1&#39; type=dtype(&#39;float32&#39;) shape=(128,)
init: name=&#39;arg2_1&#39; type=dtype(&#39;float32&#39;) shape=(16, 128, 5, 5)
init: name=&#39;arg3_1&#39; type=dtype(&#39;float32&#39;) shape=(16,)
init: name=&#39;arg5_1&#39; type=dtype(&#39;float32&#39;) shape=(1024,)
init: name=&#39;arg7_1&#39; type=dtype(&#39;float32&#39;) shape=(128,)
init: name=&#39;arg9_1&#39; type=dtype(&#39;float32&#39;) shape=(10,)
init: name=&#39;ortshared_7_1_2_0_token_8&#39; type=dtype(&#39;int64&#39;) shape=(2,) -- array([    1, 13456])
init: name=&#39;t&#39; type=dtype(&#39;float32&#39;) shape=(13456, 1024)
init: name=&#39;t_1&#39; type=dtype(&#39;float32&#39;) shape=(1024, 128)
init: name=&#39;t_2&#39; type=dtype(&#39;float32&#39;) shape=(128, 10)
FusedConv[com.microsoft](input, arg0_1, arg1_1, activation=b&#39;Relu&#39;, dilations=[1,1], group=1, strides=[1,1], pads=[0,0,0,0], auto_pad=b&#39;NOTSET&#39;) -&gt; relu
  MaxPool(relu, storage_order=0, auto_pad=b&#39;NOTSET&#39;, ceil_mode=0, dilations=[1,1], kernel_shape=[2,2], pads=[0,0,0,0], strides=[2,2]) -&gt; _onx_maxpool0, _onx_maxpool1
    FusedConv[com.microsoft](_onx_maxpool0, arg2_1, arg3_1, activation=b&#39;Relu&#39;, dilations=[1,1], group=1, strides=[1,1], pads=[0,0,0,0], auto_pad=b&#39;NOTSET&#39;) -&gt; relu_1
      MaxPool(relu_1, storage_order=0, auto_pad=b&#39;NOTSET&#39;, ceil_mode=0, dilations=[1,1], kernel_shape=[2,2], pads=[0,0,0,0], strides=[2,2]) -&gt; _onx_maxpool03, _onx_maxpool13
        Reshape(_onx_maxpool03, ortshared_7_1_2_0_token_8, allowzero=0) -&gt; view
          Gemm(view, t, arg5_1, transB=0, transA=0, alpha=1.00, beta=1.00) -&gt; addmm
            Relu(addmm) -&gt; relu_2
              Gemm(relu_2, t_1, arg7_1, transB=0, transA=0, alpha=1.00, beta=1.00) -&gt; addmm_1
                Relu(addmm_1) -&gt; relu_3
                  Gemm(relu_3, t_2, arg9_1, transB=0, transA=0, alpha=1.00, beta=1.00) -&gt; output
output: name=&#39;output&#39; type=dtype(&#39;float32&#39;) shape=[1, 10]
</pre></div>
</div>
</section>
<section id="id2">
<h3>cus_p2<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a> <span class="o">=</span> <span class="s2">&quot;ort-plot_torch_export_cus_p2-cuda-aot0.onnx&quot;</span>
<span class="k">if</span> <a href="https://docs.python.org/3/library/os.path.html#os.path.exists" title="os.path.exists" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><a href="https://onnx.ai/onnx/api/serialization.html#onnx.load" title="onnx.load" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-function"><span class="n">onnx</span><span class="o">.</span><span class="n">load</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">)))</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>opset: domain=&#39;&#39; version=18
opset: domain=&#39;ai.onnx.ml&#39; version=4
opset: domain=&#39;ai.onnx.training&#39; version=1
opset: domain=&#39;ai.onnx.preview.training&#39; version=1
opset: domain=&#39;com.microsoft&#39; version=1
opset: domain=&#39;com.microsoft.experimental&#39; version=1
opset: domain=&#39;com.microsoft.nchwc&#39; version=1
opset: domain=&#39;org.pytorch.aten&#39; version=1
input: name=&#39;input&#39; type=dtype(&#39;float32&#39;) shape=[1, 1, 128, 128]
init: name=&#39;arg0_1&#39; type=dtype(&#39;float32&#39;) shape=(128, 1, 5, 5)
init: name=&#39;arg1_1&#39; type=dtype(&#39;float32&#39;) shape=(128,)
init: name=&#39;arg2_1&#39; type=dtype(&#39;float32&#39;) shape=(16, 128, 5, 5)
init: name=&#39;arg3_1&#39; type=dtype(&#39;float32&#39;) shape=(16,)
init: name=&#39;arg5_1&#39; type=dtype(&#39;float32&#39;) shape=(1024,)
init: name=&#39;arg7_1&#39; type=dtype(&#39;float32&#39;) shape=(128,)
init: name=&#39;arg9_1&#39; type=dtype(&#39;float32&#39;) shape=(10,)
init: name=&#39;ortshared_7_1_2_0_token_8&#39; type=dtype(&#39;int64&#39;) shape=(2,) -- array([    1, 13456])
init: name=&#39;t&#39; type=dtype(&#39;float32&#39;) shape=(13456, 1024)
init: name=&#39;t_1&#39; type=dtype(&#39;float32&#39;) shape=(1024, 128)
init: name=&#39;t_2&#39; type=dtype(&#39;float32&#39;) shape=(128, 10)
FusedConv[com.microsoft](input, arg0_1, arg1_1, activation=b&#39;Relu&#39;, dilations=[1,1], group=1, strides=[1,1], pads=[0,0,0,0], auto_pad=b&#39;NOTSET&#39;) -&gt; relu
  MaxPool(relu, storage_order=0, auto_pad=b&#39;NOTSET&#39;, ceil_mode=0, dilations=[1,1], kernel_shape=[2,2], pads=[0,0,0,0], strides=[2,2]) -&gt; _onx_maxpool0, _onx_maxpool1
    FusedConv[com.microsoft](_onx_maxpool0, arg2_1, arg3_1, activation=b&#39;Relu&#39;, dilations=[1,1], group=1, strides=[1,1], pads=[0,0,0,0], auto_pad=b&#39;NOTSET&#39;) -&gt; relu_1
      MaxPool(relu_1, storage_order=0, auto_pad=b&#39;NOTSET&#39;, ceil_mode=0, dilations=[1,1], kernel_shape=[2,2], pads=[0,0,0,0], strides=[2,2]) -&gt; _onx_maxpool03, _onx_maxpool13
        Reshape(_onx_maxpool03, ortshared_7_1_2_0_token_8, allowzero=0) -&gt; view
          Gemm(view, t, arg5_1, transB=0, transA=0, alpha=1.00, beta=1.00) -&gt; addmm
            Relu(addmm) -&gt; relu_2
              Gemm(relu_2, t_1, arg7_1, transB=0, transA=0, alpha=1.00, beta=1.00) -&gt; addmm_1
                Relu(addmm_1) -&gt; relu_3
                  Gemm(relu_3, t_2, arg9_1, transB=0, transA=0, alpha=1.00, beta=1.00) -&gt; output
output: name=&#39;output&#39; type=dtype(&#39;float32&#39;) shape=[1, 10]
</pre></div>
</div>
</section>
<section id="id3">
<h3>dynopt<a class="headerlink" href="#id3" title="Permalink to this heading">#</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a> <span class="o">=</span> <span class="s2">&quot;ort-plot_torch_export_dynopt-cuda-aot1.onnx&quot;</span>
<span class="k">if</span> <a href="https://docs.python.org/3/library/os.path.html#os.path.exists" title="os.path.exists" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><a href="https://onnx.ai/onnx/api/serialization.html#onnx.load" title="onnx.load" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-function"><span class="n">onnx</span><span class="o">.</span><span class="n">load</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">)))</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>opset: domain=&#39;pkg.onnxscript.torch_lib&#39; version=1
opset: domain=&#39;pkg.torch.2.2.0.dev20231205+cu118&#39; version=1
opset: domain=&#39;&#39; version=18
opset: domain=&#39;pkg.onnxscript.torch_lib.common&#39; version=1
opset: domain=&#39;ai.onnx.ml&#39; version=4
opset: domain=&#39;ai.onnx.training&#39; version=1
opset: domain=&#39;ai.onnx.preview.training&#39; version=1
opset: domain=&#39;com.microsoft&#39; version=1
opset: domain=&#39;com.microsoft.experimental&#39; version=1
opset: domain=&#39;com.microsoft.nchwc&#39; version=1
opset: domain=&#39;org.pytorch.aten&#39; version=1
input: name=&#39;l_x_&#39; type=dtype(&#39;float32&#39;) shape=[1, 1, 128, 128]
init: name=&#39;conv1.weight&#39; type=dtype(&#39;float32&#39;) shape=(128, 1, 5, 5)
init: name=&#39;conv1.bias&#39; type=dtype(&#39;float32&#39;) shape=(128,)
init: name=&#39;conv2.weight&#39; type=dtype(&#39;float32&#39;) shape=(16, 128, 5, 5)
init: name=&#39;conv2.bias&#39; type=dtype(&#39;float32&#39;) shape=(16,)
init: name=&#39;fc1.weight&#39; type=dtype(&#39;float32&#39;) shape=(1024, 13456)
init: name=&#39;fc1.bias&#39; type=dtype(&#39;float32&#39;) shape=(1024,)
init: name=&#39;_inlfunc_torch_nn_modules_linear_Linear_fc3_1|folded_0|inlined_0|folded_0_t_2&#39; type=dtype(&#39;float32&#39;) shape=(128, 10)
init: name=&#39;fc2.bias&#39; type=dtype(&#39;float32&#39;) shape=(128,)
init: name=&#39;ortshared_7_1_2_1_token_33&#39; type=dtype(&#39;int64&#39;) shape=(2,) -- array([    1, 13456])
init: name=&#39;fc3.bias&#39; type=dtype(&#39;float32&#39;) shape=(10,)
init: name=&#39;_inlfunc_torch_nn_modules_linear_Linear_fc2_1|folded_0|inlined_0|folded_0_t_1&#39; type=dtype(&#39;float32&#39;) shape=(1024, 128)
init: name=&#39;ortshared_7_1_2_3_token_35&#39; type=dtype(&#39;int64&#39;) shape=(2,) -- array([2, 3])
init: name=&#39;ortshared_7_1_2_0_token_32&#39; type=dtype(&#39;int64&#39;) shape=(2,) -- array([0, 0])
init: name=&#39;ortshared_7_1_2_2_token_34&#39; type=dtype(&#39;int64&#39;) shape=(2,) -- array([1, 1])
FusedConv[com.microsoft](l_x_, conv1.weight, conv1.bias, activation=b&#39;Relu&#39;, dilations=[1,1], group=1, strides=[1,1], pads=[0,0,0,0], auto_pad=b&#39;NOTSET&#39;) -&gt; relu
  MaxPool(relu, storage_order=0, auto_pad=b&#39;NOTSET&#39;, ceil_mode=0, dilations=[1,1], kernel_shape=[2,2], pads=[0,0,0,0], strides=[2,2]) -&gt; _inlfunc__aten_max_pool_with_indices_onnx|folded_0|folded_0_pool_result, _inlfunc__aten_max_pool_with_indices_onnx|folded_0|folded_0_indices
    FusedConv[com.microsoft](_inlfunc__aten_max_pool_with_indices_onnx|folded_0|folded_0_pool_result, conv2.weight, conv2.bias, activation=b&#39;Relu&#39;, dilations=[1,1], group=1, strides=[1,1], pads=[0,0,0,0], auto_pad=b&#39;NOTSET&#39;) -&gt; relu_1
      MaxPool(relu_1, storage_order=0, auto_pad=b&#39;NOTSET&#39;, ceil_mode=0, dilations=[1,1], kernel_shape=[2,2], pads=[0,0,0,0], strides=[2,2]) -&gt; _inlfunc__aten_max_pool_with_indices_onnx|folded_1|folded_0_pool_result, _inlfunc__aten_max_pool_with_indices_onnx|folded_1|folded_0_indices
        Reshape(_inlfunc__aten_max_pool_with_indices_onnx|folded_1|folded_0_pool_result, ortshared_7_1_2_1_token_33, allowzero=0) -&gt; view
          Gemm(view, fc1.weight, fc1.bias, beta=1.00, transB=1, alpha=1.00, transA=0) -&gt; fc1_1
            Relu(fc1_1) -&gt; relu_2
              Gemm(relu_2, _inlfunc_torch_nn_modules_linear_Linear_fc2_1|folded_0|inlined_0|folded_0_t_1, fc2.bias, transB=0, transA=0, alpha=1.00, beta=1.00) -&gt; fc2_1
                Relu(fc2_1) -&gt; relu_3
                  Gemm(relu_3, _inlfunc_torch_nn_modules_linear_Linear_fc3_1|folded_0|inlined_0|folded_0_t_2, fc3.bias, transB=0, transA=0, alpha=1.00, beta=1.00) -&gt; fc3_1
      MaxPool(relu_1, auto_pad=b&#39;NOTSET&#39;, dilations=[1,1], ceil_mode=0, kernel_shape=[1,1], storage_order=0, strides=[1,1]) -&gt; _inlfunc__aten_max_pool_with_indices_onnx|folded_1|folded_0__, _inlfunc__aten_max_pool_with_indices_onnx|folded_1|folded_0_flatten_indices
        Slice(_inlfunc__aten_max_pool_with_indices_onnx|folded_1|folded_0_flatten_indices, ortshared_7_1_2_0_token_32, ortshared_7_1_2_2_token_34, ortshared_7_1_2_3_token_35) -&gt; _inlfunc__aten_max_pool_with_indices_onnx|folded_1|folded_0_delta
        Sub(_inlfunc__aten_max_pool_with_indices_onnx|folded_1|folded_0_indices, _inlfunc__aten_max_pool_with_indices_onnx|folded_1|folded_0_delta) -&gt; _inlfunc__aten_max_pool_with_indices_onnx|folded_1|folded_0_indices_3
  MaxPool(relu, auto_pad=b&#39;NOTSET&#39;, dilations=[1,1], ceil_mode=0, kernel_shape=[1,1], storage_order=0, strides=[1,1]) -&gt; _inlfunc__aten_max_pool_with_indices_onnx|folded_0|folded_0__, _inlfunc__aten_max_pool_with_indices_onnx|folded_0|folded_0_flatten_indices
    Slice(_inlfunc__aten_max_pool_with_indices_onnx|folded_0|folded_0_flatten_indices, ortshared_7_1_2_0_token_32, ortshared_7_1_2_2_token_34, ortshared_7_1_2_3_token_35) -&gt; _inlfunc__aten_max_pool_with_indices_onnx|folded_0|folded_0_delta
    Sub(_inlfunc__aten_max_pool_with_indices_onnx|folded_0|folded_0_indices, _inlfunc__aten_max_pool_with_indices_onnx|folded_0|folded_0_delta) -&gt; _inlfunc__aten_max_pool_with_indices_onnx|folded_0|folded_0_indices_3
output: name=&#39;fc3_1&#39; type=dtype(&#39;float32&#39;) shape=[1, 10]
</pre></div>
</div>
</section>
<section id="id4">
<h3>dynamo<a class="headerlink" href="#id4" title="Permalink to this heading">#</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a> <span class="o">=</span> <span class="s2">&quot;ort-plot_torch_export_dynamo-cuda-aot1.onnx&quot;</span>
<span class="k">if</span> <a href="https://docs.python.org/3/library/os.path.html#os.path.exists" title="os.path.exists" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><a href="https://onnx.ai/onnx/api/serialization.html#onnx.load" title="onnx.load" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-function"><span class="n">onnx</span><span class="o">.</span><span class="n">load</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">model</span></a><span class="p">)))</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>opset: domain=&#39;pkg.onnxscript.torch_lib&#39; version=1
opset: domain=&#39;pkg.torch.2.2.0.dev20231205+cu118&#39; version=1
opset: domain=&#39;&#39; version=18
opset: domain=&#39;pkg.onnxscript.torch_lib.common&#39; version=1
opset: domain=&#39;ai.onnx.ml&#39; version=4
opset: domain=&#39;ai.onnx.training&#39; version=1
opset: domain=&#39;ai.onnx.preview.training&#39; version=1
opset: domain=&#39;com.microsoft&#39; version=1
opset: domain=&#39;com.microsoft.experimental&#39; version=1
opset: domain=&#39;com.microsoft.nchwc&#39; version=1
opset: domain=&#39;org.pytorch.aten&#39; version=1
input: name=&#39;l_x_&#39; type=dtype(&#39;float32&#39;) shape=[1, 1, 128, 128]
init: name=&#39;conv1.weight&#39; type=dtype(&#39;float32&#39;) shape=(128, 1, 5, 5)
init: name=&#39;conv1.bias&#39; type=dtype(&#39;float32&#39;) shape=(128,)
init: name=&#39;conv2.weight&#39; type=dtype(&#39;float32&#39;) shape=(16, 128, 5, 5)
init: name=&#39;conv2.bias&#39; type=dtype(&#39;float32&#39;) shape=(16,)
init: name=&#39;ortshared_7_1_2_0_token_55&#39; type=dtype(&#39;int64&#39;) shape=(2,) -- array([0, 0])
init: name=&#39;fc1.bias&#39; type=dtype(&#39;float32&#39;) shape=(1024,)
init: name=&#39;_inlfunc_torch_nn_modules_linear_Linear_fc1_1_t&#39; type=dtype(&#39;float32&#39;) shape=(13456, 1024)
init: name=&#39;fc2.bias&#39; type=dtype(&#39;float32&#39;) shape=(128,)
init: name=&#39;ortshared_7_1_2_1_token_56&#39; type=dtype(&#39;int64&#39;) shape=(2,) -- array([2, 3])
init: name=&#39;fc3.bias&#39; type=dtype(&#39;float32&#39;) shape=(10,)
init: name=&#39;ortshared_7_1_2_2_token_57&#39; type=dtype(&#39;int64&#39;) shape=(2,) -- array([    1, 13456])
init: name=&#39;_inlfunc_torch_nn_modules_linear_Linear_fc3_1_t_2&#39; type=dtype(&#39;float32&#39;) shape=(128, 10)
init: name=&#39;ortshared_7_1_2_3_token_58&#39; type=dtype(&#39;int64&#39;) shape=(2,) -- array([1, 1])
init: name=&#39;_inlfunc_torch_nn_modules_linear_Linear_fc2_1_t_1&#39; type=dtype(&#39;float32&#39;) shape=(1024, 128)
FusedConv[com.microsoft](l_x_, conv1.weight, conv1.bias, activation=b&#39;Relu&#39;, dilations=[1,1], group=1, strides=[1,1], pads=[0,0,0,0], auto_pad=b&#39;NOTSET&#39;) -&gt; relu
  MaxPool(relu, storage_order=0, auto_pad=b&#39;NOTSET&#39;, ceil_mode=0, dilations=[1,1], kernel_shape=[2,2], pads=[0,0,0,0], strides=[2,2]) -&gt; _inlfunc__aten_max_pool_with_indices_onnx_pool_result, _inlfunc__aten_max_pool_with_indices_onnx_indices
    FusedConv[com.microsoft](_inlfunc__aten_max_pool_with_indices_onnx_pool_result, conv2.weight, conv2.bias, activation=b&#39;Relu&#39;, dilations=[1,1], group=1, strides=[1,1], pads=[0,0,0,0], auto_pad=b&#39;NOTSET&#39;) -&gt; relu_1
      MaxPool(relu_1, storage_order=0, auto_pad=b&#39;NOTSET&#39;, ceil_mode=0, dilations=[1,1], kernel_shape=[2,2], pads=[0,0,0,0], strides=[2,2]) -&gt; _inlfunc__aten_max_pool_with_indices_onnx_token_1_pool_result, _inlfunc__aten_max_pool_with_indices_onnx_token_1_indices
        Reshape(_inlfunc__aten_max_pool_with_indices_onnx_token_1_pool_result, ortshared_7_1_2_2_token_57, allowzero=0) -&gt; view
          Gemm(view, _inlfunc_torch_nn_modules_linear_Linear_fc1_1_t, fc1.bias, transB=0, transA=0, alpha=1.00, beta=1.00) -&gt; fc1_1
            Relu(fc1_1) -&gt; relu_2
              Gemm(relu_2, _inlfunc_torch_nn_modules_linear_Linear_fc2_1_t_1, fc2.bias, transB=0, transA=0, alpha=1.00, beta=1.00) -&gt; fc2_1
                Relu(fc2_1) -&gt; relu_3
                  Gemm(relu_3, _inlfunc_torch_nn_modules_linear_Linear_fc3_1_t_2, fc3.bias, transB=0, transA=0, alpha=1.00, beta=1.00) -&gt; fc3_1
      MaxPool(relu_1, auto_pad=b&#39;NOTSET&#39;, dilations=[1,1], ceil_mode=0, kernel_shape=[1,1], storage_order=0, strides=[1,1]) -&gt; _inlfunc__aten_max_pool_with_indices_onnx_token_1__, _inlfunc__aten_max_pool_with_indices_onnx_token_1_flatten_indices
        Slice(_inlfunc__aten_max_pool_with_indices_onnx_token_1_flatten_indices, ortshared_7_1_2_0_token_55, ortshared_7_1_2_3_token_58, ortshared_7_1_2_1_token_56) -&gt; _inlfunc__aten_max_pool_with_indices_onnx_token_1_delta
        Sub(_inlfunc__aten_max_pool_with_indices_onnx_token_1_indices, _inlfunc__aten_max_pool_with_indices_onnx_token_1_delta) -&gt; _inlfunc__aten_max_pool_with_indices_onnx_token_1_indices_3
  MaxPool(relu, auto_pad=b&#39;NOTSET&#39;, dilations=[1,1], ceil_mode=0, kernel_shape=[1,1], storage_order=0, strides=[1,1]) -&gt; _inlfunc__aten_max_pool_with_indices_onnx__, _inlfunc__aten_max_pool_with_indices_onnx_flatten_indices
    Slice(_inlfunc__aten_max_pool_with_indices_onnx_flatten_indices, ortshared_7_1_2_0_token_55, ortshared_7_1_2_3_token_58, ortshared_7_1_2_1_token_56) -&gt; _inlfunc__aten_max_pool_with_indices_onnx_delta
    Sub(_inlfunc__aten_max_pool_with_indices_onnx_indices, _inlfunc__aten_max_pool_with_indices_onnx_delta) -&gt; _inlfunc__aten_max_pool_with_indices_onnx_indices_3
output: name=&#39;fc3_1&#39; type=dtype(&#39;float32&#39;) shape=[1, 10]
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (6 minutes 13.886 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-plot-torch-export-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/0534a82190ecce5d98ccd3b019bd1c7a/plot_torch_export.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_torch_export.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/5ea159170a8b6e6d090b561d7986469d/plot_torch_export.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_torch_export.py</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../CHANGELOGS.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Change Logs</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="index.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Example gallery</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Evaluate different ways to export a torch model to ONNX</a><ul>
<li><a class="reference internal" href="#some-helpers">Some helpers</a></li>
<li><a class="reference internal" href="#the-model">The model</a></li>
<li><a class="reference internal" href="#the-exporters">The exporters</a></li>
<li><a class="reference internal" href="#exporter-memory">Exporter memory</a></li>
<li><a class="reference internal" href="#exporter-speed">Exporter speed</a></li>
<li><a class="reference internal" href="#exporter-profiling">Exporter Profiling</a></li>
<li><a class="reference internal" href="#benchmark-exported-models-with-ort">Benchmark exported models with ORT</a></li>
<li><a class="reference internal" href="#memory-loading-time-ort">Memory Loading Time (ORT)</a></li>
<li><a class="reference internal" href="#memory-first-running-time-ort">Memory First Running Time (ORT)</a></li>
<li><a class="reference internal" href="#memory-running-time-ort">Memory Running Time (ORT)</a></li>
<li><a class="reference internal" href="#show-the-interesting-models-for-cpu">Show the interesting models for CPU</a><ul>
<li><a class="reference internal" href="#script">script</a></li>
<li><a class="reference internal" href="#cus-p2">cus_p2</a></li>
<li><a class="reference internal" href="#dynopt">dynopt</a></li>
<li><a class="reference internal" href="#dynamo">dynamo</a></li>
</ul>
</li>
<li><a class="reference internal" href="#show-the-interesting-models-for-cuda">Show the interesting models for CUDA</a><ul>
<li><a class="reference internal" href="#id1">script</a></li>
<li><a class="reference internal" href="#id2">cus_p2</a></li>
<li><a class="reference internal" href="#id3">dynopt</a></li>
<li><a class="reference internal" href="#id4">dynamo</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=c88f2e48"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/scripts/furo.js?v=32e29ea5"></script>
    </body>
</html>
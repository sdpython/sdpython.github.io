<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="301: Compares LLAMA exporters" href="plot_llama_diff_export_301.html" /><link rel="prev" title="201: Evaluate different ways to export a torch model to ONNX" href="plot_torch_export_201.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>201: Use torch to export a scikit-learn model into ONNX - experimental-experiment 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css?v=7f9a90b1" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">experimental-experiment 0.1.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/logo.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">experimental-experiment 0.1.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../design/index.html">Design</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Design</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../design/exporter.html">Custom Exporter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../design/optimizer.html">Pattern Optimizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../design/backends.html">Dynamo Backends</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorial/index.html">Tutorial</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Tutorial</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/errors.html">Weird Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/docker.html">Start from a docker</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorial/exported.html">Supported Model Signatures</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Supported Model Signatures</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/exported_program.html">Exported Programs with Static Shapes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/exported_program_dynamic.html">Exported Programs with Dynamic Shapes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/exported_onnx.html">Exported into ONNX with Static Shapes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/exported_onnx_dynamic.html">Exported into ONNX with Dynamic Shapes</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api/index.html">API</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of API</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/gradient/index.html">.gradient</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of .gradient</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/gradient/ops/index.html">.gradient.ops</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of .gradient.ops</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/gradient/ops/op_broadcast_gradient_args.html">.gradient.ops.op_broadcast_gradient_args</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/gradient/grad_helper.html">.gradient.grad_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/gradient/loss_helper.html">.gradient.loss_helper</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/reference/index.html">.reference</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of .reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/reference/ops/index.html">.reference.ops</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of .reference.ops</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_add_add_mul_mul.html">.reference.ops.op_add_add_mul_mul</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_average_pool_grad.html">.reference.ops.op_average_pool_grad</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_cast_like.html">.reference.ops.op_cast_like</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_concat.html">.reference.ops.op_concat</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_constant_of_shape.html">.reference.ops.op_constant_of_shape</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_fused_matmul.html">.reference.ops.op_fused_matmul</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_gather_grad.html">.reference.ops.op_gather_grad</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_memcpy_host.html">.reference.ops.op_memcpy_host</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_mul_sigmoid.html">.reference.ops.op_mul_sigmoid</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_negxplus1.html">.reference.ops.op_negxplus1</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_quick_gelu.html">.reference.ops.op_quick_gelu</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_replace_zero.html">.reference.ops.op_replace_zero</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_rotary.html">.reference.ops.op_rotary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_qlinear_average_pool.html">.reference.ops.op_qlinear_average_pool</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_qlinear_conv.html">.reference.ops.op_qlinear_conv</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_scatter_elements.html">.reference.ops.op_scatter_elements</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_scatternd_of_shape.html">.reference.ops.op_scatternd_of_shape</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_simplified_layer_normalization.html">.reference.ops.op_simplified_layer_normalization</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_slice.html">.reference.ops.op_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_transpose_cast.html">.reference.ops.op_transpose_cast</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_tri_matrix.html">.reference.ops.op_tri_matrix</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/reference/evaluator.html">.reference.evaluator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/reference/ort_evaluator.html">.reference.ort_evaluator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/reference/quantized_tensor.html">.reference.quantized_tensor</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/convert/index.html">.convert</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of .convert</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/convert/convert_helper.html">.convert.convert_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/convert/ort_helper.html">.convert.ort_helper</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/plotting/index.html">.plotting</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of .plotting</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/plotting/data.html">.plotting.data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/plotting/memory.html">.plotting.memory</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/skl/index.html">.skl</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of .skl</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/skl/convert.html">.skl.convert</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/skl/helpers.html">.skl.helpers</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/torch_interpreter/index.html">.torch_interpreter</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of .torch_interpreter</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/_aten_functions.html">.torch_interpreter._aten_functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/_aten_functions_attention.html">.torch_interpreter._aten_functions_attention</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/_aten_methods.html">.torch_interpreter._aten_methods</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/_doc_.html">.torch_interpreter._doc_</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/_exceptions.html">.torch_interpreter._exceptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/_prims_functions.html">.torch_interpreter._prims_functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/_torch_helper.html">.torch_interpreter._torch_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/aten_functions.html">.torch_interpreter.aten_functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/aten_methods.html">.torch_interpreter.aten_methods</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/dispatcher.html">.torch_interpreter.dispatcher</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/torch_interpreter/eval/index.html">.torch_interpreter.eval</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle navigation of .torch_interpreter.eval</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/torch_interpreter/eval/model_cases.html">.torch_interpreter.eval.model_cases</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/export_options.html">.torch_interpreter.export_options</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/interpreter.html">.torch_interpreter.interpreter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/investigate_helper.html">.torch_interpreter.investigate_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/onnx_export.html">.torch_interpreter.onnx_export</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/onnx_export_errors.html">.torch_interpreter.onnx_export_errors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/onnx_export_serialization.html">.torch_interpreter.onnx_export_serialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/oxs_dispatcher.html">.torch_interpreter.oxs_dispatcher</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/oxs_opset.html">.torch_interpreter.oxs_opset</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/piece_by_piece.html">.torch_interpreter.piece_by_piece</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/piece_by_piece_serialize.html">.torch_interpreter.piece_by_piece_serialize</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/torch_interpreter/patches/index.html">.torch_interpreter.patches</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><div class="visually-hidden">Toggle navigation of .torch_interpreter.patches</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/torch_interpreter/patches/patch_torch.html">.torch_interpreter.patches.patch_torch</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/torch_interpreter/patches/patch_transformers.html">.torch_interpreter.patches.patch_transformers</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/tracing.html">.torch_interpreter.tracing</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/torch_models/index.html">.torch_models</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><div class="visually-hidden">Toggle navigation of .torch_models</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_models/diffusion_model_helper.html">.torch_models.diffusion_model_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_models/dump_helper.html">.torch_models.dump_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_models/llama_helper.html">.torch_models.llama_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_models/llm_model_helper.html">.torch_models.llm_model_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_models/llm_model_setup.html">.torch_models.llm_model_setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_models/mistral_helper.html">.torch_models.mistral_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_models/phi3_helper.html">.torch_models.phi3_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_models/phi_helper.html">.torch_models.phi_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_models/training_helper.html">.torch_models.training_helper</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/xbuilder/index.html">.xbuilder</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><div class="visually-hidden">Toggle navigation of .xbuilder</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/xbuilder/_graph_builder_runtime.html">.xbuilder._graph_builder_runtime</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xbuilder/_onnx_helper.html">.xbuilder._onnx_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xbuilder/_shape_helper.html">.xbuilder._shape_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xbuilder/expression_dimension.html">.xbuilder.expression_dimension</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xbuilder/graph_builder.html">.xbuilder.graph_builder</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xbuilder/graph_builder_opset.html">.xbuilder.graph_builder_opset</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xbuilder/model_container.html">.xbuilder.model_container</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xbuilder/optimization_options.html">.xbuilder.optimization_options</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xbuilder/shape_type_compute.html">.xbuilder.shape_type_compute</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xbuilder/type_inference.html">.xbuilder.type_inference</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/xoptim/index.html">.xoptim</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" role="switch" type="checkbox"/><label for="toctree-checkbox-17"><div class="visually-hidden">Toggle navigation of .xoptim</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/xoptim/patterns_investigation/index.html">.xoptim.patterns_investigation</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" role="switch" type="checkbox"/><label for="toctree-checkbox-18"><div class="visually-hidden">Toggle navigation of .xoptim.patterns_investigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_investigation/element_wise.html">.xoptim.patterns_investigation.element_wise</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_investigation/llm_patterns.html">.xoptim.patterns_investigation.llm_patterns</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/xoptim/patterns_ml/index.html">.xoptim.patterns_ml</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" role="switch" type="checkbox"/><label for="toctree-checkbox-19"><div class="visually-hidden">Toggle navigation of .xoptim.patterns_ml</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_ml/tree_ensemble.html">.xoptim.patterns_ml.tree_ensemble</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/xoptim/patterns_exp/index.html">.xoptim.patterns_exp</a><input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" role="switch" type="checkbox"/><label for="toctree-checkbox-20"><div class="visually-hidden">Toggle navigation of .xoptim.patterns_exp</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_exp/binary_operators.html">.xoptim.patterns_exp.binary_operators</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_exp/constant_of_shape_scatter_nd.html">.xoptim.patterns_exp.constant_of_shape_scatter_nd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_exp/constants.html">.xoptim.patterns_exp.constants</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_exp/simple_rotary.html">.xoptim.patterns_exp.simple_rotary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_exp/unary_operators.html">.xoptim.patterns_exp.unary_operators</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_exp/where_replace.html">.xoptim.patterns_exp.where_replace</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/xoptim/patterns/index.html">.xoptim.patterns</a><input class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" role="switch" type="checkbox"/><label for="toctree-checkbox-21"><div class="visually-hidden">Toggle navigation of .xoptim.patterns</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_any.html">.xoptim.patterns.onnx_any</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_cast.html">.xoptim.patterns.onnx_cast</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_clip.html">.xoptim.patterns.onnx_clip</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_constants.html">.xoptim.patterns.onnx_constants</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_conv.html">.xoptim.patterns.onnx_conv</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_dropout.html">.xoptim.patterns.onnx_dropout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_equal.html">.xoptim.patterns.onnx_equal</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_expand.html">.xoptim.patterns.onnx_expand</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_functions.html">.xoptim.patterns.onnx_functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_layer_normalization.html">.xoptim.patterns.onnx_layer_normalization</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_matmul.html">.xoptim.patterns.onnx_matmul</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_mul.html">.xoptim.patterns.onnx_mul</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_reduce.html">.xoptim.patterns.onnx_reduce</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_reshape.html">.xoptim.patterns.onnx_reshape</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_rotary.html">.xoptim.patterns.onnx_rotary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_slice.html">.xoptim.patterns.onnx_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_split.html">.xoptim.patterns.onnx_split</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_sub.html">.xoptim.patterns.onnx_sub</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_sequence.html">.xoptim.patterns.onnx_sequence</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_transpose.html">.xoptim.patterns.onnx_transpose</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_unsqueeze.html">.xoptim.patterns.onnx_unsqueeze</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/xoptim/patterns_ort/index.html">.xoptim.patterns_ort</a><input class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" role="switch" type="checkbox"/><label for="toctree-checkbox-22"><div class="visually-hidden">Toggle navigation of .xoptim.patterns_ort</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_ort/activation.html">.xoptim.patterns_ort.activation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_ort/activation_grad.html">.xoptim.patterns_ort.activation_grad</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_ort/batch_normalization.html">.xoptim.patterns_ort.batch_normalization</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_ort/fused_conv.html">.xoptim.patterns_ort.fused_conv</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_ort/fused_matmul.html">.xoptim.patterns_ort.fused_matmul</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_ort/gather_grad.html">.xoptim.patterns_ort.gather_grad</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_ort/llm_optim.html">.xoptim.patterns_ort.llm_optim</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_ort/simplified_layer_normalization.html">.xoptim.patterns_ort.simplified_layer_normalization</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/xoptim/patterns_fix/index.html">.xoptim.patterns_fix</a><input class="toctree-checkbox" id="toctree-checkbox-23" name="toctree-checkbox-23" role="switch" type="checkbox"/><label for="toctree-checkbox-23"><div class="visually-hidden">Toggle navigation of .xoptim.patterns_fix</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_fix/add_reduction_scatter_nd.html">.xoptim.patterns_fix.add_reduction_scatter_nd</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/xoptim/graph_builder_optim.html">.xoptim.graph_builder_optim</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xoptim/order_optim.html">.xoptim.order_optim</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xoptim/patterns_api.html">.xoptim.patterns_api</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/torch_dynamo/index.html">.torch_dynamo</a><input class="toctree-checkbox" id="toctree-checkbox-24" name="toctree-checkbox-24" role="switch" type="checkbox"/><label for="toctree-checkbox-24"><div class="visually-hidden">Toggle navigation of .torch_dynamo</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_dynamo/_dynamo_exporter.html">.torch_dynamo._dynamo_exporter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_dynamo/backend_helper.html">.torch_dynamo.backend_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_dynamo/debug_backend.html">.torch_dynamo.debug_backend</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_dynamo/fast_backend.html">.torch_dynamo.fast_backend</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_dynamo/partition.html">experimental_experiment.torch_dynamo.partition</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/torch_bench/index.html">.torch_bench</a><input class="toctree-checkbox" id="toctree-checkbox-25" name="toctree-checkbox-25" role="switch" type="checkbox"/><label for="toctree-checkbox-25"><div class="visually-hidden">Toggle navigation of .torch_bench</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_benchmark_runner.html">experimental_experiment.torch_bench._bash_bench_benchmark_runner</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_benchmark_runner_agg.html">experimental_experiment.torch_bench._bash_bench_benchmark_runner_agg</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_benchmark_runner_agg_helper.html">experimental_experiment.torch_bench._bash_bench_benchmark_runner_agg_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_cmd.html">experimental_experiment.torch_bench._bash_bench_cmd</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_model_runner.html">experimental_experiment.torch_bench._bash_bench_model_runner</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_models_helper.html">experimental_experiment.torch_bench._bash_bench_models_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_set_dummies.html">experimental_experiment.torch_bench._bash_bench_set_dummies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_set_explicit.html">experimental_experiment.torch_bench._bash_bench_set_explicit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_set_huggingface.html">experimental_experiment.torch_bench._bash_bench_set_huggingface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_set_huggingface_big.html">experimental_experiment.torch_bench._bash_bench_set_huggingface_big</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_set_issues.html">experimental_experiment.torch_bench._bash_bench_set_issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_set_timm.html">experimental_experiment.torch_bench._bash_bench_set_timm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_set_torchbench.html">experimental_experiment.torch_bench._bash_bench_set_torchbench</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_set_torchbench_ado.html">experimental_experiment.torch_bench._bash_bench_set_torchbench_ado</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_suites.html">experimental_experiment.torch_bench._bash_bench_suites</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_dort_cmd_common.html">experimental_experiment.torch_bench._dort_cmd_common</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_dort_cmd_common_models.html">experimental_experiment.torch_bench._dort_cmd_common_models</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/bash_bench_agg.html">.torch_bench.bash_bench_agg</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/bash_bench_explicit.html">.torch_bench.bash_bench_explicit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/bash_bench_huggingface.html">.torch_bench.bash_bench_huggingface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/bash_bench_huggingface_big.html">.torch_bench.bash_bench_huggingface_big</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/bash_bench_issues.html">.torch_bench.bash_bench_issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/bash_bench_timm.html">.torch_bench.bash_bench_timm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/bash_bench_torchbench.html">.torch_bench.bash_bench_torchbench</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/bash_bench_torchbench_ado.html">.torch_bench.bash_bench_torchbench_ado</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/bash_bench_untrained.html">.torch_bench.bash_bench_untrained</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/check_model.html">.torch_bench.check_model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/dort_bench.html">.torch_bench.dort_bench</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/dort_bench_profile.html">.torch_bench.dort_bench_profile</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/dort_profile.html">.torch_bench.dort_profile</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/export_model.html">.torch_bench.export_model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/export_model_helper.html">.torch_bench.export_model_helper</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/_bench_test.html">._bench_test</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/_command_lines_parser.html">._command_lines_parser</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/args.html">.args</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/bench_run.html">.bench_run</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/checks.html">.checks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/ext_test_case.html">.ext_test_case</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/helpers.html">.helpers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/memory_peak.html">.memory_peak</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/mini_onnx_builder.html">.mini_onnx_builder</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/model_run.html">.model_run</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/onnx_tools.html">.onnx_tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/torch_test_helper.html">.torch_test_helper</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../galleries.html">Galleries of Examples and Recipes</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-26" name="toctree-checkbox-26" role="switch" type="checkbox"/><label for="toctree-checkbox-26"><div class="visually-hidden">Toggle navigation of Galleries of Examples and Recipes</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2 current has-children"><a class="reference internal" href="index.html">Examples Gallery</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-27" name="toctree-checkbox-27" role="switch" type="checkbox"/><label for="toctree-checkbox-27"><div class="visually-hidden">Toggle navigation of Examples Gallery</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="plot_torch_custom_backend_101.html">101: A custom backend for torch</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_torch_linreg_101.html">101: Linear Regression and export to ONNX</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_optimize_101.html">101: Onnx Model Optimization based on Pattern Rewriting</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_rewrite_101.html">101: Onnx Model Rewriting</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_profile_existing_onnx_101.html">101: Profile an existing model with onnxruntime</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_torch_export_101.html">101: Some dummy examples with torch.export.export</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_convolutation_matmul_102.html">102: Convolution and Matrix Multiplication</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_onnxscript_102.html">102: Examples with onnxscript</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_custom_backend_llama_102.html">102: Fuse kernels in a small Llama Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_llama_bench_102.html">102: Measure LLAMA speed</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_torch_export_compile_102.html">102: Tweak onnx export</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_torch_dort_201.html">201: Evaluate DORT</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_torch_aot_201.html">201: Evaluate DORT Training</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_torch_export_201.html">201: Evaluate different ways to export a torch model to ONNX</a></li>
<li class="toctree-l3 current current-page"><a class="current reference internal" href="#">201: Use torch to export a scikit-learn model into ONNX</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_llama_diff_export_301.html">301: Compares LLAMA exporters</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_llama_diff_dort_301.html">301: Compares LLAMA exporters for onnxrt backend</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../auto_recipes/index.html">Exporter Recipes Gallery</a><input class="toctree-checkbox" id="toctree-checkbox-28" name="toctree-checkbox-28" role="switch" type="checkbox"/><label for="toctree-checkbox-28"><div class="visually-hidden">Toggle navigation of Exporter Recipes Gallery</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_exporter_lost_dynamic_dimension.html">A dynamic dimension lost by torch.export.export</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_exporter_inputs.html">Do no use Module as inputs!</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_exporter_phi35_piece.html">Export Phi-3.5-mini-instruct piece by piece</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_exporter_draft_mode.html">Export Phi-3.5-mini-instruct with draft_export</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_exporter_reportibility.html">Export Phi-3.5-mini-instruct with report_exportability</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_exporter_with_dynamic_cache.html">Export a model using a custom type as input</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_exporter_scan_pdist.html">Export a model with a loop (scan)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_exporter_infer_ds.html">Infer dynamic shapes before exporting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_oe_lr.html">Linear Regression and export to ONNX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_coverage.html">Measures the exporter success on many test cases</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_exporter_dynamic_shapes_auto.html">Use DYNAMIC or AUTO when dynamic shapes has constraints</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_c_phi2.html">to_onnx and Phi-2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_c_custom_ops_inplace.html">to_onnx and a custom operator inplace</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_c_custom_ops_fct.html">to_onnx and a custom operator registered with a function</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_c_scan_pdist.html">to_onnx and a model with a loop (scan)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_c_cond.html">to_onnx and a model with a test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_c_dynpad.html">to_onnx and padding one dimension to a mulitple of a constant</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_c_modules.html">to_onnx and submodules from LLMs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_c_named_ds_auto.html">to_onnx: Rename Dynamic Shapes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_oe_phi2.html">torch.onnx.export and Phi-2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_oe_cond.html">torch.onnx.export and a model with a test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_oe_dynpad.html">torch.onnx.export and padding one dimension to a mulitple of a constant</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_oe_named_ds_auto.html">torch.onnx.export: Rename Dynamic Shapes</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../command_lines.html">Command Lines</a><input class="toctree-checkbox" id="toctree-checkbox-29" name="toctree-checkbox-29" role="switch" type="checkbox"/><label for="toctree-checkbox-29"><div class="visually-hidden">Toggle navigation of Command Lines</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../bench/index.html">Benchmarks from the command line</a><input class="toctree-checkbox" id="toctree-checkbox-30" name="toctree-checkbox-30" role="switch" type="checkbox"/><label for="toctree-checkbox-30"><div class="visually-hidden">Toggle navigation of Benchmarks from the command line</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../bench/dort_bench.html">experimental_experiment.torch_bench.dort_bench</a></li>
<li class="toctree-l3"><a class="reference internal" href="../bench/dort_profile.html">experimental_experiment.torch_bench.dort_profile</a></li>
<li class="toctree-l3"><a class="reference internal" href="../bench/scripts.html">Interesting scripts or command lines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../bench/bash_bench.html">Measuring the exporters on a short list of sets of models</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../tools/index.html">Tools from the command line</a><input class="toctree-checkbox" id="toctree-checkbox-31" name="toctree-checkbox-31" role="switch" type="checkbox"/><label for="toctree-checkbox-31"><div class="visually-hidden">Toggle navigation of Tools from the command line</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../tools/lighten.html">python -m experimental_experiment lighten and unlighten</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tools/optimize.html">python -m experimental_experiment optimize</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tools/print.html">python -m experimental_experiment print</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tools/run.html">python -m experimental_experiment run</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../miscellaneous/index.html">Miscellaneous</a><input class="toctree-checkbox" id="toctree-checkbox-32" name="toctree-checkbox-32" role="switch" type="checkbox"/><label for="toctree-checkbox-32"><div class="visually-hidden">Toggle navigation of Miscellaneous</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../miscellaneous/export_times.html">Export Times</a></li>
<li class="toctree-l2"><a class="reference internal" href="../miscellaneous/long_outputs.html">Long Outputs uneasy to read</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../miscellaneous/models/index.html">Supported Models By the Custom Backend</a><input class="toctree-checkbox" id="toctree-checkbox-33" name="toctree-checkbox-33" role="switch" type="checkbox"/><label for="toctree-checkbox-33"><div class="visually-hidden">Toggle navigation of Supported Models By the Custom Backend</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../miscellaneous/models/phi.html">Phi</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">More</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../CHANGELOGS.html">Change Logs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">License</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/auto_examples/plot_torch_sklearn_201.rst" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-auto-examples-plot-torch-sklearn-201-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="use-torch-to-export-a-scikit-learn-model-into-onnx">
<span id="l-plot-torch-sklearn-201"></span><span id="sphx-glr-auto-examples-plot-torch-sklearn-201-py"></span><h1>201: Use torch to export a scikit-learn model into ONNX<a class="headerlink" href="#use-torch-to-export-a-scikit-learn-model-into-onnx" title="Link to this heading">¶</a></h1>
<p>When <a class="reference external" href="https://onnx.ai/sklearn-onnx/">sklearn-onnx</a> is missing a converter, <a class="reference external" href="https://pytorch.org/docs/stable/torch.html">torch</a> can be used
to write it. We use <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="(in scikit-learn v1.6)"><code class="xref py py-class docutils literal notranslate"><span class="pre">sklearn.impute.KNNImputer</span></code></a> as an example.
The first step is to rewrite the scikit-learn model with torch functions.
The code is then refactored and split into submodules to be able
to bypass some pieces <a class="reference external" href="https://pytorch.org/docs/main/export.html#torch.export.export" title="(in PyTorch vmain (2.7.0a0+gita9ae334 ))"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.export.export()</span></code></a> cannot process.</p>
<section id="torch-implementation-of-nan-euclidean">
<h2>torch implementation of nan_euclidean<a class="headerlink" href="#torch-implementation-of-nan-euclidean" title="Link to this heading">¶</a></h2>
<p>Let’s start with a simple case, a pairwise distance.
See <code class="xref py py-func docutils literal notranslate"><span class="pre">sklearn.metrics.nan_euclidean()</span></code>.</p>
<section id="module">
<h3>Module<a class="headerlink" href="#module" title="Link to this heading">¶</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <a href="https://docs.python.org/3/library/typing.html#typing.Any" title="typing.Any" class="sphx-glr-backref-module-typing sphx-glr-backref-type-py-data"><a href="https://docs.python.org/3/library/typing.html#typing.Any" title="typing.Any" class="sphx-glr-backref-module-typing sphx-glr-backref-type-py-data"><span class="n">Any</span></a></a><span class="p">,</span> <a href="https://docs.python.org/3/library/typing.html#typing.Dict" title="typing.Dict" class="sphx-glr-backref-module-typing sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/typing.html#typing.Dict" title="typing.Dict" class="sphx-glr-backref-module-typing sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Dict</span></a></a><span class="p">,</span> <a href="https://docs.python.org/3/library/typing.html#typing.List" title="typing.List" class="sphx-glr-backref-module-typing sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/typing.html#typing.List" title="typing.List" class="sphx-glr-backref-module-typing sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">List</span></a></a><span class="p">,</span> <a href="https://docs.python.org/3/library/typing.html#typing.Optional" title="typing.Optional" class="sphx-glr-backref-module-typing sphx-glr-backref-type-py-data"><a href="https://docs.python.org/3/library/typing.html#typing.Optional" title="typing.Optional" class="sphx-glr-backref-module-typing sphx-glr-backref-type-py-data"><span class="n">Optional</span></a></a>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">onnx</span>
<span class="kn">from</span> <span class="nn">onnx.reference.ops.op_topk</span> <span class="kn">import</span> <span class="n">TopK_11</span> <span class="k">as</span> <span class="n">TopK</span>
<span class="kn">import</span> <span class="nn">sklearn</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">onnxruntime</span>
<span class="kn">from</span> <span class="nn">experimental_experiment.reference</span> <span class="kn">import</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/reference/index.html#experimental_experiment.reference.ExtendedReferenceEvaluator" title="experimental_experiment.reference.ExtendedReferenceEvaluator" class="sphx-glr-backref-module-experimental_experiment-reference sphx-glr-backref-type-py-class"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/reference/index.html#experimental_experiment.reference.ExtendedReferenceEvaluator" title="experimental_experiment.reference.ExtendedReferenceEvaluator" class="sphx-glr-backref-module-experimental_experiment-reference sphx-glr-backref-type-py-class"><span class="n">ExtendedReferenceEvaluator</span></a></a>
<span class="kn">from</span> <span class="nn">experimental_experiment.xbuilder</span> <span class="kn">import</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/xbuilder/index.html#experimental_experiment.xbuilder.GraphBuilder" title="experimental_experiment.xbuilder.GraphBuilder" class="sphx-glr-backref-module-experimental_experiment-xbuilder sphx-glr-backref-type-py-class"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/xbuilder/index.html#experimental_experiment.xbuilder.GraphBuilder" title="experimental_experiment.xbuilder.GraphBuilder" class="sphx-glr-backref-module-experimental_experiment-xbuilder sphx-glr-backref-type-py-class"><span class="n">GraphBuilder</span></a></a>
<span class="kn">from</span> <span class="nn">experimental_experiment.helpers</span> <span class="kn">import</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/helpers.html#experimental_experiment.helpers.max_diff" title="experimental_experiment.helpers.max_diff" class="sphx-glr-backref-module-experimental_experiment-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/helpers.html#experimental_experiment.helpers.max_diff" title="experimental_experiment.helpers.max_diff" class="sphx-glr-backref-module-experimental_experiment-helpers sphx-glr-backref-type-py-function"><span class="n">max_diff</span></a></a><span class="p">,</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/helpers.html#experimental_experiment.helpers.pretty_onnx" title="experimental_experiment.helpers.pretty_onnx" class="sphx-glr-backref-module-experimental_experiment-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/helpers.html#experimental_experiment.helpers.pretty_onnx" title="experimental_experiment.helpers.pretty_onnx" class="sphx-glr-backref-module-experimental_experiment-helpers sphx-glr-backref-type-py-function"><span class="n">pretty_onnx</span></a></a>
<span class="kn">from</span> <span class="nn">experimental_experiment.skl.helpers</span> <span class="kn">import</span> <span class="n">flatnonzero</span><span class="p">,</span> <span class="n">_get_weights</span>
<span class="kn">from</span> <span class="nn">experimental_experiment.torch_interpreter</span> <span class="kn">import</span> <span class="n">make_undefined_dimension</span><span class="p">,</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.Dispatcher" title="experimental_experiment.torch_interpreter.Dispatcher" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-class"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.Dispatcher" title="experimental_experiment.torch_interpreter.Dispatcher" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-class"><span class="n">Dispatcher</span></a></a>
<span class="kn">from</span> <span class="nn">experimental_experiment.torch_interpreter.onnx_export_errors</span> <span class="kn">import</span> <span class="p">(</span>
    <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/onnx_export_errors.html#experimental_experiment.torch_interpreter.onnx_export_errors.bypass_export_some_errors" title="experimental_experiment.torch_interpreter.onnx_export_errors.bypass_export_some_errors" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-onnx_export_errors sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/onnx_export_errors.html#experimental_experiment.torch_interpreter.onnx_export_errors.bypass_export_some_errors" title="experimental_experiment.torch_interpreter.onnx_export_errors.bypass_export_some_errors" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-onnx_export_errors sphx-glr-backref-type-py-function"><span class="n">bypass_export_some_errors</span></a></a><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">experimental_experiment.torch_interpreter.piece_by_piece</span> <span class="kn">import</span> <span class="p">(</span>
    <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" title="experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" title="experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-function"><span class="n">trace_execution_piece_by_piece</span></a></a><span class="p">,</span>
    <span class="n">CustomOpStrategy</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">NanEuclidean</span><span class="p">(</span><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span></a></a><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Implements :func:`sklearn.metrics.nan_euclidean`.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">squared</span> <span class="o">=</span> <span class="n">squared</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copy</span> <span class="o">=</span> <span class="n">copy</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">,</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a><span class="p">):</span>
        <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a> <span class="o">=</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a> <span class="o">=</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">dtype</span></a></a><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

        <span class="n">missing_X</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span></a></a><span class="p">(</span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">)</span>
        <span class="n">missing_Y</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span></a></a><span class="p">(</span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a><span class="p">)</span>

        <span class="c1"># set missing values to zero</span>
        <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">[</span><span class="n">missing_X</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a><span class="p">[</span><span class="n">missing_Y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Adjust distances for missing values</span>
        <span class="n">XX</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a> <span class="o">*</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a>
        <span class="n">YY</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a> <span class="o">*</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a>

        <span class="n">distances</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a> <span class="o">@</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span><span class="o">.</span><span class="n">T</span></a></a> <span class="o">+</span> <span class="n">XX</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="n">YY</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class"><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class"><span class="n">T</span></a></a>

        <span class="n">distances</span> <span class="o">-=</span> <span class="n">XX</span> <span class="o">@</span> <span class="n">missing_Y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">dtype</span></a></a><span class="p">)</span><span class="o">.</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class"><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class"><span class="n">T</span></a></a>
        <span class="n">distances</span> <span class="o">-=</span> <span class="n">missing_X</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">dtype</span></a></a><span class="p">)</span> <span class="o">@</span> <span class="n">YY</span><span class="o">.</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class"><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class"><span class="n">T</span></a></a>

        <span class="n">distances</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.clip.html#torch.clip" title="torch.clip" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.clip.html#torch.clip" title="torch.clip" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">clip</span></a></a><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">present_X</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">missing_X</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">dtype</span></a></a><span class="p">)</span>
        <span class="n">present_Y</span> <span class="o">=</span> <span class="o">~</span><span class="n">missing_Y</span>
        <span class="n">present_count</span> <span class="o">=</span> <span class="n">present_X</span> <span class="o">@</span> <span class="n">present_Y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">dtype</span></a></a><span class="p">)</span><span class="o">.</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class"><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class"><span class="n">T</span></a></a>
        <span class="n">distances</span><span class="p">[</span><span class="n">present_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">torch</span><span class="o">.</span><span class="n">nan</span></a></a>
        <span class="c1"># avoid divide by zero</span>
        <span class="n">present_count</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.maximum.html#torch.maximum" title="torch.maximum" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.maximum.html#torch.maximum" title="torch.maximum" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">maximum</span></a></a><span class="p">(</span>
            <a href="https://pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span></a></a><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">present_count</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">present_count</span>
        <span class="p">)</span>
        <span class="n">distances</span> <span class="o">/=</span> <span class="n">present_count</span>
        <span class="n">distances</span> <span class="o">*=</span> <a href="https://pytorch.org/docs/main/size.html#torch.Size" title="torch.Size" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/size.html#torch.Size" title="torch.Size" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">shape</span></a></a><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">squared</span><span class="p">:</span>
            <span class="n">distances</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">distances</span>
</pre></div>
</div>
</section>
<section id="validation">
<h3>Validation<a class="headerlink" href="#validation" title="Link to this heading">¶</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">NanEuclidean</span></a></a><span class="p">()</span>
<a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.randn.html#torch.randn" title="torch.randn" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.randn.html#torch.randn" title="torch.randn" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">randn</span></a></a><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.randn.html#torch.randn" title="torch.randn" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.randn.html#torch.randn" title="torch.randn" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">randn</span></a></a><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="k">for</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a></a> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">[</span><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a></a><span class="p">,</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a></a> <span class="o">%</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">torch</span><span class="o">.</span><span class="n">nan</span></a></a>
<span class="k">for</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a></a> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a><span class="p">[</span><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a></a> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a></a> <span class="o">%</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">torch</span><span class="o">.</span><span class="n">nan</span></a></a>

<a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">d1</span></a></a> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">nan_euclidean_distances</span><span class="p">(</span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">d2</span></a></a> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">,</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;discrepancies: </span><span class="si">{</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/helpers.html#experimental_experiment.helpers.max_diff" title="experimental_experiment.helpers.max_diff" class="sphx-glr-backref-module-experimental_experiment-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/helpers.html#experimental_experiment.helpers.max_diff" title="experimental_experiment.helpers.max_diff" class="sphx-glr-backref-module-experimental_experiment-helpers sphx-glr-backref-type-py-function"><span class="n">max_diff</span></a></a><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">d1</span></a></a><span class="p">,</span><span class="w"> </span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">d2</span></a></a><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>discrepancies: {&#39;abs&#39;: 2.384185791015625e-07, &#39;rel&#39;: 2.0627543198679525e-07, &#39;sum&#39;: 4.172325134277344e-07, &#39;n&#39;: 25.0, &#39;dnan&#39;: 0.0}
</pre></div>
</div>
</section>
</section>
<section id="torch-implementation-of-knnimputer">
<h2>torch implementation of KNNImputer<a class="headerlink" href="#torch-implementation-of-knnimputer" title="Link to this heading">¶</a></h2>
<p>See <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="(in scikit-learn v1.6)"><code class="xref py py-class docutils literal notranslate"><span class="pre">sklearn.impute.KNNImputer</span></code></a>.
The code is split into several <a class="reference external" href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="(in PyTorch vmain (2.7.0a0+gita9ae334 ))"><code class="xref py py-class docutils literal notranslate"><span class="pre">torch.nn.Module</span></code></a>
and refactored to avoid control flow.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_get_mask</span><span class="p">(</span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">,</span> <span class="n">value_to_mask</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <a href="https://pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span></a></a><span class="p">(</span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>  <span class="c1"># sklearn.utils._missing.is_scalar_nan(value_to_mask)</span>
            <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value_to_mask</span><span class="p">,</span> <a href="https://docs.python.org/3/library/numbers.html#numbers.Integral" title="numbers.Integral" class="sphx-glr-backref-module-numbers sphx-glr-backref-type-py-class"><a href="https://docs.python.org/3/library/numbers.html#numbers.Integral" title="numbers.Integral" class="sphx-glr-backref-module-numbers sphx-glr-backref-type-py-class"><span class="n">numbers</span><span class="o">.</span><span class="n">Integral</span></a></a><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value_to_mask</span><span class="p">,</span> <a href="https://docs.python.org/3/library/numbers.html#numbers.Real" title="numbers.Real" class="sphx-glr-backref-module-numbers sphx-glr-backref-type-py-class"><a href="https://docs.python.org/3/library/numbers.html#numbers.Real" title="numbers.Real" class="sphx-glr-backref-module-numbers sphx-glr-backref-type-py-class"><span class="n">numbers</span><span class="o">.</span><span class="n">Real</span></a></a><span class="p">)</span>
            <span class="ow">and</span> <a href="https://docs.python.org/3/library/math.html#math.isnan" title="math.isnan" class="sphx-glr-backref-module-math sphx-glr-backref-type-py-function"><a href="https://docs.python.org/3/library/math.html#math.isnan" title="math.isnan" class="sphx-glr-backref-module-math sphx-glr-backref-type-py-function"><span class="n">math</span><span class="o">.</span><span class="n">isnan</span></a></a><span class="p">(</span><span class="n">value_to_mask</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">else</span> <span class="p">(</span><span class="n">value_to_mask</span> <span class="o">==</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">)</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">SubTopKIndices</span><span class="p">(</span><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span></a></a><span class="p">):</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x</span></a></a><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="c1"># torch does not like nans</span>
        <span class="n">xn</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.nan_to_num.html#torch.nan_to_num" title="torch.nan_to_num" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.nan_to_num.html#torch.nan_to_num" title="torch.nan_to_num" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">nan_to_num</span></a></a><span class="p">(</span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x</span></a></a><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">1.0e10</span><span class="p">)</span>
        <span class="k">return</span> <a href="https://pytorch.org/docs/main/generated/torch.topk.html#torch.topk" title="torch.topk" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.topk.html#torch.topk" title="torch.topk" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">topk</span></a></a><span class="p">(</span><span class="n">xn</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">largest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">indices</span>


<span class="k">class</span> <span class="nc">SubWeightMatrix</span><span class="p">(</span><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span></a></a><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">donors_dist</span><span class="p">):</span>
        <span class="n">weight_matrix</span> <span class="o">=</span> <span class="n">_get_weights</span><span class="p">(</span><span class="n">donors_dist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">weight_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weight_matrix</span> <span class="o">=</span> <span class="n">weight_matrix</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="n">weight_matrix</span><span class="p">[</span><a href="https://pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span></a></a><span class="p">(</span><span class="n">weight_matrix</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weight_matrix</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.ones_like.html#torch.ones_like" title="torch.ones_like" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.ones_like.html#torch.ones_like" title="torch.ones_like" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span></a></a><span class="p">(</span><span class="n">donors_dist</span><span class="p">)</span>
            <span class="n">weight_matrix</span><span class="p">[</span><a href="https://pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span></a></a><span class="p">(</span><span class="n">donors_dist</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="n">weight_matrix</span>


<span class="k">class</span> <span class="nc">SubDonorsIdx</span><span class="p">(</span><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span></a></a><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_topk</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">SubTopKIndices</span></a></a><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist_pot_donors</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">):</span>
        <span class="n">donors_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topk</span><span class="p">(</span><span class="n">dist_pot_donors</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">)</span>
        <span class="n">donors_dist</span> <span class="o">=</span> <span class="n">dist_pot_donors</span><span class="p">[</span><a href="https://pytorch.org/docs/main/generated/torch.arange.html#torch.arange" title="torch.arange" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.arange.html#torch.arange" title="torch.arange" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">arange</span></a></a><span class="p">(</span><span class="n">donors_idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">donors_idx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">donors_idx</span><span class="p">,</span> <span class="n">donors_dist</span>


<span class="k">class</span> <span class="nc">MakeNewWeights</span><span class="p">(</span><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span></a></a><span class="p">):</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">donors_mask</span><span class="p">,</span> <span class="n">donors</span><span class="p">,</span> <span class="n">weight_matrix</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">donors_mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">donors</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight_matrix</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">donors</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CalcImpute</span><span class="p">(</span><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span></a></a><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Implements :meth:`sklearn.impute.KNNImputer._calc_impute`.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">SubWeightMatrix</span></a></a><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_donors_idx</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">SubDonorsIdx</span></a></a><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_new_neights</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">MakeNewWeights</span></a></a><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_calc_impute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist_pot_donors</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">,</span> <span class="n">fit_X_col</span><span class="p">,</span> <span class="n">mask_fit_X_col</span><span class="p">):</span>
        <span class="n">donors_idx</span><span class="p">,</span> <span class="n">donors_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_donors_idx</span><span class="p">(</span><span class="n">dist_pot_donors</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">)</span>
        <span class="n">weight_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span><span class="p">(</span><span class="n">donors_dist</span><span class="p">)</span>
        <span class="c1"># Retrieve donor values and calculate kNN average</span>
        <span class="n">donors</span> <span class="o">=</span> <span class="n">fit_X_col</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">donors_idx</span><span class="p">)</span>
        <span class="n">donors_mask</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span></a></a><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">donors_idx</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span>
            <span class="n">mask_fit_X_col</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">donors_idx</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">donors_idx</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="n">new_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_new_neights</span><span class="p">(</span><span class="n">donors_mask</span><span class="p">,</span> <span class="n">donors</span><span class="p">,</span> <span class="n">weight_matrix</span><span class="p">)</span>

        <span class="n">weights_sum</span> <span class="o">=</span> <span class="n">new_weights</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">div</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.where.html#torch.where" title="torch.where" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.where.html#torch.where" title="torch.where" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">where</span></a></a><span class="p">(</span>
            <span class="n">weights_sum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <a href="https://pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span></a></a><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">weights_sum</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">weights_sum</span>
        <span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">donors</span> <span class="o">*</span> <span class="n">new_weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">/</span> <span class="n">div</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dist_pot_donors</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist_pot_donors</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">,</span> <span class="n">fit_X_col</span><span class="p">,</span> <span class="n">mask_fit_X_col</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_impute</span><span class="p">(</span><span class="n">dist_pot_donors</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">,</span> <span class="n">fit_X_col</span><span class="p">,</span> <span class="n">mask_fit_X_col</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ColProcessor</span><span class="p">(</span><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span></a></a><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Processes one column (= one feature).&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_impute</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">CalcImpute</span></a></a><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_neighbors</span> <span class="o">=</span> <span class="n">n_neighbors</span>

    <span class="k">def</span> <span class="nf">process_one_col</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">,</span>
        <span class="n">dist_chunk</span><span class="p">,</span>
        <span class="n">non_missing_fix_X</span><span class="p">,</span>
        <span class="n">mask_fit_X</span><span class="p">,</span>
        <span class="n">dist_idx_map</span><span class="p">,</span>
        <span class="n">mask</span><span class="p">,</span>
        <span class="n">row_missing_idx</span><span class="p">,</span>
        <span class="n">_fit_X</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span>
        <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a> <span class="o">=</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">row_missing_chunk</span> <span class="o">=</span> <span class="n">row_missing_idx</span>
        <span class="n">col_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">row_missing_chunk</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>

        <span class="n">potential_donors_idx</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.nonzero.html#torch.nonzero" title="torch.nonzero" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.nonzero.html#torch.nonzero" title="torch.nonzero" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">nonzero</span></a></a><span class="p">(</span><span class="n">non_missing_fix_X</span><span class="p">[:,</span> <span class="n">col</span><span class="p">],</span> <span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># receivers_idx are indices in X</span>
        <span class="n">receivers_idx</span> <span class="o">=</span> <span class="n">row_missing_chunk</span><span class="p">[</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">col_mask</span><span class="p">)]</span>

        <span class="c1"># distances for samples that needed imputation for column</span>
        <span class="n">dist_subset</span> <span class="o">=</span> <span class="n">dist_chunk</span><span class="p">[</span><span class="n">dist_idx_map</span><span class="p">[</span><span class="n">receivers_idx</span><span class="p">]][:,</span> <span class="n">potential_donors_idx</span><span class="p">]</span>

        <span class="c1"># receivers with all nan distances impute with mean</span>
        <span class="n">all_nan_dist_mask</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span></a></a><span class="p">(</span><span class="n">dist_subset</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">all_nan_receivers_idx</span> <span class="o">=</span> <span class="n">receivers_idx</span><span class="p">[</span><span class="n">all_nan_dist_mask</span><span class="p">]</span>

        <span class="c1"># when all_nan_receivers_idx is not empty (training set is small)</span>
        <span class="n">mask_</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">mask_fit_X</span><span class="p">[:,</span> <span class="n">col</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">_fit_X</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">mask_sum</span> <span class="o">=</span> <span class="n">mask_</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">dtype</span></a></a><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">col_sum</span> <span class="o">=</span> <span class="p">(</span><span class="n">_fit_X</span><span class="p">[</span><span class="n">mask_</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">dtype</span></a></a><span class="p">)</span>
        <span class="n">div</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.where.html#torch.where" title="torch.where" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.where.html#torch.where" title="torch.where" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">where</span></a></a><span class="p">(</span><span class="n">mask_sum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mask_sum</span><span class="p">,</span> <a href="https://pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span></a></a><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">mask_sum</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
        <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">[</span><span class="n">all_nan_receivers_idx</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_sum</span> <span class="o">/</span> <span class="n">div</span>

        <span class="c1"># receivers with at least one defined distance</span>
        <span class="n">receivers_idx</span> <span class="o">=</span> <span class="n">receivers_idx</span><span class="p">[</span><span class="o">~</span><span class="n">all_nan_dist_mask</span><span class="p">]</span>
        <span class="n">dist_subset</span> <span class="o">=</span> <span class="n">dist_chunk</span><span class="p">[</span><span class="n">dist_idx_map</span><span class="p">[</span><span class="n">receivers_idx</span><span class="p">]][:,</span> <span class="n">potential_donors_idx</span><span class="p">]</span>

        <span class="c1"># when all_nan_receivers_idx is not empty (training set is big)</span>
        <span class="n">tn</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span></a></a><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_neighbors</span><span class="p">)</span>
        <span class="n">n_neighbors</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.where.html#torch.where" title="torch.where" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.where.html#torch.where" title="torch.where" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">where</span></a></a><span class="p">(</span>
            <span class="n">tn</span> <span class="o">&lt;</span> <span class="n">potential_donors_idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tn</span><span class="p">,</span> <span class="n">potential_donors_idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># to make sure n_neighbors &gt; 0</span>
        <span class="n">n_neighbors</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.where.html#torch.where" title="torch.where" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.where.html#torch.where" title="torch.where" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">where</span></a></a><span class="p">(</span>
            <span class="n">n_neighbors</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <a href="https://pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span></a></a><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">n_neighbors</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">n_neighbors</span>
        <span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_impute</span><span class="p">(</span>
            <span class="n">dist_subset</span><span class="p">,</span>
            <span class="n">n_neighbors</span><span class="p">,</span>
            <span class="n">_fit_X</span><span class="p">[</span><span class="n">potential_donors_idx</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span>
            <span class="n">mask_fit_X</span><span class="p">[</span><span class="n">potential_donors_idx</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span>
        <span class="p">)</span>
        <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">[</span><span class="n">receivers_idx</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">dtype</span></a></a><span class="p">)</span>
        <span class="k">return</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">,</span>
        <span class="n">dist_chunk</span><span class="p">,</span>
        <span class="n">non_missing_fix_X</span><span class="p">,</span>
        <span class="n">mask_fit_X</span><span class="p">,</span>
        <span class="n">dist_idx_map</span><span class="p">,</span>
        <span class="n">mask</span><span class="p">,</span>
        <span class="n">row_missing_idx</span><span class="p">,</span>
        <span class="n">_fit_X</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_one_col</span><span class="p">(</span>
            <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">,</span>
            <span class="n">dist_chunk</span><span class="p">,</span>
            <span class="n">non_missing_fix_X</span><span class="p">,</span>
            <span class="n">mask_fit_X</span><span class="p">,</span>
            <span class="n">dist_idx_map</span><span class="p">,</span>
            <span class="n">mask</span><span class="p">,</span>
            <span class="n">row_missing_idx</span><span class="p">,</span>
            <span class="n">_fit_X</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">MakeDictIdxMap</span><span class="p">(</span><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span></a></a><span class="p">):</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">,</span> <span class="n">row_missing_idx</span><span class="p">):</span>
        <span class="n">dist_idx_map</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.zeros.html#torch.zeros" title="torch.zeros" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.zeros.html#torch.zeros" title="torch.zeros" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span></a></a><span class="p">(</span><a href="https://pytorch.org/docs/main/size.html#torch.Size" title="torch.Size" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/size.html#torch.Size" title="torch.Size" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">shape</span></a></a><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">dist_idx_map</span><span class="p">[</span><span class="n">row_missing_idx</span><span class="p">]</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.arange.html#torch.arange" title="torch.arange" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.arange.html#torch.arange" title="torch.arange" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">arange</span></a></a><span class="p">(</span><span class="n">row_missing_idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">dist_idx_map</span>


<span class="k">class</span> <span class="nc">TorchKNNImputer</span><span class="p">(</span><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span></a></a><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">knn_imputer</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">knn_imputer</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;nan_euclidean&quot;</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Not implemented for metric=</span><span class="si">{</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">metric</span><span class="si">!r}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">NanEuclidean</span></a></a><span class="p">()</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_fit_X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">ColProcessor</span></a></a><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">n_neighbors</span><span class="p">,</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">weights</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.nn.ModuleList.html#torch.nn.ModuleList" title="torch.nn.ModuleList" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://pytorch.org/docs/main/generated/torch.nn.ModuleList.html#torch.nn.ModuleList" title="torch.nn.ModuleList" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span></a></a><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
        <span class="c1"># refactoring</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_dict_idx_map</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">MakeDictIdxMap</span></a></a><span class="p">()</span>
        <span class="c1"># knn imputer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">missing_values</span> <span class="o">=</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">missing_values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_neighbors</span> <span class="o">=</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">n_neighbors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">metric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_empty_features</span> <span class="o">=</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">keep_empty_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_indicator</span> <span class="o">=</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">add_indicator</span>
        <span class="c1"># results of fitting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indicator_</span> <span class="o">=</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">indicator_</span>
        <span class="c1"># The training results.</span>
        <span class="c1"># self._fit_X = torch.from_numpy(knn_imputer._fit_X)</span>
        <span class="c1"># self._mask_fit_X = torch.from_numpy(knn_imputer._mask_fit_X)</span>
        <span class="c1"># self._valid_mask = torch.from_numpy(knn_imputer._valid_mask)</span>

    <span class="k">def</span> <span class="nf">_transform_indicator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_indicator</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;indicator_&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Make sure to call _fit_indicator before _transform_indicator&quot;</span>
                <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indicator_</span><span class="p">))</span>
            <span class="c1"># return self.indicator_.transform(X)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_concatenate_indicator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_imputed</span><span class="p">,</span> <span class="n">X_indicator</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_indicator</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">X_imputed</span>
        <span class="k">if</span> <span class="n">X_indicator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Data from the missing indicator are not provided. Call &quot;</span>
                <span class="s2">&quot;_fit_indicator and _transform_indicator in the imputer &quot;</span>
                <span class="s2">&quot;implementation.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <a href="https://pytorch.org/docs/main/generated/torch.cat.html#torch.cat" title="torch.cat" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.cat.html#torch.cat" title="torch.cat" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">cat</span></a></a><span class="p">([</span><span class="n">X_imputed</span><span class="p">,</span> <span class="n">X_indicator</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask_fit_X</span><span class="p">,</span> <span class="n">_valid_mask</span><span class="p">,</span> <span class="n">_fit_X</span><span class="p">,</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">):</span>
        <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a> <span class="o">=</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">_get_mask</span><span class="p">(</span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">missing_values</span><span class="p">)</span>

        <span class="n">X_indicator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_indicator</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

        <span class="n">row_missing_idx</span> <span class="o">=</span> <span class="n">flatnonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,</span> <span class="n">_valid_mask</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">non_missing_fix_X</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.logical_not.html#torch.logical_not" title="torch.logical_not" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.logical_not.html#torch.logical_not" title="torch.logical_not" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">logical_not</span></a></a><span class="p">(</span><span class="n">mask_fit_X</span><span class="p">)</span>

        <span class="c1"># Maps from indices from X to indices in dist matrix</span>
        <span class="n">dist_idx_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_dict_idx_map</span><span class="p">(</span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">,</span> <span class="n">row_missing_idx</span><span class="p">)</span>

        <span class="c1"># process in fixed-memory chunks</span>
        <span class="n">pairwise_distances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">[</span><span class="n">row_missing_idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">_fit_X</span><span class="p">)</span>

        <span class="c1"># The export unfold the loop as it depends on the number of features.</span>
        <span class="c1"># Fixed in this case.</span>
        <span class="k">for</span> <span class="n">col_processor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a> <span class="o">=</span> <span class="n">col_processor</span><span class="p">(</span>
                <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">,</span>
                <span class="n">pairwise_distances</span><span class="p">,</span>
                <span class="n">non_missing_fix_X</span><span class="p">,</span>
                <span class="n">mask_fit_X</span><span class="p">,</span>
                <span class="n">dist_idx_map</span><span class="p">,</span>
                <span class="n">mask</span><span class="p">,</span>
                <span class="n">row_missing_idx</span><span class="p">,</span>
                <span class="n">_fit_X</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_empty_features</span><span class="p">:</span>
            <span class="n">Xc</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="n">Xc</span><span class="p">[:,</span> <span class="o">~</span><span class="n">_valid_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Xc</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">[:,</span> <span class="n">_valid_mask</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concatenate_indicator</span><span class="p">(</span><span class="n">Xc</span><span class="p">,</span> <span class="n">X_indicator</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_mask_fit_X</span><span class="p">,</span> <span class="n">_valid_mask</span><span class="p">,</span> <span class="n">_fit_X</span><span class="p">,</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">_mask_fit_X</span><span class="p">,</span> <span class="n">_valid_mask</span><span class="p">,</span> <span class="n">_fit_X</span><span class="p">,</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">)</span>
</pre></div>
</div>
<section id="id1">
<h3>Validation<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<p>We need to do that with different sizes of training set.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">sizey</span><span class="p">):</span>
    <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.randn.html#torch.randn" title="torch.randn" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.randn.html#torch.randn" title="torch.randn" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">randn</span></a></a><span class="p">((</span><span class="n">size</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.randn.html#torch.randn" title="torch.randn" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.randn.html#torch.randn" title="torch.randn" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">randn</span></a></a><span class="p">((</span><span class="n">sizey</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a></a> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">[</span><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a></a><span class="p">,</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a></a> <span class="o">%</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">torch</span><span class="o">.</span><span class="n">nan</span></a></a>
    <span class="k">for</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a></a> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a><span class="p">[</span><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a></a> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a></a> <span class="o">%</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">torch</span><span class="o">.</span><span class="n">nan</span></a></a>

    <span class="n">knn_imputer</span> <span class="o">=</span> <a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class"><span class="n">sklearn</span><span class="o">.</span><span class="n">impute</span><span class="o">.</span><span class="n">KNNImputer</span></a></a><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">knn_imputer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">TorchKNNImputer</span></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="p">)</span>

    <span class="n">p1</span> <span class="o">=</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
        <a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_mask_fit_X</span><span class="p">),</span>
        <a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_valid_mask</span><span class="p">),</span>
        <a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_fit_X</span><span class="p">),</span>
        <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/helpers.html#experimental_experiment.helpers.max_diff" title="experimental_experiment.helpers.max_diff" class="sphx-glr-backref-module-experimental_experiment-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/helpers.html#experimental_experiment.helpers.max_diff" title="experimental_experiment.helpers.max_diff" class="sphx-glr-backref-module-experimental_experiment-helpers sphx-glr-backref-type-py-function"><span class="n">max_diff</span></a></a><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;abs&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> and sizey=</span><span class="si">{</span><span class="n">sizey</span><span class="si">}</span><span class="s2">, d=</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;knn discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">p1</span> <span class="o">=</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
        <a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_mask_fit_X</span><span class="p">),</span>
        <a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_valid_mask</span><span class="p">),</span>
        <a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_fit_X</span><span class="p">),</span>
        <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/helpers.html#experimental_experiment.helpers.max_diff" title="experimental_experiment.helpers.max_diff" class="sphx-glr-backref-module-experimental_experiment-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/helpers.html#experimental_experiment.helpers.max_diff" title="experimental_experiment.helpers.max_diff" class="sphx-glr-backref-module-experimental_experiment-helpers sphx-glr-backref-type-py-function"><span class="n">max_diff</span></a></a><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;abs&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> and sizey=</span><span class="si">{</span><span class="n">sizey</span><span class="si">}</span><span class="s2">, d=</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;knn discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">knn_imputer</span><span class="p">,</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a>


<a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn5</span></a></a><span class="p">,</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y10</span></a></a> <span class="o">=</span> <span class="n">validate</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn50</span></a></a><span class="p">,</span> <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y40</span></a></a> <span class="o">=</span> <span class="n">validate</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>knn discrepancies for size=5: {&#39;abs&#39;: 4.967053740534411e-09, &#39;rel&#39;: 3.8580606309014394e-08, &#39;sum&#39;: 9.934107481068821e-09, &#39;n&#39;: 20.0, &#39;dnan&#39;: 0.0}
knn discrepancies for size=5: {&#39;abs&#39;: 0.0, &#39;rel&#39;: 0.0, &#39;sum&#39;: 0.0, &#39;n&#39;: 2.0, &#39;dnan&#39;: 0.0}
knn discrepancies for size=50: {&#39;abs&#39;: 1.986821485111534e-08, &#39;rel&#39;: 2.3018476420929695e-08, &#39;sum&#39;: 6.705522526129215e-08, &#39;n&#39;: 80.0, &#39;dnan&#39;: 0.0}
knn discrepancies for size=50: {&#39;abs&#39;: 1.986821485111534e-08, &#39;rel&#39;: 1.8620979822721472e-08, &#39;sum&#39;: 1.986821485111534e-08, &#39;n&#39;: 2.0, &#39;dnan&#39;: 0.0}
</pre></div>
</div>
</section>
</section>
<section id="export-to-onnx">
<h2>Export to ONNX<a class="headerlink" href="#export-to-onnx" title="Link to this heading">¶</a></h2>
<p>The module cannot be exported as is because one operator <a class="reference external" href="https://pytorch.org/docs/main/generated/torch.topk.html#torch.topk" title="(in PyTorch vmain (2.7.0a0+gita9ae334 ))"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.topk()</span></code></a>
expects a fixed number of neighbour but the model makes it variable.
This is case not supported by <a class="reference external" href="https://pytorch.org/docs/main/export.html#torch.export.export" title="(in PyTorch vmain (2.7.0a0+gita9ae334 ))"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.export.export()</span></code></a>.
We need to isolate that part before exporting the model.
It is done by replacing it with a custom op.
This is automatically done by function <code class="xref py py-func docutils literal notranslate"><span class="pre">trace_execution_piece_by_piece()</span></code>.</p>
<p>First step, we create two sets of inputs. A function will use this
to infer the dynamic shapes.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span></a></a> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span>
        <span class="p">(</span>
            <a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn50</span><span class="o">.</span><span class="n">_mask_fit_X</span></a></a><span class="p">),</span>
            <a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn50</span><span class="o">.</span><span class="n">_valid_mask</span></a></a><span class="p">),</span>
            <a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn50</span><span class="o">.</span><span class="n">_fit_X</span></a></a><span class="p">),</span>
            <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y40</span></a></a><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">{},</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="p">(</span>
            <a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn5</span><span class="o">.</span><span class="n">_mask_fit_X</span></a></a><span class="p">),</span>
            <a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn5</span><span class="o">.</span><span class="n">_valid_mask</span></a></a><span class="p">),</span>
            <a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn5</span><span class="o">.</span><span class="n">_fit_X</span></a></a><span class="p">),</span>
            <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y10</span></a></a><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">{},</span>
    <span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Then we trace the execution to capture every input and output of every submodule.
The model implementation was refactored to introduce many tiny one and get
a fine-grained evaluation of the exportability.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">trace</span></a></a> <span class="o">=</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" title="experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" title="experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-function"><span class="n">trace_execution_piece_by_piece</span></a></a><span class="p">(</span><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">TorchKNNImputer</span></a></a><span class="p">(</span><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn5</span></a></a><span class="p">),</span> <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span></a></a><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">pretty</span></a></a> <span class="o">=</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><span class="n">trace</span><span class="o">.</span><span class="n">get_export_report</span></a></a><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">pretty</span></a></a><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>__main__                  TorchKNNImputer   &lt;OK-2i&gt;
..dist                    NanEuclidean      &lt;OK-2i&gt;
..columns[0]              ColProcessor      &lt;OK-2i&gt;
...._calc_impute          CalcImpute        &lt;OK-2i&gt;
......_weights            SubWeightMatrix   &lt;OK-2i&gt;
......_donors_idx         SubDonorsIdx      &lt;OK-2i&gt;
........_topk             SubTopKIndices    &lt;OK-2i&gt;
......_make_new_neights   MakeNewWeights    &lt;OK-2i&gt;
..columns[1]              ColProcessor      &lt;OK-2i&gt;
...._calc_impute          CalcImpute        &lt;OK-2i&gt;
......_weights            SubWeightMatrix   &lt;OK-2i&gt;
......_donors_idx         SubDonorsIdx      &lt;OK-2i&gt;
........_topk             SubTopKIndices    &lt;OK-2i&gt;
......_make_new_neights   MakeNewWeights    &lt;OK-2i&gt;
.._make_dict_idx_map      MakeDictIdxMap    &lt;OK-2i&gt;
</pre></div>
</div>
<p>The dynamic shapes for the whole model:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dynamic shapes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.guess_dynamic_shapes" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.guess_dynamic_shapes" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.guess_dynamic_shapes" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.guess_dynamic_shapes" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><span class="n">trace</span><span class="o">.</span><span class="n">guess_dynamic_shapes</span></a></a><span class="p">())</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>dynamic shapes:
(({0: &lt;_DimHint.DYNAMIC: 3&gt;}, {}, {0: &lt;_DimHint.DYNAMIC: 3&gt;}, {0: &lt;_DimHint.DYNAMIC: 3&gt;}), {})
</pre></div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">try_export</span></code> cannot infer all links between input shapes and output shapes
for every submodule. The following function fills this gap.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">shape_functions</span></a></a> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;NanEuclidean&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <a href="https://pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">empty</span></a></a><span class="p">(</span>
            <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
        <span class="p">)</span>
    <span class="p">},</span>
    <span class="s2">&quot;CalcImpute&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <a href="https://pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">empty</span></a></a><span class="p">((</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="s2">&quot;SubTopKIndices&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <a href="https://pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">empty</span></a></a><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">make_undefined_dimension</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn5</span><span class="o">.</span><span class="n">n_neighbors</span></a></a><span class="p">)),</span>
            <span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">},</span>
    <span class="s2">&quot;SubDonorsIdx&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <a href="https://pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">empty</span></a></a><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">make_undefined_dimension</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn5</span><span class="o">.</span><span class="n">n_neighbors</span></a></a><span class="p">)),</span>
            <span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="mi">1</span><span class="p">:</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <a href="https://pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">empty</span></a></a><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">make_undefined_dimension</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn5</span><span class="o">.</span><span class="n">n_neighbors</span></a></a><span class="p">)),</span>
            <span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><a href="https://pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">torch</span><span class="o">.</span><span class="n">float32</span></a></a><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">},</span>
    <span class="s2">&quot;MakeDictIdxMap&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <a href="https://pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">empty</span></a></a><span class="p">((</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Then we we try to export piece by piece.
We capture the standard output to avoid being overwhelmed
and we use function <code class="xref py py-func docutils literal notranslate"><span class="pre">bypass_export_some_errors()</span></code> to skip some
errors with shape checking made by <a class="reference external" href="https://pytorch.org/docs/main/torch.html#module-torch" title="(in PyTorch vmain (2.7.0a0+gita9ae334 ))"><code class="xref py py-mod docutils literal notranslate"><span class="pre">torch</span></code></a>.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/logging.html#logging.disable" title="logging.disable" class="sphx-glr-backref-module-logging sphx-glr-backref-type-py-function"><a href="https://docs.python.org/3/library/logging.html#logging.disable" title="logging.disable" class="sphx-glr-backref-module-logging sphx-glr-backref-type-py-function"><span class="n">logging</span><span class="o">.</span><span class="n">disable</span></a></a><span class="p">(</span><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span></a></a><span class="p">)</span>

<span class="k">with</span> <a href="https://docs.python.org/3/library/contextlib.html#contextlib.redirect_stderr" title="contextlib.redirect_stderr" class="sphx-glr-backref-module-contextlib sphx-glr-backref-type-py-function"><a href="https://docs.python.org/3/library/contextlib.html#contextlib.redirect_stderr" title="contextlib.redirect_stderr" class="sphx-glr-backref-module-contextlib sphx-glr-backref-type-py-function"><span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stderr</span></a></a><span class="p">(</span><a href="https://docs.python.org/3/library/io.html#io.StringIO" title="io.StringIO" class="sphx-glr-backref-module-io sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/io.html#io.StringIO" title="io.StringIO" class="sphx-glr-backref-module-io sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span></a></a><span class="p">()),</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/onnx_export_errors.html#experimental_experiment.torch_interpreter.onnx_export_errors.bypass_export_some_errors" title="experimental_experiment.torch_interpreter.onnx_export_errors.bypass_export_some_errors" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-onnx_export_errors sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/onnx_export_errors.html#experimental_experiment.torch_interpreter.onnx_export_errors.bypass_export_some_errors" title="experimental_experiment.torch_interpreter.onnx_export_errors.bypass_export_some_errors" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-onnx_export_errors sphx-glr-backref-type-py-function"><span class="n">bypass_export_some_errors</span></a></a><span class="p">():</span>
    <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExport" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExport" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExport" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExport" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ep</span></a></a> <span class="o">=</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.try_export" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.try_export" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.try_export" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.try_export" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><span class="n">trace</span><span class="o">.</span><span class="n">try_export</span></a></a><span class="p">(</span>
        <span class="n">exporter</span><span class="o">=</span><span class="s2">&quot;fx&quot;</span><span class="p">,</span>
        <span class="n">use_dynamic_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">exporter_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">replace_by_custom_op</span><span class="o">=</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.CustomOpStrategy" title="experimental_experiment.torch_interpreter.piece_by_piece.CustomOpStrategy" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.CustomOpStrategy" title="experimental_experiment.torch_interpreter.piece_by_piece.CustomOpStrategy" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">CustomOpStrategy</span><span class="o">.</span><span class="n">LOCAL</span></a></a><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">shape_functions</span></a></a><span class="o">=</span><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">shape_functions</span></a></a><span class="p">,</span>
    <span class="p">)</span>

<span class="k">assert</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ep</span><span class="o">.</span><span class="n">status</span></a></a> <span class="ow">in</span> <span class="p">(</span>
    <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ep</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">OK</span></a></a><span class="p">,</span>
    <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ep</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">OK_CHILDC</span></a></a><span class="p">,</span>
<span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;FAIL: </span><span class="si">{</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExport" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExport" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExport" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExport" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ep</span></a></a><span class="si">}</span><span class="se">\n</span><span class="s2">-- report --</span><span class="se">\n</span><span class="si">{</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><span class="n">trace</span><span class="o">.</span><span class="n">get_export_report</span></a></a><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">print</span><span class="p">(</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><span class="n">trace</span><span class="o">.</span><span class="n">get_export_report</span></a></a><span class="p">())</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>__main__                  TorchKNNImputer   OK_CHILDC -- ExportedProgram
..dist                    NanEuclidean      OK -- ExportedProgram
..columns[0]              ColProcessor      OK_CHILDC -- ExportedProgram
...._calc_impute          CalcImpute        OK_CHILDC -- ExportedProgram
......_weights            SubWeightMatrix   OK -- ExportedProgram
......_donors_idx         SubDonorsIdx      OK_CHILDC -- ExportedProgram
........_topk             SubTopKIndices    OK -- ExportedProgram
......_make_new_neights   MakeNewWeights    OK -- ExportedProgram
..columns[1]              ColProcessor      OK_CHILDC -- ExportedProgram
...._calc_impute          CalcImpute        OK_CHILDC -- ExportedProgram
......_weights            SubWeightMatrix   OK -- ExportedProgram
......_donors_idx         SubDonorsIdx      OK_CHILDC -- ExportedProgram
........_topk             SubTopKIndices    OK -- ExportedProgram
......_make_new_neights   MakeNewWeights    OK -- ExportedProgram
.._make_dict_idx_map      MakeDictIdxMap    OK -- ExportedProgram
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">OK</span></code> means the module is exportable. <code class="docutils literal notranslate"><span class="pre">OK_CHILDC</span></code> means the module
can be exported after its submodules are replaced by custom ops.
It works except for the topk function. <code class="docutils literal notranslate"><span class="pre">FAIL</span></code> means
the submodule cannot be exported at all but that
module is simple enough and its ONNX conversion can be provided.</p>
<section id="final-step">
<h3>Final step<a class="headerlink" href="#final-step" title="Link to this heading">¶</a></h3>
<p>We first start by running the decompositions on every exported program.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <a href="https://docs.python.org/3/library/warnings.html#warnings.catch_warnings" title="warnings.catch_warnings" class="sphx-glr-backref-module-warnings sphx-glr-backref-type-py-class"><a href="https://docs.python.org/3/library/warnings.html#warnings.catch_warnings" title="warnings.catch_warnings" class="sphx-glr-backref-module-warnings sphx-glr-backref-type-py-class"><span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span></a></a><span class="p">():</span>
    <a href="https://docs.python.org/3/library/warnings.html#warnings.simplefilter" title="warnings.simplefilter" class="sphx-glr-backref-module-warnings sphx-glr-backref-type-py-function"><a href="https://docs.python.org/3/library/warnings.html#warnings.simplefilter" title="warnings.simplefilter" class="sphx-glr-backref-module-warnings sphx-glr-backref-type-py-function"><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span></a></a><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

    <span class="k">for</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">t</span></a></a> <span class="ow">in</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">trace</span></a></a><span class="p">:</span>
        <span class="k">if</span> <a href="https://pytorch.org/docs/main/export.html#torch.export.ExportedProgram" title="torch.export.ExportedProgram" class="sphx-glr-backref-module-torch-export sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/export.html#torch.export.ExportedProgram" title="torch.export.ExportedProgram" class="sphx-glr-backref-module-torch-export sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">t</span><span class="o">.</span><span class="n">exporter_status</span><span class="o">.</span><span class="n">exported</span></a></a> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[run_decompositions] </span><span class="si">{</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.dot_name" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.dot_name" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-property"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.dot_name" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.dot_name" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-property"><span class="n">t</span><span class="o">.</span><span class="n">dot_name</span></a></a><span class="si">}</span><span class="s2"> - skipped&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[run_decompositions] </span><span class="si">{</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.dot_name" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.dot_name" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-property"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.dot_name" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.dot_name" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-property"><span class="n">t</span><span class="o">.</span><span class="n">dot_name</span></a></a><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <a href="https://pytorch.org/docs/main/export.html#torch.export.ExportedProgram" title="torch.export.ExportedProgram" class="sphx-glr-backref-module-torch-export sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/export.html#torch.export.ExportedProgram" title="torch.export.ExportedProgram" class="sphx-glr-backref-module-torch-export sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">t</span><span class="o">.</span><span class="n">exporter_status</span><span class="o">.</span><span class="n">exported</span></a></a> <span class="o">=</span> <a href="https://pytorch.org/docs/main/export.html#torch.export.ExportedProgram.run_decompositions" title="torch.export.ExportedProgram.run_decompositions" class="sphx-glr-backref-module-torch-export sphx-glr-backref-type-py-method"><a href="https://pytorch.org/docs/main/export.html#torch.export.ExportedProgram.run_decompositions" title="torch.export.ExportedProgram.run_decompositions" class="sphx-glr-backref-module-torch-export sphx-glr-backref-type-py-method"><span class="n">t</span><span class="o">.</span><span class="n">exporter_status</span><span class="o">.</span><span class="n">exported</span><span class="o">.</span><span class="n">run_decompositions</span></a></a><span class="p">({})</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[run_decompositions]  M:__main__-TorchKNNImputer
[run_decompositions] .. M:dist-NanEuclidean
[run_decompositions] .. M:columns[0]-ColProcessor
[run_decompositions] .... M:_calc_impute-CalcImpute
[run_decompositions] ...... M:_weights-SubWeightMatrix
[run_decompositions] ...... M:_donors_idx-SubDonorsIdx
[run_decompositions] ........ M:_topk-SubTopKIndices
[run_decompositions] ...... M:_make_new_neights-MakeNewWeights
[run_decompositions] .. M:columns[1]-ColProcessor
[run_decompositions] .... M:_calc_impute-CalcImpute
[run_decompositions] ...... M:_weights-SubWeightMatrix
[run_decompositions] ...... M:_donors_idx-SubDonorsIdx
[run_decompositions] ........ M:_topk-SubTopKIndices
[run_decompositions] ...... M:_make_new_neights-MakeNewWeights
[run_decompositions] .. M:_make_dict_idx_map-MakeDictIdxMap
</pre></div>
</div>
<p>Let’s export everything. Every submodule is exported as a local function
except topk for which we must provide an ONNX conversion.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class"><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class"><span class="n">T</span></a></a> <span class="o">=</span> <span class="nb">str</span>


<span class="k">def</span> <span class="nf">onnx_topk_indices</span><span class="p">(</span>
    <span class="n">g</span><span class="p">:</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/xbuilder/index.html#experimental_experiment.xbuilder.GraphBuilder" title="experimental_experiment.xbuilder.GraphBuilder" class="sphx-glr-backref-module-experimental_experiment-xbuilder sphx-glr-backref-type-py-class"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/xbuilder/index.html#experimental_experiment.xbuilder.GraphBuilder" title="experimental_experiment.xbuilder.GraphBuilder" class="sphx-glr-backref-module-experimental_experiment-xbuilder sphx-glr-backref-type-py-class"><span class="n">GraphBuilder</span></a></a><span class="p">,</span>
    <span class="n">sts</span><span class="p">:</span> <a href="https://docs.python.org/3/library/typing.html#typing.Optional" title="typing.Optional" class="sphx-glr-backref-module-typing sphx-glr-backref-type-py-data"><a href="https://docs.python.org/3/library/typing.html#typing.Optional" title="typing.Optional" class="sphx-glr-backref-module-typing sphx-glr-backref-type-py-data"><span class="n">Optional</span></a></a><span class="p">[</span><a href="https://docs.python.org/3/library/typing.html#typing.Dict" title="typing.Dict" class="sphx-glr-backref-module-typing sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/typing.html#typing.Dict" title="typing.Dict" class="sphx-glr-backref-module-typing sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Dict</span></a></a><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <a href="https://docs.python.org/3/library/typing.html#typing.Any" title="typing.Any" class="sphx-glr-backref-module-typing sphx-glr-backref-type-py-data"><a href="https://docs.python.org/3/library/typing.html#typing.Any" title="typing.Any" class="sphx-glr-backref-module-typing sphx-glr-backref-type-py-data"><span class="n">Any</span></a></a><span class="p">]],</span>
    <span class="n">outputs</span><span class="p">:</span> <a href="https://docs.python.org/3/library/typing.html#typing.List" title="typing.List" class="sphx-glr-backref-module-typing sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/typing.html#typing.List" title="typing.List" class="sphx-glr-backref-module-typing sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">List</span></a></a><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x</span></a></a><span class="p">:</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class"><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class"><span class="n">T</span></a></a><span class="p">,</span>
    <span class="n">k</span><span class="p">:</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class"><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class"><span class="n">T</span></a></a><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;topk&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Only one output is expected but outputs=</span><span class="si">{</span><span class="n">outputs</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">unique_name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">unique_name</span><span class="p">(</span><span class="s2">&quot;unused_topk_values&quot;</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">TopK</span><span class="p">(</span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x</span></a></a><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">unique_name</span><span class="p">,</span> <span class="o">*</span><span class="n">outputs</span><span class="p">],</span> <span class="n">largest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>Let’s check it is working somehow.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x</span></a></a> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span></a></a><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><a href="https://pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">torch</span><span class="o">.</span><span class="n">float32</span></a></a><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;torch.topk&quot;</span><span class="p">,</span> <a href="https://pytorch.org/docs/main/generated/torch.topk.html#torch.topk" title="torch.topk" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.topk.html#torch.topk" title="torch.topk" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">topk</span></a></a><span class="p">(</span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x</span></a></a><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;onnx.topk&quot;</span><span class="p">,</span> <a href="https://onnx.ai/onnx/api/reference.html#onnx.reference.op_run.OpRun.eval" title="onnx.reference.op_run.OpRun.eval" class="sphx-glr-backref-module-onnx-reference-op_run sphx-glr-backref-type-py-method"><a href="https://onnx.ai/onnx/api/reference.html#onnx.reference.op_run.OpRun.eval" title="onnx.reference.op_run.OpRun.eval" class="sphx-glr-backref-module-onnx-reference-op_run sphx-glr-backref-type-py-method"><span class="n">TopK</span><span class="o">.</span><span class="n">eval</span></a></a><span class="p">(</span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x</span></a></a><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.array.html#numpy.array" title="numpy.array" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><a href="https://numpy.org/doc/stable/reference/generated/numpy.array.html#numpy.array" title="numpy.array" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">array</span></a></a><span class="p">([</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.int64" title="numpy.int64" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.int64" title="numpy.int64" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><span class="n">np</span><span class="o">.</span><span class="n">int64</span></a></a><span class="p">))[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>torch.topk tensor([[2, 1],
        [0, 1]])
onnx.topk [[2 1]
 [0 1]]
</pre></div>
</div>
<p>And with nan values</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x</span></a></a> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span></a></a><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">np</span><span class="o">.</span><span class="n">nan</span></a></a><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">np</span><span class="o">.</span><span class="n">nan</span></a></a><span class="p">,</span> <span class="mi">4</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><a href="https://pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">torch</span><span class="o">.</span><span class="n">float32</span></a></a><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;torch.topk&quot;</span><span class="p">,</span> <a href="https://pytorch.org/docs/main/generated/torch.topk.html#torch.topk" title="torch.topk" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.topk.html#torch.topk" title="torch.topk" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">topk</span></a></a><span class="p">(</span><a href="https://pytorch.org/docs/main/generated/torch.nan_to_num.html#torch.nan_to_num" title="torch.nan_to_num" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.nan_to_num.html#torch.nan_to_num" title="torch.nan_to_num" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">nan_to_num</span></a></a><span class="p">(</span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x</span></a></a><span class="p">,</span> <span class="n">nan</span><span class="o">=-</span><span class="mf">1.0e10</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;onnx.topk&quot;</span><span class="p">,</span> <a href="https://onnx.ai/onnx/api/reference.html#onnx.reference.op_run.OpRun.eval" title="onnx.reference.op_run.OpRun.eval" class="sphx-glr-backref-module-onnx-reference-op_run sphx-glr-backref-type-py-method"><a href="https://onnx.ai/onnx/api/reference.html#onnx.reference.op_run.OpRun.eval" title="onnx.reference.op_run.OpRun.eval" class="sphx-glr-backref-module-onnx-reference-op_run sphx-glr-backref-type-py-method"><span class="n">TopK</span><span class="o">.</span><span class="n">eval</span></a></a><span class="p">(</span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x</span></a></a><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.array.html#numpy.array" title="numpy.array" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><a href="https://numpy.org/doc/stable/reference/generated/numpy.array.html#numpy.array" title="numpy.array" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">array</span></a></a><span class="p">([</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.int64" title="numpy.int64" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.int64" title="numpy.int64" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><span class="n">np</span><span class="o">.</span><span class="n">int64</span></a></a><span class="p">))[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>torch.topk tensor([[2, 0],
        [0, 2]])
onnx.topk [[2 0]
 [0 2]]
</pre></div>
</div>
<p>That works. Then the dispatcher maps the custom ops calling topk to
the previous converter functions.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.Dispatcher" title="experimental_experiment.torch_interpreter.Dispatcher" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.Dispatcher" title="experimental_experiment.torch_interpreter.Dispatcher" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dispatcher</span></a></a> <span class="o">=</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.Dispatcher" title="experimental_experiment.torch_interpreter.Dispatcher" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-class"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.Dispatcher" title="experimental_experiment.torch_interpreter.Dispatcher" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-class"><span class="n">Dispatcher</span></a></a><span class="p">(</span>
    <span class="p">{</span>
        <span class="p">(</span>
            <span class="s2">&quot;diag_lib::C_TorchKNNImputer_columns_0___calc_impute__donors_idx__topk&quot;</span>
        <span class="p">):</span> <span class="n">onnx_topk_indices</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="s2">&quot;diag_lib::C_TorchKNNImputer_columns_1___calc_impute__donors_idx__topk&quot;</span>
        <span class="p">):</span> <span class="n">onnx_topk_indices</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Let’s run the conversion. We also check the conversion into ONNX
is accurate. It is doable because every intermediate results
were previously traced.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">onx</span></a></a> <span class="o">=</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">trace</span></a></a><span class="o">.</span><span class="n">to_onnx_local</span><span class="p">(</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.Dispatcher" title="experimental_experiment.torch_interpreter.Dispatcher" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.Dispatcher" title="experimental_experiment.torch_interpreter.Dispatcher" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dispatcher</span></a></a><span class="o">=</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.Dispatcher" title="experimental_experiment.torch_interpreter.Dispatcher" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.Dispatcher" title="experimental_experiment.torch_interpreter.Dispatcher" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dispatcher</span></a></a><span class="p">,</span>
    <span class="n">check_conversion_cls</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="bp">cls</span><span class="o">=</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/reference/index.html#experimental_experiment.reference.ExtendedReferenceEvaluator" title="experimental_experiment.reference.ExtendedReferenceEvaluator" class="sphx-glr-backref-module-experimental_experiment-reference sphx-glr-backref-type-py-class"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/reference/index.html#experimental_experiment.reference.ExtendedReferenceEvaluator" title="experimental_experiment.reference.ExtendedReferenceEvaluator" class="sphx-glr-backref-module-experimental_experiment-reference sphx-glr-backref-type-py-class"><span class="n">ExtendedReferenceEvaluator</span></a></a><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">),</span>
    <span class="n">inline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[to_onnx_local]  M:__main__-TorchKNNImputer - to_onnx_local
[to_onnx_local]  M:__main__-TorchKNNImputer - export child &#39;C_TorchKNNImputer_dist&#39;
[to_onnx_local] .. M:dist-NanEuclidean - to_onnx_local
[to_onnx_local] .. M:dist-NanEuclidean - export starts C_TorchKNNImputer_dist
[to_onnx_local] .. M:dist-NanEuclidean - export done
[to_onnx_local] .. M:dist-NanEuclidean - run validation
[onnx_run_disc] .. M:dist-NanEuclidean run with cls=ExtendedReferenceEvaluator on ModelProto
[onnx_run_disc] .. M:dist-NanEuclidean run with ((T1s4x2,T11s50x2),{})
[onnx_run_disc] .. M:dist-NanEuclidean flattened into ((T1s4x2[nan,nan:AnanN4nans],T11s50x2[nan,nan:AnanN5nans]),{})
[onnx_run_disc] .. M:dist-NanEuclidean expecting (T1s4x50[nan,nan:AnanN10nans],)
[onnx_run_disc] .. M:dist-NanEuclidean computing A1s4x50[0.02562400884926319,6.643804550170898:A1.8692522174923827N10nans]
[onnx_run_disc] .. M:dist-NanEuclidean diff=abs=0.0, rel=0.0
[onnx_run_disc] .. M:dist-NanEuclidean run with ((T1s4x2,T11s5x2),{})
[onnx_run_disc] .. M:dist-NanEuclidean flattened into ((T1s4x2[nan,nan:AnanN4nans],T11s5x2[nan,nan:AnanN5nans]),{})
[onnx_run_disc] .. M:dist-NanEuclidean expecting (T1s4x5[nan,nan:AnanN10nans],)
[onnx_run_disc] .. M:dist-NanEuclidean computing A1s4x5[0.27489498257637024,4.837934494018555:A2.1912896662950514N10nans]
[onnx_run_disc] .. M:dist-NanEuclidean diff=abs=0.0, rel=0.0
[onnx_run_disc] .. M:dist-NanEuclidean validation done
[to_onnx_local] .. M:dist-NanEuclidean - done
[to_onnx_local] .. M:dist-NanEuclidean - discrepancies: abs=0.0, rel=0.0
[to_onnx_local] .. M:dist-NanEuclidean - discrepancies: abs=0.0, rel=0.0
[to_onnx_local]  M:__main__-TorchKNNImputer - export child &#39;C_TorchKNNImputer_columns_0_&#39;
[to_onnx_local] .. M:columns[0]-ColProcessor - to_onnx_local
[to_onnx_local] .. M:columns[0]-ColProcessor - export child &#39;C_TorchKNNImputer_columns_0___calc_impute&#39;
[to_onnx_local] .... M:_calc_impute-CalcImpute - to_onnx_local
[to_onnx_local] .... M:_calc_impute-CalcImpute - export child &#39;C_TorchKNNImputer_columns_0___calc_impute__weights&#39;
[to_onnx_local] ...... M:_weights-SubWeightMatrix - to_onnx_local
[to_onnx_local] ...... M:_weights-SubWeightMatrix - export starts C_TorchKNNImputer_columns_0___calc_impute__weights
[to_onnx_local] ...... M:_weights-SubWeightMatrix - export done
[to_onnx_local] ...... M:_weights-SubWeightMatrix - run validation
[onnx_run_disc] ...... M:_weights-SubWeightMatrix run with cls=ExtendedReferenceEvaluator on ModelProto
[onnx_run_disc] ...... M:_weights-SubWeightMatrix run with ((T1s2x3,),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix flattened into ((T1s2x3[0.02562400884926319,0.5225339531898499:A0.19498917118956646],),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix expecting (T1s2x3[1.0,1.0:A1.0],)
[onnx_run_disc] ...... M:_weights-SubWeightMatrix computing A1s2x3[1.0,1.0:A1.0]
[onnx_run_disc] ...... M:_weights-SubWeightMatrix diff=abs=0.0, rel=0.0
[onnx_run_disc] ...... M:_weights-SubWeightMatrix run with ((T1s0x2,),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix flattened into ((T1s0x2[empty],),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix expecting (T1s0x2[empty],)
[onnx_run_disc] ...... M:_weights-SubWeightMatrix computing A1s0x2[empty]
[onnx_run_disc] ...... M:_weights-SubWeightMatrix diff=abs=0, rel=0
[onnx_run_disc] ...... M:_weights-SubWeightMatrix validation done
[to_onnx_local] ...... M:_weights-SubWeightMatrix - done
[to_onnx_local] ...... M:_weights-SubWeightMatrix - discrepancies: abs=0.0, rel=0.0
[to_onnx_local] ...... M:_weights-SubWeightMatrix - discrepancies: abs=0, rel=0
[to_onnx_local] .... M:_calc_impute-CalcImpute - export child &#39;C_TorchKNNImputer_columns_0___calc_impute__donors_idx&#39;
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - to_onnx_local
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - skip child &#39;C_TorchKNNImputer_columns_0___calc_impute__donors_idx__topk&#39;
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - export starts C_TorchKNNImputer_columns_0___calc_impute__donors_idx
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - export done
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - run validation
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx run with cls=ExtendedReferenceEvaluator on ModelProto
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx run with ((T1s2x47,T7s1),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx flattened into ((T1s2x47[nan,nan:AnanN4nans],T7s1[3,3:A3.0]),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx expecting (T7s2x3[8,25:A17.833333333333332],T1s2x3[0.02562400884926319,0.5225339531898499:A0.19498917118956646])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx computing (A7s2x3[8,25:A17.833333333333332],A1s2x3[0.02562400884926319,0.5225339531898499:A0.19498917118956646])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx diff=abs=0, rel=0
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx run with ((T1s0x2,T7s1),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx flattened into ((T1s0x2[empty],T7s1[2,2:A2.0]),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx expecting (T7s0x2[empty],T1s0x2[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx computing (A7s0x2[empty],A1s0x2[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx diff=abs=0, rel=0
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx validation done
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - done
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - discrepancies: abs=0, rel=0
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - discrepancies: abs=0, rel=0
[to_onnx_local] .... M:_calc_impute-CalcImpute - export child &#39;C_TorchKNNImputer_columns_0___calc_impute__make_new_neights&#39;
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - to_onnx_local
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - export starts C_TorchKNNImputer_columns_0___calc_impute__make_new_neights
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - export done
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - run validation
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights run with cls=ExtendedReferenceEvaluator on ModelProto
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights run with ((T7s2x3,T11s2x3,T1s2x3),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights flattened into ((T7s2x3[1,1:A1.0],T11s2x3[-2.6722490787506104,2.6974563598632812:A0.22883254289627075],T1s2x3[1.0,1.0:A1.0]),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights expecting (T11s2x3[1.0,1.0:A1.0],)
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights computing A11s2x3[1.0,1.0:A1.0]
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights diff=abs=0.0, rel=0.0
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights run with ((T7s0x2,T11s0x2,T1s0x2),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights flattened into ((T7s0x2[empty],T11s0x2[empty],T1s0x2[empty]),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights expecting (T11s0x2[empty],)
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights computing A11s0x2[empty]
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights diff=abs=0, rel=0
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights validation done
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - done
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - discrepancies: abs=0.0, rel=0.0
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - discrepancies: abs=0, rel=0
[to_onnx_local] .... M:_calc_impute-CalcImpute - export starts C_TorchKNNImputer_columns_0___calc_impute
[to_onnx_local] .... M:_calc_impute-CalcImpute - export done
[to_onnx_local] .... M:_calc_impute-CalcImpute - run validation
[onnx_run_disc] .... M:_calc_impute-CalcImpute run with cls=ExtendedReferenceEvaluator on ModelProto
[onnx_run_disc] .... M:_calc_impute-CalcImpute run with ((T1s2x47,T7s1,T11s47,T9s47),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute flattened into ((T1s2x47[nan,nan:AnanN4nans],T7s1[3,3:A3.0],T11s47[-2.6722490787506104,2.6974563598632812:A0.15366982125696985],T9s47[False,False:A0.0]),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute expecting (T1s2[-1.065980076789856,1.5236451625823975:A0.22883254289627075],)
[onnx_run_disc] .... M:_calc_impute-CalcImpute computing A1s2[-1.065980076789856,1.5236451625823975:A0.22883254289627075]
[onnx_run_disc] .... M:_calc_impute-CalcImpute diff=abs=0.0, rel=0.0
[onnx_run_disc] .... M:_calc_impute-CalcImpute run with ((T1s0x2,T7s1,T11s2,T9s2),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute flattened into ((T1s0x2[empty],T7s1[2,2:A2.0],T11s2[-0.6274242401123047,2.5991315841674805:A0.9858536720275879],T9s2[False,False:A0.0]),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute expecting (T1s0[empty],)
[onnx_run_disc] .... M:_calc_impute-CalcImpute computing A1s0[empty]
[onnx_run_disc] .... M:_calc_impute-CalcImpute diff=abs=0, rel=0
[onnx_run_disc] .... M:_calc_impute-CalcImpute validation done
[to_onnx_local] .... M:_calc_impute-CalcImpute - done
[to_onnx_local] .... M:_calc_impute-CalcImpute - discrepancies: abs=0.0, rel=0.0
[to_onnx_local] .... M:_calc_impute-CalcImpute - discrepancies: abs=0, rel=0
[to_onnx_local] .. M:columns[0]-ColProcessor - export starts C_TorchKNNImputer_columns_0_
[to_onnx_local] .. M:columns[0]-ColProcessor - export done
[to_onnx_local] .. M:columns[0]-ColProcessor - run validation
[onnx_run_disc] .. M:columns[0]-ColProcessor run with cls=ExtendedReferenceEvaluator on ModelProto
[onnx_run_disc] .. M:columns[0]-ColProcessor run with ((T1s40x2,T1s4x50,T9s50x2,T9s50x2,T7s40,T9s40x2,T7s4,T11s50x2),{})
[onnx_run_disc] .. M:columns[0]-ColProcessor flattened into ((T1s40x2[nan,nan:AnanN4nans],T1s4x50[nan,nan:AnanN10nans],T9s50x2[False,True:A0.95],T9s50x2[False,True:A0.05],T7s40[0,3:A0.15],T9s40x2[False,True:A0.05],T7s4[1,4:A2.5],T11s50x2[nan,nan:AnanN5nans]),{})
[onnx_run_disc] .. M:columns[0]-ColProcessor expecting (T1s40x2[nan,nan:AnanN2nans],)
[onnx_run_disc] .. M:columns[0]-ColProcessor computing A1s40x2[-2.2343990802764893,2.7258105278015137:A-0.10593246023293035N2nans]
[onnx_run_disc] .. M:columns[0]-ColProcessor diff=abs=0.0, rel=0.0
[onnx_run_disc] .. M:columns[0]-ColProcessor run with ((T1s10x2,T1s4x5,T9s5x2,T9s5x2,T7s10,T9s10x2,T7s4,T11s5x2),{})
[onnx_run_disc] .. M:columns[0]-ColProcessor flattened into ((T1s10x2[nan,nan:AnanN4nans],T1s4x5[nan,nan:AnanN10nans],T9s5x2[False,True:A0.5],T9s5x2[False,True:A0.5],T7s10[0,3:A0.6],T9s10x2[False,True:A0.2],T7s4[1,4:A2.5],T11s5x2[nan,nan:AnanN5nans]),{})
[onnx_run_disc] .. M:columns[0]-ColProcessor expecting (T1s10x2[nan,nan:AnanN2nans],)
[onnx_run_disc] .. M:columns[0]-ColProcessor computing A1s10x2[-2.5295796394348145,3.1395082473754883:A0.46641130508699763N2nans]
[onnx_run_disc] .. M:columns[0]-ColProcessor diff=abs=0.0, rel=0.0
[onnx_run_disc] .. M:columns[0]-ColProcessor validation done
[to_onnx_local] .. M:columns[0]-ColProcessor - done
[to_onnx_local] .. M:columns[0]-ColProcessor - discrepancies: abs=0.0, rel=0.0
[to_onnx_local] .. M:columns[0]-ColProcessor - discrepancies: abs=0.0, rel=0.0
[to_onnx_local]  M:__main__-TorchKNNImputer - export child &#39;C_TorchKNNImputer_columns_1_&#39;
[to_onnx_local] .. M:columns[1]-ColProcessor - to_onnx_local
[to_onnx_local] .. M:columns[1]-ColProcessor - export child &#39;C_TorchKNNImputer_columns_1___calc_impute&#39;
[to_onnx_local] .... M:_calc_impute-CalcImpute - to_onnx_local
[to_onnx_local] .... M:_calc_impute-CalcImpute - export child &#39;C_TorchKNNImputer_columns_1___calc_impute__weights&#39;
[to_onnx_local] ...... M:_weights-SubWeightMatrix - to_onnx_local
[to_onnx_local] ...... M:_weights-SubWeightMatrix - export starts C_TorchKNNImputer_columns_1___calc_impute__weights
[to_onnx_local] ...... M:_weights-SubWeightMatrix - export done
[to_onnx_local] ...... M:_weights-SubWeightMatrix - run validation
[onnx_run_disc] ...... M:_weights-SubWeightMatrix run with cls=ExtendedReferenceEvaluator on ModelProto
[onnx_run_disc] ...... M:_weights-SubWeightMatrix run with ((T1s2x3,),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix flattened into ((T1s2x3[0.07385001331567764,1.1403498649597168:A0.518671645472447],),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix expecting (T1s2x3[1.0,1.0:A1.0],)
[onnx_run_disc] ...... M:_weights-SubWeightMatrix computing A1s2x3[1.0,1.0:A1.0]
[onnx_run_disc] ...... M:_weights-SubWeightMatrix diff=abs=0.0, rel=0.0
[onnx_run_disc] ...... M:_weights-SubWeightMatrix run with ((T1s0x3,),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix flattened into ((T1s0x3[empty],),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix expecting (T1s0x3[empty],)
[onnx_run_disc] ...... M:_weights-SubWeightMatrix computing A1s0x3[empty]
[onnx_run_disc] ...... M:_weights-SubWeightMatrix diff=abs=0, rel=0
[onnx_run_disc] ...... M:_weights-SubWeightMatrix validation done
[to_onnx_local] ...... M:_weights-SubWeightMatrix - done
[to_onnx_local] ...... M:_weights-SubWeightMatrix - discrepancies: abs=0.0, rel=0.0
[to_onnx_local] ...... M:_weights-SubWeightMatrix - discrepancies: abs=0, rel=0
[to_onnx_local] .... M:_calc_impute-CalcImpute - export child &#39;C_TorchKNNImputer_columns_1___calc_impute__donors_idx&#39;
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - to_onnx_local
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - skip child &#39;C_TorchKNNImputer_columns_1___calc_impute__donors_idx__topk&#39;
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - export starts C_TorchKNNImputer_columns_1___calc_impute__donors_idx
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - export done
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - run validation
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx run with cls=ExtendedReferenceEvaluator on ModelProto
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx run with ((T1s2x48,T7s1),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx flattened into ((T1s2x48[nan,nan:AnanN6nans],T7s1[3,3:A3.0]),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx expecting (T7s2x3[3,42:A18.666666666666668],T1s2x3[0.07385001331567764,1.1403498649597168:A0.518671645472447])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx computing (A7s2x3[3,42:A18.666666666666668],A1s2x3[0.07385001331567764,1.1403498649597168:A0.518671645472447])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx diff=abs=0, rel=0
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx run with ((T1s0x3,T7s1),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx flattened into ((T1s0x3[empty],T7s1[3,3:A3.0]),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx expecting (T7s0x3[empty],T1s0x3[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx computing (A7s0x3[empty],A1s0x3[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx diff=abs=0, rel=0
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx validation done
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - done
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - discrepancies: abs=0, rel=0
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - discrepancies: abs=0, rel=0
[to_onnx_local] .... M:_calc_impute-CalcImpute - export child &#39;C_TorchKNNImputer_columns_1___calc_impute__make_new_neights&#39;
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - to_onnx_local
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - export starts C_TorchKNNImputer_columns_1___calc_impute__make_new_neights
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - export done
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - run validation
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights run with cls=ExtendedReferenceEvaluator on ModelProto
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights run with ((T7s2x3,T11s2x3,T1s2x3),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights flattened into ((T7s2x3[1,1:A1.0],T11s2x3[-1.5542010068893433,1.4427423477172852:A-0.13992430393894514],T1s2x3[1.0,1.0:A1.0]),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights expecting (T11s2x3[1.0,1.0:A1.0],)
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights computing A11s2x3[1.0,1.0:A1.0]
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights diff=abs=0.0, rel=0.0
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights run with ((T7s0x3,T11s0x3,T1s0x3),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights flattened into ((T7s0x3[empty],T11s0x3[empty],T1s0x3[empty]),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights expecting (T11s0x3[empty],)
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights computing A11s0x3[empty]
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights diff=abs=0, rel=0
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights validation done
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - done
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - discrepancies: abs=0.0, rel=0.0
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - discrepancies: abs=0, rel=0
[to_onnx_local] .... M:_calc_impute-CalcImpute - export starts C_TorchKNNImputer_columns_1___calc_impute
[to_onnx_local] .... M:_calc_impute-CalcImpute - export done
[to_onnx_local] .... M:_calc_impute-CalcImpute - run validation
[onnx_run_disc] .... M:_calc_impute-CalcImpute run with cls=ExtendedReferenceEvaluator on ModelProto
[onnx_run_disc] .... M:_calc_impute-CalcImpute run with ((T1s2x48,T7s1,T11s48,T9s48),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute flattened into ((T1s2x48[nan,nan:AnanN6nans],T7s1[3,3:A3.0],T11s48[-2.0484697818756104,1.8861173391342163:A-0.06413272099598544],T9s48[False,False:A0.0]),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute expecting (T1s2[-1.0340979099273682,0.7542492747306824:A-0.1399243175983429],)
[onnx_run_disc] .... M:_calc_impute-CalcImpute computing A1s2[-1.0340979099273682,0.7542492747306824:A-0.1399243175983429]
[onnx_run_disc] .... M:_calc_impute-CalcImpute diff=abs=0.0, rel=0.0
[onnx_run_disc] .... M:_calc_impute-CalcImpute run with ((T1s0x3,T7s1,T11s3,T9s3),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute flattened into ((T1s0x3[empty],T7s1[3,3:A3.0],T11s3[-1.1547163724899292,1.8039337396621704:A-0.12774483362833658],T9s3[False,False:A0.0]),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute expecting (T1s0[empty],)
[onnx_run_disc] .... M:_calc_impute-CalcImpute computing A1s0[empty]
[onnx_run_disc] .... M:_calc_impute-CalcImpute diff=abs=0, rel=0
[onnx_run_disc] .... M:_calc_impute-CalcImpute validation done
[to_onnx_local] .... M:_calc_impute-CalcImpute - done
[to_onnx_local] .... M:_calc_impute-CalcImpute - discrepancies: abs=0.0, rel=0.0
[to_onnx_local] .... M:_calc_impute-CalcImpute - discrepancies: abs=0, rel=0
[to_onnx_local] .. M:columns[1]-ColProcessor - export starts C_TorchKNNImputer_columns_1_
[to_onnx_local] .. M:columns[1]-ColProcessor - export done
[to_onnx_local] .. M:columns[1]-ColProcessor - run validation
[onnx_run_disc] .. M:columns[1]-ColProcessor run with cls=ExtendedReferenceEvaluator on ModelProto
[onnx_run_disc] .. M:columns[1]-ColProcessor run with ((T1s40x2,T1s4x50,T9s50x2,T9s50x2,T7s40,T9s40x2,T7s4,T11s50x2),{})
[onnx_run_disc] .. M:columns[1]-ColProcessor flattened into ((T1s40x2[nan,nan:AnanN2nans],T1s4x50[nan,nan:AnanN10nans],T9s50x2[False,True:A0.95],T9s50x2[False,True:A0.05],T7s40[0,3:A0.15],T9s40x2[False,True:A0.05],T7s4[1,4:A2.5],T11s50x2[nan,nan:AnanN5nans]),{})
[onnx_run_disc] .. M:columns[1]-ColProcessor expecting (T1s40x2[-2.2343990802764893,2.7258105278015137:A-0.10678225666706567],)
[onnx_run_disc] .. M:columns[1]-ColProcessor computing A1s40x2[-2.2343990802764893,2.7258105278015137:A-0.10678225666706567]
[onnx_run_disc] .. M:columns[1]-ColProcessor diff=abs=0.0, rel=0.0
[onnx_run_disc] .. M:columns[1]-ColProcessor run with ((T1s10x2,T1s4x5,T9s5x2,T9s5x2,T7s10,T9s10x2,T7s4,T11s5x2),{})
[onnx_run_disc] .. M:columns[1]-ColProcessor flattened into ((T1s10x2[nan,nan:AnanN2nans],T1s4x5[nan,nan:AnanN10nans],T9s5x2[False,True:A0.5],T9s5x2[False,True:A0.5],T7s10[0,3:A0.6],T9s10x2[False,True:A0.2],T7s4[1,4:A2.5],T11s5x2[nan,nan:AnanN5nans]),{})
[onnx_run_disc] .. M:columns[1]-ColProcessor expecting (T1s10x2[-2.5295796394348145,3.1395082473754883:A0.40699569071875885],)
[onnx_run_disc] .. M:columns[1]-ColProcessor computing A1s10x2[-2.5295796394348145,3.1395082473754883:A0.40699569071875885]
[onnx_run_disc] .. M:columns[1]-ColProcessor diff=abs=0.0, rel=0.0
[onnx_run_disc] .. M:columns[1]-ColProcessor validation done
[to_onnx_local] .. M:columns[1]-ColProcessor - done
[to_onnx_local] .. M:columns[1]-ColProcessor - discrepancies: abs=0.0, rel=0.0
[to_onnx_local] .. M:columns[1]-ColProcessor - discrepancies: abs=0.0, rel=0.0
[to_onnx_local]  M:__main__-TorchKNNImputer - export child &#39;C_TorchKNNImputer__make_dict_idx_map&#39;
[to_onnx_local] .. M:_make_dict_idx_map-MakeDictIdxMap - to_onnx_local
[to_onnx_local] .. M:_make_dict_idx_map-MakeDictIdxMap - export starts C_TorchKNNImputer__make_dict_idx_map
[to_onnx_local] .. M:_make_dict_idx_map-MakeDictIdxMap - export done
[to_onnx_local] .. M:_make_dict_idx_map-MakeDictIdxMap - run validation
[onnx_run_disc] .. M:_make_dict_idx_map-MakeDictIdxMap run with cls=ExtendedReferenceEvaluator on ModelProto
[onnx_run_disc] .. M:_make_dict_idx_map-MakeDictIdxMap run with ((T1s40x2,T7s4),{})
[onnx_run_disc] .. M:_make_dict_idx_map-MakeDictIdxMap flattened into ((T1s40x2[nan,nan:AnanN4nans],T7s4[1,4:A2.5]),{})
[onnx_run_disc] .. M:_make_dict_idx_map-MakeDictIdxMap expecting (T7s40[0,3:A0.15],)
[onnx_run_disc] .. M:_make_dict_idx_map-MakeDictIdxMap computing A7s40[0,3:A0.15]
[onnx_run_disc] .. M:_make_dict_idx_map-MakeDictIdxMap diff=abs=0.0, rel=0.0
[onnx_run_disc] .. M:_make_dict_idx_map-MakeDictIdxMap run with ((T1s10x2,T7s4),{})
[onnx_run_disc] .. M:_make_dict_idx_map-MakeDictIdxMap flattened into ((T1s10x2[nan,nan:AnanN4nans],T7s4[1,4:A2.5]),{})
[onnx_run_disc] .. M:_make_dict_idx_map-MakeDictIdxMap expecting (T7s10[0,3:A0.6],)
[onnx_run_disc] .. M:_make_dict_idx_map-MakeDictIdxMap computing A7s10[0,3:A0.6]
[onnx_run_disc] .. M:_make_dict_idx_map-MakeDictIdxMap diff=abs=0.0, rel=0.0
[onnx_run_disc] .. M:_make_dict_idx_map-MakeDictIdxMap validation done
[to_onnx_local] .. M:_make_dict_idx_map-MakeDictIdxMap - done
[to_onnx_local] .. M:_make_dict_idx_map-MakeDictIdxMap - discrepancies: abs=0.0, rel=0.0
[to_onnx_local] .. M:_make_dict_idx_map-MakeDictIdxMap - discrepancies: abs=0.0, rel=0.0
[to_onnx_local]  M:__main__-TorchKNNImputer - export starts C_TorchKNNImputer
[to_onnx_local]  M:__main__-TorchKNNImputer - export done
[to_onnx_local]  M:__main__-TorchKNNImputer - run validation
[onnx_run_disc]  M:__main__-TorchKNNImputer run with cls=ExtendedReferenceEvaluator on ModelProto
[onnx_run_disc]  M:__main__-TorchKNNImputer run with ((T9s50x2,T9s2,T11s50x2,T1s40x2),{})
[onnx_run_disc]  M:__main__-TorchKNNImputer flattened into ((T9s50x2[False,True:A0.05],T9s2[True,True:A1.0],T11s50x2[nan,nan:AnanN5nans],T1s40x2[nan,nan:AnanN4nans]),{})
[onnx_run_disc]  M:__main__-TorchKNNImputer expecting (T1s40x2[-2.2343990802764893,2.7258105278015137:A-0.10678225666706567],)
[onnx_run_disc]  M:__main__-TorchKNNImputer computing A1s40x2[-2.2343990802764893,2.7258105278015137:A-0.10678225666706567]
[onnx_run_disc]  M:__main__-TorchKNNImputer diff=abs=0.0, rel=0.0
[onnx_run_disc]  M:__main__-TorchKNNImputer run with ((T9s5x2,T9s2,T11s5x2,T1s10x2),{})
[onnx_run_disc]  M:__main__-TorchKNNImputer flattened into ((T9s5x2[False,True:A0.5],T9s2[True,True:A1.0],T11s5x2[nan,nan:AnanN5nans],T1s10x2[nan,nan:AnanN4nans]),{})
[onnx_run_disc]  M:__main__-TorchKNNImputer expecting (T1s10x2[-2.5295796394348145,3.1395082473754883:A0.40699569071875885],)
[onnx_run_disc]  M:__main__-TorchKNNImputer computing A1s10x2[-2.5295796394348145,3.1395082473754883:A0.40699569071875885]
[onnx_run_disc]  M:__main__-TorchKNNImputer diff=abs=0.0, rel=0.0
[onnx_run_disc]  M:__main__-TorchKNNImputer validation done
[to_onnx_local]  M:__main__-TorchKNNImputer - done
[to_onnx_local]  M:__main__-TorchKNNImputer - discrepancies: abs=0.0, rel=0.0
[to_onnx_local]  M:__main__-TorchKNNImputer - discrepancies: abs=0.0, rel=0.0
</pre></div>
</div>
<p>Let’s save it.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">onnx</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">onx</span></a></a><span class="p">,</span> <span class="s2">&quot;plot_torch_sklearn_201.onnx&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>We can also print it.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/helpers.html#experimental_experiment.helpers.pretty_onnx" title="experimental_experiment.helpers.pretty_onnx" class="sphx-glr-backref-module-experimental_experiment-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/helpers.html#experimental_experiment.helpers.pretty_onnx" title="experimental_experiment.helpers.pretty_onnx" class="sphx-glr-backref-module-experimental_experiment-helpers sphx-glr-backref-type-py-function"><span class="n">pretty_onnx</span></a></a><span class="p">(</span><a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">onx</span></a></a><span class="p">))</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>opset: domain=&#39;&#39; version=18
opset: domain=&#39;local_domain&#39; version=1
input: name=&#39;_mask_fit_x&#39; type=dtype(&#39;bool&#39;) shape=[&#39;s0&#39;, 2]
input: name=&#39;_valid_mask&#39; type=dtype(&#39;bool&#39;) shape=[2]
input: name=&#39;_fit_x&#39; type=dtype(&#39;float64&#39;) shape=[&#39;s1&#39;, 2]
input: name=&#39;x&#39; type=dtype(&#39;float32&#39;) shape=[&#39;s2&#39;, 2]
init: name=&#39;init7_s1_1&#39; type=int64 shape=(1,) -- array([1])           -- Opset.make_node.1/Shape##Opset.make_node.1/Shape##Opset.make_node.1/Shape##Opset.make_node.1/Shape##Opset.make_node.1/Shape##Opset.make_node.1/Shape##Opset.make_node.1/Shape
init: name=&#39;init7_s1_-1&#39; type=int64 shape=(1,) -- array([-1])         -- Opset.make_node.1/Shape##Opset.make_node.1/Shape
IsNaN(x) -&gt; isnan
  Compress(isnan, _valid_mask, axis=1) -&gt; _onx_compress_isnan0
    Cast(_onx_compress_isnan0, to=6) -&gt; _onx_cast_index0
      ReduceMax(_onx_cast_index0, init7_s1_1, keepdims=0) -&gt; _onx_reducemax_cast_index00
        Cast(_onx_reducemax_cast_index00, to=9) -&gt; any_1
          Reshape(any_1, init7_s1_-1) -&gt; view
            NonZero(view) -&gt; _onx_nonzero_view0
              Reshape(_onx_nonzero_view0, init7_s1_-1) -&gt; nonzero_numpy#0
                diag_lib_C_TorchKNNImputer__make_dict_idx_map_default[local_domain](x, nonzero_numpy#0) -&gt; c_torch_knnimputer__make_dict_idx_map
Not(_mask_fit_x) -&gt; logical_not
Gather(x, nonzero_numpy#0, axis=0) -&gt; index_1
  diag_lib_C_TorchKNNImputer_dist_default[local_domain](index_1, _fit_x) -&gt; c_torch_knnimputer_dist
  diag_lib_C_TorchKNNImputer_columns_0__default[local_domain](x, c_torch_knnimputer_dist, logical_not, _mask_fit_x, c_torch_knnimputer__make_dict_idx_map, isnan, nonzero_numpy#0, _fit_x) -&gt; c_torch_knnimputer_columns_0_
  diag_lib_C_TorchKNNImputer_columns_1__default[local_domain](c_torch_knnimputer_columns_0_, c_torch_knnimputer_dist, logical_not, _mask_fit_x, c_torch_knnimputer__make_dict_idx_map, isnan, nonzero_numpy#0, _fit_x) -&gt; c_torch_knnimputer_columns_1_
    Compress(c_torch_knnimputer_columns_1_, _valid_mask, axis=1) -&gt; output_0
output: name=&#39;output_0&#39; type=dtype(&#39;float32&#39;) shape=[&#39;s2&#39;, &#39;u4&#39;]
----- function name=diag_lib_C_TorchKNNImputer__make_dict_idx_map_default domain=local_domain
----- doc_string: -- function_options=FunctionOptions(export_as_function=...
opset: domain=&#39;&#39; version=18
input: &#39;x&#39;
input: &#39;row_missing_idx&#39;
Constant(value=0) -&gt; init7_s_0
Constant(value=4) -&gt; init7_s_4
Constant(value=1) -&gt; init7_s_1
  Range(init7_s_0, init7_s_4, init7_s_1) -&gt; arange
Constant(value=[-1]) -&gt; init7_s1_-1
  Unsqueeze(row_missing_idx, init7_s1_-1) -&gt; _onx_unsqueeze_row_missing_idx0
Shape(x, end=1, start=0) -&gt; _shape_x0
  ConstantOfShape(_shape_x0, value=[0]) -&gt; zeros
    ScatterND(zeros, _onx_unsqueeze_row_missing_idx0, arange) -&gt; output_0
output: name=&#39;output_0&#39; type=? shape=?
----- function name=diag_lib_C_TorchKNNImputer_dist_default domain=local_domain
----- doc_string: -- function_options=FunctionOptions(export_as_function=...
opset: domain=&#39;&#39; version=18
input: &#39;x&#39;
input: &#39;y&#39;
Cast(y, to=1) -&gt; _to_copy
  IsNaN(_to_copy) -&gt; isnan_1
    Cast(isnan_1, to=1) -&gt; _to_copy_1
Constant(value=0.0) -&gt; c_lifted_tensor_0
Constant(value=0.0) -&gt; c_lifted_tensor_1
  Where(isnan_1, c_lifted_tensor_1, _to_copy) -&gt; index_put_1
    Mul(index_put_1, index_put_1) -&gt; mul_11
Constant(value=nan) -&gt; c_lifted_tensor_2
Constant(value=[1.0]) -&gt; c_lifted_tensor_3
Constant(value=-2.0) -&gt; init1_s_
Constant(value=[1]) -&gt; init7_s1_1
  Reshape(init1_s_, init7_s1_1) -&gt; _reshape_init1_s_0
Constant(value=[0.0]) -&gt; init1_s1_
Constant(value=1.0) -&gt; init1_s_2
  Reshape(init1_s_2, init7_s1_1) -&gt; _reshape_init1_s_20
Constant(value=0.0) -&gt; init1_s_3
  Reshape(init1_s_3, init7_s1_1) -&gt; _reshape_init1_s_30
Constant(value=2.0) -&gt; init1_s_4
  Reshape(init1_s_4, init7_s1_1) -&gt; _reshape_init1_s_40
Constant(value=[1, -1]) -&gt; init7_s2_1_-1
IsNaN(x) -&gt; isnan
  Cast(isnan, to=1) -&gt; _to_copy_2
    Gemm(_to_copy_2, mul_11, transA=0, transB=1) -&gt; matmul_2
  Where(isnan, c_lifted_tensor_0, x) -&gt; index_put
    Mul(index_put, index_put) -&gt; mul_10
  ReduceSum(mul_10, init7_s1_1, keepdims=1) -&gt; sum_1
Mul(index_put, _reshape_init1_s_0) -&gt; _onx_mul_index_put0
  Gemm(_onx_mul_index_put0, index_put_1, transA=0, transB=1) -&gt; matmul
    Add(matmul, sum_1) -&gt; add_26
  ReduceSum(mul_11, init7_s1_1, keepdims=1) -&gt; sum_2
  Reshape(sum_2, init7_s2_1_-1) -&gt; permute_2
    Add(add_26, permute_2) -&gt; add_35
Gemm(mul_10, _to_copy_1, transA=0, transB=1) -&gt; matmul_1
  Sub(add_35, matmul_1) -&gt; sub_18
    Sub(sub_18, matmul_2) -&gt; sub_24
  Clip(sub_24, init1_s1_) -&gt; clip
Sub(_reshape_init1_s_20, _to_copy_2) -&gt; rsub
Not(isnan_1) -&gt; bitwise_not
  Cast(bitwise_not, to=1) -&gt; _to_copy_4
  Gemm(rsub, _to_copy_4, transA=0, transB=1) -&gt; matmul_3
    Equal(matmul_3, _reshape_init1_s_30) -&gt; eq_33
  Where(eq_33, c_lifted_tensor_2, clip) -&gt; index_put_2
Max(c_lifted_tensor_3, matmul_3) -&gt; maximum
  Div(index_put_2, maximum) -&gt; div
    Mul(div, _reshape_init1_s_40) -&gt; _onx_mul_div0
      Sqrt(_onx_mul_div0) -&gt; output_0
output: name=&#39;output_0&#39; type=? shape=?
----- function name=diag_lib_C_TorchKNNImputer_columns_0___calc_impute__donors_idx_default domain=local_domain
----- doc_string: -- function_options=FunctionOptions(export_as_function=...
opset: domain=&#39;&#39; version=18
input: &#39;dist_pot_donors&#39;
input: &#39;n_neighbors&#39;
Constant(value=0) -&gt; init7_s_0
Constant(value=[1]) -&gt; init7_s1_1
Constant(value=1) -&gt; init7_s_1
Shape(dist_pot_donors, end=1, start=0) -&gt; _shape_dist_pot_donors0
  Squeeze(_shape_dist_pot_donors0) -&gt; sym_size_int_4
  Range(init7_s_0, sym_size_int_4, init7_s_1) -&gt; arange
  Unsqueeze(arange, init7_s1_1) -&gt; unsqueeze
    GatherND(dist_pot_donors, unsqueeze, batch_dims=0) -&gt; _onx_gathernd_dist_pot_donors0
TopK(dist_pot_donors, n_neighbors, largest=0, sorted=1) -&gt; unused_topk_values, output_0
  GatherElements(_onx_gathernd_dist_pot_donors0, output_0, axis=1) -&gt; output_1
output: name=&#39;output_0&#39; type=? shape=?
output: name=&#39;output_1&#39; type=? shape=?
----- function name=diag_lib_C_TorchKNNImputer_columns_0___calc_impute__weights_default domain=local_domain
----- doc_string: -- function_options=FunctionOptions(export_as_function=...
opset: domain=&#39;&#39; version=18
input: &#39;donors_dist&#39;
Constant(value=0.0) -&gt; c_lifted_tensor_0
Shape(donors_dist) -&gt; _shape_donors_dist0
  ConstantOfShape(_shape_donors_dist0, value=[1.0]) -&gt; ones_like
IsNaN(donors_dist) -&gt; isnan
  Where(isnan, c_lifted_tensor_0, ones_like) -&gt; output_0
output: name=&#39;output_0&#39; type=? shape=?
----- function name=diag_lib_C_TorchKNNImputer_columns_0___calc_impute__make_new_neights_default domain=local_domain
----- doc_string: -- function_options=FunctionOptions(export_as_function=...
opset: domain=&#39;&#39; version=18
input: &#39;donors_mask&#39;
input: &#39;donors&#39;
input: &#39;weight_matrix&#39;
Cast(donors_mask, to=11) -&gt; _to_copy
Cast(weight_matrix, to=11) -&gt; _to_copy_1
  Mul(_to_copy, _to_copy_1) -&gt; output_0
output: name=&#39;output_0&#39; type=? shape=?
----- function name=diag_lib_C_TorchKNNImputer_columns_0___calc_impute_default domain=local_domain
----- doc_string: -- function_options=FunctionOptions(export_as_function=...
opset: domain=&#39;&#39; version=18
opset: domain=&#39;local_domain&#39; version=1
input: &#39;dist_pot_donors&#39;
input: &#39;n_neighbors&#39;
input: &#39;fit_x_col&#39;
input: &#39;mask_fit_x_col&#39;
Constant(value=[1]) -&gt; c_lifted_tensor_0
Constant(value=[1.0]) -&gt; c_lifted_tensor_1
Constant(value=[-1]) -&gt; init7_s1_-1
  Reshape(fit_x_col, init7_s1_-1) -&gt; _reshape_fit_x_col0
Constant(value=0.0) -&gt; init11_s_
  Reshape(init11_s_, c_lifted_tensor_0) -&gt; _reshape_init11_s_0
diag_lib_C_TorchKNNImputer_columns_0___calc_impute__donors_idx_default[local_domain](dist_pot_donors, n_neighbors) -&gt; c_torch_knnimputer_columns_0___calc_impute__donors_idx#0, c_torch_knnimputer_columns_0___calc_impute__donors_idx#1
  diag_lib_C_TorchKNNImputer_columns_0___calc_impute__weights_default[local_domain](c_torch_knnimputer_columns_0___calc_impute__donors_idx#1) -&gt; c_torch_knnimputer_columns_0___calc_impute__weights
Gather(_reshape_fit_x_col0, c_torch_knnimputer_columns_0___calc_impute__donors_idx#0) -&gt; take
Reshape(mask_fit_x_col, init7_s1_-1) -&gt; _reshape_mask_fit_x_col0
  Gather(_reshape_mask_fit_x_col0, c_torch_knnimputer_columns_0___calc_impute__donors_idx#0) -&gt; take_1
    Cast(take_1, to=7) -&gt; _to_copy
  Sub(c_lifted_tensor_0, _to_copy) -&gt; sub_12
  diag_lib_C_TorchKNNImputer_columns_0___calc_impute__make_new_neights_default[local_domain](sub_12, take, c_torch_knnimputer_columns_0___calc_impute__weights) -&gt; c_torch_knnimputer_columns_0___calc_impute__make_new_neights
  ReduceSum(c_torch_knnimputer_columns_0___calc_impute__make_new_neights, c_lifted_tensor_0, keepdims=1) -&gt; sum_1
    Equal(sum_1, _reshape_init11_s_0) -&gt; eq_17
  Where(eq_17, c_lifted_tensor_1, sum_1) -&gt; where
Mul(take, c_torch_knnimputer_columns_0___calc_impute__make_new_neights) -&gt; mul_17
  ReduceSum(mul_17, c_lifted_tensor_0, keepdims=1) -&gt; sum_2
    Div(sum_2, where) -&gt; div
  Squeeze(div, c_lifted_tensor_0) -&gt; _onx_squeeze_div0
    Cast(_onx_squeeze_div0, to=1) -&gt; output_0
output: name=&#39;output_0&#39; type=? shape=?
----- function name=diag_lib_C_TorchKNNImputer_columns_0__default domain=local_domain
----- doc_string: -- function_options=FunctionOptions(export_as_function=...
opset: domain=&#39;&#39; version=18
opset: domain=&#39;local_domain&#39; version=1
input: &#39;x&#39;
input: &#39;dist_chunk&#39;
input: &#39;non_missing_fix_x&#39;
input: &#39;mask_fit_x&#39;
input: &#39;dist_idx_map&#39;
input: &#39;mask&#39;
input: &#39;row_missing_idx&#39;
input: &#39;_fit_x&#39;
Constant(value=[1.0]) -&gt; c_lifted_tensor_0
Constant(value=3) -&gt; c_lifted_tensor_1
Constant(value=[1]) -&gt; c_lifted_tensor_2
Constant(value=0) -&gt; init7_s_0
  Gather(mask, init7_s_0, axis=1) -&gt; select
    Gather(select, row_missing_idx, axis=0) -&gt; index
Constant(value=[-1]) -&gt; init7_s1_-1
  Reshape(index, init7_s1_-1) -&gt; view
    NonZero(view) -&gt; _onx_nonzero_view0
  Reshape(_onx_nonzero_view0, init7_s1_-1) -&gt; nonzero_numpy_1#0
    Gather(row_missing_idx, nonzero_numpy_1#0, axis=0) -&gt; index_1
      Gather(dist_idx_map, index_1, axis=0) -&gt; index_2
        Gather(dist_chunk, index_2, axis=0) -&gt; index_3
Constant(value=1.0) -&gt; init11_s_
  Reshape(init11_s_, c_lifted_tensor_2) -&gt; _reshape_init11_s_0
Constant(value=0.0) -&gt; init1_s_
Constant(value=[0]) -&gt; init7_s1_0
Constant(value=1) -&gt; init7_s_1
Gather(non_missing_fix_x, init7_s_0, axis=1) -&gt; select_1
  NonZero(select_1) -&gt; _onx_nonzero_select_10
  Reshape(_onx_nonzero_select_10, init7_s1_-1) -&gt; nonzero_numpy#0
    Shape(nonzero_numpy#0, end=1, start=0) -&gt; _shape_getitem_20
      Squeeze(_shape_getitem_20) -&gt; sym_size_int_20
  Less(c_lifted_tensor_1, sym_size_int_20) -&gt; lt
  Where(lt, c_lifted_tensor_1, sym_size_int_20) -&gt; where_1
  LessOrEqual(where_1, init7_s_0) -&gt; le_3
  Where(le_3, c_lifted_tensor_2, where_1) -&gt; where_2
Gather(index_3, nonzero_numpy#0, axis=1) -&gt; _onx_gather_index_30
  IsNaN(_onx_gather_index_30) -&gt; isnan
    Cast(isnan, to=6) -&gt; _onx_cast_isnan0
  ReduceMin(_onx_cast_isnan0, c_lifted_tensor_2, keepdims=0) -&gt; _onx_reducemin_cast_isnan00
    Cast(_onx_reducemin_cast_isnan00, to=9) -&gt; all_1
      Compress(index_1, all_1, axis=0) -&gt; index_5
  Unsqueeze(index_5, init7_s1_-1) -&gt; _onx_unsqueeze_index_50
Gather(mask_fit_x, init7_s_0, axis=1) -&gt; select_2
  Not(select_2) -&gt; bitwise_not
    Cast(bitwise_not, to=11) -&gt; _to_copy
      Cast(_to_copy, to=1) -&gt; _to_copy_1
        ReduceSum(_to_copy_1, keepdims=0) -&gt; sum_1
  Greater(sum_1, init1_s_) -&gt; gt
  Where(gt, sum_1, c_lifted_tensor_0) -&gt; where
Equal(_to_copy, _reshape_init11_s_0) -&gt; eq_23
Gather(_fit_x, init7_s_0, axis=1) -&gt; select_3
  Compress(select_3, eq_23, axis=0) -&gt; index_6
    ReduceSum(index_6, keepdims=0) -&gt; sum_2
      Cast(sum_2, to=1) -&gt; _to_copy_2
  Reshape(_to_copy_2, c_lifted_tensor_2) -&gt; _reshape__to_copy_20
    Div(_reshape__to_copy_20, where) -&gt; div
  Squeeze(div, init7_s1_0) -&gt; view_1
Gather(x, init7_s_0, axis=1) -&gt; select_4
Shape(index_5) -&gt; _shape_index_502
  Expand(view_1, _shape_index_502) -&gt; _onx_expand_view_10
  ScatterND(select_4, _onx_unsqueeze_index_50, _onx_expand_view_10) -&gt; index_put
  Unsqueeze(index_put, init7_s_1) -&gt; _onx_unsqueeze_index_put0
    Shape(_onx_unsqueeze_index_put0) -&gt; _shape_unsqueeze_index_put00
  Expand(init7_s1_0, _shape_unsqueeze_index_put00) -&gt; _onx_expand_init7_s1_00
    ScatterElements(x, _onx_expand_init7_s1_00, _onx_unsqueeze_index_put0, axis=1, reduction=b&#39;none&#39;) -&gt; select_scatter
  Gather(select_scatter, init7_s_0, axis=1) -&gt; select_9
Not(all_1) -&gt; bitwise_not_1
  Compress(index_1, bitwise_not_1, axis=0) -&gt; index_7
    Gather(dist_idx_map, index_7, axis=0) -&gt; index_8
      Gather(dist_chunk, index_8, axis=0) -&gt; index_9
    Gather(index_9, nonzero_numpy#0, axis=1) -&gt; _onx_gather_index_90
  Gather(_fit_x, init7_s_0, axis=1) -&gt; select_6
    Gather(select_6, nonzero_numpy#0, axis=0) -&gt; index_11
  Gather(mask_fit_x, init7_s_0, axis=1) -&gt; select_7
    Gather(select_7, nonzero_numpy#0, axis=0) -&gt; index_12
    diag_lib_C_TorchKNNImputer_columns_0___calc_impute_default[local_domain](_onx_gather_index_90, where_2, index_11, index_12) -&gt; c_torch_knnimputer_columns_0___calc_impute
  Unsqueeze(index_7, init7_s1_-1) -&gt; _onx_unsqueeze_index_70
    ScatterND(select_9, _onx_unsqueeze_index_70, c_torch_knnimputer_columns_0___calc_impute) -&gt; index_put_1
  Unsqueeze(index_put_1, init7_s_1) -&gt; _onx_unsqueeze_index_put_10
    Shape(_onx_unsqueeze_index_put_10) -&gt; _shape_unsqueeze_index_put_100
  Expand(init7_s1_0, _shape_unsqueeze_index_put_100) -&gt; _onx_expand_init7_s1_002
    ScatterElements(select_scatter, _onx_expand_init7_s1_002, _onx_unsqueeze_index_put_10, axis=1, reduction=b&#39;none&#39;) -&gt; output_0
output: name=&#39;output_0&#39; type=? shape=?
----- function name=diag_lib_C_TorchKNNImputer_columns_1___calc_impute__donors_idx_default domain=local_domain
----- doc_string: -- function_options=FunctionOptions(export_as_function=...
opset: domain=&#39;&#39; version=18
input: &#39;dist_pot_donors&#39;
input: &#39;n_neighbors&#39;
Constant(value=0) -&gt; init7_s_0
Constant(value=[1]) -&gt; init7_s1_1
Constant(value=1) -&gt; init7_s_1
Shape(dist_pot_donors, end=1, start=0) -&gt; _shape_dist_pot_donors0
  Squeeze(_shape_dist_pot_donors0) -&gt; sym_size_int_4
  Range(init7_s_0, sym_size_int_4, init7_s_1) -&gt; arange
  Unsqueeze(arange, init7_s1_1) -&gt; unsqueeze
    GatherND(dist_pot_donors, unsqueeze, batch_dims=0) -&gt; _onx_gathernd_dist_pot_donors0
TopK(dist_pot_donors, n_neighbors, largest=0, sorted=1) -&gt; unused_topk_values, output_0
  GatherElements(_onx_gathernd_dist_pot_donors0, output_0, axis=1) -&gt; output_1
output: name=&#39;output_0&#39; type=? shape=?
output: name=&#39;output_1&#39; type=? shape=?
----- function name=diag_lib_C_TorchKNNImputer_columns_1___calc_impute__weights_default domain=local_domain
----- doc_string: -- function_options=FunctionOptions(export_as_function=...
opset: domain=&#39;&#39; version=18
input: &#39;donors_dist&#39;
Constant(value=0.0) -&gt; c_lifted_tensor_0
Shape(donors_dist) -&gt; _shape_donors_dist0
  ConstantOfShape(_shape_donors_dist0, value=[1.0]) -&gt; ones_like
IsNaN(donors_dist) -&gt; isnan
  Where(isnan, c_lifted_tensor_0, ones_like) -&gt; output_0
output: name=&#39;output_0&#39; type=? shape=?
----- function name=diag_lib_C_TorchKNNImputer_columns_1___calc_impute__make_new_neights_default domain=local_domain
----- doc_string: -- function_options=FunctionOptions(export_as_function=...
opset: domain=&#39;&#39; version=18
input: &#39;donors_mask&#39;
input: &#39;donors&#39;
input: &#39;weight_matrix&#39;
Cast(donors_mask, to=11) -&gt; _to_copy
Cast(weight_matrix, to=11) -&gt; _to_copy_1
  Mul(_to_copy, _to_copy_1) -&gt; output_0
output: name=&#39;output_0&#39; type=? shape=?
----- function name=diag_lib_C_TorchKNNImputer_columns_1___calc_impute_default domain=local_domain
----- doc_string: -- function_options=FunctionOptions(export_as_function=...
opset: domain=&#39;&#39; version=18
opset: domain=&#39;local_domain&#39; version=1
input: &#39;dist_pot_donors&#39;
input: &#39;n_neighbors&#39;
input: &#39;fit_x_col&#39;
input: &#39;mask_fit_x_col&#39;
Constant(value=[1]) -&gt; c_lifted_tensor_0
Constant(value=[1.0]) -&gt; c_lifted_tensor_1
Constant(value=[-1]) -&gt; init7_s1_-1
  Reshape(fit_x_col, init7_s1_-1) -&gt; _reshape_fit_x_col0
Constant(value=0.0) -&gt; init11_s_
  Reshape(init11_s_, c_lifted_tensor_0) -&gt; _reshape_init11_s_0
diag_lib_C_TorchKNNImputer_columns_1___calc_impute__donors_idx_default[local_domain](dist_pot_donors, n_neighbors) -&gt; c_torch_knnimputer_columns_1___calc_impute__donors_idx#0, c_torch_knnimputer_columns_1___calc_impute__donors_idx#1
  diag_lib_C_TorchKNNImputer_columns_1___calc_impute__weights_default[local_domain](c_torch_knnimputer_columns_1___calc_impute__donors_idx#1) -&gt; c_torch_knnimputer_columns_1___calc_impute__weights
Gather(_reshape_fit_x_col0, c_torch_knnimputer_columns_1___calc_impute__donors_idx#0) -&gt; take
Reshape(mask_fit_x_col, init7_s1_-1) -&gt; _reshape_mask_fit_x_col0
  Gather(_reshape_mask_fit_x_col0, c_torch_knnimputer_columns_1___calc_impute__donors_idx#0) -&gt; take_1
    Cast(take_1, to=7) -&gt; _to_copy
  Sub(c_lifted_tensor_0, _to_copy) -&gt; sub_12
  diag_lib_C_TorchKNNImputer_columns_1___calc_impute__make_new_neights_default[local_domain](sub_12, take, c_torch_knnimputer_columns_1___calc_impute__weights) -&gt; c_torch_knnimputer_columns_1___calc_impute__make_new_neights
  ReduceSum(c_torch_knnimputer_columns_1___calc_impute__make_new_neights, c_lifted_tensor_0, keepdims=1) -&gt; sum_1
    Equal(sum_1, _reshape_init11_s_0) -&gt; eq_17
  Where(eq_17, c_lifted_tensor_1, sum_1) -&gt; where
Mul(take, c_torch_knnimputer_columns_1___calc_impute__make_new_neights) -&gt; mul_17
  ReduceSum(mul_17, c_lifted_tensor_0, keepdims=1) -&gt; sum_2
    Div(sum_2, where) -&gt; div
  Squeeze(div, c_lifted_tensor_0) -&gt; _onx_squeeze_div0
    Cast(_onx_squeeze_div0, to=1) -&gt; output_0
output: name=&#39;output_0&#39; type=? shape=?
----- function name=diag_lib_C_TorchKNNImputer_columns_1__default domain=local_domain
----- doc_string: -- function_options=FunctionOptions(export_as_function=...
opset: domain=&#39;&#39; version=18
opset: domain=&#39;local_domain&#39; version=1
input: &#39;x&#39;
input: &#39;dist_chunk&#39;
input: &#39;non_missing_fix_x&#39;
input: &#39;mask_fit_x&#39;
input: &#39;dist_idx_map&#39;
input: &#39;mask&#39;
input: &#39;row_missing_idx&#39;
input: &#39;_fit_x&#39;
Constant(value=[1.0]) -&gt; c_lifted_tensor_0
Constant(value=3) -&gt; c_lifted_tensor_1
Constant(value=[1]) -&gt; c_lifted_tensor_2
Constant(value=1) -&gt; init7_s_1
  Gather(mask, init7_s_1, axis=1) -&gt; select
    Gather(select, row_missing_idx, axis=0) -&gt; index
Constant(value=[-1]) -&gt; init7_s1_-1
  Reshape(index, init7_s1_-1) -&gt; view
    NonZero(view) -&gt; _onx_nonzero_view0
  Reshape(_onx_nonzero_view0, init7_s1_-1) -&gt; nonzero_numpy_1#0
    Gather(row_missing_idx, nonzero_numpy_1#0, axis=0) -&gt; index_1
      Gather(dist_idx_map, index_1, axis=0) -&gt; index_2
        Gather(dist_chunk, index_2, axis=0) -&gt; index_3
Constant(value=0) -&gt; init7_s_0
Constant(value=1.0) -&gt; init11_s_
  Reshape(init11_s_, c_lifted_tensor_2) -&gt; _reshape_init11_s_0
Constant(value=0.0) -&gt; init1_s_
Constant(value=[0]) -&gt; init7_s1_0
Gather(non_missing_fix_x, init7_s_1, axis=1) -&gt; select_1
  NonZero(select_1) -&gt; _onx_nonzero_select_10
  Reshape(_onx_nonzero_select_10, init7_s1_-1) -&gt; nonzero_numpy#0
    Shape(nonzero_numpy#0, end=1, start=0) -&gt; _shape_getitem_20
      Squeeze(_shape_getitem_20) -&gt; sym_size_int_20
  Less(c_lifted_tensor_1, sym_size_int_20) -&gt; lt
  Where(lt, c_lifted_tensor_1, sym_size_int_20) -&gt; where_1
  LessOrEqual(where_1, init7_s_0) -&gt; le_3
  Where(le_3, c_lifted_tensor_2, where_1) -&gt; where_2
Gather(index_3, nonzero_numpy#0, axis=1) -&gt; _onx_gather_index_30
  IsNaN(_onx_gather_index_30) -&gt; isnan
    Cast(isnan, to=6) -&gt; _onx_cast_isnan0
  ReduceMin(_onx_cast_isnan0, c_lifted_tensor_2, keepdims=0) -&gt; _onx_reducemin_cast_isnan00
    Cast(_onx_reducemin_cast_isnan00, to=9) -&gt; all_1
      Compress(index_1, all_1, axis=0) -&gt; index_5
  Unsqueeze(index_5, init7_s1_-1) -&gt; _onx_unsqueeze_index_50
Gather(mask_fit_x, init7_s_1, axis=1) -&gt; select_2
  Not(select_2) -&gt; bitwise_not
    Cast(bitwise_not, to=11) -&gt; _to_copy
      Cast(_to_copy, to=1) -&gt; _to_copy_1
        ReduceSum(_to_copy_1, keepdims=0) -&gt; sum_1
  Greater(sum_1, init1_s_) -&gt; gt
  Where(gt, sum_1, c_lifted_tensor_0) -&gt; where
Equal(_to_copy, _reshape_init11_s_0) -&gt; eq_23
Gather(_fit_x, init7_s_1, axis=1) -&gt; select_3
  Compress(select_3, eq_23, axis=0) -&gt; index_6
    ReduceSum(index_6, keepdims=0) -&gt; sum_2
      Cast(sum_2, to=1) -&gt; _to_copy_2
  Reshape(_to_copy_2, c_lifted_tensor_2) -&gt; _reshape__to_copy_20
    Div(_reshape__to_copy_20, where) -&gt; div
  Squeeze(div, init7_s1_0) -&gt; view_1
Gather(x, init7_s_1, axis=1) -&gt; select_4
Shape(index_5) -&gt; _shape_index_502
  Expand(view_1, _shape_index_502) -&gt; _onx_expand_view_10
  ScatterND(select_4, _onx_unsqueeze_index_50, _onx_expand_view_10) -&gt; index_put
  Unsqueeze(index_put, init7_s_1) -&gt; _onx_unsqueeze_index_put0
    Shape(_onx_unsqueeze_index_put0) -&gt; _shape_unsqueeze_index_put00
  Expand(c_lifted_tensor_2, _shape_unsqueeze_index_put00) -&gt; _onx_expand_c_lifted_tensor_20
    ScatterElements(x, _onx_expand_c_lifted_tensor_20, _onx_unsqueeze_index_put0, axis=1, reduction=b&#39;none&#39;) -&gt; select_scatter
  Gather(select_scatter, init7_s_1, axis=1) -&gt; select_9
Not(all_1) -&gt; bitwise_not_1
  Compress(index_1, bitwise_not_1, axis=0) -&gt; index_7
    Gather(dist_idx_map, index_7, axis=0) -&gt; index_8
      Gather(dist_chunk, index_8, axis=0) -&gt; index_9
    Gather(index_9, nonzero_numpy#0, axis=1) -&gt; _onx_gather_index_90
  Gather(_fit_x, init7_s_1, axis=1) -&gt; select_6
    Gather(select_6, nonzero_numpy#0, axis=0) -&gt; index_11
  Gather(mask_fit_x, init7_s_1, axis=1) -&gt; select_7
    Gather(select_7, nonzero_numpy#0, axis=0) -&gt; index_12
    diag_lib_C_TorchKNNImputer_columns_1___calc_impute_default[local_domain](_onx_gather_index_90, where_2, index_11, index_12) -&gt; c_torch_knnimputer_columns_1___calc_impute
  Unsqueeze(index_7, init7_s1_-1) -&gt; _onx_unsqueeze_index_70
    ScatterND(select_9, _onx_unsqueeze_index_70, c_torch_knnimputer_columns_1___calc_impute) -&gt; index_put_1
  Unsqueeze(index_put_1, init7_s_1) -&gt; _onx_unsqueeze_index_put_10
    Shape(_onx_unsqueeze_index_put_10) -&gt; _shape_unsqueeze_index_put_100
  Expand(c_lifted_tensor_2, _shape_unsqueeze_index_put_100) -&gt; _onx_expand_c_lifted_tensor_202
    ScatterElements(select_scatter, _onx_expand_c_lifted_tensor_202, _onx_unsqueeze_index_put_10, axis=1, reduction=b&#39;none&#39;) -&gt; output_0
output: name=&#39;output_0&#39; type=? shape=?
</pre></div>
</div>
</section>
</section>
<section id="id2">
<h2>Validation<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h2>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">validate_onnx</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">sizey</span><span class="p">,</span> <a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">onx</span></a></a><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">use_ort</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.randn.html#torch.randn" title="torch.randn" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.randn.html#torch.randn" title="torch.randn" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">randn</span></a></a><span class="p">((</span><span class="n">size</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.randn.html#torch.randn" title="torch.randn" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.randn.html#torch.randn" title="torch.randn" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">randn</span></a></a><span class="p">((</span><span class="n">sizey</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a></a> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">[</span><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a></a><span class="p">,</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a></a> <span class="o">%</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">torch</span><span class="o">.</span><span class="n">nan</span></a></a>
    <span class="k">for</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a></a> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a><span class="p">[</span><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a></a> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a></a> <span class="o">%</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">torch</span><span class="o">.</span><span class="n">nan</span></a></a>

    <span class="n">knn_imputer</span> <span class="o">=</span> <a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class"><span class="n">sklearn</span><span class="o">.</span><span class="n">impute</span><span class="o">.</span><span class="n">KNNImputer</span></a></a><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">knn_imputer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">TorchKNNImputer</span></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="p">)</span>

    <span class="n">p1</span> <span class="o">=</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a><span class="p">)</span>

    <span class="n">model_inputs</span> <span class="o">=</span> <span class="p">(</span>
        <a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_mask_fit_X</span><span class="p">),</span>
        <a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_valid_mask</span><span class="p">),</span>
        <a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_fit_X</span><span class="p">),</span>
        <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="o">*</span><span class="n">model_inputs</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/helpers.html#experimental_experiment.helpers.max_diff" title="experimental_experiment.helpers.max_diff" class="sphx-glr-backref-module-experimental_experiment-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/helpers.html#experimental_experiment.helpers.max_diff" title="experimental_experiment.helpers.max_diff" class="sphx-glr-backref-module-experimental_experiment-helpers sphx-glr-backref-type-py-function"><span class="n">max_diff</span></a></a><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;abs&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> and sizey=</span><span class="si">{</span><span class="n">sizey</span><span class="si">}</span><span class="s2">, d=</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Torch Discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> and sizey=</span><span class="si">{</span><span class="n">sizey</span><span class="si">}</span><span class="s2">, d=</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">input_names</span> <span class="o">=</span> <span class="p">[</span><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span><span class="o">.</span><span class="n">name</span></a></a> <span class="k">for</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a></a> <span class="ow">in</span> <a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">onx</span></a></a><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">input</span><span class="p">]</span>
    <span class="n">feeds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">input_names</span><span class="p">,</span> <span class="p">[</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">t</span><span class="o">.</span><span class="n">numpy</span></a></a><span class="p">()</span> <span class="k">for</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">t</span></a></a> <span class="ow">in</span> <span class="n">model_inputs</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;python: loading the model...&quot;</span><span class="p">)</span>
    <span class="n">sess</span> <span class="o">=</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/reference/index.html#experimental_experiment.reference.ExtendedReferenceEvaluator" title="experimental_experiment.reference.ExtendedReferenceEvaluator" class="sphx-glr-backref-module-experimental_experiment-reference sphx-glr-backref-type-py-class"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/reference/index.html#experimental_experiment.reference.ExtendedReferenceEvaluator" title="experimental_experiment.reference.ExtendedReferenceEvaluator" class="sphx-glr-backref-module-experimental_experiment-reference sphx-glr-backref-type-py-class"><span class="n">ExtendedReferenceEvaluator</span></a></a><span class="p">(</span><a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">onx</span></a></a><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;python: running the model...&quot;</span><span class="p">)</span>
    <span class="n">got</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">feeds</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/helpers.html#experimental_experiment.helpers.max_diff" title="experimental_experiment.helpers.max_diff" class="sphx-glr-backref-module-experimental_experiment-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/helpers.html#experimental_experiment.helpers.max_diff" title="experimental_experiment.helpers.max_diff" class="sphx-glr-backref-module-experimental_experiment-helpers sphx-glr-backref-type-py-function"><span class="n">max_diff</span></a></a><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">got</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;abs&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ONNX Discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> and sizey=</span><span class="si">{</span><span class="n">sizey</span><span class="si">}</span><span class="s2">, d=</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ONNX Discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> and sizey=</span><span class="si">{</span><span class="n">sizey</span><span class="si">}</span><span class="s2">, d=</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">use_ort</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;onnxruntime: loading the model...&quot;</span><span class="p">)</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="n">onnxruntime</span><span class="o">.</span><span class="n">SessionOptions</span><span class="p">()</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">optimized_model_filepath</span> <span class="o">=</span> <span class="s2">&quot;plot_torch_sklearn_201.ort.onnx&quot;</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">log_severity_level</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">log_verbosity_level</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="n">onnxruntime</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span>
            <a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">onx</span></a></a><span class="o">.</span><span class="n">SerializeToString</span><span class="p">(),</span> <span class="n">opts</span><span class="p">,</span> <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CPUExecutionProvider&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;onnxruntime: running the model...&quot;</span><span class="p">)</span>
        <span class="n">got</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">feeds</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/helpers.html#experimental_experiment.helpers.max_diff" title="experimental_experiment.helpers.max_diff" class="sphx-glr-backref-module-experimental_experiment-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/helpers.html#experimental_experiment.helpers.max_diff" title="experimental_experiment.helpers.max_diff" class="sphx-glr-backref-module-experimental_experiment-helpers sphx-glr-backref-type-py-function"><span class="n">max_diff</span></a></a><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">got</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;abs&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ONNX Discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> and sizey=</span><span class="si">{</span><span class="n">sizey</span><span class="si">}</span><span class="s2">, d=</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ONNX Discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> and sizey=</span><span class="si">{</span><span class="n">sizey</span><span class="si">}</span><span class="s2">, d=</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">model_inputs</span> <span class="o">=</span> <span class="p">(</span>
        <a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_mask_fit_X</span><span class="p">),</span>
        <a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_valid_mask</span><span class="p">),</span>
        <a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_fit_X</span><span class="p">),</span>
        <a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="o">*</span><span class="n">model_inputs</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/helpers.html#experimental_experiment.helpers.max_diff" title="experimental_experiment.helpers.max_diff" class="sphx-glr-backref-module-experimental_experiment-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/helpers.html#experimental_experiment.helpers.max_diff" title="experimental_experiment.helpers.max_diff" class="sphx-glr-backref-module-experimental_experiment-helpers sphx-glr-backref-type-py-function"><span class="n">max_diff</span></a></a><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;abs&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> and sizey=</span><span class="si">{</span><span class="n">sizey</span><span class="si">}</span><span class="s2">, d=</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">feeds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">input_names</span><span class="p">,</span> <span class="p">[</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">t</span><span class="o">.</span><span class="n">numpy</span></a></a><span class="p">()</span> <span class="k">for</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">t</span></a></a> <span class="ow">in</span> <span class="n">model_inputs</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;onnxruntime: running the model...&quot;</span><span class="p">)</span>
    <span class="n">got</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">feeds</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/helpers.html#experimental_experiment.helpers.max_diff" title="experimental_experiment.helpers.max_diff" class="sphx-glr-backref-module-experimental_experiment-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/helpers.html#experimental_experiment.helpers.max_diff" title="experimental_experiment.helpers.max_diff" class="sphx-glr-backref-module-experimental_experiment-helpers sphx-glr-backref-type-py-function"><span class="n">max_diff</span></a></a><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">got</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;abs&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ONNX Discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> and sizey=</span><span class="si">{</span><span class="n">sizey</span><span class="si">}</span><span class="s2">, d=</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">)</span>


<span class="c1"># This does not work yet.</span>
<span class="n">validate_onnx</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">onx</span></a></a><span class="p">)</span>
<span class="n">validate_onnx</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://onnx.ai/onnx/api/serialization.html#onnx.ModelProto" title="onnx.ModelProto" class="sphx-glr-backref-module-onnx sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">onx</span></a></a><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Torch Discrepancies for size=5 and sizey=10, d={&#39;abs&#39;: 2.9802322387695312e-08, &#39;rel&#39;: 4.6411738120561695e-08, &#39;sum&#39;: 7.947285962650597e-08, &#39;n&#39;: 20.0, &#39;dnan&#39;: 0.0}
python: loading the model...
python: running the model...
ONNX Discrepancies for size=5 and sizey=10, d={&#39;abs&#39;: 2.9802322387695312e-08, &#39;rel&#39;: 4.6411738120561695e-08, &#39;sum&#39;: 7.947285962650597e-08, &#39;n&#39;: 20.0, &#39;dnan&#39;: 0.0}
onnxruntime: running the model...
done
Torch Discrepancies for size=50 and sizey=40, d={&#39;abs&#39;: 1.9868214962137642e-08, &#39;rel&#39;: 2.5721566741681128e-08, &#39;sum&#39;: 3.725290298461914e-08, &#39;n&#39;: 80.0, &#39;dnan&#39;: 0.0}
python: loading the model...
python: running the model...
ONNX Discrepancies for size=50 and sizey=40, d={&#39;abs&#39;: 1.9868214962137642e-08, &#39;rel&#39;: 2.5721566741681128e-08, &#39;sum&#39;: 3.725290298461914e-08, &#39;n&#39;: 80.0, &#39;dnan&#39;: 0.0}
onnxruntime: running the model...
done
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 18.881 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-plot-torch-sklearn-201-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/424a4167f0d4e68c68581003765f271f/plot_torch_sklearn_201.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_torch_sklearn_201.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/91a11247fad55ba7ccd05b38fa897a78/plot_torch_sklearn_201.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_torch_sklearn_201.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../_downloads/84f58a1f54b99d7bc6a56dce5bd2d150/plot_torch_sklearn_201.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">zipped:</span> <span class="pre">plot_torch_sklearn_201.zip</span></code></a></p>
</div>
</div>
<p class="rubric">Related examples</p>
<div class="sphx-glr-thumbnails"><div class="sphx-glr-thumbcontainer" tooltip="The convolution is a well known image transformation used to transform an image. It can be used to blur, to compute the gradient in one direction and it is widely used in deep neural networks. Having a fast implementation is important."><img alt="" src="../_images/sphx_glr_plot_convolutation_matmul_102_thumb.png" />
<p><a class="reference internal" href="plot_convolutation_matmul_102.html#sphx-glr-auto-examples-plot-convolutation-matmul-102-py"><span class="std std-ref">102: Convolution and Matrix Multiplication</span></a></p>
  <div class="sphx-glr-thumbnail-title">102: Convolution and Matrix Multiplication</div>
</div><div class="sphx-glr-thumbcontainer" tooltip="This example leverages the function torch.compile and the ability to use a custom backend (see Custom Backends) to test the optimization of a model by fusing simple element-wise kernels."><img alt="" src="../_images/sphx_glr_plot_custom_backend_llama_102_thumb.png" />
<p><a class="reference internal" href="plot_custom_backend_llama_102.html#sphx-glr-auto-examples-plot-custom-backend-llama-102-py"><span class="std std-ref">102: Fuse kernels in a small Llama Model</span></a></p>
  <div class="sphx-glr-thumbnail-title">102: Fuse kernels in a small Llama Model</div>
</div><div class="sphx-glr-thumbcontainer" tooltip="The script compares the two exporters implemented in pytorch for a part of llama model. The model are compared after all optimizations were made with and onnxruntime."><img alt="" src="../_images/sphx_glr_plot_llama_diff_export_301_thumb.png" />
<p><a class="reference internal" href="plot_llama_diff_export_301.html#sphx-glr-auto-examples-plot-llama-diff-export-301-py"><span class="std std-ref">301: Compares LLAMA exporters</span></a></p>
  <div class="sphx-glr-thumbnail-title">301: Compares LLAMA exporters</div>
</div><div class="sphx-glr-thumbcontainer" tooltip="This example leverages the examples introduced on this page Custom Backends. It uses backend experimental_experiment.torch_dynamo.onnx_custom_backend based on onnxruntime and running on CPU or CUDA. It could easily replaced by experimental_experiment.torch_dynamo.onnx_debug_backend. This one based on the reference implemented from onnx can show the intermediate results if needed. It is very slow."><img alt="" src="../_images/sphx_glr_plot_torch_custom_backend_101_thumb.png" />
<p><a class="reference internal" href="plot_torch_custom_backend_101.html#sphx-glr-auto-examples-plot-torch-custom-backend-101-py"><span class="std std-ref">101: A custom backend for torch</span></a></p>
  <div class="sphx-glr-thumbnail-title">101: A custom backend for torch</div>
</div><div class="sphx-glr-thumbcontainer" tooltip="scikit-learn and torch to train a linear regression."><img alt="" src="../_images/sphx_glr_plot_torch_linreg_101_thumb.png" />
<p><a class="reference internal" href="plot_torch_linreg_101.html#sphx-glr-auto-examples-plot-torch-linreg-101-py"><span class="std std-ref">101: Linear Regression and export to ONNX</span></a></p>
  <div class="sphx-glr-thumbnail-title">101: Linear Regression and export to ONNX</div>
</div></div><p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="plot_llama_diff_export_301.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">301: Compares LLAMA exporters</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="plot_torch_export_201.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">201: Evaluate different ways to export a torch model to ONNX</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023-2024
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">201: Use torch to export a scikit-learn model into ONNX</a><ul>
<li><a class="reference internal" href="#torch-implementation-of-nan-euclidean">torch implementation of nan_euclidean</a><ul>
<li><a class="reference internal" href="#module">Module</a></li>
<li><a class="reference internal" href="#validation">Validation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#torch-implementation-of-knnimputer">torch implementation of KNNImputer</a><ul>
<li><a class="reference internal" href="#id1">Validation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#export-to-onnx">Export to ONNX</a><ul>
<li><a class="reference internal" href="#final-step">Final step</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id2">Validation</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=a1637f0b"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=5fa4622c"></script>
    </body>
</html>
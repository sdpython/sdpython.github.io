
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "auto_recipes/plot_exporter_exporter_infer_ds.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_auto_recipes_plot_exporter_exporter_infer_ds.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_recipes_plot_exporter_exporter_infer_ds.py:


.. _l-plot-exporter-exporter-infer-ds:

Infer dynamic shapes before exporting
=====================================

Dynamic shapes need to be specified to get a model able to cope
with different dimensions. Input rank are expected to be the same
but the dimension may change. The user has the ability to
set them up or to call a function able to infer them from
two sets of inputs having different values for the dynamic dimensions.

Infer dynamic shapes
++++++++++++++++++++

.. GENERATED FROM PYTHON SOURCE LINES 16-56

.. code-block:: Python


    import onnx
    from onnx_array_api.plotting.graphviz_helper import plot_dot
    import torch
    from experimental_experiment.torch_interpreter import to_onnx
    from experimental_experiment.torch_interpreter.piece_by_piece import (
        trace_execution_piece_by_piece,
    )


    class MA(torch.nn.Module):
        def forward(self, x, y):
            return x + y


    class MM(torch.nn.Module):
        def forward(self, x, y):
            return x * y


    class MASMM(torch.nn.Module):
        def __init__(self):
            super().__init__()
            self.ma = MA()
            self.mm = MM()

        def forward(self, x, y, z):
            return self.ma(x, y) - self.mm(y, z)


    class Model(torch.nn.Module):
        def __init__(self):
            super().__init__()
            self.ma = MA()
            self.masmm = MASMM()

        def forward(self, x):
            return self.ma(x, self.masmm(x, x, x))









.. GENERATED FROM PYTHON SOURCE LINES 57-58

The model.

.. GENERATED FROM PYTHON SOURCE LINES 58-60

.. code-block:: Python

    model = Model()








.. GENERATED FROM PYTHON SOURCE LINES 61-62

Two sets of inputs.

.. GENERATED FROM PYTHON SOURCE LINES 62-67

.. code-block:: Python

    inputs = [
        ((torch.randn((5, 6)),), {}),
        ((torch.randn((6, 6)),), {}),
    ]








.. GENERATED FROM PYTHON SOURCE LINES 68-70

Then we run the model, stores intermediates inputs and outputs,
to finally guess the dynamic shapes.

.. GENERATED FROM PYTHON SOURCE LINES 70-74

.. code-block:: Python

    diag = trace_execution_piece_by_piece(model, inputs, verbose=0)
    pretty = diag.pretty_text(with_dynamic_shape=True)
    print(pretty)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    >>> __main__: Model
      DS=(({0: <_DimHint.DYNAMIC: 3>},), {})
      > ((CT1s5x6[-1.6343743801116943,1.5840283632278442:A0.21215250256160895],),{})
      > ((CT1s6x6[-1.3563047647476196,2.310480833053589:A0.1465506377733416],),{})
        >>> ma: MA
          DS=(({0: <_DimHint.DYNAMIC: 3>}, {0: <_DimHint.DYNAMIC: 3>}), {})
          > ((CT1s5x6[-1.6343743801116943,1.5840283632278442:A0.21215250256160895],CT1s5x6[-5.93992805480957,0.9989712238311768:A-0.5209599755704403]),{})
          > ((CT1s6x6[-1.3563047647476196,2.310480833053589:A0.1465506377733416],CT1s6x6[-4.5521721839904785,0.9687278270721436:A-0.6981551880016923]),{})
          < (CT1s5x6[-7.574302673339844,2.24814510345459:A-0.3088074654340744],)
          < (CT1s6x6[-5.908476829528809,2.2454233169555664:A-0.5516045551954044],)
        <<<
        >>> masmm: MASMM
          DS=(({0: <_DimHint.DYNAMIC: 3>}, {0: <_DimHint.DYNAMIC: 3>}, {0: <_DimHint.DYNAMIC: 3>}), {})
          > ((CT1s5x6[-1.6343743801116943,1.5840283632278442:A0.21215250256160895],CT1s5x6[-1.6343743801116943,1.5840283632278442:A0.21215250256160895],CT1s5x6[-1.6343743801116943,1.5840283632278442:A0.21215250256160895]),{})
          > ((CT1s6x6[-1.3563047647476196,2.310480833053589:A0.1465506377733416],CT1s6x6[-1.3563047647476196,2.310480833053589:A0.1465506377733416],CT1s6x6[-1.3563047647476196,2.310480833053589:A0.1465506377733416]),{})
            >>> ma: MA
              DS=(({0: <_DimHint.DYNAMIC: 3>}, {0: <_DimHint.DYNAMIC: 3>}), {})
              > ((CT1s5x6[-1.6343743801116943,1.5840283632278442:A0.21215250256160895],CT1s5x6[-1.6343743801116943,1.5840283632278442:A0.21215250256160895]),{})
              > ((CT1s6x6[-1.3563047647476196,2.310480833053589:A0.1465506377733416],CT1s6x6[-1.3563047647476196,2.310480833053589:A0.1465506377733416]),{})
              < (CT1s5x6[-3.2687487602233887,3.1680567264556885:A0.4243050051232179],)
              < (CT1s6x6[-2.7126095294952393,4.620961666107178:A0.2931012755466832],)
            <<<
            >>> mm: MM
              DS=(({0: <_DimHint.DYNAMIC: 3>}, {0: <_DimHint.DYNAMIC: 3>}), {})
              > ((CT1s5x6[-1.6343743801116943,1.5840283632278442:A0.21215250256160895],CT1s5x6[-1.6343743801116943,1.5840283632278442:A0.21215250256160895]),{})
              > ((CT1s6x6[-1.3563047647476196,2.310480833053589:A0.1465506377733416],CT1s6x6[-1.3563047647476196,2.310480833053589:A0.1465506377733416]),{})
              < (CT1s5x6[0.0033631178084760904,2.6711795330047607:A0.945264990759703],)
              < (CT1s6x6[0.00032021309016272426,5.338321685791016:A0.9912564563096061],)
            <<<
          < (CT1s5x6[-5.93992805480957,0.9989712238311768:A-0.5209599755704403],)
          < (CT1s6x6[-4.5521721839904785,0.9687278270721436:A-0.6981551880016923],)
        <<<
      < (CT1s5x6[-7.574302673339844,2.24814510345459:A-0.3088074654340744],)
      < (CT1s6x6[-5.908476829528809,2.2454233169555664:A-0.5516045551954044],)
    <<<




.. GENERATED FROM PYTHON SOURCE LINES 75-76

The dynamic shapes are obtained with:

.. GENERATED FROM PYTHON SOURCE LINES 76-79

.. code-block:: Python

    ds = diag.guess_dynamic_shapes()
    print(ds)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    (({0: <_DimHint.DYNAMIC: 3>},), {})




.. GENERATED FROM PYTHON SOURCE LINES 80-84

Export
++++++

We use these dynamic shapes to export.

.. GENERATED FROM PYTHON SOURCE LINES 84-88

.. code-block:: Python


    ep = torch.export.export(model, inputs[0][0], kwargs=inputs[0][1], dynamic_shapes=ds[0])
    print(ep)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    ExportedProgram:
        class GraphModule(torch.nn.Module):
            def forward(self, x: "f32[s0, 6]"):
                 # File: /home/xadupre/github/experimental-experiment/_doc/recipes/plot_exporter_exporter_infer_ds.py:28 in forward, code: return x + y
                add: "f32[s0, 6]" = torch.ops.aten.add.Tensor(x, x)
            
                 # File: /home/xadupre/github/experimental-experiment/_doc/recipes/plot_exporter_exporter_infer_ds.py:33 in forward, code: return x * y
                mul: "f32[s0, 6]" = torch.ops.aten.mul.Tensor(x, x)
            
                 # File: /home/xadupre/github/experimental-experiment/_doc/recipes/plot_exporter_exporter_infer_ds.py:43 in forward, code: return self.ma(x, y) - self.mm(y, z)
                sub: "f32[s0, 6]" = torch.ops.aten.sub.Tensor(add, mul);  add = mul = None
            
                 # File: /home/xadupre/github/experimental-experiment/_doc/recipes/plot_exporter_exporter_infer_ds.py:28 in forward, code: return x + y
                add_1: "f32[s0, 6]" = torch.ops.aten.add.Tensor(x, sub);  x = sub = None
                return (add_1,)
            
    Graph signature: ExportGraphSignature(input_specs=[InputSpec(kind=<InputKind.USER_INPUT: 1>, arg=TensorArgument(name='x'), target=None, persistent=None)], output_specs=[OutputSpec(kind=<OutputKind.USER_OUTPUT: 1>, arg=TensorArgument(name='add_1'), target=None)])
    Range constraints: {s0: VR[2, int_oo]}





.. GENERATED FROM PYTHON SOURCE LINES 89-90

We can use that graph to get the onnx model.

.. GENERATED FROM PYTHON SOURCE LINES 90-95

.. code-block:: Python


    onx, builder = to_onnx(ep, return_builder=True)
    onnx.save(onx, "plot_exporter_exporter_infer_ds.onnx")
    print(builder.pretty_text())





.. rst-class:: sphx-glr-script-out

 .. code-block:: none


    dyn---: s0 -> 's0'
    opset: : 18
    input:: x                                                                       |T1: s0 x 6
    Add: x, x -> add                                                                |T1: s0 x 6                   - add_Tensor
    Mul: x, x -> mul                                                                |T1: s0 x 6                   - mul_Tensor
    Sub: add, mul -> sub                                                            |T1: s0 x 6                   - sub_Tensor
    Add: x, sub -> output_0                                                         |T1: s0 x 6                   - add_Tensor2
    output:: output_0                                                               |T1: s0 x 6




.. GENERATED FROM PYTHON SOURCE LINES 96-97

And visually.

.. GENERATED FROM PYTHON SOURCE LINES 97-99

.. code-block:: Python


    plot_dot(onx)



.. image-sg:: /auto_recipes/images/sphx_glr_plot_exporter_exporter_infer_ds_001.png
   :alt: plot exporter exporter infer ds
   :srcset: /auto_recipes/images/sphx_glr_plot_exporter_exporter_infer_ds_001.png
   :class: sphx-glr-single-img






.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 0.148 seconds)


.. _sphx_glr_download_auto_recipes_plot_exporter_exporter_infer_ds.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: plot_exporter_exporter_infer_ds.ipynb <plot_exporter_exporter_infer_ds.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: plot_exporter_exporter_infer_ds.py <plot_exporter_exporter_infer_ds.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: plot_exporter_exporter_infer_ds.zip <plot_exporter_exporter_infer_ds.zip>`


.. include:: plot_exporter_exporter_infer_ds.recommendations


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_

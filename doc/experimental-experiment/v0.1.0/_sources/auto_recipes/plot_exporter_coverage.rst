
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "auto_recipes/plot_exporter_coverage.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_auto_recipes_plot_exporter_coverage.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_recipes_plot_exporter_coverage.py:


.. _l-plot-exporter-coverage:

Measures the exporter success on many test cases
================================================

All test cases can be found in module
:mod:`experimental_experiment.torch_interpreter.eval.model_cases`.
Page :ref:`l-export-supported-signatures` shows the exported
program for many of those cases.

.. GENERATED FROM PYTHON SOURCE LINES 13-63

.. code-block:: Python


    from experimental_experiment.args import get_parsed_args

    script_args = get_parsed_args(
        "plot_exporter_coverage",
        description=__doc__,
        exporter=("all", "an exporter to rerun"),
        dynamic=("all", "use dyanmic shapes"),
        case=(
            "three",
            "model cases, two for the first two (to test), "
            "all to select all, a name or a regular expression fior a subset",
        ),
        quiet=("1", "0 or 1"),
        verbose=("1", "verbosity"),
        expose="exporter,dyanmic,case,quiet,verbose",
    )

    exporters = (
        (
            "export-strict",
            "export-strict-dec",
            "export-nostrict",
            "export-nostrict-dec",
            "export-jit",
            "export-tracing",
            "custom-strict",
            "custom-nostrict",
            "custom-strict-dec",
            "custom-nostrict-dec",
            "custom-tracing",
            "dynamo",
            "dynamo-ir",
            "script",
        )
        if script_args.exporter == "all"
        else script_args.exporter.split(",")
    )
    dynamic = (0, 1) if script_args.dynamic == "all" else (int(script_args.dynamic),)
    cases = None if script_args.case == "all" else script_args.case.split(",")
    quiet = bool(int(script_args.quiet))
    verbose = int(script_args.verbose)

    import pandas
    from experimental_experiment.torch_interpreter.eval import evaluation

    obs = evaluation(
        exporters=exporters, dynamic=dynamic, cases=cases, quiet=quiet, verbose=verbose
    )





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

      0%|          | 0/84 [00:00<?, ?it/s]      2%|▏         | 2/84 [00:00<00:08,  9.97it/s]      5%|▍         | 4/84 [00:00<00:05, 13.50it/s]      7%|▋         | 6/84 [00:00<00:05, 13.76it/s]     10%|▉         | 8/84 [00:00<00:04, 15.59it/s]     12%|█▏        | 10/84 [00:00<00:07,  9.52it/s]     14%|█▍        | 12/84 [00:01<00:10,  6.96it/s]     15%|█▌        | 13/84 [00:02<00:19,  3.55it/s]     18%|█▊        | 15/84 [00:02<00:14,  4.90it/s]     19%|█▉        | 16/84 [00:02<00:13,  5.15it/s]     21%|██▏       | 18/84 [00:02<00:10,  6.22it/s]     27%|██▋       | 23/84 [00:02<00:06, 10.00it/s]     30%|██▉       | 25/84 [00:03<00:06,  9.70it/s]     32%|███▏      | 27/84 [00:04<00:13,  4.20it/s]     36%|███▌      | 30/84 [00:04<00:09,  5.48it/s]     38%|███▊      | 32/84 [00:04<00:08,  6.28it/s]     42%|████▏     | 35/84 [00:04<00:05,  8.44it/s]     44%|████▍     | 37/84 [00:05<00:06,  7.73it/s]     46%|████▋     | 39/84 [00:05<00:05,  8.32it/s]     49%|████▉     | 41/84 [00:06<00:11,  3.86it/s]     51%|█████     | 43/84 [00:06<00:08,  4.88it/s]     54%|█████▎    | 45/84 [00:07<00:06,  5.78it/s]     56%|█████▌    | 47/84 [00:07<00:06,  6.02it/s]     58%|█████▊    | 49/84 [00:07<00:04,  7.53it/s]     61%|██████    | 51/84 [00:07<00:04,  7.29it/s]     63%|██████▎   | 53/84 [00:08<00:04,  7.35it/s]     64%|██████▍   | 54/84 [00:08<00:05,  5.40it/s]     65%|██████▌   | 55/84 [00:09<00:09,  3.19it/s]/home/xadupre/vv/this312/lib/python3.12/site-packages/torch/export/_unlift.py:75: UserWarning: Attempted to insert a get_attr Node with no underlying reference in the owning GraphModule! Call GraphModule.add_submodule to add the necessary submodule, GraphModule.add_parameter to add the necessary Parameter, or nn.Module.register_buffer to add the necessary buffer
      getattr_node = gm.graph.get_attr(lifted_node)
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/fx/graph.py:1801: UserWarning: Node bias target bias bias of  does not reference an nn.Module, nn.Parameter, or buffer, which is what 'get_attr' Nodes typically target
      warnings.warn(
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/export/_unlift.py:75: UserWarning: Attempted to insert a get_attr Node with no underlying reference in the owning GraphModule! Call GraphModule.add_submodule to add the necessary submodule, GraphModule.add_parameter to add the necessary Parameter, or nn.Module.register_buffer to add the necessary buffer
      getattr_node = gm.graph.get_attr(lifted_node)
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/fx/graph.py:1801: UserWarning: Node bias target bias bias of  does not reference an nn.Module, nn.Parameter, or buffer, which is what 'get_attr' Nodes typically target
      warnings.warn(
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/export/_unlift.py:75: UserWarning: Attempted to insert a get_attr Node with no underlying reference in the owning GraphModule! Call GraphModule.add_submodule to add the necessary submodule, GraphModule.add_parameter to add the necessary Parameter, or nn.Module.register_buffer to add the necessary buffer
      getattr_node = gm.graph.get_attr(lifted_node)
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/fx/graph.py:1801: UserWarning: Node bias target bias bias of  does not reference an nn.Module, nn.Parameter, or buffer, which is what 'get_attr' Nodes typically target
      warnings.warn(
     69%|██████▉   | 58/84 [00:09<00:05,  4.89it/s]/home/xadupre/vv/this312/lib/python3.12/site-packages/torch/export/_unlift.py:75: UserWarning: Attempted to insert a get_attr Node with no underlying reference in the owning GraphModule! Call GraphModule.add_submodule to add the necessary submodule, GraphModule.add_parameter to add the necessary Parameter, or nn.Module.register_buffer to add the necessary buffer
      getattr_node = gm.graph.get_attr(lifted_node)
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/fx/graph.py:1801: UserWarning: Node bias target bias bias of  does not reference an nn.Module, nn.Parameter, or buffer, which is what 'get_attr' Nodes typically target
      warnings.warn(
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/export/_unlift.py:75: UserWarning: Attempted to insert a get_attr Node with no underlying reference in the owning GraphModule! Call GraphModule.add_submodule to add the necessary submodule, GraphModule.add_parameter to add the necessary Parameter, or nn.Module.register_buffer to add the necessary buffer
      getattr_node = gm.graph.get_attr(lifted_node)
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/fx/graph.py:1801: UserWarning: Node bias target bias bias of  does not reference an nn.Module, nn.Parameter, or buffer, which is what 'get_attr' Nodes typically target
      warnings.warn(
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/export/_unlift.py:75: UserWarning: Attempted to insert a get_attr Node with no underlying reference in the owning GraphModule! Call GraphModule.add_submodule to add the necessary submodule, GraphModule.add_parameter to add the necessary Parameter, or nn.Module.register_buffer to add the necessary buffer
      getattr_node = gm.graph.get_attr(lifted_node)
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/fx/graph.py:1801: UserWarning: Node bias target bias bias of  does not reference an nn.Module, nn.Parameter, or buffer, which is what 'get_attr' Nodes typically target
      warnings.warn(
     71%|███████▏  | 60/84 [00:09<00:03,  6.23it/s]/home/xadupre/vv/this312/lib/python3.12/site-packages/torch/export/_unlift.py:75: UserWarning: Attempted to insert a get_attr Node with no underlying reference in the owning GraphModule! Call GraphModule.add_submodule to add the necessary submodule, GraphModule.add_parameter to add the necessary Parameter, or nn.Module.register_buffer to add the necessary buffer
      getattr_node = gm.graph.get_attr(lifted_node)
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/fx/graph.py:1801: UserWarning: Node lifted_tensor_3 target lifted_tensor_3 lifted_tensor_3 of  does not reference an nn.Module, nn.Parameter, or buffer, which is what 'get_attr' Nodes typically target
      warnings.warn(
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/export/_unlift.py:75: UserWarning: Attempted to insert a get_attr Node with no underlying reference in the owning GraphModule! Call GraphModule.add_submodule to add the necessary submodule, GraphModule.add_parameter to add the necessary Parameter, or nn.Module.register_buffer to add the necessary buffer
      getattr_node = gm.graph.get_attr(lifted_node)
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/fx/graph.py:1801: UserWarning: Node bias target bias bias of  does not reference an nn.Module, nn.Parameter, or buffer, which is what 'get_attr' Nodes typically target
      warnings.warn(
     77%|███████▋  | 65/84 [00:09<00:02,  9.47it/s]/home/xadupre/vv/this312/lib/python3.12/site-packages/torch/export/_unlift.py:75: UserWarning: Attempted to insert a get_attr Node with no underlying reference in the owning GraphModule! Call GraphModule.add_submodule to add the necessary submodule, GraphModule.add_parameter to add the necessary Parameter, or nn.Module.register_buffer to add the necessary buffer
      getattr_node = gm.graph.get_attr(lifted_node)
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/fx/graph.py:1801: UserWarning: Node bias target bias bias of  does not reference an nn.Module, nn.Parameter, or buffer, which is what 'get_attr' Nodes typically target
      warnings.warn(
     80%|███████▉  | 67/84 [00:10<00:01,  9.33it/s]     82%|████████▏ | 69/84 [00:11<00:03,  4.55it/s]/home/xadupre/vv/this312/lib/python3.12/site-packages/torch/export/_unlift.py:75: UserWarning: Attempted to insert a get_attr Node with no underlying reference in the owning GraphModule! Call GraphModule.add_submodule to add the necessary submodule, GraphModule.add_parameter to add the necessary Parameter, or nn.Module.register_buffer to add the necessary buffer
      getattr_node = gm.graph.get_attr(lifted_node)
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/fx/graph.py:1801: UserWarning: Node bias target bias bias of  does not reference an nn.Module, nn.Parameter, or buffer, which is what 'get_attr' Nodes typically target
      warnings.warn(
     85%|████████▍ | 71/84 [00:11<00:02,  5.51it/s]/home/xadupre/vv/this312/lib/python3.12/site-packages/torch/export/_unlift.py:75: UserWarning: Attempted to insert a get_attr Node with no underlying reference in the owning GraphModule! Call GraphModule.add_submodule to add the necessary submodule, GraphModule.add_parameter to add the necessary Parameter, or nn.Module.register_buffer to add the necessary buffer
      getattr_node = gm.graph.get_attr(lifted_node)
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/fx/graph.py:1801: UserWarning: Node bias target bias bias of  does not reference an nn.Module, nn.Parameter, or buffer, which is what 'get_attr' Nodes typically target
      warnings.warn(
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/export/_unlift.py:75: UserWarning: Attempted to insert a get_attr Node with no underlying reference in the owning GraphModule! Call GraphModule.add_submodule to add the necessary submodule, GraphModule.add_parameter to add the necessary Parameter, or nn.Module.register_buffer to add the necessary buffer
      getattr_node = gm.graph.get_attr(lifted_node)
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/fx/graph.py:1801: UserWarning: Node bias target bias bias of  does not reference an nn.Module, nn.Parameter, or buffer, which is what 'get_attr' Nodes typically target
      warnings.warn(
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/export/_unlift.py:75: UserWarning: Attempted to insert a get_attr Node with no underlying reference in the owning GraphModule! Call GraphModule.add_submodule to add the necessary submodule, GraphModule.add_parameter to add the necessary Parameter, or nn.Module.register_buffer to add the necessary buffer
      getattr_node = gm.graph.get_attr(lifted_node)
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/fx/graph.py:1801: UserWarning: Node bias target bias bias of  does not reference an nn.Module, nn.Parameter, or buffer, which is what 'get_attr' Nodes typically target
      warnings.warn(
     87%|████████▋ | 73/84 [00:11<00:01,  6.44it/s]/home/xadupre/vv/this312/lib/python3.12/site-packages/torch/export/_unlift.py:75: UserWarning: Attempted to insert a get_attr Node with no underlying reference in the owning GraphModule! Call GraphModule.add_submodule to add the necessary submodule, GraphModule.add_parameter to add the necessary Parameter, or nn.Module.register_buffer to add the necessary buffer
      getattr_node = gm.graph.get_attr(lifted_node)
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/fx/graph.py:1801: UserWarning: Node bias target bias bias of  does not reference an nn.Module, nn.Parameter, or buffer, which is what 'get_attr' Nodes typically target
      warnings.warn(
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/export/_unlift.py:75: UserWarning: Attempted to insert a get_attr Node with no underlying reference in the owning GraphModule! Call GraphModule.add_submodule to add the necessary submodule, GraphModule.add_parameter to add the necessary Parameter, or nn.Module.register_buffer to add the necessary buffer
      getattr_node = gm.graph.get_attr(lifted_node)
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/fx/graph.py:1801: UserWarning: Node bias target bias bias of  does not reference an nn.Module, nn.Parameter, or buffer, which is what 'get_attr' Nodes typically target
      warnings.warn(
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/export/_unlift.py:75: UserWarning: Attempted to insert a get_attr Node with no underlying reference in the owning GraphModule! Call GraphModule.add_submodule to add the necessary submodule, GraphModule.add_parameter to add the necessary Parameter, or nn.Module.register_buffer to add the necessary buffer
      getattr_node = gm.graph.get_attr(lifted_node)
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/fx/graph.py:1801: UserWarning: Node lifted_tensor_3 target lifted_tensor_3 lifted_tensor_3 of  does not reference an nn.Module, nn.Parameter, or buffer, which is what 'get_attr' Nodes typically target
      warnings.warn(
     89%|████████▉ | 75/84 [00:11<00:01,  7.17it/s]/home/xadupre/vv/this312/lib/python3.12/site-packages/torch/export/_unlift.py:75: UserWarning: Attempted to insert a get_attr Node with no underlying reference in the owning GraphModule! Call GraphModule.add_submodule to add the necessary submodule, GraphModule.add_parameter to add the necessary Parameter, or nn.Module.register_buffer to add the necessary buffer
      getattr_node = gm.graph.get_attr(lifted_node)
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/fx/graph.py:1801: UserWarning: Node bias target bias bias of  does not reference an nn.Module, nn.Parameter, or buffer, which is what 'get_attr' Nodes typically target
      warnings.warn(
     94%|█████████▍| 79/84 [00:12<00:00,  8.83it/s]/home/xadupre/vv/this312/lib/python3.12/site-packages/torch/export/_unlift.py:75: UserWarning: Attempted to insert a get_attr Node with no underlying reference in the owning GraphModule! Call GraphModule.add_submodule to add the necessary submodule, GraphModule.add_parameter to add the necessary Parameter, or nn.Module.register_buffer to add the necessary buffer
      getattr_node = gm.graph.get_attr(lifted_node)
    /home/xadupre/vv/this312/lib/python3.12/site-packages/torch/fx/graph.py:1801: UserWarning: Node bias target bias bias of  does not reference an nn.Module, nn.Parameter, or buffer, which is what 'get_attr' Nodes typically target
      warnings.warn(
     96%|█████████▋| 81/84 [00:12<00:00,  8.78it/s]     99%|█████████▉| 83/84 [00:13<00:00,  4.46it/s]    100%|██████████| 84/84 [00:13<00:00,  6.25it/s]




.. GENERATED FROM PYTHON SOURCE LINES 64-65

The results

.. GENERATED FROM PYTHON SOURCE LINES 65-74

.. code-block:: Python


    df = pandas.DataFrame(obs).sort_values(["dynamic", "name", "exporter"]).reset_index(drop=True)
    df.to_csv("plot-exporter-coverage.csv", index=False)
    df.to_excel("plot-exporter-coverage.xlsx")
    for c in ["error", "error_step"]:
        if c in df.columns:
            df[c] = df[c].fillna("")
    print(df)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

        abs  rel  dnan  success                                          model_cls                                           exported                                               onnx         name  dynamic             exporter                                              error error_step
    0   0.0  0.0   0.0        1  <class 'experimental_experiment.torch_interpre...  <function run_exporter.<locals>.<lambda> at 0x...  ir_version: 8\ndoc_string: "large_model=False,...  AtenRollPos        0      custom-nostrict                                                              
    1   0.0  0.0   0.0        1  <class 'experimental_experiment.torch_interpre...  <function run_exporter.<locals>.<lambda> at 0x...  ir_version: 8\ndoc_string: "large_model=False,...  AtenRollPos        0  custom-nostrict-dec                                                              
    2   0.0  0.0   0.0        1  <class 'experimental_experiment.torch_interpre...  <function run_exporter.<locals>.<lambda> at 0x...  ir_version: 8\ndoc_string: "large_model=False,...  AtenRollPos        0        custom-strict                                                              
    3   0.0  0.0   0.0        1  <class 'experimental_experiment.torch_interpre...  <function run_exporter.<locals>.<lambda> at 0x...  ir_version: 8\ndoc_string: "large_model=False,...  AtenRollPos        0    custom-strict-dec                                                              
    4   0.0  0.0   0.0        1  <class 'experimental_experiment.torch_interpre...  <function run_exporter.<locals>.<lambda> at 0x...  ir_version: 8\ndoc_string: "large_model=False,...  AtenRollPos        0       custom-tracing                                                              
    ..  ...  ...   ...      ...                                                ...                                                ...                                                ...          ...      ...                  ...                                                ...        ...
    79  0.0  0.0   0.0        1  <class 'experimental_experiment.torch_interpre...  GraphModule()\n\n\n\ndef forward(self, x):\n  ...                                               None   InplaceAdd        1  export-nostrict-dec                                                              
    80  0.0  0.0   0.0        1  <class 'experimental_experiment.torch_interpre...  GraphModule()\n\n\n\ndef forward(self, x):\n  ...                                               None   InplaceAdd        1        export-strict                                                              
    81  0.0  0.0   0.0        1  <class 'experimental_experiment.torch_interpre...  GraphModule()\n\n\n\ndef forward(self, x):\n  ...                                               None   InplaceAdd        1    export-strict-dec                                                              
    82  0.0  0.0   0.0        1  <class 'experimental_experiment.torch_interpre...  GraphModule()\n\n\n\ndef forward(self, x):\n  ...                                               None   InplaceAdd        1       export-tracing                                                              
    83  NaN  NaN   NaN        0                                                NaN                                                NaN                                                NaN   InplaceAdd        1               script  number of input names provided (3) exceeded nu...     export

    [84 rows x 12 columns]




.. GENERATED FROM PYTHON SOURCE LINES 75-76

Errors if any or all successes.

.. GENERATED FROM PYTHON SOURCE LINES 76-85

.. code-block:: Python


    piv = df.pivot(
        index=["dynamic", "name"],
        columns=["exporter"],
        values="error_step" if "error_step" in df.columns else "success",
    )

    piv.to_excel("plot-exporter-coverage-summary.xlsx")
    print(piv)




.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    exporter             custom-nostrict custom-nostrict-dec custom-strict custom-strict-dec custom-tracing dynamo dynamo-ir export-jit export-nostrict export-nostrict-dec export-strict export-strict-dec export-tracing  script
    dynamic name                                                                                                                                                                                                                  
    0       AtenRollPos                                                                                                                                                                                                           
            AtenRollRelu                                                                                                                                                                                                          
            InplaceAdd                                                                                                                                                                                                            
    1       AtenRollPos                                                                                                                                                                                                     export
            AtenRollRelu                                                                                                                                                                                                    export
            InplaceAdd                                                                                                                                                                                                      export





.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 17.737 seconds)


.. _sphx_glr_download_auto_recipes_plot_exporter_coverage.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: plot_exporter_coverage.ipynb <plot_exporter_coverage.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: plot_exporter_coverage.py <plot_exporter_coverage.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: plot_exporter_coverage.zip <plot_exporter_coverage.zip>`


.. include:: plot_exporter_coverage.recommendations


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_

<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="301: Compares LLAMA exporters" href="plot_llama_diff_export_301.html" /><link rel="prev" title="201: Evaluate different ways to export a torch model to ONNX" href="plot_torch_export_201.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>201: Use torch to export a scikit-learn model into ONNX - experimental-experiment 0.1.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css?v=7f9a90b1" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">experimental-experiment 0.1.1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/logo.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">experimental-experiment 0.1.1 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../design/index.html">Design</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Design</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../design/exporter.html">Custom Exporter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../design/optimizer.html">Pattern Optimizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../design/backends.html">Dynamo Backends</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorial/index.html">Tutorial</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Tutorial</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/errors.html">Unexpected Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/docker.html">Start from a docker</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorial/exported.html">Supported Model Signatures</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Supported Model Signatures</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/exported_program.html">Exported Programs with Static Shapes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/exported_program_dynamic.html">Exported Programs with Dynamic Shapes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/exported_onnx.html">Exported into ONNX with Static Shapes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/exported_onnx_dynamic.html">Exported into ONNX with Dynamic Shapes</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api/index.html">API</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of API</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/gradient/index.html">.gradient</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of .gradient</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/gradient/ops/index.html">.gradient.ops</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of .gradient.ops</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/gradient/ops/op_broadcast_gradient_args.html">.gradient.ops.op_broadcast_gradient_args</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/gradient/grad_helper.html">.gradient.grad_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/gradient/loss_helper.html">.gradient.loss_helper</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/reference/index.html">.reference</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of .reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/reference/ops/index.html">.reference.ops</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of .reference.ops</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_add_add_mul_mul.html">.reference.ops.op_add_add_mul_mul</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_average_pool_grad.html">.reference.ops.op_average_pool_grad</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_cast_like.html">.reference.ops.op_cast_like</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_complex.html">.reference.ops.op_complex</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_concat.html">.reference.ops.op_concat</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_constant_of_shape.html">.reference.ops.op_constant_of_shape</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_fused_matmul.html">.reference.ops.op_fused_matmul</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_gather_grad.html">.reference.ops.op_gather_grad</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_memcpy_host.html">.reference.ops.op_memcpy_host</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_mul_sigmoid.html">.reference.ops.op_mul_sigmoid</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_negxplus1.html">.reference.ops.op_negxplus1</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_quick_gelu.html">.reference.ops.op_quick_gelu</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_replace_zero.html">.reference.ops.op_replace_zero</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_rotary.html">.reference.ops.op_rotary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_qlinear_average_pool.html">.reference.ops.op_qlinear_average_pool</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_qlinear_conv.html">.reference.ops.op_qlinear_conv</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_scatter_elements.html">.reference.ops.op_scatter_elements</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_scatternd_of_shape.html">.reference.ops.op_scatternd_of_shape</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_simplified_layer_normalization.html">.reference.ops.op_simplified_layer_normalization</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_skip_layer_normalization.html">.reference.ops.op_skip_layer_normalization</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_slice.html">.reference.ops.op_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_transpose_cast.html">.reference.ops.op_transpose_cast</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/reference/ops/op_tri_matrix.html">.reference.ops.op_tri_matrix</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/reference/evaluator.html">.reference.evaluator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/reference/ort_evaluator.html">.reference.ort_evaluator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/reference/quantized_tensor.html">.reference.quantized_tensor</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/convert/index.html">.convert</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of .convert</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/convert/convert_helper.html">.convert.convert_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/convert/ort_helper.html">.convert.ort_helper</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/plotting/index.html">.plotting</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of .plotting</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/plotting/data.html">.plotting.data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/plotting/memory.html">.plotting.memory</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/skl/index.html">.skl</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of .skl</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/skl/convert.html">.skl.convert</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/skl/helpers.html">.skl.helpers</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/torch_interpreter/index.html">.torch_interpreter</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of .torch_interpreter</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/_aten_functions.html">.torch_interpreter._aten_functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/_aten_functions_attention.html">.torch_interpreter._aten_functions_attention</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/_non_aten_functions.html">.torch_interpreter._non_aten_functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/_aten_methods.html">.torch_interpreter._aten_methods</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/_doc_.html">.torch_interpreter._doc_</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/_exceptions.html">.torch_interpreter._exceptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/_prims_functions.html">.torch_interpreter._prims_functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/_torch_helper.html">.torch_interpreter._torch_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/aten_functions.html">.torch_interpreter.aten_functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/aten_methods.html">.torch_interpreter.aten_methods</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/dispatcher.html">.torch_interpreter.dispatcher</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/torch_interpreter/eval/index.html">.torch_interpreter.eval</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle navigation of .torch_interpreter.eval</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/torch_interpreter/eval/model_cases.html">.torch_interpreter.eval.model_cases</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/export_options.html">.torch_interpreter.export_options</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/interpreter.html">.torch_interpreter.interpreter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/investigate_helper.html">.torch_interpreter.investigate_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/onnx_export.html">.torch_interpreter.onnx_export</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/oxs_dispatcher.html">.torch_interpreter.oxs_dispatcher</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/oxs_opset.html">.torch_interpreter.oxs_opset</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/piece_by_piece.html">.torch_interpreter.piece_by_piece</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/piece_by_piece_serialize.html">.torch_interpreter.piece_by_piece_serialize</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_interpreter/tracing.html">.torch_interpreter.tracing</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/torch_models/index.html">.torch_models</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><div class="visually-hidden">Toggle navigation of .torch_models</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_models/diffusion_model_helper.html">.torch_models.diffusion_model_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_models/dump_helper.html">.torch_models.dump_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_models/llama_helper.html">.torch_models.llama_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_models/llm_model_helper.html">.torch_models.llm_model_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_models/llm_model_setup.html">.torch_models.llm_model_setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_models/mistral_helper.html">.torch_models.mistral_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_models/phi3_helper.html">.torch_models.phi3_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_models/phi_helper.html">.torch_models.phi_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_models/training_helper.html">.torch_models.training_helper</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/xbuilder/index.html">.xbuilder</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><div class="visually-hidden">Toggle navigation of .xbuilder</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/xbuilder/_graph_builder_runtime.html">.xbuilder._graph_builder_runtime</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xbuilder/_onnx_helper.html">.xbuilder._onnx_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xbuilder/_shape_helper.html">.xbuilder._shape_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xbuilder/expression_dimension.html">.xbuilder.expression_dimension</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xbuilder/graph_builder.html">.xbuilder.graph_builder</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xbuilder/graph_builder_opset.html">.xbuilder.graph_builder_opset</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xbuilder/model_container.html">.xbuilder.model_container</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xbuilder/optimization_options.html">.xbuilder.optimization_options</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xbuilder/reverse_graph_builder.html">.xbuilder.reverse_graph_builder</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xbuilder/shape_type_compute.html">.xbuilder.shape_type_compute</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xbuilder/type_inference.html">.xbuilder.type_inference</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/xoptim/index.html">.xoptim</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><div class="visually-hidden">Toggle navigation of .xoptim</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/xoptim/patterns_investigation/index.html">.xoptim.patterns_investigation</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" role="switch" type="checkbox"/><label for="toctree-checkbox-17"><div class="visually-hidden">Toggle navigation of .xoptim.patterns_investigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_investigation/element_wise.html">.xoptim.patterns_investigation.element_wise</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_investigation/llm_patterns.html">.xoptim.patterns_investigation.llm_patterns</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/xoptim/patterns_ml/index.html">.xoptim.patterns_ml</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" role="switch" type="checkbox"/><label for="toctree-checkbox-18"><div class="visually-hidden">Toggle navigation of .xoptim.patterns_ml</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_ml/tree_ensemble.html">.xoptim.patterns_ml.tree_ensemble</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/xoptim/patterns_exp/index.html">.xoptim.patterns_exp</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" role="switch" type="checkbox"/><label for="toctree-checkbox-19"><div class="visually-hidden">Toggle navigation of .xoptim.patterns_exp</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_exp/binary_operators.html">.xoptim.patterns_exp.binary_operators</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_exp/constant_of_shape_scatter_nd.html">.xoptim.patterns_exp.constant_of_shape_scatter_nd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_exp/constants.html">.xoptim.patterns_exp.constants</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_exp/simple_rotary.html">.xoptim.patterns_exp.simple_rotary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_exp/unary_operators.html">.xoptim.patterns_exp.unary_operators</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_exp/where_replace.html">.xoptim.patterns_exp.where_replace</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/xoptim/patterns/index.html">.xoptim.patterns</a><input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" role="switch" type="checkbox"/><label for="toctree-checkbox-20"><div class="visually-hidden">Toggle navigation of .xoptim.patterns</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_any.html">.xoptim.patterns.onnx_any</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_cast.html">.xoptim.patterns.onnx_cast</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_clip.html">.xoptim.patterns.onnx_clip</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_constants.html">.xoptim.patterns.onnx_constants</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_conv.html">.xoptim.patterns.onnx_conv</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_dropout.html">.xoptim.patterns.onnx_dropout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_equal.html">.xoptim.patterns.onnx_equal</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_expand.html">.xoptim.patterns.onnx_expand</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_functions.html">.xoptim.patterns.onnx_functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_layer_normalization.html">.xoptim.patterns.onnx_layer_normalization</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_matmul.html">.xoptim.patterns.onnx_matmul</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_mul.html">.xoptim.patterns.onnx_mul</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_reduce.html">.xoptim.patterns.onnx_reduce</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_reshape.html">.xoptim.patterns.onnx_reshape</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_rotary.html">.xoptim.patterns.onnx_rotary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_slice.html">.xoptim.patterns.onnx_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_split.html">.xoptim.patterns.onnx_split</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_sub.html">.xoptim.patterns.onnx_sub</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_sequence.html">.xoptim.patterns.onnx_sequence</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_transpose.html">.xoptim.patterns.onnx_transpose</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns/onnx_unsqueeze.html">.xoptim.patterns.onnx_unsqueeze</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/xoptim/patterns_ort/index.html">.xoptim.patterns_ort</a><input class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" role="switch" type="checkbox"/><label for="toctree-checkbox-21"><div class="visually-hidden">Toggle navigation of .xoptim.patterns_ort</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_ort/activation.html">.xoptim.patterns_ort.activation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_ort/activation_grad.html">.xoptim.patterns_ort.activation_grad</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_ort/attention_patterns.html">.xoptim.patterns_ort.attention_patterns</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_ort/batch_normalization.html">.xoptim.patterns_ort.batch_normalization</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_ort/fused_conv.html">.xoptim.patterns_ort.fused_conv</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_ort/fused_matmul.html">.xoptim.patterns_ort.fused_matmul</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_ort/gather_grad.html">.xoptim.patterns_ort.gather_grad</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_ort/llm_optim.html">.xoptim.patterns_ort.llm_optim</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_ort/simplified_layer_normalization.html">.xoptim.patterns_ort.simplified_layer_normalization</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/xoptim/patterns_fix/index.html">.xoptim.patterns_fix</a><input class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" role="switch" type="checkbox"/><label for="toctree-checkbox-22"><div class="visually-hidden">Toggle navigation of .xoptim.patterns_fix</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/xoptim/patterns_fix/add_reduction_scatter_nd.html">.xoptim.patterns_fix.add_reduction_scatter_nd</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/xoptim/graph_builder_optim.html">.xoptim.graph_builder_optim</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xoptim/order_optim.html">.xoptim.order_optim</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xoptim/patterns_api.html">.xoptim.patterns_api</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/xoptim/unfused.html">.xoptim.unfused</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/torch_dynamo/index.html">.torch_dynamo</a><input class="toctree-checkbox" id="toctree-checkbox-23" name="toctree-checkbox-23" role="switch" type="checkbox"/><label for="toctree-checkbox-23"><div class="visually-hidden">Toggle navigation of .torch_dynamo</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_dynamo/_dynamo_exporter.html">.torch_dynamo._dynamo_exporter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_dynamo/backend_helper.html">.torch_dynamo.backend_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_dynamo/debug_backend.html">.torch_dynamo.debug_backend</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_dynamo/fast_backend.html">.torch_dynamo.fast_backend</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_dynamo/partition.html">experimental_experiment.torch_dynamo.partition</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/torch_bench/index.html">.torch_bench</a><input class="toctree-checkbox" id="toctree-checkbox-24" name="toctree-checkbox-24" role="switch" type="checkbox"/><label for="toctree-checkbox-24"><div class="visually-hidden">Toggle navigation of .torch_bench</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_benchmark_runner.html">experimental_experiment.torch_bench._bash_bench_benchmark_runner</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_benchmark_runner_agg.html">experimental_experiment.torch_bench._bash_bench_benchmark_runner_agg</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_benchmark_runner_agg_helper.html">experimental_experiment.torch_bench._bash_bench_benchmark_runner_agg_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_cmd.html">experimental_experiment.torch_bench._bash_bench_cmd</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_model_runner.html">experimental_experiment.torch_bench._bash_bench_model_runner</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_models_helper.html">experimental_experiment.torch_bench._bash_bench_models_helper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_set_dummies.html">experimental_experiment.torch_bench._bash_bench_set_dummies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_set_explicit.html">experimental_experiment.torch_bench._bash_bench_set_explicit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_set_huggingface.html">experimental_experiment.torch_bench._bash_bench_set_huggingface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_set_huggingface_big.html">experimental_experiment.torch_bench._bash_bench_set_huggingface_big</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_set_issues.html">experimental_experiment.torch_bench._bash_bench_set_issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_set_timm.html">experimental_experiment.torch_bench._bash_bench_set_timm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_set_torchbench.html">experimental_experiment.torch_bench._bash_bench_set_torchbench</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_set_torchbench_ado.html">experimental_experiment.torch_bench._bash_bench_set_torchbench_ado</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_bash_bench_untrained.html">experimental_experiment.torch_bench._bash_bench_untrained</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_dort_cmd_common.html">experimental_experiment.torch_bench._dort_cmd_common</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/_dort_cmd_common_models.html">experimental_experiment.torch_bench._dort_cmd_common_models</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/bash_bench_agg.html">.torch_bench.bash_bench_agg</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/bash_bench_explicit.html">.torch_bench.bash_bench_explicit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/bash_bench_huggingface.html">.torch_bench.bash_bench_huggingface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/bash_bench_huggingface_big.html">.torch_bench.bash_bench_huggingface_big</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/bash_bench_issues.html">.torch_bench.bash_bench_issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/bash_bench_timm.html">.torch_bench.bash_bench_timm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/bash_bench_torchbench.html">.torch_bench.bash_bench_torchbench</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/bash_bench_torchbench_ado.html">.torch_bench.bash_bench_torchbench_ado</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/bash_bench_untrained.html">.torch_bench.bash_bench_untrained</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/check_model.html">.torch_bench.check_model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/dort_bench.html">.torch_bench.dort_bench</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/dort_bench_profile.html">.torch_bench.dort_bench_profile</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/dort_profile.html">.torch_bench.dort_profile</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/export_model.html">.torch_bench.export_model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/torch_bench/export_model_helper.html">.torch_bench.export_model_helper</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/_bench_test.html">._bench_test</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/_command_lines_parser.html">._command_lines_parser</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/args.html">.args</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/bench_run.html">.bench_run</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/checks.html">.checks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/ext_test_case.html">.ext_test_case</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/helpers.html">.helpers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/memory_peak.html">.memory_peak</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/mini_onnx_builder.html">.mini_onnx_builder</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/model_run.html">.model_run</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/onnx_tools.html">.onnx_tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/ort_session.html">.ort_session</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/torch_test_helper.html">.torch_test_helper</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../galleries.html">Galleries of Examples and Recipes</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-25" name="toctree-checkbox-25" role="switch" type="checkbox"/><label for="toctree-checkbox-25"><div class="visually-hidden">Toggle navigation of Galleries of Examples and Recipes</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2 current has-children"><a class="reference internal" href="index.html">Examples Gallery</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-26" name="toctree-checkbox-26" role="switch" type="checkbox"/><label for="toctree-checkbox-26"><div class="visually-hidden">Toggle navigation of Examples Gallery</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="plot_torch_custom_backend_101.html">101: A custom backend for torch</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_torch_linreg_101.html">101: Linear Regression and export to ONNX</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_optimize_101.html">101: Onnx Model Optimization based on Pattern Rewriting</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_rewrite_101.html">101: Onnx Model Rewriting</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_profile_existing_onnx_101.html">101: Profile an existing model with onnxruntime</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_torch_export_101.html">101: Some dummy examples with torch.export.export</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_convolutation_matmul_102.html">102: Convolution and Matrix Multiplication</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_onnxscript_102.html">102: Examples with onnxscript</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_custom_backend_llama_102.html">102: Fuse kernels in a small Llama Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_llama_bench_102.html">102: Measure LLAMA speed</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_torch_export_compile_102.html">102: Tweak onnx export</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_torch_dort_201.html">201: Evaluate DORT</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_torch_aot_201.html">201: Evaluate DORT Training</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_torch_export_201.html">201: Evaluate different ways to export a torch model to ONNX</a></li>
<li class="toctree-l3 current current-page"><a class="current reference internal" href="#">201: Use torch to export a scikit-learn model into ONNX</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_llama_diff_export_301.html">301: Compares LLAMA exporters</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_llama_diff_dort_301.html">301: Compares LLAMA exporters for onnxrt backend</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_model_to_python.html">Playground for big optimization pattern</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../auto_recipes/index.html">Exporter Recipes Gallery</a><input class="toctree-checkbox" id="toctree-checkbox-27" name="toctree-checkbox-27" role="switch" type="checkbox"/><label for="toctree-checkbox-27"><div class="visually-hidden">Toggle navigation of Exporter Recipes Gallery</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_exporter_lost_dynamic_dimension.html">A dynamic dimension lost by torch.export.export</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_exporter_untrained_tinyllm.html">Check the exporter on a dummy from HuggingFace</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_exporter_inputs.html">Do no use Module as inputs!</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_exporter_phi35_piece.html">Export Phi-3.5-mini-instruct piece by piece</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_exporter_draft_mode.html">Export Phi-3.5-mini-instruct with draft_export</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_exporter_reportibility.html">Export Phi-3.5-mini-instruct with report_exportability</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_exporter_with_dynamic_cache.html">Export a model using a custom type as input</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_exporter_scan_pdist.html">Export a model with a loop (scan)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_exporter_infer_ds.html">Infer dynamic shapes before exporting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_oe_lr.html">Linear Regression and export to ONNX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_coverage.html">Measures the exporter success on many test cases</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_exporter_dynamic_shapes_auto.html">Use DYNAMIC or AUTO when dynamic shapes has constraints</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_c_phi2.html">to_onnx and Phi-2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_c_custom_ops_inplace.html">to_onnx and a custom operator inplace</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_c_custom_ops_fct.html">to_onnx and a custom operator registered with a function</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_c_scan_pdist.html">to_onnx and a model with a loop (scan)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_c_cond.html">to_onnx and a model with a test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_c_dynpad.html">to_onnx and padding one dimension to a mulitple of a constant</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_c_modules.html">to_onnx and submodules from LLMs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_c_named_ds_auto.html">to_onnx: Rename Dynamic Shapes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_oe_phi2.html">torch.onnx.export and Phi-2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_oe_custom_ops_inplace.html">torch.onnx.export and a custom operator inplace</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_oe_custom_ops_fct.html">torch.onnx.export and a custom operator registered with a function</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_oe_cond.html">torch.onnx.export and a model with a test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_oe_dynpad.html">torch.onnx.export and padding one dimension to a mulitple of a constant</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_recipes/plot_exporter_recipes_oe_named_ds_auto.html">torch.onnx.export: Rename Dynamic Shapes</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../command_lines.html">Command Lines</a><input class="toctree-checkbox" id="toctree-checkbox-28" name="toctree-checkbox-28" role="switch" type="checkbox"/><label for="toctree-checkbox-28"><div class="visually-hidden">Toggle navigation of Command Lines</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../bench/index.html">Benchmarks from the command line</a><input class="toctree-checkbox" id="toctree-checkbox-29" name="toctree-checkbox-29" role="switch" type="checkbox"/><label for="toctree-checkbox-29"><div class="visually-hidden">Toggle navigation of Benchmarks from the command line</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../bench/dort_bench.html">experimental_experiment.torch_bench.dort_bench</a></li>
<li class="toctree-l3"><a class="reference internal" href="../bench/dort_profile.html">experimental_experiment.torch_bench.dort_profile</a></li>
<li class="toctree-l3"><a class="reference internal" href="../bench/scripts.html">Interesting scripts or command lines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../bench/bash_bench.html">Measuring the exporters on a short list of sets of models</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../tools/index.html">Tools from the command line</a><input class="toctree-checkbox" id="toctree-checkbox-30" name="toctree-checkbox-30" role="switch" type="checkbox"/><label for="toctree-checkbox-30"><div class="visually-hidden">Toggle navigation of Tools from the command line</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../tools/lighten.html">python -m experimental_experiment lighten and unlighten</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tools/optimize.html">python -m experimental_experiment optimize</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tools/print.html">python -m experimental_experiment print</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tools/run.html">python -m experimental_experiment run</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../miscellaneous/index.html">Miscellaneous</a><input class="toctree-checkbox" id="toctree-checkbox-31" name="toctree-checkbox-31" role="switch" type="checkbox"/><label for="toctree-checkbox-31"><div class="visually-hidden">Toggle navigation of Miscellaneous</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../miscellaneous/export_times.html">Export Times</a></li>
<li class="toctree-l2"><a class="reference internal" href="../miscellaneous/long_outputs.html">Long Outputs uneasy to read</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../miscellaneous/models/index.html">Supported Models By the Custom Backend</a><input class="toctree-checkbox" id="toctree-checkbox-32" name="toctree-checkbox-32" role="switch" type="checkbox"/><label for="toctree-checkbox-32"><div class="visually-hidden">Toggle navigation of Supported Models By the Custom Backend</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../miscellaneous/models/phi.html">Phi</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">More</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../license.html">License</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/auto_examples/plot_torch_sklearn_201.rst" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-auto-examples-plot-torch-sklearn-201-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="use-torch-to-export-a-scikit-learn-model-into-onnx">
<span id="l-plot-torch-sklearn-201"></span><span id="sphx-glr-auto-examples-plot-torch-sklearn-201-py"></span><h1>201: Use torch to export a scikit-learn model into ONNX<a class="headerlink" href="#use-torch-to-export-a-scikit-learn-model-into-onnx" title="Link to this heading">¶</a></h1>
<p>When <a class="reference external" href="https://onnx.ai/sklearn-onnx/">sklearn-onnx</a> is missing a converter, <a class="reference external" href="https://pytorch.org/docs/stable/torch.html">torch</a> can be used
to write it. We use <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="(in scikit-learn v1.6)"><code class="xref py py-class docutils literal notranslate"><span class="pre">sklearn.impute.KNNImputer</span></code></a> as an example.
The first step is to rewrite the scikit-learn model with torch functions.
The code is then refactored and split into submodules to be able
to bypass some pieces <a class="reference external" href="https://docs.pytorch.org/docs/main/export.html#torch.export.export" title="(in PyTorch vmain (2.8.0a0+git32b1baa ))"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.export.export()</span></code></a> cannot process.</p>
<section id="torch-implementation-of-nan-euclidean-distances">
<h2>torch implementation of nan_euclidean_distances<a class="headerlink" href="#torch-implementation-of-nan-euclidean-distances" title="Link to this heading">¶</a></h2>
<p>Let’s start with a simple case, a pairwise distance.
See <code class="xref py py-func docutils literal notranslate"><span class="pre">sklearn.metrics.nan_euclidean_distances()</span></code>.</p>
<section id="module">
<h3>Module<a class="headerlink" href="#module" title="Link to this heading">¶</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">onnx</span>
<span class="kn">import</span> <span class="nn">sklearn</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">onnxruntime</span>
<span class="kn">from</span> <span class="nn">onnx_diagnostic.helpers</span> <span class="kn">import</span> <a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><span class="n">max_diff</span></a></a></a>
<span class="kn">from</span> <span class="nn">onnx_diagnostic.helpers.onnx_helper</span> <span class="kn">import</span> <a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/onnx_helper.html#onnx_diagnostic.helpers.onnx_helper.pretty_onnx" title="onnx_diagnostic.helpers.onnx_helper.pretty_onnx" class="sphx-glr-backref-module-onnx_diagnostic-helpers-onnx_helper sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/onnx_helper.html#onnx_diagnostic.helpers.onnx_helper.pretty_onnx" title="onnx_diagnostic.helpers.onnx_helper.pretty_onnx" class="sphx-glr-backref-module-onnx_diagnostic-helpers-onnx_helper sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/onnx_helper.html#onnx_diagnostic.helpers.onnx_helper.pretty_onnx" title="onnx_diagnostic.helpers.onnx_helper.pretty_onnx" class="sphx-glr-backref-module-onnx_diagnostic-helpers-onnx_helper sphx-glr-backref-type-py-function"><span class="n">pretty_onnx</span></a></a></a>
<span class="kn">from</span> <span class="nn">experimental_experiment.reference</span> <span class="kn">import</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/reference/index.html#experimental_experiment.reference.ExtendedReferenceEvaluator" title="experimental_experiment.reference.ExtendedReferenceEvaluator" class="sphx-glr-backref-module-experimental_experiment-reference sphx-glr-backref-type-py-class"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/reference/index.html#experimental_experiment.reference.ExtendedReferenceEvaluator" title="experimental_experiment.reference.ExtendedReferenceEvaluator" class="sphx-glr-backref-module-experimental_experiment-reference sphx-glr-backref-type-py-class"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/reference/index.html#experimental_experiment.reference.ExtendedReferenceEvaluator" title="experimental_experiment.reference.ExtendedReferenceEvaluator" class="sphx-glr-backref-module-experimental_experiment-reference sphx-glr-backref-type-py-class"><span class="n">ExtendedReferenceEvaluator</span></a></a></a>
<span class="kn">from</span> <span class="nn">experimental_experiment.skl.helpers</span> <span class="kn">import</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/skl/helpers.html#experimental_experiment.skl.helpers.flatnonzero" title="experimental_experiment.skl.helpers.flatnonzero" class="sphx-glr-backref-module-experimental_experiment-skl-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/skl/helpers.html#experimental_experiment.skl.helpers.flatnonzero" title="experimental_experiment.skl.helpers.flatnonzero" class="sphx-glr-backref-module-experimental_experiment-skl-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/skl/helpers.html#experimental_experiment.skl.helpers.flatnonzero" title="experimental_experiment.skl.helpers.flatnonzero" class="sphx-glr-backref-module-experimental_experiment-skl-helpers sphx-glr-backref-type-py-function"><span class="n">flatnonzero</span></a></a></a><span class="p">,</span> <span class="n">_get_weights</span>
<span class="kn">from</span> <span class="nn">experimental_experiment.torch_interpreter</span> <span class="kn">import</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.make_undefined_dimension" title="experimental_experiment.torch_interpreter.make_undefined_dimension" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.make_undefined_dimension" title="experimental_experiment.torch_interpreter.make_undefined_dimension" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.make_undefined_dimension" title="experimental_experiment.torch_interpreter.make_undefined_dimension" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-function"><span class="n">make_undefined_dimension</span></a></a></a>
<span class="kn">from</span> <span class="nn">onnx_diagnostic.torch_export_patches</span> <span class="kn">import</span> <a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/torch_export_patches/index.html#onnx_diagnostic.torch_export_patches.torch_export_patches" title="onnx_diagnostic.torch_export_patches.torch_export_patches" class="sphx-glr-backref-module-onnx_diagnostic-torch_export_patches sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/torch_export_patches/index.html#onnx_diagnostic.torch_export_patches.torch_export_patches" title="onnx_diagnostic.torch_export_patches.torch_export_patches" class="sphx-glr-backref-module-onnx_diagnostic-torch_export_patches sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/torch_export_patches/index.html#onnx_diagnostic.torch_export_patches.torch_export_patches" title="onnx_diagnostic.torch_export_patches.torch_export_patches" class="sphx-glr-backref-module-onnx_diagnostic-torch_export_patches sphx-glr-backref-type-py-function"><span class="n">torch_export_patches</span></a></a></a>
<span class="kn">from</span> <span class="nn">experimental_experiment.torch_interpreter.piece_by_piece</span> <span class="kn">import</span> <span class="p">(</span>
    <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" title="experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" title="experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" title="experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-function"><span class="n">trace_execution_piece_by_piece</span></a></a></a><span class="p">,</span>
    <span class="n">CustomOpStrategy</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">experimental_experiment.xbuilder.reverse_graph_builder</span> <span class="kn">import</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/xbuilder/reverse_graph_builder.html#experimental_experiment.xbuilder.reverse_graph_builder.to_graph_builder_code" title="experimental_experiment.xbuilder.reverse_graph_builder.to_graph_builder_code" class="sphx-glr-backref-module-experimental_experiment-xbuilder-reverse_graph_builder sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/xbuilder/reverse_graph_builder.html#experimental_experiment.xbuilder.reverse_graph_builder.to_graph_builder_code" title="experimental_experiment.xbuilder.reverse_graph_builder.to_graph_builder_code" class="sphx-glr-backref-module-experimental_experiment-xbuilder-reverse_graph_builder sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/xbuilder/reverse_graph_builder.html#experimental_experiment.xbuilder.reverse_graph_builder.to_graph_builder_code" title="experimental_experiment.xbuilder.reverse_graph_builder.to_graph_builder_code" class="sphx-glr-backref-module-experimental_experiment-xbuilder-reverse_graph_builder sphx-glr-backref-type-py-function"><span class="n">to_graph_builder_code</span></a></a></a>


<span class="k">class</span> <span class="nc">NanEuclidean</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span></a></a></a><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Implements :func:`sklearn.metrics.nan_euclidean_distances`.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">squared</span> <span class="o">=</span> <span class="n">squared</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copy</span> <span class="o">=</span> <span class="n">copy</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a><span class="p">):</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">dtype</span></a></a></a><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

        <span class="n">missing_X</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span></a></a></a><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">)</span>
        <span class="n">missing_Y</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span></a></a></a><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a><span class="p">)</span>

        <span class="c1"># set missing values to zero</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">[</span><span class="n">missing_X</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a><span class="p">[</span><span class="n">missing_Y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Adjust distances for missing values</span>
        <span class="n">XX</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a> <span class="o">*</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a>
        <span class="n">YY</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a> <span class="o">*</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a>

        <span class="n">distances</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a> <span class="o">@</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span><span class="o">.</span><span class="n">T</span></a></a></a> <span class="o">+</span> <span class="n">XX</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="n">YY</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="n">distances</span> <span class="o">-=</span> <span class="n">XX</span> <span class="o">@</span> <span class="n">missing_Y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">dtype</span></a></a></a><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">distances</span> <span class="o">-=</span> <span class="n">missing_X</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">dtype</span></a></a></a><span class="p">)</span> <span class="o">@</span> <span class="n">YY</span><span class="o">.</span><span class="n">T</span>

        <span class="n">distances</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.clip.html#torch.clip" title="torch.clip" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.clip.html#torch.clip" title="torch.clip" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.clip.html#torch.clip" title="torch.clip" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">clip</span></a></a></a><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">present_X</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">missing_X</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">dtype</span></a></a></a><span class="p">)</span>
        <span class="n">present_Y</span> <span class="o">=</span> <span class="o">~</span><span class="n">missing_Y</span>
        <span class="n">present_count</span> <span class="o">=</span> <span class="n">present_X</span> <span class="o">@</span> <span class="n">present_Y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">dtype</span></a></a></a><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">distances</span><span class="p">[</span><span class="n">present_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">torch</span><span class="o">.</span><span class="n">nan</span></a></a></a>
        <span class="c1"># avoid divide by zero</span>
        <span class="n">present_count</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.maximum.html#torch.maximum" title="torch.maximum" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.maximum.html#torch.maximum" title="torch.maximum" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.maximum.html#torch.maximum" title="torch.maximum" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">maximum</span></a></a></a><span class="p">(</span>
            <a href="https://docs.pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span></a></a></a><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">present_count</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">present_count</span>
        <span class="p">)</span>
        <span class="n">distances</span> <span class="o">/=</span> <span class="n">present_count</span>
        <span class="n">distances</span> <span class="o">*=</span> <a href="https://docs.pytorch.org/docs/main/size.html#torch.Size" title="torch.Size" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/size.html#torch.Size" title="torch.Size" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/size.html#torch.Size" title="torch.Size" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">shape</span></a></a></a><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">squared</span><span class="p">:</span>
            <span class="n">distances</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">distances</span>
</pre></div>
</div>
</section>
<section id="validation">
<h3>Validation<a class="headerlink" href="#validation" title="Link to this heading">¶</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_xy</span><span class="p">(</span><span class="n">sizex</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sizey</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_nans</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.randn.html#torch.randn" title="torch.randn" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.randn.html#torch.randn" title="torch.randn" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.randn.html#torch.randn" title="torch.randn" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">randn</span></a></a></a><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span>
    <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.randn.html#torch.randn" title="torch.randn" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.randn.html#torch.randn" title="torch.randn" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.randn.html#torch.randn" title="torch.randn" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">randn</span></a></a></a><span class="p">((</span><span class="n">sizey</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span>
    <span class="n">i_nans</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sizex</span><span class="p">):</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <a href="https://docs.pytorch.org/docs/main/size.html#torch.Size" title="torch.Size" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/size.html#torch.Size" title="torch.Size" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/size.html#torch.Size" title="torch.Size" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">shape</span></a></a></a><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">torch</span><span class="o">.</span><span class="n">nan</span></a></a></a>
        <span class="n">i_nans</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">n_nans</span> <span class="ow">and</span> <span class="n">n_nans</span> <span class="o">&gt;=</span> <span class="n">i_nans</span><span class="p">:</span>
            <span class="k">break</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <a href="https://docs.pytorch.org/docs/main/size.html#torch.Size" title="torch.Size" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/size.html#torch.Size" title="torch.Size" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/size.html#torch.Size" title="torch.Size" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">shape</span></a></a></a><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">torch</span><span class="o">.</span><span class="n">nan</span></a></a></a>
        <span class="n">i_nans</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">n_nans</span> <span class="ow">and</span> <span class="n">n_nans</span> <span class="o">&gt;=</span> <span class="n">i_nans</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">i_nans</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sizey</span><span class="p">):</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">sizey</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <a href="https://docs.pytorch.org/docs/main/size.html#torch.Size" title="torch.Size" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/size.html#torch.Size" title="torch.Size" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/size.html#torch.Size" title="torch.Size" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span><span class="o">.</span><span class="n">shape</span></a></a></a><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">torch</span><span class="o">.</span><span class="n">nan</span></a></a></a>
        <span class="n">i_nans</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">n_nans</span> <span class="ow">and</span> <span class="n">n_nans</span> <span class="o">&gt;=</span> <span class="n">i_nans</span><span class="p">:</span>
            <span class="k">break</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">sizey</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <a href="https://docs.pytorch.org/docs/main/size.html#torch.Size" title="torch.Size" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/size.html#torch.Size" title="torch.Size" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/size.html#torch.Size" title="torch.Size" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span><span class="o">.</span><span class="n">shape</span></a></a></a><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">torch</span><span class="o">.</span><span class="n">nan</span></a></a></a>
        <span class="n">i_nans</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">n_nans</span> <span class="ow">and</span> <span class="n">n_nans</span> <span class="o">&gt;=</span> <span class="n">i_nans</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a>


<a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a> <span class="o">=</span> <span class="n">get_xy</span><span class="p">()</span>
<span class="n">model</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">NanEuclidean</span></a></a></a><span class="p">()</span>


<a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">d1</span></a></a></a> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">nan_euclidean_distances</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">d2</span></a></a></a> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;discrepancies: </span><span class="si">{</span><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><span class="n">max_diff</span></a></a></a><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">d1</span></a></a></a><span class="p">,</span><span class="w"> </span><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">d2</span></a></a></a><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>discrepancies: {&#39;abs&#39;: 0.0, &#39;rel&#39;: 0.0, &#39;sum&#39;: 0.0, &#39;n&#39;: 15.0, &#39;dnan&#39;: 0.0, &#39;argm&#39;: (0, 0)}
</pre></div>
</div>
</section>
</section>
<section id="torch-implementation-of-knnimputer">
<h2>torch implementation of KNNImputer<a class="headerlink" href="#torch-implementation-of-knnimputer" title="Link to this heading">¶</a></h2>
<p>See <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="(in scikit-learn v1.6)"><code class="xref py py-class docutils literal notranslate"><span class="pre">sklearn.impute.KNNImputer</span></code></a>.
The code is split into several <a class="reference external" href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="(in PyTorch vmain (2.8.0a0+git32b1baa ))"><code class="xref py py-class docutils literal notranslate"><span class="pre">torch.nn.Module</span></code></a>
and refactored to avoid control flow.</p>
<section id="module-and-sub-modules">
<h3>Module and sub modules<a class="headerlink" href="#module-and-sub-modules" title="Link to this heading">¶</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_get_mask</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">,</span> <span class="n">value_to_mask</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <a href="https://docs.pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span></a></a></a><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>  <span class="c1"># sklearn.utils._missing.is_scalar_nan(value_to_mask)</span>
            <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value_to_mask</span><span class="p">,</span> <a href="https://docs.python.org/3/library/numbers.html#numbers.Integral" title="numbers.Integral" class="sphx-glr-backref-module-numbers sphx-glr-backref-type-py-class"><a href="https://docs.python.org/3/library/numbers.html#numbers.Integral" title="numbers.Integral" class="sphx-glr-backref-module-numbers sphx-glr-backref-type-py-class"><a href="https://docs.python.org/3/library/numbers.html#numbers.Integral" title="numbers.Integral" class="sphx-glr-backref-module-numbers sphx-glr-backref-type-py-class"><span class="n">numbers</span><span class="o">.</span><span class="n">Integral</span></a></a></a><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value_to_mask</span><span class="p">,</span> <a href="https://docs.python.org/3/library/numbers.html#numbers.Real" title="numbers.Real" class="sphx-glr-backref-module-numbers sphx-glr-backref-type-py-class"><a href="https://docs.python.org/3/library/numbers.html#numbers.Real" title="numbers.Real" class="sphx-glr-backref-module-numbers sphx-glr-backref-type-py-class"><a href="https://docs.python.org/3/library/numbers.html#numbers.Real" title="numbers.Real" class="sphx-glr-backref-module-numbers sphx-glr-backref-type-py-class"><span class="n">numbers</span><span class="o">.</span><span class="n">Real</span></a></a></a><span class="p">)</span>
            <span class="ow">and</span> <a href="https://docs.python.org/3/library/math.html#math.isnan" title="math.isnan" class="sphx-glr-backref-module-math sphx-glr-backref-type-py-function"><a href="https://docs.python.org/3/library/math.html#math.isnan" title="math.isnan" class="sphx-glr-backref-module-math sphx-glr-backref-type-py-function"><a href="https://docs.python.org/3/library/math.html#math.isnan" title="math.isnan" class="sphx-glr-backref-module-math sphx-glr-backref-type-py-function"><span class="n">math</span><span class="o">.</span><span class="n">isnan</span></a></a></a><span class="p">(</span><span class="n">value_to_mask</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">else</span> <span class="p">(</span><span class="n">value_to_mask</span> <span class="o">==</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">)</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">SubWeightMatrix</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span></a></a></a><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">donors_dist</span><span class="p">):</span>
        <span class="n">weight_matrix</span> <span class="o">=</span> <span class="n">_get_weights</span><span class="p">(</span><span class="n">donors_dist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">weight_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weight_matrix</span> <span class="o">=</span> <span class="n">weight_matrix</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="n">weight_matrix</span><span class="p">[</span><a href="https://docs.pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span></a></a></a><span class="p">(</span><span class="n">weight_matrix</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weight_matrix</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.ones_like.html#torch.ones_like" title="torch.ones_like" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.ones_like.html#torch.ones_like" title="torch.ones_like" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.ones_like.html#torch.ones_like" title="torch.ones_like" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span></a></a></a><span class="p">(</span><span class="n">donors_dist</span><span class="p">)</span>
            <span class="n">weight_matrix</span><span class="p">[</span><a href="https://docs.pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span></a></a></a><span class="p">(</span><span class="n">donors_dist</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="n">weight_matrix</span>


<span class="k">class</span> <span class="nc">SubDonorsIdx</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span></a></a></a><span class="p">):</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist_pot_donors</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">):</span>
        <span class="n">xn</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.nan_to_num.html#torch.nan_to_num" title="torch.nan_to_num" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.nan_to_num.html#torch.nan_to_num" title="torch.nan_to_num" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.nan_to_num.html#torch.nan_to_num" title="torch.nan_to_num" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">nan_to_num</span></a></a></a><span class="p">(</span><span class="n">dist_pot_donors</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">1.0e10</span><span class="p">)</span>
        <span class="n">tk</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.topk.html#torch.topk" title="torch.topk" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.topk.html#torch.topk" title="torch.topk" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.topk.html#torch.topk" title="torch.topk" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">topk</span></a></a></a><span class="p">(</span><span class="n">xn</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">largest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tk</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span> <span class="n">tk</span><span class="o">.</span><span class="n">values</span>


<span class="k">class</span> <span class="nc">MakeNewWeights</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span></a></a></a><span class="p">):</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">donors_mask</span><span class="p">,</span> <span class="n">donors</span><span class="p">,</span> <span class="n">weight_matrix</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">donors_mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">donors</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight_matrix</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">donors</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CalcImpute</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span></a></a></a><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Implements :meth:`sklearn.impute.KNNImputer._calc_impute`.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">SubWeightMatrix</span></a></a></a><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_donors_idx</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">SubDonorsIdx</span></a></a></a><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_new_neights</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">MakeNewWeights</span></a></a></a><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_calc_impute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist_pot_donors</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">,</span> <span class="n">fit_X_col</span><span class="p">,</span> <span class="n">mask_fit_X_col</span><span class="p">):</span>
        <span class="n">donors_idx</span><span class="p">,</span> <span class="n">donors_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_donors_idx</span><span class="p">(</span><span class="n">dist_pot_donors</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">)</span>
        <span class="n">weight_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span><span class="p">(</span><span class="n">donors_dist</span><span class="p">)</span>
        <span class="c1"># Retrieve donor values and calculate kNN average</span>
        <span class="n">donors</span> <span class="o">=</span> <span class="n">fit_X_col</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">donors_idx</span><span class="p">)</span>
        <span class="n">donors_mask</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span></a></a></a><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">donors_idx</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span>
            <span class="n">mask_fit_X_col</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">donors_idx</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">donors_idx</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="n">new_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_new_neights</span><span class="p">(</span><span class="n">donors_mask</span><span class="p">,</span> <span class="n">donors</span><span class="p">,</span> <span class="n">weight_matrix</span><span class="p">)</span>

        <span class="n">weights_sum</span> <span class="o">=</span> <span class="n">new_weights</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">div</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.where.html#torch.where" title="torch.where" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.where.html#torch.where" title="torch.where" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.where.html#torch.where" title="torch.where" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">where</span></a></a></a><span class="p">(</span>
            <span class="n">weights_sum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span></a></a></a><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">weights_sum</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">weights_sum</span>
        <span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">donors</span> <span class="o">*</span> <span class="n">new_weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">/</span> <span class="n">div</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dist_pot_donors</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist_pot_donors</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">,</span> <span class="n">fit_X_col</span><span class="p">,</span> <span class="n">mask_fit_X_col</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_impute</span><span class="p">(</span><span class="n">dist_pot_donors</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">,</span> <span class="n">fit_X_col</span><span class="p">,</span> <span class="n">mask_fit_X_col</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ColProcessorAllNan</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span></a></a></a><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">col</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">,</span>
        <span class="n">dist_subset</span><span class="p">,</span>
        <span class="n">mask_fit_X</span><span class="p">,</span>
        <span class="n">_fit_X</span><span class="p">,</span>
        <span class="n">receivers_idx</span><span class="p">,</span>
        <span class="n">all_nan_receivers_idx</span><span class="p">,</span>
        <span class="n">all_nan_dist_mask</span><span class="p">,</span>
        <span class="n">dist_chunk</span><span class="p">,</span>
        <span class="n">dist_idx_map</span><span class="p">,</span>
        <span class="n">potential_donors_idx</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">mask_</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">mask_fit_X</span><span class="p">[:,</span> <span class="n">col</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">_fit_X</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">mask_sum</span> <span class="o">=</span> <span class="n">mask_</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">dtype</span></a></a></a><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">col_sum</span> <span class="o">=</span> <span class="p">(</span><span class="n">_fit_X</span><span class="p">[</span><span class="n">mask_</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">dtype</span></a></a></a><span class="p">)</span>
        <span class="n">div</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.where.html#torch.where" title="torch.where" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.where.html#torch.where" title="torch.where" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.where.html#torch.where" title="torch.where" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">where</span></a></a></a><span class="p">(</span><span class="n">mask_sum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mask_sum</span><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span></a></a></a><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">mask_sum</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">[</span><span class="n">all_nan_receivers_idx</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_sum</span> <span class="o">/</span> <span class="n">div</span>

        <span class="c1"># receivers with at least one defined distance</span>
        <span class="n">receivers_idx</span> <span class="o">=</span> <span class="n">receivers_idx</span><span class="p">[</span><span class="o">~</span><span class="n">all_nan_dist_mask</span><span class="p">]</span>
        <span class="n">dist_subset</span> <span class="o">=</span> <span class="n">dist_chunk</span><span class="p">[</span><span class="n">dist_idx_map</span><span class="p">[</span><span class="n">receivers_idx</span><span class="p">]][:,</span> <span class="n">potential_donors_idx</span><span class="p">]</span>
        <span class="k">return</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">,</span> <span class="n">dist_subset</span><span class="p">,</span> <span class="n">receivers_idx</span>


<span class="k">class</span> <span class="nc">ColProcessorIdentity</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span></a></a></a><span class="p">):</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">,</span>
        <span class="n">dist_subset</span><span class="p">,</span>
        <span class="n">mask_fit_X</span><span class="p">,</span>
        <span class="n">_fit_X</span><span class="p">,</span>
        <span class="n">receivers_idx</span><span class="p">,</span>
        <span class="n">all_nan_receivers_idx</span><span class="p">,</span>
        <span class="n">all_nan_dist_mask</span><span class="p">,</span>
        <span class="n">dist_chunk</span><span class="p">,</span>
        <span class="n">dist_idx_map</span><span class="p">,</span>
        <span class="n">potential_donors_idx</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># .clone() not efficient but torch.cond does not like simple return</span>
        <span class="k">return</span> <span class="p">(</span>
            <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="o">.</span><span class="n">contiguous</span><span class="p">(),</span>
            <span class="n">dist_subset</span><span class="o">.</span><span class="n">contiguous</span><span class="p">(),</span>
            <span class="n">receivers_idx</span><span class="o">.</span><span class="n">contiguous</span><span class="p">(),</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">ColProcessorCond</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span></a></a></a><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_nan</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">ColProcessorAllNan</span></a></a></a><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_identity</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">ColProcessorIdentity</span></a></a></a><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">,</span>
        <span class="n">dist_subset</span><span class="p">,</span>
        <span class="n">mask_fit_X</span><span class="p">,</span>
        <span class="n">_fit_X</span><span class="p">,</span>
        <span class="n">receivers_idx</span><span class="p">,</span>
        <span class="n">all_nan_receivers_idx</span><span class="p">,</span>
        <span class="n">all_nan_dist_mask</span><span class="p">,</span>
        <span class="n">dist_chunk</span><span class="p">,</span>
        <span class="n">dist_idx_map</span><span class="p">,</span>
        <span class="n">potential_donors_idx</span><span class="p">,</span>
    <span class="p">):</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">,</span> <span class="n">dist_subset</span><span class="p">,</span> <span class="n">receivers_idx</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.cond.html#torch.cond" title="torch.cond" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.cond.html#torch.cond" title="torch.cond" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.cond.html#torch.cond" title="torch.cond" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">cond</span></a></a></a><span class="p">(</span>
            <span class="n">all_nan_receivers_idx</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_all_nan</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_identity</span><span class="p">,</span>
            <span class="p">[</span>
                <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">,</span>
                <span class="n">dist_subset</span><span class="p">,</span>
                <span class="n">mask_fit_X</span><span class="p">,</span>
                <span class="n">_fit_X</span><span class="p">,</span>
                <span class="n">receivers_idx</span><span class="p">,</span>
                <span class="n">all_nan_receivers_idx</span><span class="p">,</span>
                <span class="n">all_nan_dist_mask</span><span class="p">,</span>
                <span class="n">dist_chunk</span><span class="p">,</span>
                <span class="n">dist_idx_map</span><span class="p">,</span>
                <span class="n">potential_donors_idx</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>
        <span class="k">return</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="o">.</span><span class="n">contiguous</span><span class="p">(),</span> <span class="n">dist_subset</span><span class="o">.</span><span class="n">contiguous</span><span class="p">(),</span> <span class="n">receivers_idx</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">ColProcessor</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span></a></a></a><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Processes one column (= one feature).&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_impute</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">CalcImpute</span></a></a></a><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_col_cond</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">ColProcessorCond</span></a></a></a><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_neighbors</span> <span class="o">=</span> <span class="n">n_neighbors</span>

    <span class="k">def</span> <span class="nf">process_one_col</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">,</span>
        <span class="n">dist_chunk</span><span class="p">,</span>
        <span class="n">non_missing_fix_X</span><span class="p">,</span>
        <span class="n">mask_fit_X</span><span class="p">,</span>
        <span class="n">dist_idx_map</span><span class="p">,</span>
        <span class="n">mask</span><span class="p">,</span>
        <span class="n">row_missing_idx</span><span class="p">,</span>
        <span class="n">_fit_X</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">row_missing_chunk</span> <span class="o">=</span> <span class="n">row_missing_idx</span>
        <span class="n">col_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">row_missing_chunk</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>

        <span class="n">potential_donors_idx</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.nonzero.html#torch.nonzero" title="torch.nonzero" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.nonzero.html#torch.nonzero" title="torch.nonzero" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.nonzero.html#torch.nonzero" title="torch.nonzero" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">nonzero</span></a></a></a><span class="p">(</span><span class="n">non_missing_fix_X</span><span class="p">[:,</span> <span class="n">col</span><span class="p">],</span> <span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># receivers_idx are indices in X</span>
        <span class="n">receivers_idx</span> <span class="o">=</span> <span class="n">row_missing_chunk</span><span class="p">[</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/skl/helpers.html#experimental_experiment.skl.helpers.flatnonzero" title="experimental_experiment.skl.helpers.flatnonzero" class="sphx-glr-backref-module-experimental_experiment-skl-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/skl/helpers.html#experimental_experiment.skl.helpers.flatnonzero" title="experimental_experiment.skl.helpers.flatnonzero" class="sphx-glr-backref-module-experimental_experiment-skl-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/skl/helpers.html#experimental_experiment.skl.helpers.flatnonzero" title="experimental_experiment.skl.helpers.flatnonzero" class="sphx-glr-backref-module-experimental_experiment-skl-helpers sphx-glr-backref-type-py-function"><span class="n">flatnonzero</span></a></a></a><span class="p">(</span><span class="n">col_mask</span><span class="p">)]</span>

        <span class="c1"># distances for samples that needed imputation for column</span>
        <span class="n">dist_subset</span> <span class="o">=</span> <span class="n">dist_chunk</span><span class="p">[</span><span class="n">dist_idx_map</span><span class="p">[</span><span class="n">receivers_idx</span><span class="p">]][:,</span> <span class="n">potential_donors_idx</span><span class="p">]</span>

        <span class="c1"># receivers with all nan distances impute with mean</span>
        <span class="n">all_nan_dist_mask</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.isnan.html#torch.isnan" title="torch.isnan" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span></a></a></a><span class="p">(</span><span class="n">dist_subset</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">all_nan_receivers_idx</span> <span class="o">=</span> <span class="n">receivers_idx</span><span class="p">[</span><span class="n">all_nan_dist_mask</span><span class="p">]</span>

        <span class="c1"># when all_nan_receivers_idx is not empty (training set is small)</span>
        <span class="c1"># ... if all_nan_receivers_idx.size &gt; 0:</span>
        <span class="c1">#    # onnxruntime does not like this part when it is empty</span>
        <span class="c1">#    mask_ = (~mask_fit_X[:, col]).to(_fit_X.dtype)</span>
        <span class="c1">#    mask_sum = mask_.to(X.dtype).sum()</span>
        <span class="c1">#</span>
        <span class="c1">#    col_sum = (_fit_X[mask_ == 1, col]).sum().to(X.dtype)</span>
        <span class="c1">#    div = torch.where(mask_sum &gt; 0, mask_sum, torch.tensor([1], dtype=mask_sum.dtype))</span>
        <span class="c1">#    X[all_nan_receivers_idx, col] = col_sum / div</span>
        <span class="c1">#</span>
        <span class="c1">#     # receivers with at least one defined distance</span>
        <span class="c1">#     receivers_idx = receivers_idx[~all_nan_dist_mask]</span>
        <span class="c1">#     dist_subset = dist_chunk[dist_idx_map[receivers_idx]][:, potential_donors_idx]</span>
        <span class="c1"># else</span>
        <span class="c1">#     ... identity</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">,</span> <span class="n">dist_subset</span><span class="p">,</span> <span class="n">receivers_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_cond</span><span class="p">(</span>
            <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">,</span>
            <span class="n">dist_subset</span><span class="p">,</span>
            <span class="n">mask_fit_X</span><span class="p">,</span>
            <span class="n">_fit_X</span><span class="p">,</span>
            <span class="n">receivers_idx</span><span class="p">,</span>
            <span class="n">all_nan_receivers_idx</span><span class="p">,</span>
            <span class="n">all_nan_dist_mask</span><span class="p">,</span>
            <span class="n">dist_chunk</span><span class="p">,</span>
            <span class="n">dist_idx_map</span><span class="p">,</span>
            <span class="n">potential_donors_idx</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># when all_nan_receivers_idx is not empty (training set is big)</span>
        <span class="n">tn</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span></a></a></a><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_neighbors</span><span class="p">)</span>
        <span class="n">n_neighbors</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.where.html#torch.where" title="torch.where" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.where.html#torch.where" title="torch.where" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.where.html#torch.where" title="torch.where" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">where</span></a></a></a><span class="p">(</span>
            <span class="n">tn</span> <span class="o">&lt;</span> <span class="n">potential_donors_idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tn</span><span class="p">,</span> <span class="n">potential_donors_idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># to make sure n_neighbors &gt; 0</span>
        <span class="n">n_neighbors</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.where.html#torch.where" title="torch.where" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.where.html#torch.where" title="torch.where" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.where.html#torch.where" title="torch.where" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">where</span></a></a></a><span class="p">(</span>
            <span class="n">n_neighbors</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.tensor.html#torch.tensor" title="torch.tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span></a></a></a><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">n_neighbors</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">n_neighbors</span>
        <span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_impute</span><span class="p">(</span>
            <span class="n">dist_subset</span><span class="p">,</span>
            <span class="n">n_neighbors</span><span class="p">,</span>
            <span class="n">_fit_X</span><span class="p">[</span><span class="n">potential_donors_idx</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span>
            <span class="n">mask_fit_X</span><span class="p">[</span><span class="n">potential_donors_idx</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span>
        <span class="p">)</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">[</span><span class="n">receivers_idx</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">dtype</span></a></a></a><span class="p">)</span>
        <span class="k">return</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">,</span>
        <span class="n">dist_chunk</span><span class="p">,</span>
        <span class="n">non_missing_fix_X</span><span class="p">,</span>
        <span class="n">mask_fit_X</span><span class="p">,</span>
        <span class="n">dist_idx_map</span><span class="p">,</span>
        <span class="n">mask</span><span class="p">,</span>
        <span class="n">row_missing_idx</span><span class="p">,</span>
        <span class="n">_fit_X</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_one_col</span><span class="p">(</span>
            <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">,</span>
            <span class="n">dist_chunk</span><span class="p">,</span>
            <span class="n">non_missing_fix_X</span><span class="p">,</span>
            <span class="n">mask_fit_X</span><span class="p">,</span>
            <span class="n">dist_idx_map</span><span class="p">,</span>
            <span class="n">mask</span><span class="p">,</span>
            <span class="n">row_missing_idx</span><span class="p">,</span>
            <span class="n">_fit_X</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">MakeDictIdxMap</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span></a></a></a><span class="p">):</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">,</span> <span class="n">row_missing_idx</span><span class="p">):</span>
        <span class="n">dist_idx_map</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.zeros.html#torch.zeros" title="torch.zeros" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.zeros.html#torch.zeros" title="torch.zeros" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.zeros.html#torch.zeros" title="torch.zeros" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span></a></a></a><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/size.html#torch.Size" title="torch.Size" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/size.html#torch.Size" title="torch.Size" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/size.html#torch.Size" title="torch.Size" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">shape</span></a></a></a><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">dist_idx_map</span><span class="p">[</span><span class="n">row_missing_idx</span><span class="p">]</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.arange.html#torch.arange" title="torch.arange" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.arange.html#torch.arange" title="torch.arange" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.arange.html#torch.arange" title="torch.arange" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">arange</span></a></a></a><span class="p">(</span><span class="n">row_missing_idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">dist_idx_map</span>


<span class="k">class</span> <span class="nc">TorchKNNImputer</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span></a></a></a><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">knn_imputer</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">knn_imputer</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;nan_euclidean&quot;</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Not implemented for metric=</span><span class="si">{</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">metric</span><span class="si">!r}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">NanEuclidean</span></a></a></a><span class="p">()</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_fit_X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">ColProcessor</span></a></a></a><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">n_neighbors</span><span class="p">,</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">weights</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.nn.ModuleList.html#torch.nn.ModuleList" title="torch.nn.ModuleList" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.ModuleList.html#torch.nn.ModuleList" title="torch.nn.ModuleList" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.ModuleList.html#torch.nn.ModuleList" title="torch.nn.ModuleList" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span></a></a></a><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
        <span class="c1"># refactoring</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_dict_idx_map</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">MakeDictIdxMap</span></a></a></a><span class="p">()</span>
        <span class="c1"># knn imputer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">missing_values</span> <span class="o">=</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">missing_values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_neighbors</span> <span class="o">=</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">n_neighbors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">metric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_empty_features</span> <span class="o">=</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">keep_empty_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_indicator</span> <span class="o">=</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">add_indicator</span>
        <span class="c1"># results of fitting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indicator_</span> <span class="o">=</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">indicator_</span>
        <span class="c1"># The training results.</span>
        <span class="c1"># self._fit_X = torch.from_numpy(knn_imputer._fit_X.astype(np.float32))</span>
        <span class="c1"># self._mask_fit_X = torch.from_numpy(knn_imputer._mask_fit_X)</span>
        <span class="c1"># self._valid_mask = torch.from_numpy(knn_imputer._valid_mask)</span>

    <span class="k">def</span> <span class="nf">_transform_indicator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_indicator</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;indicator_&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Make sure to call _fit_indicator before _transform_indicator&quot;</span>
                <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indicator_</span><span class="p">))</span>
            <span class="c1"># return self.indicator_.transform(X)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_concatenate_indicator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_imputed</span><span class="p">,</span> <span class="n">X_indicator</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_indicator</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">X_imputed</span>
        <span class="k">if</span> <span class="n">X_indicator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Data from the missing indicator are not provided. Call &quot;</span>
                <span class="s2">&quot;_fit_indicator and _transform_indicator in the imputer &quot;</span>
                <span class="s2">&quot;implementation.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.cat.html#torch.cat" title="torch.cat" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.cat.html#torch.cat" title="torch.cat" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.cat.html#torch.cat" title="torch.cat" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">cat</span></a></a></a><span class="p">([</span><span class="n">X_imputed</span><span class="p">,</span> <span class="n">X_indicator</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask_fit_X</span><span class="p">,</span> <span class="n">_valid_mask</span><span class="p">,</span> <span class="n">_fit_X</span><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">):</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">_get_mask</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">missing_values</span><span class="p">)</span>

        <span class="n">X_indicator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_indicator</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

        <span class="n">row_missing_idx</span> <span class="o">=</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/skl/helpers.html#experimental_experiment.skl.helpers.flatnonzero" title="experimental_experiment.skl.helpers.flatnonzero" class="sphx-glr-backref-module-experimental_experiment-skl-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/skl/helpers.html#experimental_experiment.skl.helpers.flatnonzero" title="experimental_experiment.skl.helpers.flatnonzero" class="sphx-glr-backref-module-experimental_experiment-skl-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/skl/helpers.html#experimental_experiment.skl.helpers.flatnonzero" title="experimental_experiment.skl.helpers.flatnonzero" class="sphx-glr-backref-module-experimental_experiment-skl-helpers sphx-glr-backref-type-py-function"><span class="n">flatnonzero</span></a></a></a><span class="p">(</span><span class="n">mask</span><span class="p">[:,</span> <span class="n">_valid_mask</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">non_missing_fix_X</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.logical_not.html#torch.logical_not" title="torch.logical_not" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.logical_not.html#torch.logical_not" title="torch.logical_not" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.logical_not.html#torch.logical_not" title="torch.logical_not" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">logical_not</span></a></a></a><span class="p">(</span><span class="n">mask_fit_X</span><span class="p">)</span>

        <span class="c1"># Maps from indices from X to indices in dist matrix</span>
        <span class="n">dist_idx_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_dict_idx_map</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">,</span> <span class="n">row_missing_idx</span><span class="p">)</span>

        <span class="c1"># process in fixed-memory chunks</span>
        <span class="n">pairwise_distances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">[</span><span class="n">row_missing_idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">_fit_X</span><span class="p">)</span>

        <span class="c1"># The export unfold the loop as it depends on the number of features.</span>
        <span class="c1"># Fixed in this case.</span>
        <span class="k">for</span> <span class="n">col_processor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a> <span class="o">=</span> <span class="n">col_processor</span><span class="p">(</span>
                <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">,</span>
                <span class="n">pairwise_distances</span><span class="p">,</span>
                <span class="n">non_missing_fix_X</span><span class="p">,</span>
                <span class="n">mask_fit_X</span><span class="p">,</span>
                <span class="n">dist_idx_map</span><span class="p">,</span>
                <span class="n">mask</span><span class="p">,</span>
                <span class="n">row_missing_idx</span><span class="p">,</span>
                <span class="n">_fit_X</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_empty_features</span><span class="p">:</span>
            <span class="n">Xc</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="n">Xc</span><span class="p">[:,</span> <span class="o">~</span><span class="n">_valid_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Xc</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">[:,</span> <span class="n">_valid_mask</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concatenate_indicator</span><span class="p">(</span><span class="n">Xc</span><span class="p">,</span> <span class="n">X_indicator</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_mask_fit_X</span><span class="p">,</span> <span class="n">_valid_mask</span><span class="p">,</span> <span class="n">_fit_X</span><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">_mask_fit_X</span><span class="p">,</span> <span class="n">_valid_mask</span><span class="p">,</span> <span class="n">_fit_X</span><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id1">
<h3>Validation<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<p>We need to do that with different sizes of training set.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">sizey</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_nans</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a> <span class="o">=</span> <span class="n">get_xy</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">sizey</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">n_nans</span><span class="p">)</span>
    <span class="n">knn_imputer</span> <span class="o">=</span> <a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class"><span class="n">sklearn</span><span class="o">.</span><span class="n">impute</span><span class="o">.</span><span class="n">KNNImputer</span></a></a></a><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">knn_imputer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">TorchKNNImputer</span></a></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="p">)</span>

    <span class="n">p1</span> <span class="o">=</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
        <a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_mask_fit_X</span><span class="p">),</span>
        <a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_valid_mask</span><span class="p">),</span>
        <a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_fit_X</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.float32" title="numpy.float32" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.float32" title="numpy.float32" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.float32" title="numpy.float32" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><span class="n">np</span><span class="o">.</span><span class="n">float32</span></a></a></a><span class="p">)),</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><span class="n">max_diff</span></a></a></a><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;abs&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> and sizey=</span><span class="si">{</span><span class="n">sizey</span><span class="si">}</span><span class="s2">, d=</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;knn discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">p1</span> <span class="o">=</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
        <a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_mask_fit_X</span><span class="p">),</span>
        <a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_valid_mask</span><span class="p">),</span>
        <a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_fit_X</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.float32" title="numpy.float32" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.float32" title="numpy.float32" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.float32" title="numpy.float32" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><span class="n">np</span><span class="o">.</span><span class="n">float32</span></a></a></a><span class="p">)),</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><span class="n">max_diff</span></a></a></a><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;abs&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> and sizey=</span><span class="si">{</span><span class="n">sizey</span><span class="si">}</span><span class="s2">, d=</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;knn discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">knn_imputer</span><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a>


<a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn5</span></a></a></a><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y10</span></a></a></a> <span class="o">=</span> <span class="n">validate</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn50</span></a></a></a><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y40</span></a></a></a> <span class="o">=</span> <span class="n">validate</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
<a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn1</span></a></a></a><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y1</span></a></a></a> <span class="o">=</span> <span class="n">validate</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">n_nans</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn11</span></a></a></a><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y11</span></a></a></a> <span class="o">=</span> <span class="n">validate</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">n_nans</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>knn discrepancies for size=5: {&#39;abs&#39;: 1.4901161193847656e-08, &#39;rel&#39;: 3.727023293108136e-08, &#39;sum&#39;: 1.043081283569336e-07, &#39;n&#39;: 30.0, &#39;dnan&#39;: 0.0, &#39;argm&#39;: (0, 0)}
knn discrepancies for size=5: {&#39;abs&#39;: 1.4901161193847656e-08, &#39;rel&#39;: 3.727023293108136e-08, &#39;sum&#39;: 1.4901161193847656e-08, &#39;n&#39;: 3.0, &#39;dnan&#39;: 0.0, &#39;argm&#39;: (0, 0)}
knn discrepancies for size=50: {&#39;abs&#39;: 9.368009423749157e-09, &#39;rel&#39;: 1.379606193778086e-07, &#39;sum&#39;: 5.808165843348978e-07, &#39;n&#39;: 120.0, &#39;dnan&#39;: 0.0, &#39;argm&#39;: (2, 2)}
knn discrepancies for size=50: {&#39;abs&#39;: 7.450580596923828e-09, &#39;rel&#39;: 9.230125399471292e-08, &#39;sum&#39;: 1.2490679233978508e-08, &#39;n&#39;: 3.0, &#39;dnan&#39;: 0.0, &#39;argm&#39;: (0, 1)}
knn discrepancies for size=10: {&#39;abs&#39;: 1.9868214962137642e-08, &#39;rel&#39;: 2.948249269874871e-08, &#39;sum&#39;: 1.9868214962137642e-08, &#39;n&#39;: 30.0, &#39;dnan&#39;: 0.0, &#39;argm&#39;: (1, 0)}
knn discrepancies for size=10: {&#39;abs&#39;: 1.9868214962137642e-08, &#39;rel&#39;: 2.948249269874871e-08, &#39;sum&#39;: 1.9868214962137642e-08, &#39;n&#39;: 3.0, &#39;dnan&#39;: 0.0, &#39;argm&#39;: (0, 0)}
knn discrepancies for size=11: {&#39;abs&#39;: 9.934107481068821e-09, &#39;rel&#39;: 3.110919082332138e-08, &#39;sum&#39;: 9.934107481068821e-09, &#39;n&#39;: 33.0, &#39;dnan&#39;: 0.0, &#39;argm&#39;: (1, 0)}
knn discrepancies for size=11: {&#39;abs&#39;: 9.934107481068821e-09, &#39;rel&#39;: 3.110919082332138e-08, &#39;sum&#39;: 9.934107481068821e-09, &#39;n&#39;: 3.0, &#39;dnan&#39;: 0.0, &#39;argm&#39;: (0, 0)}
</pre></div>
</div>
</section>
</section>
<section id="export-to-onnx">
<h2>Export to ONNX<a class="headerlink" href="#export-to-onnx" title="Link to this heading">¶</a></h2>
<p>The module cannot be exported as is because one operator <a class="reference external" href="https://docs.pytorch.org/docs/main/generated/torch.topk.html#torch.topk" title="(in PyTorch vmain (2.8.0a0+git32b1baa ))"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.topk()</span></code></a>
expects a fixed number of neighbour but the model makes it variable.
This is case not supported by <a class="reference external" href="https://docs.pytorch.org/docs/main/export.html#torch.export.export" title="(in PyTorch vmain (2.8.0a0+git32b1baa ))"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.export.export()</span></code></a>.
We need to isolate that part before exporting the model.
It is done by replacing it with a custom op.
This is automatically done by function <code class="xref py py-func docutils literal notranslate"><span class="pre">trace_execution_piece_by_piece()</span></code>.</p>
<p>First step, we create two sets of inputs. A function will use this
to infer the dynamic shapes.</p>
<section id="first-step-tracing-intermediate-outputs">
<h3>First step: tracing intermediate outputs<a class="headerlink" href="#first-step-tracing-intermediate-outputs" title="Link to this heading">¶</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">used</span></a></a></a> <span class="o">=</span> <span class="p">[(</span><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn50</span></a></a></a><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y40</span></a></a></a><span class="p">),</span> <span class="p">(</span><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn5</span></a></a></a><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y10</span></a></a></a><span class="p">),</span> <span class="p">(</span><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn1</span></a></a></a><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y1</span></a></a></a><span class="p">),</span> <span class="p">(</span><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn11</span></a></a></a><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y11</span></a></a></a><span class="p">)]</span>
<a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span></a></a></a> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span>
        <span class="p">(</span>
            <a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a></a><span class="p">(</span><span class="n">knn</span><span class="o">.</span><span class="n">_mask_fit_X</span><span class="p">),</span>
            <a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a></a><span class="p">(</span><span class="n">knn</span><span class="o">.</span><span class="n">_valid_mask</span><span class="p">),</span>
            <a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a></a><span class="p">(</span><span class="n">knn</span><span class="o">.</span><span class="n">_fit_X</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.float32" title="numpy.float32" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.float32" title="numpy.float32" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.float32" title="numpy.float32" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><span class="n">np</span><span class="o">.</span><span class="n">float32</span></a></a></a><span class="p">)),</span>
            <span class="n">y</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">{},</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">knn</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">used</span></a></a></a>
<span class="p">]</span>
</pre></div>
</div>
<p>Then we trace the execution to capture every input and output of every submodule.
The model implementation was refactored to introduce many tiny one and get
a fine-grained evaluation of the exportability.
We track messages such as <code class="docutils literal notranslate"><span class="pre">-needs-more-inputs</span></code> or <code class="docutils literal notranslate"><span class="pre">-no-input</span></code>.
If any, we must provide the tracer more input to make sure
every submodule receives enough data to guess dynamic shapes and export.
When the model has control flow, we need more data to make sure every
piece is used.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">trace</span></a></a></a> <span class="o">=</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" title="experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" title="experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" title="experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-function"><span class="n">trace_execution_piece_by_piece</span></a></a></a><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">TorchKNNImputer</span></a></a></a><span class="p">(</span><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn5</span></a></a></a><span class="p">),</span> <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span></a></a></a><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">pretty</span></a></a></a> <span class="o">=</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><span class="n">trace</span><span class="o">.</span><span class="n">get_export_report</span></a></a></a><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">pretty</span></a></a></a><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>__main__                  TorchKNNImputer        &lt;OK-4i-0&gt;
..dist                    NanEuclidean           &lt;OK-4i-0&gt;
..columns[0]              ColProcessor           &lt;OK-4i-0&gt;
...._calc_impute          CalcImpute             &lt;OK-4i-2&gt;
......_weights            SubWeightMatrix        &lt;OK-4i-2&gt;
......_donors_idx         SubDonorsIdx           &lt;OK-4i-2&gt;
......_make_new_neights   MakeNewWeights         &lt;OK-4i-2&gt;
...._col_cond             ColProcessorCond       &lt;OK-4i-0&gt;
......_all_nan            ColProcessorAllNan     &lt;OK-2i-0&gt;
......_identity           ColProcessorIdentity   &lt;OK-2i-may-need-more&gt;
..columns[1]              ColProcessor           &lt;OK-4i-0&gt;
...._calc_impute          CalcImpute             &lt;OK-4i-may-need-more&gt;
......_weights            SubWeightMatrix        &lt;OK-4i-may-need-more&gt;
......_donors_idx         SubDonorsIdx           &lt;OK-4i-may-need-more&gt;
......_make_new_neights   MakeNewWeights         &lt;OK-4i-may-need-more&gt;
...._col_cond             ColProcessorCond       &lt;OK-4i-0&gt;
......_all_nan            ColProcessorAllNan     &lt;OK-2i-0&gt;
......_identity           ColProcessorIdentity   &lt;OK-2i-may-need-more&gt;
..columns[2]              ColProcessor           &lt;OK-4i-0&gt;
...._calc_impute          CalcImpute             &lt;OK-4i-may-need-more&gt;
......_weights            SubWeightMatrix        &lt;OK-4i-may-need-more&gt;
......_donors_idx         SubDonorsIdx           &lt;OK-4i-may-need-more&gt;
......_make_new_neights   MakeNewWeights         &lt;OK-4i-may-need-more&gt;
...._col_cond             ColProcessorCond       &lt;OK-4i-0&gt;
......_all_nan            ColProcessorAllNan     &lt;OK-2i-0&gt;
......_identity           ColProcessorIdentity   &lt;OK-2i-may-need-more&gt;
.._make_dict_idx_map      MakeDictIdxMap         &lt;OK-4i-0&gt;
</pre></div>
</div>
<p>We need more so let’s add more.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span></a></a></a><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span></a></a></a><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span></a></a></a><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span></a></a></a><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span></a></a></a><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.cat.html#torch.cat" title="torch.cat" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.cat.html#torch.cat" title="torch.cat" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.cat.html#torch.cat" title="torch.cat" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">cat</span></a></a></a><span class="p">([</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span></a></a></a><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span></a></a></a><span class="p">[:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span></a></a></a><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span></a></a></a><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.cat.html#torch.cat" title="torch.cat" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.cat.html#torch.cat" title="torch.cat" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.cat.html#torch.cat" title="torch.cat" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">cat</span></a></a></a><span class="p">([</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span></a></a></a><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span></a></a></a><span class="p">[:</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span></a></a></a>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span></a></a></a><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rotate</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span></a></a></a><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span></a></a></a><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">rotate</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span></a></a></a><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span></a></a></a><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">rotate</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span><span class="o">.</span><span class="n">items</span></a></a></a><span class="p">()}</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span></a></a></a><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span></a></a></a> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span></a></a></a><span class="p">,</span> <span class="o">*</span><span class="n">rotate</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span></a></a></a><span class="p">),</span> <span class="o">*</span><span class="n">rotate</span><span class="p">(</span><span class="n">rotate</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span></a></a></a><span class="p">))]</span>
</pre></div>
</div>
<p>Let’s try again.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------&quot;</span><span class="p">)</span>
<a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">trace</span></a></a></a> <span class="o">=</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" title="experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" title="experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" title="experimental_experiment.torch_interpreter.piece_by_piece.trace_execution_piece_by_piece" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-function"><span class="n">trace_execution_piece_by_piece</span></a></a></a><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">TorchKNNImputer</span></a></a></a><span class="p">(</span><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn5</span></a></a></a><span class="p">),</span> <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">inputs</span></a></a></a><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">pretty</span></a></a></a> <span class="o">=</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><span class="n">trace</span><span class="o">.</span><span class="n">get_export_report</span></a></a></a><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">pretty</span></a></a></a><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>---------
__main__                  TorchKNNImputer        &lt;OK-12i-0&gt;
..dist                    NanEuclidean           &lt;OK-12i-0&gt;
..columns[0]              ColProcessor           &lt;OK-12i-0&gt;
...._calc_impute          CalcImpute             &lt;OK-12i-2&gt;
......_weights            SubWeightMatrix        &lt;OK-12i-2&gt;
......_donors_idx         SubDonorsIdx           &lt;OK-12i-2&gt;
......_make_new_neights   MakeNewWeights         &lt;OK-12i-2&gt;
...._col_cond             ColProcessorCond       &lt;OK-12i-0&gt;
......_all_nan            ColProcessorAllNan     &lt;OK-6i-0&gt;
......_identity           ColProcessorIdentity   &lt;OK-6i-may-need-more&gt;
..columns[1]              ColProcessor           &lt;OK-12i-0&gt;
...._calc_impute          CalcImpute             &lt;OK-12i-10&gt;
......_weights            SubWeightMatrix        &lt;OK-12i-10&gt;
......_donors_idx         SubDonorsIdx           &lt;OK-12i-10&gt;
......_make_new_neights   MakeNewWeights         &lt;OK-12i-10&gt;
...._col_cond             ColProcessorCond       &lt;OK-12i-0&gt;
......_all_nan            ColProcessorAllNan     &lt;OK-6i-0&gt;
......_identity           ColProcessorIdentity   &lt;OK-6i-may-need-more&gt;
..columns[2]              ColProcessor           &lt;OK-12i-0&gt;
...._calc_impute          CalcImpute             &lt;OK-12i-6&gt;
......_weights            SubWeightMatrix        &lt;OK-12i-6&gt;
......_donors_idx         SubDonorsIdx           &lt;OK-12i-6&gt;
......_make_new_neights   MakeNewWeights         &lt;OK-12i-6&gt;
...._col_cond             ColProcessorCond       &lt;OK-12i-0&gt;
......_all_nan            ColProcessorAllNan     &lt;OK-6i-0&gt;
......_identity           ColProcessorIdentity   &lt;OK-6i-may-need-more&gt;
.._make_dict_idx_map      MakeDictIdxMap         &lt;OK-12i-0&gt;
</pre></div>
</div>
<p>The dynamic shapes for the whole model:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dynamic shapes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.guess_dynamic_shapes" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.guess_dynamic_shapes" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.guess_dynamic_shapes" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.guess_dynamic_shapes" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.guess_dynamic_shapes" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.guess_dynamic_shapes" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><span class="n">trace</span><span class="o">.</span><span class="n">guess_dynamic_shapes</span></a></a></a><span class="p">())</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>dynamic shapes:
(({0: _DimHint(type=&lt;_DimHintType.DYNAMIC: 3&gt;, min=None, max=None, _factory=True)}, {}, {0: _DimHint(type=&lt;_DimHintType.DYNAMIC: 3&gt;, min=None, max=None, _factory=True)}, {0: _DimHint(type=&lt;_DimHintType.DYNAMIC: 3&gt;, min=None, max=None, _factory=True)}), {})
</pre></div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">try_export</span></code> cannot infer all links between input shapes and output shapes
for every submodule. The following function fills this gap.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">shape_functions</span></a></a></a> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;NanEuclidean&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">empty</span></a></a></a><span class="p">(</span>
            <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
        <span class="p">)</span>
    <span class="p">},</span>
    <span class="s2">&quot;CalcImpute&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">empty</span></a></a></a><span class="p">((</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="s2">&quot;SubDonorsIdx&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">empty</span></a></a></a><span class="p">(</span>
            <span class="p">(</span>
                <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.make_undefined_dimension" title="experimental_experiment.torch_interpreter.make_undefined_dimension" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.make_undefined_dimension" title="experimental_experiment.torch_interpreter.make_undefined_dimension" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.make_undefined_dimension" title="experimental_experiment.torch_interpreter.make_undefined_dimension" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-function"><span class="n">make_undefined_dimension</span></a></a></a><span class="p">(</span><span class="mi">111111</span><span class="p">),</span>  <span class="c1"># args[0].shape[0]),</span>
                <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.make_undefined_dimension" title="experimental_experiment.torch_interpreter.make_undefined_dimension" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.make_undefined_dimension" title="experimental_experiment.torch_interpreter.make_undefined_dimension" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.make_undefined_dimension" title="experimental_experiment.torch_interpreter.make_undefined_dimension" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-function"><span class="n">make_undefined_dimension</span></a></a></a><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn5</span><span class="o">.</span><span class="n">n_neighbors</span></a></a></a><span class="p">)),</span>
            <span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="mi">1</span><span class="p">:</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">empty</span></a></a></a><span class="p">(</span>
            <span class="p">(</span>
                <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.make_undefined_dimension" title="experimental_experiment.torch_interpreter.make_undefined_dimension" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.make_undefined_dimension" title="experimental_experiment.torch_interpreter.make_undefined_dimension" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.make_undefined_dimension" title="experimental_experiment.torch_interpreter.make_undefined_dimension" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-function"><span class="n">make_undefined_dimension</span></a></a></a><span class="p">(</span><span class="mi">111111</span><span class="p">),</span>  <span class="c1"># args[0].shape[0]),</span>
                <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.make_undefined_dimension" title="experimental_experiment.torch_interpreter.make_undefined_dimension" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.make_undefined_dimension" title="experimental_experiment.torch_interpreter.make_undefined_dimension" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.make_undefined_dimension" title="experimental_experiment.torch_interpreter.make_undefined_dimension" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-function"><span class="n">make_undefined_dimension</span></a></a></a><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">knn5</span><span class="o">.</span><span class="n">n_neighbors</span></a></a></a><span class="p">)),</span>
            <span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensor_attributes.html#torch.dtype" title="torch.dtype" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">torch</span><span class="o">.</span><span class="n">float32</span></a></a></a><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">},</span>
    <span class="s2">&quot;MakeDictIdxMap&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">empty</span></a></a></a><span class="p">((</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="s2">&quot;ColProcessorCond&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">empty</span></a></a></a><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
        <span class="mi">1</span><span class="p">:</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">empty</span></a></a></a><span class="p">(</span>
            <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.make_undefined_dimension" title="experimental_experiment.torch_interpreter.make_undefined_dimension" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.make_undefined_dimension" title="experimental_experiment.torch_interpreter.make_undefined_dimension" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.make_undefined_dimension" title="experimental_experiment.torch_interpreter.make_undefined_dimension" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-function"><span class="n">make_undefined_dimension</span></a></a></a><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
        <span class="p">),</span>
        <span class="mi">2</span><span class="p">:</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.empty.html#torch.empty" title="torch.empty" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">empty</span></a></a></a><span class="p">(</span>
            <span class="p">(</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.make_undefined_dimension" title="experimental_experiment.torch_interpreter.make_undefined_dimension" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.make_undefined_dimension" title="experimental_experiment.torch_interpreter.make_undefined_dimension" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/index.html#experimental_experiment.torch_interpreter.make_undefined_dimension" title="experimental_experiment.torch_interpreter.make_undefined_dimension" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter sphx-glr-backref-type-py-function"><span class="n">make_undefined_dimension</span></a></a></a><span class="p">(</span><span class="mi">0</span><span class="p">),),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
        <span class="p">),</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Then we we try to export piece by piece.
We capture the standard output to avoid being overwhelmed
and we use function
<a class="reference external" href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/torch_export_patches/index.html#onnx_diagnostic.torch_export_patches.torch_export_patches" title="(in onnx-diagnostic v0.5.0)"><code class="xref py py-func docutils literal notranslate"><span class="pre">onnx_diagnostic.torch_export_patches.torch_export_patches()</span></code></a>
to skip some errors with shape checking made by <a class="reference external" href="https://docs.pytorch.org/docs/main/torch.html#module-torch" title="(in PyTorch vmain (2.8.0a0+git32b1baa ))"><code class="xref py py-mod docutils literal notranslate"><span class="pre">torch</span></code></a>.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/logging.html#logging.disable" title="logging.disable" class="sphx-glr-backref-module-logging sphx-glr-backref-type-py-function"><a href="https://docs.python.org/3/library/logging.html#logging.disable" title="logging.disable" class="sphx-glr-backref-module-logging sphx-glr-backref-type-py-function"><a href="https://docs.python.org/3/library/logging.html#logging.disable" title="logging.disable" class="sphx-glr-backref-module-logging sphx-glr-backref-type-py-function"><span class="n">logging</span><span class="o">.</span><span class="n">disable</span></a></a></a><span class="p">(</span><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span></a></a></a><span class="p">)</span>

<span class="k">with</span> <a href="https://docs.python.org/3/library/contextlib.html#contextlib.redirect_stderr" title="contextlib.redirect_stderr" class="sphx-glr-backref-module-contextlib sphx-glr-backref-type-py-function"><a href="https://docs.python.org/3/library/contextlib.html#contextlib.redirect_stderr" title="contextlib.redirect_stderr" class="sphx-glr-backref-module-contextlib sphx-glr-backref-type-py-function"><a href="https://docs.python.org/3/library/contextlib.html#contextlib.redirect_stderr" title="contextlib.redirect_stderr" class="sphx-glr-backref-module-contextlib sphx-glr-backref-type-py-function"><span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stderr</span></a></a></a><span class="p">(</span><a href="https://docs.python.org/3/library/io.html#io.StringIO" title="io.StringIO" class="sphx-glr-backref-module-io sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/io.html#io.StringIO" title="io.StringIO" class="sphx-glr-backref-module-io sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/io.html#io.StringIO" title="io.StringIO" class="sphx-glr-backref-module-io sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span></a></a></a><span class="p">()),</span> <a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/torch_export_patches/index.html#onnx_diagnostic.torch_export_patches.torch_export_patches" title="onnx_diagnostic.torch_export_patches.torch_export_patches" class="sphx-glr-backref-module-onnx_diagnostic-torch_export_patches sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/torch_export_patches/index.html#onnx_diagnostic.torch_export_patches.torch_export_patches" title="onnx_diagnostic.torch_export_patches.torch_export_patches" class="sphx-glr-backref-module-onnx_diagnostic-torch_export_patches sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/torch_export_patches/index.html#onnx_diagnostic.torch_export_patches.torch_export_patches" title="onnx_diagnostic.torch_export_patches.torch_export_patches" class="sphx-glr-backref-module-onnx_diagnostic-torch_export_patches sphx-glr-backref-type-py-function"><span class="n">torch_export_patches</span></a></a></a><span class="p">():</span>
    <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExport" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExport" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExport" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExport" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExport" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExport" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ep</span></a></a></a> <span class="o">=</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.try_export" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.try_export" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.try_export" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.try_export" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.try_export" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.try_export" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><span class="n">trace</span><span class="o">.</span><span class="n">try_export</span></a></a></a><span class="p">(</span>
        <span class="n">exporter</span><span class="o">=</span><span class="s2">&quot;fx&quot;</span><span class="p">,</span>
        <span class="n">use_dynamic_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">exporter_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">replace_by_custom_op</span><span class="o">=</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.CustomOpStrategy" title="experimental_experiment.torch_interpreter.piece_by_piece.CustomOpStrategy" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.CustomOpStrategy" title="experimental_experiment.torch_interpreter.piece_by_piece.CustomOpStrategy" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.CustomOpStrategy" title="experimental_experiment.torch_interpreter.piece_by_piece.CustomOpStrategy" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">CustomOpStrategy</span><span class="o">.</span><span class="n">LOCAL</span></a></a></a><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">shape_functions</span></a></a></a><span class="o">=</span><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">shape_functions</span></a></a></a><span class="p">,</span>
        <span class="n">quiet</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">assert</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ep</span><span class="o">.</span><span class="n">status</span></a></a></a> <span class="ow">in</span> <span class="p">(</span>
    <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ep</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">OK</span></a></a></a><span class="p">,</span>
    <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExportCode" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ep</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">OK_CHILDC</span></a></a></a><span class="p">,</span>
<span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;FAIL: </span><span class="si">{</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExport" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExport" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExport" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExport" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.StatusExport" title="experimental_experiment.torch_interpreter.piece_by_piece.StatusExport" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ep</span></a></a></a><span class="si">}</span><span class="se">\n</span><span class="s2">-- report --</span><span class="se">\n</span><span class="si">{</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><span class="n">trace</span><span class="o">.</span><span class="n">get_export_report</span></a></a></a><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">print</span><span class="p">(</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.get_export_report" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><span class="n">trace</span><span class="o">.</span><span class="n">get_export_report</span></a></a></a><span class="p">())</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>__main__                  TorchKNNImputer        OK_CHILDC -- ExportedProgram
..dist                    NanEuclidean           OK -- ExportedProgram
..columns[0]              ColProcessor           OK_CHILDC -- ExportedProgram
...._calc_impute          CalcImpute             OK_CHILDC -- ExportedProgram
......_weights            SubWeightMatrix        OK -- ExportedProgram
......_donors_idx         SubDonorsIdx           OK -- ExportedProgram
......_make_new_neights   MakeNewWeights         OK -- ExportedProgram
...._col_cond             ColProcessorCond       FAIL_CHILDC -- step=EXPORT, reason=&#39;Dynamo failed to run FX node with fake tensors: call_function cond(*(s2, GraphModule(), GraphModule(...&#39;
......_all_nan            ColProcessorAllNan     OK -- ExportedProgram
......_identity           ColProcessorIdentity   OK -- ExportedProgram
..columns[1]              ColProcessor           OK_CHILDC -- ExportedProgram
...._calc_impute          CalcImpute             OK_CHILDC -- ExportedProgram
......_weights            SubWeightMatrix        OK -- ExportedProgram
......_donors_idx         SubDonorsIdx           OK -- ExportedProgram
......_make_new_neights   MakeNewWeights         OK -- ExportedProgram
...._col_cond             ColProcessorCond       FAIL_CHILDC -- step=EXPORT, reason=&#39;Dynamo failed to run FX node with fake tensors: call_function cond(*(s2, GraphModule(), GraphModule(...&#39;
......_all_nan            ColProcessorAllNan     OK -- ExportedProgram
......_identity           ColProcessorIdentity   OK -- ExportedProgram
..columns[2]              ColProcessor           OK_CHILDC -- ExportedProgram
...._calc_impute          CalcImpute             OK_CHILDC -- ExportedProgram
......_weights            SubWeightMatrix        OK -- ExportedProgram
......_donors_idx         SubDonorsIdx           OK -- ExportedProgram
......_make_new_neights   MakeNewWeights         OK -- ExportedProgram
...._col_cond             ColProcessorCond       FAIL_CHILDC -- step=EXPORT, reason=&#39;Dynamo failed to run FX node with fake tensors: call_function cond(*(s2, GraphModule(), GraphModule(...&#39;
......_all_nan            ColProcessorAllNan     OK -- ExportedProgram
......_identity           ColProcessorIdentity   OK -- ExportedProgram
.._make_dict_idx_map      MakeDictIdxMap         OK -- ExportedProgram
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">OK</span></code> means the module is exportable. <code class="docutils literal notranslate"><span class="pre">OK_CHILDC</span></code> means the module
can be exported after its submodules are replaced by custom ops.
It works except for the topk function. <code class="docutils literal notranslate"><span class="pre">FAIL</span></code> means
the submodule cannot be exported at all but that
module is simple enough and its ONNX conversion can be provided.</p>
</section>
<section id="final-step">
<h3>Final step<a class="headerlink" href="#final-step" title="Link to this heading">¶</a></h3>
<p>We first start by running the decompositions on every exported program.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <a href="https://docs.python.org/3/library/warnings.html#warnings.catch_warnings" title="warnings.catch_warnings" class="sphx-glr-backref-module-warnings sphx-glr-backref-type-py-class"><a href="https://docs.python.org/3/library/warnings.html#warnings.catch_warnings" title="warnings.catch_warnings" class="sphx-glr-backref-module-warnings sphx-glr-backref-type-py-class"><a href="https://docs.python.org/3/library/warnings.html#warnings.catch_warnings" title="warnings.catch_warnings" class="sphx-glr-backref-module-warnings sphx-glr-backref-type-py-class"><span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span></a></a></a><span class="p">():</span>
    <a href="https://docs.python.org/3/library/warnings.html#warnings.simplefilter" title="warnings.simplefilter" class="sphx-glr-backref-module-warnings sphx-glr-backref-type-py-function"><a href="https://docs.python.org/3/library/warnings.html#warnings.simplefilter" title="warnings.simplefilter" class="sphx-glr-backref-module-warnings sphx-glr-backref-type-py-function"><a href="https://docs.python.org/3/library/warnings.html#warnings.simplefilter" title="warnings.simplefilter" class="sphx-glr-backref-module-warnings sphx-glr-backref-type-py-function"><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span></a></a></a><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

    <span class="k">for</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">t</span></a></a></a> <span class="ow">in</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">trace</span></a></a></a><span class="p">:</span>
        <span class="k">if</span> <a href="https://docs.pytorch.org/docs/main/export.html#torch.export.ExportedProgram" title="torch.export.ExportedProgram" class="sphx-glr-backref-module-torch-export sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/export.html#torch.export.ExportedProgram" title="torch.export.ExportedProgram" class="sphx-glr-backref-module-torch-export sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/export.html#torch.export.ExportedProgram" title="torch.export.ExportedProgram" class="sphx-glr-backref-module-torch-export sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">t</span><span class="o">.</span><span class="n">exporter_status</span><span class="o">.</span><span class="n">exported</span></a></a></a> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[run_decompositions] </span><span class="si">{</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.dot_name" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.dot_name" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-property"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.dot_name" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.dot_name" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-property"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.dot_name" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.dot_name" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-property"><span class="n">t</span><span class="o">.</span><span class="n">dot_name</span></a></a></a><span class="si">}</span><span class="s2"> - skipped&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[run_decompositions] </span><span class="si">{</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.dot_name" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.dot_name" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-property"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.dot_name" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.dot_name" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-property"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.dot_name" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.dot_name" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-property"><span class="n">t</span><span class="o">.</span><span class="n">dot_name</span></a></a></a><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <a href="https://docs.pytorch.org/docs/main/export.html#torch.export.ExportedProgram" title="torch.export.ExportedProgram" class="sphx-glr-backref-module-torch-export sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/export.html#torch.export.ExportedProgram" title="torch.export.ExportedProgram" class="sphx-glr-backref-module-torch-export sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/export.html#torch.export.ExportedProgram" title="torch.export.ExportedProgram" class="sphx-glr-backref-module-torch-export sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">t</span><span class="o">.</span><span class="n">exporter_status</span><span class="o">.</span><span class="n">exported</span></a></a></a> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/export.html#torch.export.ExportedProgram.run_decompositions" title="torch.export.ExportedProgram.run_decompositions" class="sphx-glr-backref-module-torch-export sphx-glr-backref-type-py-method"><a href="https://docs.pytorch.org/docs/main/export.html#torch.export.ExportedProgram.run_decompositions" title="torch.export.ExportedProgram.run_decompositions" class="sphx-glr-backref-module-torch-export sphx-glr-backref-type-py-method"><a href="https://docs.pytorch.org/docs/main/export.html#torch.export.ExportedProgram.run_decompositions" title="torch.export.ExportedProgram.run_decompositions" class="sphx-glr-backref-module-torch-export sphx-glr-backref-type-py-method"><span class="n">t</span><span class="o">.</span><span class="n">exporter_status</span><span class="o">.</span><span class="n">exported</span><span class="o">.</span><span class="n">run_decompositions</span></a></a></a><span class="p">({})</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[run_decompositions]  M:__main__-TorchKNNImputer
[run_decompositions] .. M:dist-NanEuclidean
[run_decompositions] .. M:columns[0]-ColProcessor
[run_decompositions] .... M:_calc_impute-CalcImpute
[run_decompositions] ...... M:_weights-SubWeightMatrix
[run_decompositions] ...... M:_donors_idx-SubDonorsIdx
[run_decompositions] ...... M:_make_new_neights-MakeNewWeights
[run_decompositions] .... M:_col_cond-ColProcessorCond - skipped
[run_decompositions] ...... M:_all_nan-ColProcessorAllNan
[run_decompositions] ...... M:_identity-ColProcessorIdentity
[run_decompositions] .. M:columns[1]-ColProcessor
[run_decompositions] .... M:_calc_impute-CalcImpute
[run_decompositions] ...... M:_weights-SubWeightMatrix
[run_decompositions] ...... M:_donors_idx-SubDonorsIdx
[run_decompositions] ...... M:_make_new_neights-MakeNewWeights
[run_decompositions] .... M:_col_cond-ColProcessorCond - skipped
[run_decompositions] ...... M:_all_nan-ColProcessorAllNan
[run_decompositions] ...... M:_identity-ColProcessorIdentity
[run_decompositions] .. M:columns[2]-ColProcessor
[run_decompositions] .... M:_calc_impute-CalcImpute
[run_decompositions] ...... M:_weights-SubWeightMatrix
[run_decompositions] ...... M:_donors_idx-SubDonorsIdx
[run_decompositions] ...... M:_make_new_neights-MakeNewWeights
[run_decompositions] .... M:_col_cond-ColProcessorCond - skipped
[run_decompositions] ...... M:_all_nan-ColProcessorAllNan
[run_decompositions] ...... M:_identity-ColProcessorIdentity
[run_decompositions] .. M:_make_dict_idx_map-MakeDictIdxMap
</pre></div>
</div>
<p>Let’s run the conversion. We also check the conversion into ONNX
is accurate. It is doable because every intermediate results
were previously traced.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">onx</span> <span class="o">=</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.to_onnx_local" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.to_onnx_local" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.to_onnx_local" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.to_onnx_local" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.to_onnx_local" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput.to_onnx_local" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-method"><span class="n">trace</span><span class="o">.</span><span class="n">to_onnx_local</span></a></a></a><span class="p">(</span>
        <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">check_conversion_cls</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="bp">cls</span><span class="o">=</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/reference/index.html#experimental_experiment.reference.ExtendedReferenceEvaluator" title="experimental_experiment.reference.ExtendedReferenceEvaluator" class="sphx-glr-backref-module-experimental_experiment-reference sphx-glr-backref-type-py-class"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/reference/index.html#experimental_experiment.reference.ExtendedReferenceEvaluator" title="experimental_experiment.reference.ExtendedReferenceEvaluator" class="sphx-glr-backref-module-experimental_experiment-reference sphx-glr-backref-type-py-class"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/reference/index.html#experimental_experiment.reference.ExtendedReferenceEvaluator" title="experimental_experiment.reference.ExtendedReferenceEvaluator" class="sphx-glr-backref-module-experimental_experiment-reference sphx-glr-backref-type-py-class"><span class="n">ExtendedReferenceEvaluator</span></a></a></a><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">),</span>
        <span class="n">inline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The example is broken: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">onx</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[to_onnx_local]  M:__main__-TorchKNNImputer - to_onnx_local
[to_onnx_local]  M:__main__-TorchKNNImputer - export child &#39;C_TorchKNNImputer_dist&#39;
[to_onnx_local] .. M:dist-NanEuclidean - to_onnx_local
[to_onnx_local] .. M:dist-NanEuclidean - export starts C_TorchKNNImputer_dist
[to_onnx_local] .. M:dist-NanEuclidean - export done
[to_onnx_local] .. M:dist-NanEuclidean - run validation
[onnx_run_disc] .. M:dist-NanEuclidean run with cls=ExtendedReferenceEvaluator on ModelProto
[onnx_run_disc] .. M:dist-NanEuclidean run with ((T1s40x3,T1s50x3),{})
[onnx_run_disc] .. M:dist-NanEuclidean flattened into ((T1s40x3[nan,nan:AnanN80nans],T1s50x3[nan,nan:AnanN100nans]),{})
[onnx_run_disc] .. M:dist-NanEuclidean expecting (T1s40x50[nan,nan:AnanN1333nans],)
[onnx_run_disc] .. M:dist-NanEuclidean computing A1s40x50[0.0014024811098352075,7.827565670013428:A1.572636351330908N1333nans]
[onnx_run_disc] .. M:dist-NanEuclidean diff=abs=0.0, rel=0.0,amax=0,0
[onnx_run_disc] .. M:dist-NanEuclidean run with ((T1s10x3,T1s5x3),{})
[onnx_run_disc] .. M:dist-NanEuclidean flattened into ((T1s10x3[nan,nan:AnanN20nans],T1s5x3[nan,nan:AnanN10nans]),{})
[onnx_run_disc] .. M:dist-NanEuclidean expecting (T1s10x5[nan,nan:AnanN33nans],)
[onnx_run_disc] .. M:dist-NanEuclidean computing A1s10x5[0.0014024811098352075,4.854142665863037:A1.9105679926750085N33nans]
[onnx_run_disc] .. M:dist-NanEuclidean diff=abs=0.0, rel=0.0,amax=0,0
[onnx_run_disc] .. M:dist-NanEuclidean run with ((T1s1x3,T1s10x3),{})
[onnx_run_disc] .. M:dist-NanEuclidean flattened into ((T1s1x3[nan,nan:AnanN1nans],T1s10x3[nan,nan:AnanN1nans]),{})
[onnx_run_disc] .. M:dist-NanEuclidean expecting (T1s1x10[1.891329288482666,3.3306772708892822:A2.516362464427948],)
[onnx_run_disc] .. M:dist-NanEuclidean computing A1s1x10[1.891329288482666,3.3306772708892822:A2.516362464427948]
[onnx_run_disc] .. M:dist-NanEuclidean diff=abs=0.0, rel=0.0,amax=0,0
[onnx_run_disc] .. M:dist-NanEuclidean run with ((T1s1x3,T1s11x3),{})
[onnx_run_disc] .. M:dist-NanEuclidean flattened into ((T1s1x3[nan,nan:AnanN1nans],T1s11x3[nan,nan:AnanN1nans]),{})
[onnx_run_disc] .. M:dist-NanEuclidean expecting (T1s1x11[0.6446343064308167,3.4043798446655273:A1.950129048390822],)
[onnx_run_disc] .. M:dist-NanEuclidean computing A1s1x11[0.6446343064308167,3.4043798446655273:A1.950129048390822]
[onnx_run_disc] .. M:dist-NanEuclidean diff=abs=0.0, rel=0.0,amax=0,0
[onnx_run_disc] .. M:dist-NanEuclidean run with ((T1s40x3,T1s50x3),{})
[onnx_run_disc] .. M:dist-NanEuclidean flattened into ((T1s40x3[nan,nan:AnanN80nans],T1s50x3[nan,nan:AnanN100nans]),{})
[onnx_run_disc] .. M:dist-NanEuclidean expecting (T1s40x50[nan,nan:AnanN1333nans],)
[onnx_run_disc] .. M:dist-NanEuclidean computing A1s40x50[0.0014024811098352075,7.827565670013428:A1.572636351330908N1333nans]
[onnx_run_disc] .. M:dist-NanEuclidean diff=abs=0.0, rel=0.0,amax=0,0
[onnx_run_disc] .. M:dist-NanEuclidean run with ((T1s10x3,T1s5x3),{})
[onnx_run_disc] .. M:dist-NanEuclidean flattened into ((T1s10x3[nan,nan:AnanN20nans],T1s5x3[nan,nan:AnanN10nans]),{})
[onnx_run_disc] .. M:dist-NanEuclidean expecting (T1s10x5[nan,nan:AnanN33nans],)
[onnx_run_disc] .. M:dist-NanEuclidean computing A1s10x5[0.0014024811098352075,4.854142665863037:A1.9105679926750085N33nans]
[onnx_run_disc] .. M:dist-NanEuclidean diff=abs=0.0, rel=0.0,amax=0,0
[onnx_run_disc] .. M:dist-NanEuclidean run with ((T1s1x3,T1s10x3),{})
[onnx_run_disc] .. M:dist-NanEuclidean flattened into ((T1s1x3[nan,nan:AnanN1nans],T1s10x3[nan,nan:AnanN1nans]),{})
[onnx_run_disc] .. M:dist-NanEuclidean expecting (T1s1x10[1.891329288482666,3.3306772708892822:A2.5163624405860903],)
[onnx_run_disc] .. M:dist-NanEuclidean computing A1s1x10[1.891329288482666,3.3306772708892822:A2.5163624405860903]
[onnx_run_disc] .. M:dist-NanEuclidean diff=abs=0.0, rel=0.0,amax=0,0
[onnx_run_disc] .. M:dist-NanEuclidean run with ((T1s1x3,T1s11x3),{})
[onnx_run_disc] .. M:dist-NanEuclidean flattened into ((T1s1x3[nan,nan:AnanN1nans],T1s11x3[nan,nan:AnanN1nans]),{})
[onnx_run_disc] .. M:dist-NanEuclidean expecting (T1s1x11[0.6446343064308167,3.4043798446655273:A1.950129048390822],)
[onnx_run_disc] .. M:dist-NanEuclidean computing A1s1x11[0.6446343064308167,3.4043798446655273:A1.950129048390822]
[onnx_run_disc] .. M:dist-NanEuclidean diff=abs=0.0, rel=0.0,amax=0,0
[onnx_run_disc] .. M:dist-NanEuclidean run with ((T1s40x3,T1s50x3),{})
[onnx_run_disc] .. M:dist-NanEuclidean flattened into ((T1s40x3[nan,nan:AnanN80nans],T1s50x3[nan,nan:AnanN100nans]),{})
[onnx_run_disc] .. M:dist-NanEuclidean expecting (T1s40x50[nan,nan:AnanN1333nans],)
[onnx_run_disc] .. M:dist-NanEuclidean computing A1s40x50[0.0014024811098352075,7.827565670013428:A1.572636351330908N1333nans]
[onnx_run_disc] .. M:dist-NanEuclidean diff=abs=0.0, rel=0.0,amax=0,0
[onnx_run_disc] .. M:dist-NanEuclidean run with ((T1s10x3,T1s5x3),{})
[onnx_run_disc] .. M:dist-NanEuclidean flattened into ((T1s10x3[nan,nan:AnanN20nans],T1s5x3[nan,nan:AnanN10nans]),{})
[onnx_run_disc] .. M:dist-NanEuclidean expecting (T1s10x5[nan,nan:AnanN33nans],)
[onnx_run_disc] .. M:dist-NanEuclidean computing A1s10x5[0.0014024811098352075,4.854142665863037:A1.9105679926750085N33nans]
[onnx_run_disc] .. M:dist-NanEuclidean diff=abs=0.0, rel=0.0,amax=0,0
[onnx_run_disc] .. M:dist-NanEuclidean run with ((T1s1x3,T1s10x3),{})
[onnx_run_disc] .. M:dist-NanEuclidean flattened into ((T1s1x3[nan,nan:AnanN1nans],T1s10x3[nan,nan:AnanN1nans]),{})
[onnx_run_disc] .. M:dist-NanEuclidean expecting (T1s1x10[1.891329288482666,3.330677032470703:A2.5163624405860903],)
[onnx_run_disc] .. M:dist-NanEuclidean computing A1s1x10[1.891329288482666,3.330677032470703:A2.5163624405860903]
[onnx_run_disc] .. M:dist-NanEuclidean diff=abs=0.0, rel=0.0,amax=0,0
[onnx_run_disc] .. M:dist-NanEuclidean run with ((T1s1x3,T1s11x3),{})
[onnx_run_disc] .. M:dist-NanEuclidean flattened into ((T1s1x3[nan,nan:AnanN1nans],T1s11x3[nan,nan:AnanN1nans]),{})
[onnx_run_disc] .. M:dist-NanEuclidean expecting (T1s1x11[0.6446343064308167,3.4043798446655273:A1.950129048390822],)
[onnx_run_disc] .. M:dist-NanEuclidean computing A1s1x11[0.6446343064308167,3.4043798446655273:A1.950129048390822]
[onnx_run_disc] .. M:dist-NanEuclidean diff=abs=0.0, rel=0.0,amax=0,0
[onnx_run_disc] .. M:dist-NanEuclidean validation done
[to_onnx_local] .. M:dist-NanEuclidean - done
[to_onnx_local] .. M:dist-NanEuclidean - discrepancies: abs=0.0, rel=0.0,amax=0,0
[to_onnx_local] .. M:dist-NanEuclidean - discrepancies: abs=0.0, rel=0.0,amax=0,0
[to_onnx_local] .. M:dist-NanEuclidean - discrepancies: abs=0.0, rel=0.0,amax=0,0
[to_onnx_local] .. M:dist-NanEuclidean - discrepancies: abs=0.0, rel=0.0,amax=0,0
[to_onnx_local] .. M:dist-NanEuclidean - discrepancies: abs=0.0, rel=0.0,amax=0,0
[to_onnx_local] .. M:dist-NanEuclidean - discrepancies: abs=0.0, rel=0.0,amax=0,0
[to_onnx_local] .. M:dist-NanEuclidean - discrepancies: abs=0.0, rel=0.0,amax=0,0
[to_onnx_local] .. M:dist-NanEuclidean - discrepancies: abs=0.0, rel=0.0,amax=0,0
[to_onnx_local] .. M:dist-NanEuclidean - discrepancies: abs=0.0, rel=0.0,amax=0,0
[to_onnx_local] .. M:dist-NanEuclidean - discrepancies: abs=0.0, rel=0.0,amax=0,0
[to_onnx_local] .. M:dist-NanEuclidean - discrepancies: abs=0.0, rel=0.0,amax=0,0
[to_onnx_local] .. M:dist-NanEuclidean - discrepancies: abs=0.0, rel=0.0,amax=0,0
[to_onnx_local]  M:__main__-TorchKNNImputer - export child &#39;C_TorchKNNImputer_columns_0_&#39;
[to_onnx_local] .. M:columns[0]-ColProcessor - to_onnx_local
[to_onnx_local] .. M:columns[0]-ColProcessor - export child &#39;C_TorchKNNImputer_columns_0___calc_impute&#39;
[to_onnx_local] .... M:_calc_impute-CalcImpute - to_onnx_local
[to_onnx_local] .... M:_calc_impute-CalcImpute - export child &#39;C_TorchKNNImputer_columns_0___calc_impute__weights&#39;
[to_onnx_local] ...... M:_weights-SubWeightMatrix - to_onnx_local
[to_onnx_local] ...... M:_weights-SubWeightMatrix - export starts C_TorchKNNImputer_columns_0___calc_impute__weights
[to_onnx_local] ...... M:_weights-SubWeightMatrix - export done
[to_onnx_local] ...... M:_weights-SubWeightMatrix - run validation
[onnx_run_disc] ...... M:_weights-SubWeightMatrix run with cls=ExtendedReferenceEvaluator on ModelProto
[onnx_run_disc] ...... M:_weights-SubWeightMatrix run with ((T1s0x3,),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix flattened into ((T1s0x3[empty],),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix expecting (T1s0x3[empty],)
[onnx_run_disc] ...... M:_weights-SubWeightMatrix computing A1s0x3[empty]
[onnx_run_disc] ...... M:_weights-SubWeightMatrix diff=abs=0, rel=0,amax=None
[onnx_run_disc] ...... M:_weights-SubWeightMatrix run with ((T1s0x2,),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix flattened into ((T1s0x2[empty],),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix expecting (T1s0x2[empty],)
[onnx_run_disc] ...... M:_weights-SubWeightMatrix computing A1s0x2[empty]
[onnx_run_disc] ...... M:_weights-SubWeightMatrix diff=abs=0, rel=0,amax=None
[onnx_run_disc] ...... M:_weights-SubWeightMatrix run with ((T1s1x3,),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix flattened into ((T1s1x3[1.960836410522461,2.320211172103882:A2.0816839933395386],),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix expecting (T1s1x3[1.0,1.0:A1.0],)
[onnx_run_disc] ...... M:_weights-SubWeightMatrix computing A1s1x3[1.0,1.0:A1.0]
[onnx_run_disc] ...... M:_weights-SubWeightMatrix diff=abs=0.0, rel=0.0,amax=0,0
[onnx_run_disc] ...... M:_weights-SubWeightMatrix run with ((T1s1x3,),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix flattened into ((T1s1x3[0.6446343064308167,1.6473352909088135:A1.0984085599581401],),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix expecting (T1s1x3[1.0,1.0:A1.0],)
[onnx_run_disc] ...... M:_weights-SubWeightMatrix computing A1s1x3[1.0,1.0:A1.0]
[onnx_run_disc] ...... M:_weights-SubWeightMatrix diff=abs=0.0, rel=0.0,amax=0,0
[onnx_run_disc] ...... M:_weights-SubWeightMatrix run with ((T1s0x3,),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix flattened into ((T1s0x3[empty],),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix expecting (T1s0x3[empty],)
[onnx_run_disc] ...... M:_weights-SubWeightMatrix computing A1s0x3[empty]
[onnx_run_disc] ...... M:_weights-SubWeightMatrix diff=abs=0, rel=0,amax=None
[onnx_run_disc] ...... M:_weights-SubWeightMatrix run with ((T1s0x1,),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix flattened into ((T1s0x1[empty],),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix expecting (T1s0x1[empty],)
[onnx_run_disc] ...... M:_weights-SubWeightMatrix computing A1s0x1[empty]
[onnx_run_disc] ...... M:_weights-SubWeightMatrix diff=abs=0, rel=0,amax=None
[onnx_run_disc] ...... M:_weights-SubWeightMatrix run with ((T1s0x3,),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix flattened into ((T1s0x3[empty],),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix expecting (T1s0x3[empty],)
[onnx_run_disc] ...... M:_weights-SubWeightMatrix computing A1s0x3[empty]
[onnx_run_disc] ...... M:_weights-SubWeightMatrix diff=abs=0, rel=0,amax=None
[onnx_run_disc] ...... M:_weights-SubWeightMatrix run with ((T1s0x3,),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix flattened into ((T1s0x3[empty],),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix expecting (T1s0x3[empty],)
[onnx_run_disc] ...... M:_weights-SubWeightMatrix computing A1s0x3[empty]
[onnx_run_disc] ...... M:_weights-SubWeightMatrix diff=abs=0, rel=0,amax=None
[onnx_run_disc] ...... M:_weights-SubWeightMatrix run with ((T1s0x3,),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix flattened into ((T1s0x3[empty],),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix expecting (T1s0x3[empty],)
[onnx_run_disc] ...... M:_weights-SubWeightMatrix computing A1s0x3[empty]
[onnx_run_disc] ...... M:_weights-SubWeightMatrix diff=abs=0, rel=0,amax=None
[onnx_run_disc] ...... M:_weights-SubWeightMatrix run with ((T1s0x2,),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix flattened into ((T1s0x2[empty],),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix expecting (T1s0x2[empty],)
[onnx_run_disc] ...... M:_weights-SubWeightMatrix computing A1s0x2[empty]
[onnx_run_disc] ...... M:_weights-SubWeightMatrix diff=abs=0, rel=0,amax=None
[onnx_run_disc] ...... M:_weights-SubWeightMatrix run with ((T1s0x3,),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix flattened into ((T1s0x3[empty],),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix expecting (T1s0x3[empty],)
[onnx_run_disc] ...... M:_weights-SubWeightMatrix computing A1s0x3[empty]
[onnx_run_disc] ...... M:_weights-SubWeightMatrix diff=abs=0, rel=0,amax=None
[onnx_run_disc] ...... M:_weights-SubWeightMatrix run with ((T1s0x3,),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix flattened into ((T1s0x3[empty],),{})
[onnx_run_disc] ...... M:_weights-SubWeightMatrix expecting (T1s0x3[empty],)
[onnx_run_disc] ...... M:_weights-SubWeightMatrix computing A1s0x3[empty]
[onnx_run_disc] ...... M:_weights-SubWeightMatrix diff=abs=0, rel=0,amax=None
[onnx_run_disc] ...... M:_weights-SubWeightMatrix validation done
[to_onnx_local] ...... M:_weights-SubWeightMatrix - done
[to_onnx_local] ...... M:_weights-SubWeightMatrix - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] ...... M:_weights-SubWeightMatrix - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] ...... M:_weights-SubWeightMatrix - discrepancies: abs=0.0, rel=0.0,amax=0,0
[to_onnx_local] ...... M:_weights-SubWeightMatrix - discrepancies: abs=0.0, rel=0.0,amax=0,0
[to_onnx_local] ...... M:_weights-SubWeightMatrix - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] ...... M:_weights-SubWeightMatrix - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] ...... M:_weights-SubWeightMatrix - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] ...... M:_weights-SubWeightMatrix - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] ...... M:_weights-SubWeightMatrix - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] ...... M:_weights-SubWeightMatrix - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] ...... M:_weights-SubWeightMatrix - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] ...... M:_weights-SubWeightMatrix - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] .... M:_calc_impute-CalcImpute - export child &#39;C_TorchKNNImputer_columns_0___calc_impute__donors_idx&#39;
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - to_onnx_local
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - export starts C_TorchKNNImputer_columns_0___calc_impute__donors_idx
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - export done
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - run validation
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx run with cls=ExtendedReferenceEvaluator on ModelProto
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx run with ((T1s0x17,T7s1),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx flattened into ((T1s0x17[empty],T7s1[3,3:A3.0]),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx expecting (T7s0x3[empty],T1s0x3[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx computing (A7s0x3[empty],A1s0x3[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx diff=abs=0, rel=0
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx run with ((T1s0x2,T7s1),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx flattened into ((T1s0x2[empty],T7s1[2,2:A2.0]),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx expecting (T7s0x2[empty],T1s0x2[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx computing (A7s0x2[empty],A1s0x2[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx diff=abs=0, rel=0
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx run with ((T1s1x9,T7s1),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx flattened into ((T1s1x9[1.960836410522461,3.3306772708892822:A2.585810595088535],T7s1[3,3:A3.0]),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx expecting (T7s1x3[0,7:A3.6666666666666665],T1s1x3[1.960836410522461,2.320211172103882:A2.0816839933395386])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx computing (A7s1x3[0,7:A3.6666666666666665],A1s1x3[1.960836410522461,2.320211172103882:A2.0816839933395386])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx diff=abs=0, rel=0
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx run with ((T1s1x10,T7s1),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx flattened into ((T1s1x10[0.6446343064308167,3.4043798446655273:A1.947733038663864],T7s1[3,3:A3.0]),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx expecting (T7s1x3[1,9:A5.333333333333333],T1s1x3[0.6446343064308167,1.6473352909088135:A1.0984085599581401])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx computing (A7s1x3[1,9:A5.333333333333333],A1s1x3[0.6446343064308167,1.6473352909088135:A1.0984085599581401])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx diff=abs=0, rel=0
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx run with ((T1s0x16,T7s1),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx flattened into ((T1s0x16[empty],T7s1[3,3:A3.0]),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx expecting (T7s0x3[empty],T1s0x3[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx computing (A7s0x3[empty],A1s0x3[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx diff=abs=0, rel=0
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx run with ((T1s0x1,T7s1),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx flattened into ((T1s0x1[empty],T7s1[1,1:A1.0]),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx expecting (T7s0x1[empty],T1s0x1[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx computing (A7s0x1[empty],A1s0x1[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx diff=abs=0, rel=0
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx run with ((T1s0x10,T7s1),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx flattened into ((T1s0x10[empty],T7s1[3,3:A3.0]),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx expecting (T7s0x3[empty],T1s0x3[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx computing (A7s0x3[empty],A1s0x3[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx diff=abs=0, rel=0
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx run with ((T1s0x11,T7s1),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx flattened into ((T1s0x11[empty],T7s1[3,3:A3.0]),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx expecting (T7s0x3[empty],T1s0x3[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx computing (A7s0x3[empty],A1s0x3[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx diff=abs=0, rel=0
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx run with ((T1s0x17,T7s1),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx flattened into ((T1s0x17[empty],T7s1[3,3:A3.0]),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx expecting (T7s0x3[empty],T1s0x3[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx computing (A7s0x3[empty],A1s0x3[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx diff=abs=0, rel=0
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx run with ((T1s0x2,T7s1),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx flattened into ((T1s0x2[empty],T7s1[2,2:A2.0]),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx expecting (T7s0x2[empty],T1s0x2[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx computing (A7s0x2[empty],A1s0x2[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx diff=abs=0, rel=0
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx run with ((T1s0x10,T7s1),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx flattened into ((T1s0x10[empty],T7s1[3,3:A3.0]),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx expecting (T7s0x3[empty],T1s0x3[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx computing (A7s0x3[empty],A1s0x3[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx diff=abs=0, rel=0
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx run with ((T1s0x11,T7s1),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx flattened into ((T1s0x11[empty],T7s1[3,3:A3.0]),{})
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx expecting (T7s0x3[empty],T1s0x3[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx computing (A7s0x3[empty],A1s0x3[empty])
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx diff=abs=0, rel=0
[onnx_run_disc] ...... M:_donors_idx-SubDonorsIdx validation done
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - done
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - discrepancies: abs=0, rel=0
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - discrepancies: abs=0, rel=0
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - discrepancies: abs=0, rel=0
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - discrepancies: abs=0, rel=0
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - discrepancies: abs=0, rel=0
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - discrepancies: abs=0, rel=0
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - discrepancies: abs=0, rel=0
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - discrepancies: abs=0, rel=0
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - discrepancies: abs=0, rel=0
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - discrepancies: abs=0, rel=0
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - discrepancies: abs=0, rel=0
[to_onnx_local] ...... M:_donors_idx-SubDonorsIdx - discrepancies: abs=0, rel=0
[to_onnx_local] .... M:_calc_impute-CalcImpute - export child &#39;C_TorchKNNImputer_columns_0___calc_impute__make_new_neights&#39;
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - to_onnx_local
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - export starts C_TorchKNNImputer_columns_0___calc_impute__make_new_neights
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - export done
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - run validation
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights run with cls=ExtendedReferenceEvaluator on ModelProto
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights run with ((T7s0x3,T1s0x3,T1s0x3),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights flattened into ((T7s0x3[empty],T1s0x3[empty],T1s0x3[empty]),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights expecting (T1s0x3[empty],)
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights computing A1s0x3[empty]
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights diff=abs=0, rel=0,amax=None
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights run with ((T7s0x2,T1s0x2,T1s0x2),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights flattened into ((T7s0x2[empty],T1s0x2[empty],T1s0x2[empty]),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights expecting (T1s0x2[empty],)
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights computing A1s0x2[empty]
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights diff=abs=0, rel=0,amax=None
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights run with ((T7s1x3,T1s1x3,T1s1x3),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights flattened into ((T7s1x3[1,1:A1.0],T1s1x3[0.2025328278541565,0.9459595680236816:A0.6728987495104471],T1s1x3[1.0,1.0:A1.0]),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights expecting (T1s1x3[1.0,1.0:A1.0],)
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights computing A1s1x3[1.0,1.0:A1.0]
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights diff=abs=0.0, rel=0.0,amax=0,0
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights run with ((T7s1x3,T1s1x3,T1s1x3),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights flattened into ((T7s1x3[1,1:A1.0],T1s1x3[-0.7442224621772766,0.23930585384368896:A-0.3183303078015645],T1s1x3[1.0,1.0:A1.0]),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights expecting (T1s1x3[1.0,1.0:A1.0],)
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights computing A1s1x3[1.0,1.0:A1.0]
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights diff=abs=0.0, rel=0.0,amax=0,0
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights run with ((T7s0x3,T1s0x3,T1s0x3),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights flattened into ((T7s0x3[empty],T1s0x3[empty],T1s0x3[empty]),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights expecting (T1s0x3[empty],)
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights computing A1s0x3[empty]
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights diff=abs=0, rel=0,amax=None
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights run with ((T7s0x1,T1s0x1,T1s0x1),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights flattened into ((T7s0x1[empty],T1s0x1[empty],T1s0x1[empty]),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights expecting (T1s0x1[empty],)
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights computing A1s0x1[empty]
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights diff=abs=0, rel=0,amax=None
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights run with ((T7s0x3,T1s0x3,T1s0x3),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights flattened into ((T7s0x3[empty],T1s0x3[empty],T1s0x3[empty]),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights expecting (T1s0x3[empty],)
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights computing A1s0x3[empty]
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights diff=abs=0, rel=0,amax=None
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights run with ((T7s0x3,T1s0x3,T1s0x3),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights flattened into ((T7s0x3[empty],T1s0x3[empty],T1s0x3[empty]),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights expecting (T1s0x3[empty],)
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights computing A1s0x3[empty]
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights diff=abs=0, rel=0,amax=None
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights run with ((T7s0x3,T1s0x3,T1s0x3),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights flattened into ((T7s0x3[empty],T1s0x3[empty],T1s0x3[empty]),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights expecting (T1s0x3[empty],)
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights computing A1s0x3[empty]
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights diff=abs=0, rel=0,amax=None
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights run with ((T7s0x2,T1s0x2,T1s0x2),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights flattened into ((T7s0x2[empty],T1s0x2[empty],T1s0x2[empty]),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights expecting (T1s0x2[empty],)
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights computing A1s0x2[empty]
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights diff=abs=0, rel=0,amax=None
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights run with ((T7s0x3,T1s0x3,T1s0x3),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights flattened into ((T7s0x3[empty],T1s0x3[empty],T1s0x3[empty]),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights expecting (T1s0x3[empty],)
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights computing A1s0x3[empty]
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights diff=abs=0, rel=0,amax=None
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights run with ((T7s0x3,T1s0x3,T1s0x3),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights flattened into ((T7s0x3[empty],T1s0x3[empty],T1s0x3[empty]),{})
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights expecting (T1s0x3[empty],)
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights computing A1s0x3[empty]
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights diff=abs=0, rel=0,amax=None
[onnx_run_disc] ...... M:_make_new_neights-MakeNewWeights validation done
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - done
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - discrepancies: abs=0.0, rel=0.0,amax=0,0
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - discrepancies: abs=0.0, rel=0.0,amax=0,0
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] ...... M:_make_new_neights-MakeNewWeights - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] .... M:_calc_impute-CalcImpute - export starts C_TorchKNNImputer_columns_0___calc_impute
[to_onnx_local] .... M:_calc_impute-CalcImpute - export done
[to_onnx_local] .... M:_calc_impute-CalcImpute - run validation
[onnx_run_disc] .... M:_calc_impute-CalcImpute run with cls=ExtendedReferenceEvaluator on ModelProto
[onnx_run_disc] .... M:_calc_impute-CalcImpute run with ((T1s0x17,T7s1,T1s17,T9s17),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute flattened into ((T1s0x17[empty],T7s1[3,3:A3.0],T1s17[-1.0490533113479614,1.4862864017486572:A0.05360487717039445],T9s17[False,False:A0.0]),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute expecting (T1s0[empty],)
[onnx_run_disc] .... M:_calc_impute-CalcImpute computing A1s0[empty]
[onnx_run_disc] .... M:_calc_impute-CalcImpute diff=abs=0, rel=0,amax=None
[onnx_run_disc] .... M:_calc_impute-CalcImpute run with ((T1s0x2,T7s1,T1s2,T9s2),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute flattened into ((T1s0x2[empty],T7s1[2,2:A2.0],T1s2[-1.0841875076293945,0.28655949234962463:A-0.39881400763988495],T9s2[False,False:A0.0]),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute expecting (T1s0[empty],)
[onnx_run_disc] .... M:_calc_impute-CalcImpute computing A1s0[empty]
[onnx_run_disc] .... M:_calc_impute-CalcImpute diff=abs=0, rel=0,amax=None
[onnx_run_disc] .... M:_calc_impute-CalcImpute run with ((T1s1x9,T7s1,T1s9,T9s9),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute flattened into ((T1s1x9[1.960836410522461,3.3306772708892822:A2.585810595088535],T7s1[3,3:A3.0],T1s9[-2.2622437477111816,0.9459595680236816:A-0.2179878850777944],T9s9[False,False:A0.0]),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute expecting (T1s1[0.6728987693786621,0.6728987693786621:A0.6728987693786621],)
[onnx_run_disc] .... M:_calc_impute-CalcImpute computing A1s1[0.6728987693786621,0.6728987693786621:A0.6728987693786621]
[onnx_run_disc] .... M:_calc_impute-CalcImpute diff=abs=0.0, rel=0.0,amax=0
[onnx_run_disc] .... M:_calc_impute-CalcImpute run with ((T1s1x10,T7s1,T1s10,T9s10),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute flattened into ((T1s1x10[0.6446343064308167,3.4043798446655273:A1.947733038663864],T7s1[3,3:A3.0],T1s10[-1.0289477109909058,1.3091744184494019:A-0.06142359673976898],T9s10[False,False:A0.0]),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute expecting (T1s1[-0.318330317735672,-0.318330317735672:A-0.318330317735672],)
[onnx_run_disc] .... M:_calc_impute-CalcImpute computing A1s1[-0.318330317735672,-0.318330317735672:A-0.318330317735672]
[onnx_run_disc] .... M:_calc_impute-CalcImpute diff=abs=0.0, rel=0.0,amax=0
[onnx_run_disc] .... M:_calc_impute-CalcImpute run with ((T1s0x16,T7s1,T1s16,T9s16),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute flattened into ((T1s0x16[empty],T7s1[3,3:A3.0],T1s16[-1.5512176752090454,1.0594156980514526:A-0.16428888589143753],T9s16[False,False:A0.0]),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute expecting (T1s0[empty],)
[onnx_run_disc] .... M:_calc_impute-CalcImpute computing A1s0[empty]
[onnx_run_disc] .... M:_calc_impute-CalcImpute diff=abs=0, rel=0,amax=None
[onnx_run_disc] .... M:_calc_impute-CalcImpute run with ((T1s0x1,T7s1,T1s1,T9s1),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute flattened into ((T1s0x1[empty],T7s1[1,1:A1.0],T1s1[0.5527158379554749,0.5527158379554749:A0.5527158379554749],T9s1[False,False:A0.0]),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute expecting (T1s0[empty],)
[onnx_run_disc] .... M:_calc_impute-CalcImpute computing A1s0[empty]
[onnx_run_disc] .... M:_calc_impute-CalcImpute diff=abs=0, rel=0,amax=None
[onnx_run_disc] .... M:_calc_impute-CalcImpute run with ((T1s0x10,T7s1,T1s10,T9s10),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute flattened into ((T1s0x10[empty],T7s1[3,3:A3.0],T1s10[-1.9389777183532715,1.426966905593872:A-0.5683467619121074],T9s10[False,False:A0.0]),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute expecting (T1s0[empty],)
[onnx_run_disc] .... M:_calc_impute-CalcImpute computing A1s0[empty]
[onnx_run_disc] .... M:_calc_impute-CalcImpute diff=abs=0, rel=0,amax=None
[onnx_run_disc] .... M:_calc_impute-CalcImpute run with ((T1s0x11,T7s1,T1s11,T9s11),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute flattened into ((T1s0x11[empty],T7s1[3,3:A3.0],T1s11[-1.745384693145752,1.8026071786880493:A0.23856408157470552],T9s11[False,False:A0.0]),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute expecting (T1s0[empty],)
[onnx_run_disc] .... M:_calc_impute-CalcImpute computing A1s0[empty]
[onnx_run_disc] .... M:_calc_impute-CalcImpute diff=abs=0, rel=0,amax=None
[onnx_run_disc] .... M:_calc_impute-CalcImpute run with ((T1s0x17,T7s1,T1s17,T9s17),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute flattened into ((T1s0x17[empty],T7s1[3,3:A3.0],T1s17[-1.9769785404205322,1.096831202507019:A-0.06690350366646752],T9s17[False,False:A0.0]),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute expecting (T1s0[empty],)
[onnx_run_disc] .... M:_calc_impute-CalcImpute computing A1s0[empty]
[onnx_run_disc] .... M:_calc_impute-CalcImpute diff=abs=0, rel=0,amax=None
[onnx_run_disc] .... M:_calc_impute-CalcImpute run with ((T1s0x2,T7s1,T1s2,T9s2),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute flattened into ((T1s0x2[empty],T7s1[2,2:A2.0],T1s2[-1.8390218019485474,0.472423791885376:A-0.6832990050315857],T9s2[False,False:A0.0]),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute expecting (T1s0[empty],)
[onnx_run_disc] .... M:_calc_impute-CalcImpute computing A1s0[empty]
[onnx_run_disc] .... M:_calc_impute-CalcImpute diff=abs=0, rel=0,amax=None
[onnx_run_disc] .... M:_calc_impute-CalcImpute run with ((T1s0x10,T7s1,T1s10,T9s10),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute flattened into ((T1s0x10[empty],T7s1[3,3:A3.0],T1s10[-1.918097734451294,2.5004260540008545:A-0.2677750276401639],T9s10[False,False:A0.0]),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute expecting (T1s0[empty],)
[onnx_run_disc] .... M:_calc_impute-CalcImpute computing A1s0[empty]
[onnx_run_disc] .... M:_calc_impute-CalcImpute diff=abs=0, rel=0,amax=None
[onnx_run_disc] .... M:_calc_impute-CalcImpute run with ((T1s0x11,T7s1,T1s11,T9s11),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute flattened into ((T1s0x11[empty],T7s1[3,3:A3.0],T1s11[-0.9313030242919922,0.7051165103912354:A-0.03593648805029013],T9s11[False,False:A0.0]),{})
[onnx_run_disc] .... M:_calc_impute-CalcImpute expecting (T1s0[empty],)
[onnx_run_disc] .... M:_calc_impute-CalcImpute computing A1s0[empty]
[onnx_run_disc] .... M:_calc_impute-CalcImpute diff=abs=0, rel=0,amax=None
[onnx_run_disc] .... M:_calc_impute-CalcImpute validation done
[to_onnx_local] .... M:_calc_impute-CalcImpute - done
[to_onnx_local] .... M:_calc_impute-CalcImpute - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] .... M:_calc_impute-CalcImpute - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] .... M:_calc_impute-CalcImpute - discrepancies: abs=0.0, rel=0.0,amax=0
[to_onnx_local] .... M:_calc_impute-CalcImpute - discrepancies: abs=0.0, rel=0.0,amax=0
[to_onnx_local] .... M:_calc_impute-CalcImpute - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] .... M:_calc_impute-CalcImpute - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] .... M:_calc_impute-CalcImpute - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] .... M:_calc_impute-CalcImpute - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] .... M:_calc_impute-CalcImpute - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] .... M:_calc_impute-CalcImpute - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] .... M:_calc_impute-CalcImpute - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] .... M:_calc_impute-CalcImpute - discrepancies: abs=0, rel=0,amax=None
[to_onnx_local] .. M:columns[0]-ColProcessor - export child &#39;C_TorchKNNImputer_columns_0___col_cond&#39;
The example is broken: _col_cond:ColProcessorCond: exporter failed, status=&lt;StatusExportCode.FAIL_CHILDC: 6&gt;, reason=&#39;Dynamo failed to run FX node with fake tensors: call_function cond(*(s2, GraphModule(), GraphModule(), (FakeTensor(..., size=(s85, 3)), FakeTensor(..., size=(s57, s30)), FakeTensor(..., size=(s84, 3), dtype=torch.bool), FakeTensor(..., size=(s52, 3)), FakeTensor(..., size=(s94,), dtype=torch.int64), FakeTensor(..., size=(s29,), dtype=torch.int64), FakeTensor(..., size=(s72,), dtype=torch.bool), FakeTensor(..., size=(s79, s54)), FakeTensor(..., size=(s31,), dtype=torch.int64), FakeTensor(..., size=(s96,), dtype=torch.int64))), **{}): got AssertionError((0, 1)) ---  --- from user code: ---    File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_higher_order_ops/cond.py&quot;, line 184, in _cond_op_wrapper ---     return cond_op(*args, **kwargs) ---  --- Set TORCHDYNAMO_VERBOSE=1 for the internal stack trace (please do this especially if you\&#39;re reporting a bug to PyTorch). For even more developer context, set TORCH_LOGS=&quot;+dynamo&quot; --- [\&#39;Traceback (most recent call last):\\n\&#39;, \&#39;  File &quot;~/github/experimental-experiment/experimental_experiment/torch_interpreter/piece_by_piece.py&quot;, line 1587, in _try_export_no_bypass_export\\n    ep = torch.export.export(\\n         ^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/export/__init__.py&quot;, line 319, in export\\n    raise e\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/export/__init__.py&quot;, line 286, in export\\n    return _export(\\n           ^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/export/_trace.py&quot;, line 1159, in wrapper\\n    raise e\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/export/_trace.py&quot;, line 1125, in wrapper\\n    ep = fn(*args, **kwargs)\\n         ^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/export/exported_program.py&quot;, line 123, in wrapper\\n    return fn(*args, **kwargs)\\n           ^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/export/_trace.py&quot;, line 2172, in _export\\n    ep = _export_for_training(\\n         ^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/export/_trace.py&quot;, line 1159, in wrapper\\n    raise e\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/export/_trace.py&quot;, line 1125, in wrapper\\n    ep = fn(*args, **kwargs)\\n         ^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/export/exported_program.py&quot;, line 123, in wrapper\\n    return fn(*args, **kwargs)\\n           ^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/export/_trace.py&quot;, line 2033, in _export_for_training\\n    export_artifact = export_func(\\n                      ^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/export/_trace.py&quot;, line 1975, in _non_strict_export\\n    aten_export_artifact = _to_aten_func(  # type: ignore[operator]\\n                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/export/_trace.py&quot;, line 1760, in _export_to_aten_ir_make_fx\\n    gm, graph_signature = transform(_make_fx_helper)(\\n                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/export/_trace.py&quot;, line 1901, in _aot_export_non_strict\\n    gm, sig = aot_export(wrapped_mod, args, kwargs=kwargs, **flags)\\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/export/_trace.py&quot;, line 1679, in _make_fx_helper\\n    gm = make_fx(\\n         ^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/fx/experimental/proxy_tensor.py&quot;, line 2290, in wrapped\\n    return make_fx_tracer.trace(f, *args)\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/fx/experimental/proxy_tensor.py&quot;, line 2228, in trace\\n    return self._trace_inner(f, *args)\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/fx/experimental/proxy_tensor.py&quot;, line 2199, in _trace_inner\\n    t = dispatch_trace(\\n        ^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_compile.py&quot;, line 51, in inner\\n    return disable_fn(*args, **kwargs)\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/eval_frame.py&quot;, line 893, in _fn\\n    return fn(*args, **kwargs)\\n           ^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/fx/experimental/proxy_tensor.py&quot;, line 1223, in dispatch_trace\\n    graph = tracer.trace(root, concrete_args)  # type: ignore[arg-type]\\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/fx/experimental/proxy_tensor.py&quot;, line 1787, in trace\\n    res = super().trace(root, concrete_args)\\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/fx/_symbolic_trace.py&quot;, line 850, in trace\\n    (self.create_arg(fn(*args)),),\\n                     ^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/fx/experimental/proxy_tensor.py&quot;, line 1278, in wrapped\\n    out = f(*tensors)  # type:ignore[call-arg]\\n          ^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;&lt;string&gt;&quot;, line 1, in &lt;lambda&gt;\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/export/_trace.py&quot;, line 1583, in wrapped_fn\\n    return tuple(flat_fn(*args))\\n                 ^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_functorch/_aot_autograd/utils.py&quot;, line 184, in flat_fn\\n    tree_out = fn(*args, **kwargs)\\n               ^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_functorch/_aot_autograd/traced_function_transforms.py&quot;, line 906, in functional_call\\n    out = mod(*args[params_len:], **kwargs)\\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/fx/_symbolic_trace.py&quot;, line 825, in module_call_wrapper\\n    return self.call_module(mod, forward, args, kwargs)\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/fx/experimental/proxy_tensor.py&quot;, line 1857, in call_module\\n    return Tracer.call_module(self, m, forward, args, kwargs)\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/fx/_symbolic_trace.py&quot;, line 542, in call_module\\n    ret_val = forward(*args, **kwargs)\\n              ^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/fx/_symbolic_trace.py&quot;, line 818, in forward\\n    return _orig_module_call(mod, *args, **kwargs)\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/nn/modules/module.py&quot;, line 1767, in _wrapped_call_impl\\n    return self._call_impl(*args, **kwargs)\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/nn/modules/module.py&quot;, line 1778, in _call_impl\\n    return forward_call(*args, **kwargs)\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/export/_trace.py&quot;, line 1885, in forward\\n    tree_out = mod(*args, **kwargs)\\n               ^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/fx/_symbolic_trace.py&quot;, line 825, in module_call_wrapper\\n    return self.call_module(mod, forward, args, kwargs)\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/fx/experimental/proxy_tensor.py&quot;, line 1857, in call_module\\n    return Tracer.call_module(self, m, forward, args, kwargs)\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/fx/_symbolic_trace.py&quot;, line 542, in call_module\\n    ret_val = forward(*args, **kwargs)\\n              ^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/fx/_symbolic_trace.py&quot;, line 818, in forward\\n    return _orig_module_call(mod, *args, **kwargs)\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/nn/modules/module.py&quot;, line 1767, in _wrapped_call_impl\\n    return self._call_impl(*args, **kwargs)\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/nn/modules/module.py&quot;, line 1778, in _call_impl\\n    return forward_call(*args, **kwargs)\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/github/experimental-experiment/_doc/examples/plot_torch_sklearn_201.py&quot;, line 293, in forward\\n    X, dist_subset, receivers_idx = torch.cond(\\n                                    ^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_higher_order_ops/cond.py&quot;, line 192, in cond\\n    return torch.compile(_cond_op_wrapper, backend=backend, fullgraph=True)(\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/eval_frame.py&quot;, line 699, in _fn\\n    return fn(*args, **kwargs)\\n           ^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/convert_frame.py&quot;, line 1463, in __call__\\n    return self._torchdynamo_orig_callable(\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/convert_frame.py&quot;, line 624, in __call__\\n    return _compile(\\n           ^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/convert_frame.py&quot;, line 1087, in _compile\\n    guarded_code = compile_inner(code, one_graph, hooks, transform)\\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_utils_internal.py&quot;, line 97, in wrapper_function\\n    return function(*args, **kwargs)\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/convert_frame.py&quot;, line 778, in compile_inner\\n    return _compile_inner(code, one_graph, hooks, transform)\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/convert_frame.py&quot;, line 817, in _compile_inner\\n    out_code = transform_code_object(code, transform)\\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/bytecode_transformation.py&quot;, line 1423, in transform_code_object\\n    transformations(instructions, code_options)\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/convert_frame.py&quot;, line 264, in _fn\\n    return fn(*args, **kwargs)\\n           ^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/convert_frame.py&quot;, line 742, in transform\\n    tracer.run()\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/symbolic_convert.py&quot;, line 3508, in run\\n    super().run()\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/symbolic_convert.py&quot;, line 1345, in run\\n    while self.step():\\n          ^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/symbolic_convert.py&quot;, line 1253, in step\\n    self.dispatch_table[inst.opcode](self, inst)\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/symbolic_convert.py&quot;, line 828, in wrapper\\n    return inner_fn(self, inst)\\n           ^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/symbolic_convert.py&quot;, line 2254, in CALL_FUNCTION_EX\\n    self.call_function(fn, argsvars.items, kwargsvars)\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/symbolic_convert.py&quot;, line 1179, in call_function\\n    self.push(fn.call_function(self, args, kwargs))  # type: ignore[arg-type]\\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/variables/lazy.py&quot;, line 201, in realize_and_forward\\n    return getattr(self.realize(), name)(*args, **kwargs)\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/variables/higher_order_ops.py&quot;, line 75, in graph_break_as_hard_error\\n    return fn(*args, **kwargs)\\n           ^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/variables/higher_order_ops.py&quot;, line 1129, in call_function\\n    return _call_function_and_unflatten_output(\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/variables/higher_order_ops.py&quot;, line 210, in _call_function_and_unflatten_output\\n    flat_variable = wrap_fx_proxy(\\n                    ^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/variables/builder.py&quot;, line 2490, in wrap_fx_proxy\\n    return wrap_fx_proxy_cls(target_cls=TensorVariable, **kwargs)\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/variables/builder.py&quot;, line 2556, in wrap_fx_proxy_cls\\n    return _wrap_fx_proxy(\\n           ^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/variables/builder.py&quot;, line 2654, in _wrap_fx_proxy\\n    example_value = get_fake_value(proxy.node, tx, allow_non_graph_fake=True)\\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/utils.py&quot;, line 3302, in get_fake_value\\n    raise TorchRuntimeError(str(e)).with_traceback(e.__traceback__) from None\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/utils.py&quot;, line 3200, in get_fake_value\\n    ret_val = wrap_fake_exception(\\n              ^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/utils.py&quot;, line 2700, in wrap_fake_exception\\n    return fn()\\n           ^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/utils.py&quot;, line 3201, in &lt;lambda&gt;\\n    lambda: run_node(tx.output, node, args, kwargs, nnmodule)\\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/utils.py&quot;, line 3409, in run_node\\n    raise RuntimeError(make_error_message(e)).with_traceback(\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_dynamo/utils.py&quot;, line 3368, in run_node\\n    return node.target(*args, **kwargs)\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_higher_order_ops/cond.py&quot;, line 59, in __call__\\n    return super().__call__(pred, true_fn, false_fn, operands)\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_ops.py&quot;, line 501, in __call__\\n    return wrapper()\\n           ^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_ops.py&quot;, line 497, in wrapper\\n    return self.dispatch(\\n           ^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_ops.py&quot;, line 485, in dispatch\\n    return kernel(*args, **kwargs)\\n           ^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_ops.py&quot;, line 320, in maybe_run_autograd\\n    return self(*args, **kwargs)\\n           ^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_higher_order_ops/cond.py&quot;, line 59, in __call__\\n    return super().__call__(pred, true_fn, false_fn, operands)\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_ops.py&quot;, line 501, in __call__\\n    return wrapper()\\n           ^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_ops.py&quot;, line 497, in wrapper\\n    return self.dispatch(\\n           ^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_ops.py&quot;, line 393, in dispatch\\n    result = handler(mode, *args, **kwargs)\\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_higher_order_ops/cond.py&quot;, line 432, in cond_fake_tensor_mode\\n    merged_outs.append(_merge_tensors(true_out, false_out, mode))\\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_higher_order_ops/cond.py&quot;, line 656, in _merge_tensors\\n    merged_stride: list[Union[int, torch.SymInt]] = _bound_stride(\\n                                                    ^^^^^^^^^^^^^^\\n\&#39;, \&#39;  File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_higher_order_ops/cond.py&quot;, line 624, in _bound_stride\\n    assert b_val == 0, (a_val, b_val)\\n           ^^^^^^^^^^\\n\&#39;, \&#39;torch._dynamo.exc.TorchRuntimeError: Dynamo failed to run FX node with fake tensors: call_function cond(*(s2, GraphModule(), GraphModule(), (FakeTensor(..., size=(s85, 3)), FakeTensor(..., size=(s57, s30)), FakeTensor(..., size=(s84, 3), dtype=torch.bool), FakeTensor(..., size=(s52, 3)), FakeTensor(..., size=(s94,), dtype=torch.int64), FakeTensor(..., size=(s29,), dtype=torch.int64), FakeTensor(..., size=(s72,), dtype=torch.bool), FakeTensor(..., size=(s79, s54)), FakeTensor(..., size=(s31,), dtype=torch.int64), FakeTensor(..., size=(s96,), dtype=torch.int64))), **{}): got AssertionError((0, 1))\\n\\nfrom user code:\\n   File &quot;~/vv/this312/lib/python3.12/site-packages/torch/_higher_order_ops/cond.py&quot;, line 184, in _cond_op_wrapper\\n    return cond_op(*args, **kwargs)\\n\\nSet TORCHDYNAMO_VERBOSE=1 for the internal stack trace (please do this especially if you\\\&#39;re reporting a bug to PyTorch). For even more developer context, set TORCH_LOGS=&quot;+dynamo&quot;\\n\\n\&#39;]&#39;, a custom onnx converter must be provided for &#39;diag_lib::C_TorchKNNImputer_columns_0___col_cond&#39;, args=(T1s40x3,T1s27x17,T9s50x3,T1s50x3,T7s27,T7s27,T9s27,T1s40x50,T7s40,T7s17), kwargs={}, outputs=(T1s40x3,T1s0x17,T7s0)
</pre></div>
</div>
<p>Let’s save it.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">onx</span><span class="p">:</span>
    <span class="n">onnx</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="s2">&quot;plot_torch_sklearn_201.onnx&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>We can also print it.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">onx</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/onnx_helper.html#onnx_diagnostic.helpers.onnx_helper.pretty_onnx" title="onnx_diagnostic.helpers.onnx_helper.pretty_onnx" class="sphx-glr-backref-module-onnx_diagnostic-helpers-onnx_helper sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/onnx_helper.html#onnx_diagnostic.helpers.onnx_helper.pretty_onnx" title="onnx_diagnostic.helpers.onnx_helper.pretty_onnx" class="sphx-glr-backref-module-onnx_diagnostic-helpers-onnx_helper sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/onnx_helper.html#onnx_diagnostic.helpers.onnx_helper.pretty_onnx" title="onnx_diagnostic.helpers.onnx_helper.pretty_onnx" class="sphx-glr-backref-module-onnx_diagnostic-helpers-onnx_helper sphx-glr-backref-type-py-function"><span class="n">pretty_onnx</span></a></a></a><span class="p">(</span><span class="n">onx</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="validation-again">
<h3>Validation again<a class="headerlink" href="#validation-again" title="Link to this heading">¶</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">validate_onnx</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">sizey</span><span class="p">,</span> <span class="n">onx</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">use_ort</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
    <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">,</span> <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a> <span class="o">=</span> <span class="n">get_xy</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">sizey</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>

    <span class="n">knn_imputer</span> <span class="o">=</span> <a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class"><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html#sklearn.impute.KNNImputer" title="sklearn.impute.KNNImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class"><span class="n">sklearn</span><span class="o">.</span><span class="n">impute</span><span class="o">.</span><span class="n">KNNImputer</span></a></a></a><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">knn_imputer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a></a></a><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><a href="https://docs.pytorch.org/docs/main/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">TorchKNNImputer</span></a></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="p">)</span>

    <span class="n">expected</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a><span class="p">)</span>

    <span class="n">model_inputs</span> <span class="o">=</span> <span class="p">(</span>
        <a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_mask_fit_X</span><span class="p">),</span>
        <a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_valid_mask</span><span class="p">),</span>
        <a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_fit_X</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.float32" title="numpy.float32" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.float32" title="numpy.float32" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.float32" title="numpy.float32" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><span class="n">np</span><span class="o">.</span><span class="n">float32</span></a></a></a><span class="p">)),</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="o">*</span><span class="n">model_inputs</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><span class="n">max_diff</span></a></a></a><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;abs&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> and sizey=</span><span class="si">{</span><span class="n">sizey</span><span class="si">}</span><span class="s2">, d=</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Torch Discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> and sizey=</span><span class="si">{</span><span class="n">sizey</span><span class="si">}</span><span class="s2">, d=</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">input_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">onx</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">input</span><span class="p">]</span>
    <span class="n">feeds</span> <span class="o">=</span> <span class="n">feeds0</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">input_names</span><span class="p">,</span> <span class="p">[</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">t</span><span class="o">.</span><span class="n">numpy</span></a></a></a><span class="p">()</span> <span class="k">for</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">t</span></a></a></a> <span class="ow">in</span> <span class="n">model_inputs</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;python: loading the model...&quot;</span><span class="p">)</span>
    <span class="n">sess</span> <span class="o">=</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/reference/index.html#experimental_experiment.reference.ExtendedReferenceEvaluator" title="experimental_experiment.reference.ExtendedReferenceEvaluator" class="sphx-glr-backref-module-experimental_experiment-reference sphx-glr-backref-type-py-class"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/reference/index.html#experimental_experiment.reference.ExtendedReferenceEvaluator" title="experimental_experiment.reference.ExtendedReferenceEvaluator" class="sphx-glr-backref-module-experimental_experiment-reference sphx-glr-backref-type-py-class"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/reference/index.html#experimental_experiment.reference.ExtendedReferenceEvaluator" title="experimental_experiment.reference.ExtendedReferenceEvaluator" class="sphx-glr-backref-module-experimental_experiment-reference sphx-glr-backref-type-py-class"><span class="n">ExtendedReferenceEvaluator</span></a></a></a><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;python: running the model...&quot;</span><span class="p">)</span>
    <span class="n">got</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">feeds</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><span class="n">max_diff</span></a></a></a><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">got</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;abs&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ONNX Discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> and sizey=</span><span class="si">{</span><span class="n">sizey</span><span class="si">}</span><span class="s2">, d=</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ONNX Discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> and sizey=</span><span class="si">{</span><span class="n">sizey</span><span class="si">}</span><span class="s2">, d=</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">use_ort</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;onnxruntime: loading the model...&quot;</span><span class="p">)</span>
        <span class="n">opts</span> <span class="o">=</span> <a href="https://onnxruntime.ai/docs/api/python/api_summary.html#onnxruntime.SessionOptions" title="onnxruntime.capi.onnxruntime_pybind11_state.SessionOptions" class="sphx-glr-backref-module-onnxruntime-capi-onnxruntime_pybind11_state sphx-glr-backref-type-py-class"><a href="https://onnxruntime.ai/docs/api/python/api_summary.html#onnxruntime.SessionOptions" title="onnxruntime.capi.onnxruntime_pybind11_state.SessionOptions" class="sphx-glr-backref-module-onnxruntime-capi-onnxruntime_pybind11_state sphx-glr-backref-type-py-class"><a href="https://onnxruntime.ai/docs/api/python/api_summary.html#onnxruntime.SessionOptions" title="onnxruntime.capi.onnxruntime_pybind11_state.SessionOptions" class="sphx-glr-backref-module-onnxruntime-capi-onnxruntime_pybind11_state sphx-glr-backref-type-py-class"><span class="n">onnxruntime</span><span class="o">.</span><span class="n">SessionOptions</span></a></a></a><span class="p">()</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">optimized_model_filepath</span> <span class="o">=</span> <span class="s2">&quot;plot_torch_sklearn_201.ort.onnx&quot;</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">log_severity_level</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">log_verbosity_level</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sess</span> <span class="o">=</span> <a href="https://onnxruntime.ai/docs/api/python/api_summary.html#onnxruntime.InferenceSession" title="onnxruntime.capi.onnxruntime_inference_collection.InferenceSession" class="sphx-glr-backref-module-onnxruntime-capi-onnxruntime_inference_collection sphx-glr-backref-type-py-class"><a href="https://onnxruntime.ai/docs/api/python/api_summary.html#onnxruntime.InferenceSession" title="onnxruntime.capi.onnxruntime_inference_collection.InferenceSession" class="sphx-glr-backref-module-onnxruntime-capi-onnxruntime_inference_collection sphx-glr-backref-type-py-class"><a href="https://onnxruntime.ai/docs/api/python/api_summary.html#onnxruntime.InferenceSession" title="onnxruntime.capi.onnxruntime_inference_collection.InferenceSession" class="sphx-glr-backref-module-onnxruntime-capi-onnxruntime_inference_collection sphx-glr-backref-type-py-class"><span class="n">onnxruntime</span><span class="o">.</span><span class="n">InferenceSession</span></a></a></a><span class="p">(</span>
            <span class="n">onx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">(),</span> <span class="n">opts</span><span class="p">,</span> <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CPUExecutionProvider&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;onnxruntime: running the model...&quot;</span><span class="p">)</span>
        <span class="n">got</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">feeds</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><span class="n">max_diff</span></a></a></a><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">got</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;abs&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ONNX Discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> and sizey=</span><span class="si">{</span><span class="n">sizey</span><span class="si">}</span><span class="s2">, d=</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ONNX Discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> and sizey=</span><span class="si">{</span><span class="n">sizey</span><span class="si">}</span><span class="s2">, d=</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">model_inputs</span> <span class="o">=</span> <span class="p">(</span>
        <a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_mask_fit_X</span><span class="p">),</span>
        <a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_valid_mask</span><span class="p">),</span>
        <a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><a href="https://docs.pytorch.org/docs/main/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a></a></a><span class="p">(</span><span class="n">knn_imputer</span><span class="o">.</span><span class="n">_fit_X</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.float32" title="numpy.float32" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.float32" title="numpy.float32" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.float32" title="numpy.float32" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><span class="n">np</span><span class="o">.</span><span class="n">float32</span></a></a></a><span class="p">)),</span>
        <a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">knn_imputer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://docs.pytorch.org/docs/main/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Y</span></a></a></a><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="o">*</span><span class="n">model_inputs</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><span class="n">max_diff</span></a></a></a><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;abs&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> and sizey=</span><span class="si">{</span><span class="n">sizey</span><span class="si">}</span><span class="s2">, d=</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">feeds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">input_names</span><span class="p">,</span> <span class="p">[</span><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">t</span><span class="o">.</span><span class="n">numpy</span></a></a></a><span class="p">()</span> <span class="k">for</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/torch_interpreter/piece_by_piece.html#experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" title="experimental_experiment.torch_interpreter.piece_by_piece.ModelDiagnoseOutput" class="sphx-glr-backref-module-experimental_experiment-torch_interpreter-piece_by_piece sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">t</span></a></a></a> <span class="ow">in</span> <span class="n">model_inputs</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ReferenceEvaluator: running the model...&quot;</span><span class="p">)</span>
    <span class="n">got</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">feeds</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/onnx-diagnostic/dev/api/helpers/index.html#onnx_diagnostic.helpers.max_diff" title="onnx_diagnostic.helpers.max_diff" class="sphx-glr-backref-module-onnx_diagnostic-helpers sphx-glr-backref-type-py-function"><span class="n">max_diff</span></a></a></a><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">got</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;abs&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ONNX Discrepancies for size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> and sizey=</span><span class="si">{</span><span class="n">sizey</span><span class="si">}</span><span class="s2">, d=</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">feeds0</span><span class="p">,</span> <span class="n">expected</span>
</pre></div>
</div>
<p>This does not work yet.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">onx</span><span class="p">:</span>
    <span class="n">feeds</span><span class="p">,</span> <span class="n">expected</span> <span class="o">=</span> <span class="n">validate_onnx</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">onx</span><span class="p">)</span>
    <span class="n">validate_onnx</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="n">onx</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="modelproto-to-python-code">
<h2>ModelProto to python Code<a class="headerlink" href="#modelproto-to-python-code" title="Link to this heading">¶</a></h2>
<p>We finally call function <a class="reference internal" href="../api/xbuilder/reverse_graph_builder.html#experimental_experiment.xbuilder.reverse_graph_builder.to_graph_builder_code" title="experimental_experiment.xbuilder.reverse_graph_builder.to_graph_builder_code"><code class="xref py py-func docutils literal notranslate"><span class="pre">to_graph_builder_code</span></code></a>
to convert the onnx model into pseudo code if that helps moving that code
to a converter library (<a class="reference external" href="https://onnx.ai/sklearn-onnx/">sklearn-onnx</a>).</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">onx</span><span class="p">:</span>
    <span class="n">code</span> <span class="o">=</span> <a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/xbuilder/reverse_graph_builder.html#experimental_experiment.xbuilder.reverse_graph_builder.to_graph_builder_code" title="experimental_experiment.xbuilder.reverse_graph_builder.to_graph_builder_code" class="sphx-glr-backref-module-experimental_experiment-xbuilder-reverse_graph_builder sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/xbuilder/reverse_graph_builder.html#experimental_experiment.xbuilder.reverse_graph_builder.to_graph_builder_code" title="experimental_experiment.xbuilder.reverse_graph_builder.to_graph_builder_code" class="sphx-glr-backref-module-experimental_experiment-xbuilder-reverse_graph_builder sphx-glr-backref-type-py-function"><a href="https://sdpython.github.io/doc/experimental-experiment/dev/api/xbuilder/reverse_graph_builder.html#experimental_experiment.xbuilder.reverse_graph_builder.to_graph_builder_code" title="experimental_experiment.xbuilder.reverse_graph_builder.to_graph_builder_code" class="sphx-glr-backref-module-experimental_experiment-xbuilder-reverse_graph_builder sphx-glr-backref-type-py-function"><span class="n">to_graph_builder_code</span></a></a></a><span class="p">(</span><span class="n">onx</span><span class="p">)</span>
    <span class="n">addition</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>

<span class="s2">    feeds = </span><span class="si">{</span><span class="n">feeds</span><span class="si">!r}</span>
<span class="s2">    expected = </span><span class="si">{</span><span class="n">expected</span><span class="si">!r}</span>
<span class="s2">    ref = ExtendedReferenceEvaluator(model)</span>
<span class="s2">    got = ref.run(None, feeds)</span>
<span class="s2">    print(&quot;disrepancies:&quot;, max_diff(expected, got[0]))</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;nan&quot;</span><span class="p">,</span> <span class="s2">&quot;np.nan&quot;</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="s2">&quot;np.array&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="s2">&quot;np.float32&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    from experimental_experiment.reference import ExtendedReferenceEvaluator</span>
<span class="s2">    from experimental_experiment.helpers import max_diff</span>
<span class="s2">    </span><span class="si">{</span><span class="n">code</span><span class="si">}</span>
<span class="s2">    </span><span class="si">{</span><span class="n">addition</span><span class="si">}</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s finally check it produces the same results.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">onx</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;_plot_torch_sklearn_201_knnpy.py&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s run it…
It can be run this way.</p>
<p><code class="docutils literal notranslate"><span class="pre">subprocess.run([sys.executable,</span> <span class="pre">&quot;_plot_torch_sklearn_201_knnpy.py&quot;])</span></code></p>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 24.578 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-plot-torch-sklearn-201-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/424a4167f0d4e68c68581003765f271f/plot_torch_sklearn_201.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_torch_sklearn_201.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/91a11247fad55ba7ccd05b38fa897a78/plot_torch_sklearn_201.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_torch_sklearn_201.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../_downloads/84f58a1f54b99d7bc6a56dce5bd2d150/plot_torch_sklearn_201.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">zipped:</span> <span class="pre">plot_torch_sklearn_201.zip</span></code></a></p>
</div>
</div>
<p class="rubric">Related examples</p>
<div class="sphx-glr-thumbnails"><div class="sphx-glr-thumbcontainer" tooltip="The convolution is a well known image transformation used to transform an image. It can be used to blur, to compute the gradient in one direction and it is widely used in deep neural networks. Having a fast implementation is important."><img alt="" src="../_images/sphx_glr_plot_convolutation_matmul_102_thumb.png" />
<p><a class="reference internal" href="plot_convolutation_matmul_102.html#sphx-glr-auto-examples-plot-convolutation-matmul-102-py"><span class="std std-ref">102: Convolution and Matrix Multiplication</span></a></p>
  <div class="sphx-glr-thumbnail-title">102: Convolution and Matrix Multiplication</div>
</div><div class="sphx-glr-thumbcontainer" tooltip="This example leverages the function torch.compile and the ability to use a custom backend (see Custom Backends) to test the optimization of a model by fusing simple element-wise kernels."><img alt="" src="../_images/sphx_glr_plot_custom_backend_llama_102_thumb.png" />
<p><a class="reference internal" href="plot_custom_backend_llama_102.html#sphx-glr-auto-examples-plot-custom-backend-llama-102-py"><span class="std std-ref">102: Fuse kernels in a small Llama Model</span></a></p>
  <div class="sphx-glr-thumbnail-title">102: Fuse kernels in a small Llama Model</div>
</div><div class="sphx-glr-thumbcontainer" tooltip="The script compares the two exporters implemented in pytorch for a part of llama model. The model are compared after all optimizations were made with and onnxruntime."><img alt="" src="../_images/sphx_glr_plot_llama_diff_export_301_thumb.png" />
<p><a class="reference internal" href="plot_llama_diff_export_301.html#sphx-glr-auto-examples-plot-llama-diff-export-301-py"><span class="std std-ref">301: Compares LLAMA exporters</span></a></p>
  <div class="sphx-glr-thumbnail-title">301: Compares LLAMA exporters</div>
</div><div class="sphx-glr-thumbcontainer" tooltip="# %% # Write the code producing the model # =================================="><img alt="" src="../_images/sphx_glr_plot_model_to_python_thumb.png" />
<p><a class="reference internal" href="plot_model_to_python.html#sphx-glr-auto-examples-plot-model-to-python-py"><span class="std std-ref">Playground for big optimization pattern</span></a></p>
  <div class="sphx-glr-thumbnail-title">Playground for big optimization pattern</div>
</div><div class="sphx-glr-thumbcontainer" tooltip="This example leverages the examples introduced on this page Custom Backends. It uses backend experimental_experiment.torch_dynamo.onnx_custom_backend based on onnxruntime and running on CPU or CUDA. It could easily replaced by experimental_experiment.torch_dynamo.onnx_debug_backend. This one based on the reference implemented from onnx can show the intermediate results if needed. It is very slow."><img alt="" src="../_images/sphx_glr_plot_torch_custom_backend_101_thumb.png" />
<p><a class="reference internal" href="plot_torch_custom_backend_101.html#sphx-glr-auto-examples-plot-torch-custom-backend-101-py"><span class="std std-ref">101: A custom backend for torch</span></a></p>
  <div class="sphx-glr-thumbnail-title">101: A custom backend for torch</div>
</div></div><p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="plot_llama_diff_export_301.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">301: Compares LLAMA exporters</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="plot_torch_export_201.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">201: Evaluate different ways to export a torch model to ONNX</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023-2024
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">201: Use torch to export a scikit-learn model into ONNX</a><ul>
<li><a class="reference internal" href="#torch-implementation-of-nan-euclidean-distances">torch implementation of nan_euclidean_distances</a><ul>
<li><a class="reference internal" href="#module">Module</a></li>
<li><a class="reference internal" href="#validation">Validation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#torch-implementation-of-knnimputer">torch implementation of KNNImputer</a><ul>
<li><a class="reference internal" href="#module-and-sub-modules">Module and sub modules</a></li>
<li><a class="reference internal" href="#id1">Validation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#export-to-onnx">Export to ONNX</a><ul>
<li><a class="reference internal" href="#first-step-tracing-intermediate-outputs">First step: tracing intermediate outputs</a></li>
<li><a class="reference internal" href="#final-step">Final step</a></li>
<li><a class="reference internal" href="#validation-again">Validation again</a></li>
</ul>
</li>
<li><a class="reference internal" href="#modelproto-to-python-code">ModelProto to python Code</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=1a9ffd16"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=5fa4622c"></script>
    </body>
</html>
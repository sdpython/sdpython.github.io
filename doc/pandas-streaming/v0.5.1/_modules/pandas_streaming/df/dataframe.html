<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../genindex.html"><link rel="search" title="Search" href="../../../search.html">
        <link rel="prefetch" href="../../../_static/project_ico.png" as="image">

    <!-- Generated with Sphinx 8.1.3 and Furo 2025.09.25 -->
        <title>pandas_streaming.df.dataframe - pandas-streaming 0.5.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=580074bf" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">pandas-streaming 0.5.1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../../_static/project_ico.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">pandas-streaming 0.5.1 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/index.html">Tutorial</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../auto_examples/index.html">Gallery of Examples</a><input aria-label="Toggle navigation of Gallery of Examples" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/first_step.html">First steps with pandas_streaming</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../api/index.html">API</a><input aria-label="Toggle navigation of API" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/rdata.html">pandas_streaming.data</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../api/rdf.html">pandas_streaming.df</a><input aria-label="Toggle navigation of pandas_streaming.df" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/dataframe.html">pandas_streaming.df.dataframe</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/connex_split.html">pandas_streaming.df.connex_split</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/dataframe_io.html">pandas_streaming.df.dataframe_io</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/dataframe_split.html">pandas_streaming.df.dataframe_split</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/rexc.html">pandas_streaming.exc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/rio.html">Inputs / Outputs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../i_ex.html">Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">More</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../CHANGELOGS.html">Change Logs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for pandas_streaming.df.dataframe</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">StringIO</span><span class="p">,</span> <span class="n">BytesIO</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">inspect</span><span class="w"> </span><span class="kn">import</span> <span class="n">isfunction</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy.random</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nrandom</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pandas.testing</span><span class="w"> </span><span class="kn">import</span> <span class="n">assert_frame_equal</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="kn">import</span> <span class="n">json_normalize</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pandas.io.json</span><span class="w"> </span><span class="kn">import</span> <span class="n">json_normalize</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.dataframe_split</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">sklearn_train_test_split</span><span class="p">,</span>
    <span class="n">sklearn_train_test_split_streaming</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.dataframe_io_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">enumerate_json_items</span><span class="p">,</span> <span class="n">JsonIterator2Stream</span>


<div class="viewcode-block" id="StreamingDataFrameSchemaError">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrameSchemaError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">StreamingDataFrameSchemaError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reveals an issue with inconsistant schemas.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="StreamingDataFrame">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">StreamingDataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines a streaming dataframe.</span>
<span class="sd">    The goal is to reduce the memory footprint.</span>
<span class="sd">    The class takes a function which creates an iterator</span>
<span class="sd">    on :epkg:`dataframe`. We assume this function can</span>
<span class="sd">    be called multiple time. As a matter of fact, the</span>
<span class="sd">    function is called every time the class needs to walk</span>
<span class="sd">    through the stream with the following loop:</span>

<span class="sd">    ::</span>

<span class="sd">        for df in self:  # self is a StreamingDataFrame</span>
<span class="sd">            # ...</span>

<span class="sd">    The constructor cannot receive an iterator otherwise</span>
<span class="sd">    this class would be able to walk through the data</span>
<span class="sd">    only once. The main reason is it is impossible to</span>
<span class="sd">    :mod:`pickle` (or :epkg:`dill`)</span>
<span class="sd">    an iterator: it cannot be replicated.</span>
<span class="sd">    Instead, the class takes a function which generates</span>
<span class="sd">    an iterator on :epkg:`DataFrame`.</span>
<span class="sd">    Most of the methods returns either a :epkg:`DataFrame`</span>
<span class="sd">    either a see :class:`StreamingDataFrame</span>
<span class="sd">    &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;`. In the second case,</span>
<span class="sd">    methods can be chained.</span>

<span class="sd">    By default, the object checks that the schema remains</span>
<span class="sd">    the same between two chunks. This can be disabled</span>
<span class="sd">    by setting *check_schema=False* in the constructor.</span>

<span class="sd">    The user should expect the data to remain stable.</span>
<span class="sd">    Every loop should produce the same data. However,</span>
<span class="sd">    in some situations, it is more efficient not to keep</span>
<span class="sd">    that constraints. Draw a random @see me sample</span>
<span class="sd">    is one of these cases.</span>

<span class="sd">    :param iter_creation: function which creates an iterator or an</span>
<span class="sd">        instance of see :class:`StreamingDataFrame</span>
<span class="sd">        &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;`</span>
<span class="sd">    :param check_schema: checks that the schema is the same</span>
<span class="sd">        for every :epkg:`dataframe`</span>
<span class="sd">    :param stable: indicates if the :epkg:`dataframe` remains the same</span>
<span class="sd">        whenever it is walked through</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="StreamingDataFrame.__init__">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iter_creation</span><span class="p">,</span> <span class="n">check_schema</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stable</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delete_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iter_creation</span><span class="p">,</span> <span class="p">(</span><span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Unexpected type </span><span class="si">%r</span><span class="s2"> for iter_creation. It must &quot;</span>
                <span class="s2">&quot;be an iterator.&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">iter_creation</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iter_creation</span><span class="p">,</span> <span class="n">StreamingDataFrame</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iter_creation</span> <span class="o">=</span> <span class="n">iter_creation</span><span class="o">.</span><span class="n">iter_creation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stable</span> <span class="o">=</span> <span class="n">iter_creation</span><span class="o">.</span><span class="n">stable</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iter_creation</span> <span class="o">=</span> <span class="n">iter_creation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stable</span> <span class="o">=</span> <span class="n">stable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_schema</span> <span class="o">=</span> <span class="n">check_schema</span></div>


<div class="viewcode-block" id="StreamingDataFrame.is_stable">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.is_stable">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_stable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">do_check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tells if the :epkg:`dataframe` is supposed to be stable.</span>

<span class="sd">        :param do_check: do not trust the value sent to the constructor</span>
<span class="sd">        :param n: number of rows used to check the stability,</span>
<span class="sd">            None for all rows</span>
<span class="sd">        :return: boolean</span>

<span class="sd">        *do_check=True* means the methods checks the first</span>
<span class="sd">        *n* rows remains the same for two iterations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">do_check</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">assert_frame_equal</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stable</span></div>


<div class="viewcode-block" id="StreamingDataFrame.get_kwargs">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.get_kwargs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the parameters used to call the constructor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">check_schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">check_schema</span><span class="p">)</span></div>


<div class="viewcode-block" id="StreamingDataFrame.train_test_split">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.train_test_split">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">train_test_split</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path_or_buf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">export_method</span><span class="o">=</span><span class="s2">&quot;to_csv&quot;</span><span class="p">,</span>
        <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">streaming</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">partitions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Randomly splits a :epkg:`dataframe` into smaller pieces.</span>
<span class="sd">        The function returns streams of file names.</span>
<span class="sd">        It chooses one of the options from module</span>
<span class="sd">        :mod:`dataframe_split &lt;pandas_streaming.df.dataframe_split&gt;`.</span>

<span class="sd">        :param path_or_buf: a string, a list of strings or buffers, if it is a</span>
<span class="sd">            string, it must contain ``{}`` like ``partition{}.txt``,</span>
<span class="sd">            if None, the function returns strings.</span>
<span class="sd">        :param export_method: method used to store the partitions, by default</span>
<span class="sd">            :meth:`pandas.DataFrame.to_csv`, additional parameters</span>
<span class="sd">            will be given to that function</span>
<span class="sd">        :param names: partitions names, by default ``(&#39;train&#39;, &#39;test&#39;)``</span>
<span class="sd">        :param kwargs: parameters for the export function and</span>
<span class="sd">            :func:`sklearn.model_selection.train_test_split`.</span>
<span class="sd">        :param streaming: the function switches to a</span>
<span class="sd">            streaming version of the algorithm.</span>
<span class="sd">        :param partitions: splitting partitions</span>
<span class="sd">        :return: outputs of the exports functions or two</span>
<span class="sd">            see class `StreamingDataFrame`</span>
<span class="sd">            if *path_or_buf* is None.</span>

<span class="sd">        The streaming version of this algorithm is implemented by function</span>
<span class="sd">        :func:`sklearn_train_test_split_streaming</span>
<span class="sd">        &lt;pandas_streaming.df.dataframe_split.sklearn_train_test_split_streaming&gt;`.</span>
<span class="sd">        Its documentation indicates the limitation of the streaming version</span>
<span class="sd">        and gives some insights about the additional parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">streaming</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">partitions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">partitions</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>  <span class="c1"># pragma: no cover</span>
                        <span class="s2">&quot;Only train and test split is allowed, *partitions* &quot;</span>
                        <span class="s2">&quot;must be of length 2.&quot;</span>
                    <span class="p">)</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;train_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">partitions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;test_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">partitions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">sklearn_train_test_split_streaming</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sklearn_train_test_split</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">path_or_buf</span><span class="o">=</span><span class="n">path_or_buf</span><span class="p">,</span>
            <span class="n">export_method</span><span class="o">=</span><span class="n">export_method</span><span class="p">,</span>
            <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_process_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filters out parameters for the constructor of this class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;check_schema&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">kw</span>

<div class="viewcode-block" id="StreamingDataFrame.read_json">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.read_json">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_json</span><span class="p">(</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="n">flatten</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StreamingDataFrame&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads a :epkg:`json` file or buffer as an iterator</span>
<span class="sd">        on :epkg:`DataFrame`. The signature is the same as</span>
<span class="sd">        :epkg:`pandas:read_json`. The important parameter is</span>
<span class="sd">        *chunksize* which defines the number</span>
<span class="sd">        of rows to parse in a single bloc</span>
<span class="sd">        and it must be defined to return an iterator.</span>
<span class="sd">        If *lines* is True, the function falls back into</span>
<span class="sd">        :epkg:`pandas:read_json`, otherwise it used</span>
<span class="sd">        @see fn enumerate_json_items. If *lines* is ``&#39;stream&#39;``,</span>
<span class="sd">        *enumerate_json_items* is called with parameter</span>
<span class="sd">        ``lines=True``.</span>
<span class="sd">        Parameter *flatten* uses the trick described at</span>
<span class="sd">        `Flattening JSON objects in Python</span>
<span class="sd">        &lt;https://towardsdatascience.com/flattening-json-objects-in-python-f5343c794b10&gt;`_.</span>
<span class="sd">        Examples:</span>

<span class="sd">        .. runpython::</span>
<span class="sd">            :showcode:</span>

<span class="sd">            from io import BytesIO</span>
<span class="sd">            from pandas_streaming.df import StreamingDataFrame</span>

<span class="sd">            data = b&#39;&#39;&#39;{&quot;a&quot;: 1, &quot;b&quot;: 2}</span>
<span class="sd">                       {&quot;a&quot;: 3, &quot;b&quot;: 4}&#39;&#39;&#39;</span>
<span class="sd">            it = StreamingDataFrame.read_json(BytesIO(data), lines=True)</span>
<span class="sd">            dfs = list(it)</span>
<span class="sd">            print(dfs)</span>

<span class="sd">        .. runpython::</span>
<span class="sd">            :showcode:</span>

<span class="sd">            from io import BytesIO</span>
<span class="sd">            from pandas_streaming.df import StreamingDataFrame</span>

<span class="sd">            data = b&#39;&#39;&#39;[{&quot;a&quot;: 1,</span>
<span class="sd">                         &quot;b&quot;: 2},</span>
<span class="sd">                        {&quot;a&quot;: 3,</span>
<span class="sd">                         &quot;b&quot;: 4}]&#39;&#39;&#39;</span>

<span class="sd">            it = StreamingDataFrame.read_json(BytesIO(data))</span>
<span class="sd">            dfs = list(it)</span>
<span class="sd">            print(dfs)</span>

<span class="sd">        The parsed json must have an empty line at the end otherwise</span>
<span class="sd">        the following exception is raised:</span>
<span class="sd">        `ijson.common.IncompleteJSONError`:</span>
<span class="sd">        `parse error: unallowed token at this point in JSON text`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chunksize</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">chunksize</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;chunksize must be a positive integer&quot;</span><span class="p">)</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">kwargs_create</span> <span class="o">=</span> <span class="n">StreamingDataFrame</span><span class="o">.</span><span class="n">_process_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">flatten</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="o">.</span><span class="n">read_df</span><span class="p">(</span>
                    <span class="n">json_normalize</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="o">**</span><span class="n">kwargs_create</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="o">.</span><span class="n">read_df</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs_create</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;stream&quot;</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">localf</span><span class="p">(</span><span class="n">a0</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="s2">&quot;seek&quot;</span><span class="p">):</span>
                    <span class="n">a0</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">enumerate_json_items</span><span class="p">(</span>
                    <span class="n">a0</span><span class="p">,</span>
                    <span class="n">encoding</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;encoding&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">flatten</span><span class="o">=</span><span class="n">flatten</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">st</span> <span class="o">=</span> <span class="n">JsonIterator2Stream</span><span class="p">(</span><span class="n">localf</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

            <span class="k">if</span> <span class="n">chunksize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span>
                    <span class="k">lambda</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span>
                        <span class="n">st</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
                    <span class="p">),</span>
                    <span class="o">**</span><span class="n">kwargs_create</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">fct1</span><span class="p">(</span>
                <span class="n">st</span><span class="o">=</span><span class="n">st</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">chunksize</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># noqa: B008</span>
            <span class="p">):</span>
                <span class="n">st</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span>  <span class="c1"># noqa: UP028</span>
                    <span class="n">st</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">chunksize</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">chunksize</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
                <span class="p">):</span>
                    <span class="k">yield</span> <span class="n">r</span>

            <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span><span class="n">fct1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs_create</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">flatten</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;flatten==True is implemented with option lines=&#39;stream&#39;&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">chunksize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span>
                    <span class="k">lambda</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
                    <span class="o">**</span><span class="n">kwargs_create</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">fct2</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">chunksize</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()):</span>  <span class="c1"># noqa: B008</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span>  <span class="c1"># noqa: UP028</span>
                    <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">chunksize</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">chunksize</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
                <span class="p">):</span>
                    <span class="k">yield</span> <span class="n">r</span>

            <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span><span class="n">fct2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs_create</span><span class="p">)</span>

        <span class="n">st</span> <span class="o">=</span> <span class="n">JsonIterator2Stream</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">a0</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">enumerate_json_items</span><span class="p">(</span>
                <span class="n">a0</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;encoding&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">flatten</span><span class="o">=</span><span class="n">flatten</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="s2">&quot;lines&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">chunksize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span>
                    <span class="n">st</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">chunksize</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">),</span>
                <span class="o">**</span><span class="n">kwargs_create</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">fct3</span><span class="p">(</span><span class="n">st</span><span class="o">=</span><span class="n">st</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">chunksize</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()):</span>  <span class="c1"># noqa: B008</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s2">&quot;seek&quot;</span><span class="p">):</span>
                <span class="n">st</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span>  <span class="c1"># noqa: UP028</span>
                <span class="n">st</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">chunksize</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">chunksize</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
            <span class="p">):</span>
                <span class="k">yield</span> <span class="n">r</span>

        <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span><span class="n">fct3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs_create</span><span class="p">)</span></div>


<div class="viewcode-block" id="StreamingDataFrame.read_csv">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.read_csv">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_csv</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StreamingDataFrame&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads a :epkg:`csv` file or buffer</span>
<span class="sd">        as an iterator on :epkg:`DataFrame`.</span>
<span class="sd">        The signature is the same as :epkg:`pandas:read_csv`.</span>
<span class="sd">        The important parameter is *chunksize* which defines the number</span>
<span class="sd">        of rows to parse in a single bloc. If not specified,</span>
<span class="sd">        it will be equal to 100000.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;iterator&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If specified, iterator must be True.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chunksize&quot;</span><span class="p">,</span> <span class="mi">100000</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If specified, chunksize must not be None.&quot;</span><span class="p">)</span>
        <span class="n">kwargs_create</span> <span class="o">=</span> <span class="n">StreamingDataFrame</span><span class="o">.</span><span class="n">_process_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;iterator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s2">&quot;chunksize&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;chunksize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100000</span>
        <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs_create</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="StreamingDataFrame.read_str">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.read_str">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_str</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StreamingDataFrame&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads a :epkg:`DataFrame` as an iterator on :epkg:`DataFrame`.</span>
<span class="sd">        The signature is the same as :epkg:`pandas:read_csv`.</span>
<span class="sd">        The important parameter is *chunksize* which defines the number</span>
<span class="sd">        of rows to parse in a single bloc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;iterator&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If specified, iterator must be True.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chunksize&quot;</span><span class="p">,</span> <span class="mi">100000</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If specified, chunksize must not be None.&quot;</span><span class="p">)</span>
        <span class="n">kwargs_create</span> <span class="o">=</span> <span class="n">StreamingDataFrame</span><span class="o">.</span><span class="n">_process_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;iterator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s2">&quot;chunksize&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;chunksize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100000</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs_create</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="StreamingDataFrame.read_df">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.read_df">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_schema</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StreamingDataFrame&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Splits a :epkg:`DataFrame` into small chunks mostly for</span>
<span class="sd">        unit testing purposes.</span>

<span class="sd">        :param df: :class:`pandas.DataFrame`</span>
<span class="sd">        :param chunksize: number rows per chunks (// 10 by default)</span>
<span class="sd">        :param check_schema: check schema between two iterations</span>
<span class="sd">        :return: iterator on see :class:`StreamingDataFrame</span>
<span class="sd">            &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">chunksize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">):</span>
                <span class="n">chunksize</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot retrieve size to infer chunksize for type=</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">):</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>  <span class="c1"># pragma: no cover</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot retrieve size for type=</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">local_iterator</span><span class="p">():</span>
            <span class="s2">&quot;local iterator&quot;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">):</span>
                <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">chunksize</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span><span class="n">local_iterator</span><span class="p">,</span> <span class="n">check_schema</span><span class="o">=</span><span class="n">check_schema</span><span class="p">)</span></div>


<div class="viewcode-block" id="StreamingDataFrame.__iter__">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.__iter__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterator on a large file with a sliding window.</span>
<span class="sd">        Each windows is a :epkg:`DataFrame`.</span>
<span class="sd">        The method stores a copy of the initial iterator</span>
<span class="sd">        and restores it after the end of the iterations.</span>
<span class="sd">        If *check_schema* was enabled when calling the constructor,</span>
<span class="sd">        the method checks that every :epkg:`DataFrame`</span>
<span class="sd">        follows the same schema as the first chunck.</span>

<span class="sd">        Even with a big chunk size, it might happen</span>
<span class="sd">        that consecutive chunks might detect different type</span>
<span class="sd">        for one particular column. An error message shows up</span>
<span class="sd">        saying ``Column types are different after row``</span>
<span class="sd">        with more information about the column which failed.</span>
<span class="sd">        In that case, :epkg:`pandas:DataFrame.read_csv` can overwrite</span>
<span class="sd">        the type on one column by specifying</span>
<span class="sd">        ``dtype={column_name: new_type}``. It frequently happens</span>
<span class="sd">        when a string column has many missing values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">iters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_creation</span><span class="p">()</span>
        <span class="n">sch</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">iters</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sch</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">dtypes</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_schema</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="n">sch</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1"># pylint: disable=E1136</span>
                    <span class="k">raise</span> <span class="n">StreamingDataFrameSchemaError</span><span class="p">(</span>  <span class="c1"># pragma: no cover</span>
                        <span class="s2">&quot;Column names are different after row </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">First   chunk: </span><span class="si">{1}</span><span class="s2">&quot;</span>  <span class="c1"># noqa: UP030</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Current chunk: </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">sch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
                    <span class="p">)</span>  <span class="c1"># pylint: disable=E1136</span>
                <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span> <span class="o">!=</span> <span class="n">sch</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># pylint: disable=E1136</span>
                    <span class="n">errdf</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                        <span class="nb">dict</span><span class="p">(</span>
                            <span class="n">names</span><span class="o">=</span><span class="n">sch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">schema1</span><span class="o">=</span><span class="n">sch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># pylint: disable=E1136</span>
                            <span class="n">schema2</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">dtypes</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>  <span class="c1"># pylint: disable=E1136</span>
                    <span class="n">tdf</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
                    <span class="n">errdf</span><span class="p">[</span><span class="s2">&quot;diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">errdf</span><span class="p">[</span><span class="s2">&quot;schema2&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">errdf</span><span class="p">[</span><span class="s2">&quot;schema1&quot;</span><span class="p">]</span>
                    <span class="n">errdf</span> <span class="o">=</span> <span class="n">errdf</span><span class="p">[</span><span class="n">errdf</span><span class="p">[</span><span class="s2">&quot;diff&quot;</span><span class="p">]]</span>
                    <span class="n">errdf</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">tdf</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">StreamingDataFrameSchemaError</span><span class="p">(</span>
                        <span class="s2">&quot;Column types are different after row </span><span class="si">{0}</span><span class="s2">. You may use option &quot;</span>  <span class="c1"># noqa: UP030</span>
                        <span class="s1">&#39;dtype={{&quot;column_name&quot;: str}} to force the type on this column.&#39;</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---</span><span class="se">\n</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
                    <span class="p">)</span>

            <span class="n">rows</span> <span class="o">+=</span> <span class="n">it</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">yield</span> <span class="n">it</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is the kind of operations you do not want to do</span>
<span class="sd">        when a file is large because it goes through the whole</span>
<span class="sd">        stream just to get the number of rows.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nl</span><span class="p">,</span> <span class="n">nc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">nc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nc</span><span class="p">)</span>
            <span class="n">nl</span> <span class="o">+=</span> <span class="n">it</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">nl</span><span class="p">,</span> <span class="n">nc</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See :epkg:`pandas:DataFrame:columns`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">it</span><span class="o">.</span><span class="n">columns</span>
        <span class="c1"># The dataframe is empty.</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See :epkg:`pandas:DataFrame:dtypes`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">it</span><span class="o">.</span><span class="n">dtypes</span>

<div class="viewcode-block" id="StreamingDataFrame.to_csv">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.to_csv">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_or_buf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StreamingDataFrame&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the :epkg:`DataFrame` into string.</span>
<span class="sd">        See :epkg:`pandas:DataFrame.to_csv`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">path_or_buf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
            <span class="n">close</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_or_buf</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">st</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_or_buf</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;encoding&quot;</span><span class="p">))</span>  <span class="c1"># noqa: SIM115</span>
            <span class="n">close</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">path_or_buf</span>
            <span class="n">close</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;header&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">close</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">StringIO</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">st</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">path_or_buf</span></div>


<div class="viewcode-block" id="StreamingDataFrame.to_dataframe">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.to_dataframe">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts everything into a single :epkg:`DataFrame`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="StreamingDataFrame.to_df">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.to_df">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_df</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts everything into a single :epkg:`DataFrame`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span></div>


<div class="viewcode-block" id="StreamingDataFrame.iterrows">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.iterrows">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">iterrows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See :epkg:`pandas:DataFrame:iterrows`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>  <span class="c1"># noqa: UP028</span>
                <span class="k">yield</span> <span class="n">it</span></div>


<div class="viewcode-block" id="StreamingDataFrame.head">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.head">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">head</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the first rows as a :epkg:`DataFrame`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">h</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">st</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">n</span> <span class="o">-=</span> <span class="n">h</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="StreamingDataFrame.tail">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.tail">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">tail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the last rows as a :epkg:`DataFrame`.</span>
<span class="sd">        The size of chunks must be greater than ``n`` to</span>
<span class="sd">        get ``n`` lines. This method is not efficient</span>
<span class="sd">        because the whole dataset must be walked through.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span></div>


<div class="viewcode-block" id="StreamingDataFrame.where">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.where">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">where</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StreamingDataFrame&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies :epkg:`pandas:DataFrame:where`.</span>
<span class="sd">        *inplace* must be False.</span>
<span class="sd">        This function returns a see :class:`StreamingDataFrame</span>
<span class="sd">        &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;inplace&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="bp">self</span><span class="p">),</span>  <span class="c1"># noqa: C417</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs</span><span class="p">(),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="StreamingDataFrame.sample">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.sample">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reservoir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StreamingDataFrame&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See :meth:`pandas.DataFrame.sample`.</span>
<span class="sd">        Only *frac* is available, otherwise choose :meth`reservoir_sampling`.</span>
<span class="sd">        This function returns a see :class:`StreamingDataFrame</span>
<span class="sd">        &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;`.</span>

<span class="sd">        :param reservoir: use</span>
<span class="sd">            `reservoir sampling &lt;https://en.wikipedia.org/wiki/Reservoir_sampling&gt;`_</span>
<span class="sd">        :param cache: cache the sample</span>
<span class="sd">        :param kwargs: additional parameters for :meth:`pandas.DataFrame.sample`</span>

<span class="sd">        If *cache* is True, the sample is cached (assuming it holds in memory).</span>
<span class="sd">        The second time an iterator walks through the</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">reservoir</span> <span class="ow">or</span> <span class="s2">&quot;n&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;frac&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;frac cannot be specified for reservoir sampling.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reservoir_sampling</span><span class="p">(</span>
                <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">],</span> <span class="n">random_state</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;random_state&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
            <span class="n">sdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">sdf</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="o">.</span><span class="n">read_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="bp">self</span><span class="p">),</span>  <span class="c1"># noqa: C417</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs</span><span class="p">(),</span>
            <span class="n">stable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_reservoir_sampling</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StreamingDataFrame&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uses the `reservoir sampling &lt;https://en.wikipedia.org/wiki/Reservoir_sampling&gt;`_</span>
<span class="sd">        algorithm to draw a random sample with exactly *n* samples.</span>

<span class="sd">        :param cache: cache the sample</span>
<span class="sd">        :param n: number of observations to keep</span>
<span class="sd">        :param random_state: sets the random_state</span>
<span class="sd">        :return: see :class:`StreamingDataFrame</span>
<span class="sd">            &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;`</span>

<span class="sd">        .. warning::</span>
<span class="sd">            The sample is split by chunks of size 1000.</span>
<span class="sd">            This parameter is not yet exposed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cache</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cache=False is not available for reservoir sampling.&quot;</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ir</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
                <span class="n">seen</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                    <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">ir</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">nrandom</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="o">*</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">seen</span> <span class="o">-</span> <span class="n">n</span><span class="p">):</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="n">nrandom</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">indices</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ir</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">reservoir_iterate</span><span class="p">(</span><span class="n">sdf</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">):</span>
            <span class="s2">&quot;iterator&quot;</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ir</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ir</span><span class="p">)</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
                        <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">chunksize</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
                            <span class="n">buffer</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">reservoir_iterate</span><span class="p">(</span><span class="n">sdf</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="p">)</span>

<div class="viewcode-block" id="StreamingDataFrame.drop">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.drop">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">drop</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StreamingDataFrame&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies :epkg:`pandas:DataFrame:drop`.</span>
<span class="sd">        This function returns a see :class:`StreamingDataFrame</span>
<span class="sd">        &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;drop is not implemented for axis=</span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;drop is not implemented for inplace=</span><span class="si">{</span><span class="n">inplace</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="nb">map</span><span class="p">(</span>  <span class="c1"># noqa: C417</span>
                <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                    <span class="n">labels</span><span class="p">,</span>
                    <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
                    <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span>
                    <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
                    <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="bp">self</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs</span><span class="p">(),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="StreamingDataFrame.apply">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.apply">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StreamingDataFrame&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies :epkg:`pandas:DataFrame:apply`.</span>
<span class="sd">        This function returns a see :class:`StreamingDataFrame</span>
<span class="sd">        &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="bp">self</span><span class="p">),</span>  <span class="c1"># noqa: C417</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs</span><span class="p">(),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="StreamingDataFrame.applymap">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.applymap">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">applymap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StreamingDataFrame&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies :epkg:`pandas:DataFrame:applymap`.</span>
<span class="sd">        This function returns a see :class:`StreamingDataFrame</span>
<span class="sd">        &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="bp">self</span><span class="p">),</span>  <span class="c1"># noqa: C417</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs</span><span class="p">(),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="StreamingDataFrame.merge">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.merge">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StreamingDataFrame&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merges two see :class:`StreamingDataFrame</span>
<span class="sd">        &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;`</span>
<span class="sd">        and returns see :class:`StreamingDataFrame</span>
<span class="sd">        &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;`.</span>
<span class="sd">        *right* can be either a see :class:`StreamingDataFrame</span>
<span class="sd">        &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;` or simply</span>
<span class="sd">        a :epkg:`pandas:DataFrame`. It calls :epkg:`pandas:DataFrame:merge` in</span>
<span class="sd">        a double loop, loop on *self*, loop on *right*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">StreamingDataFrame</span><span class="o">.</span><span class="n">read_df</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">right</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">iterator_merge</span><span class="p">(</span><span class="n">sdf1</span><span class="p">,</span> <span class="n">sdf2</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="s2">&quot;iterate on dataframes&quot;</span>
            <span class="k">for</span> <span class="n">df1</span> <span class="ow">in</span> <span class="n">sdf1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">df2</span> <span class="ow">in</span> <span class="n">sdf2</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df2</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">df</span>

        <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">iterator_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="StreamingDataFrame.concat">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.concat">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">concat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">others</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StreamingDataFrame&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Concatenates :epkg:`dataframes`.</span>
<span class="sd">        The function ensures all :epkg:`pandas:DataFrame`</span>
<span class="sd">        or see :class:`StreamingDataFrame</span>
<span class="sd">        &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;`</span>
<span class="sd">        share the same columns (name and type).</span>
<span class="sd">        Otherwise, the function fails as it cannot guess the schema without</span>
<span class="sd">        walking through all :epkg:`dataframes`.</span>

<span class="sd">        :param others: list, enumeration, :epkg:`pandas:DataFrame`</span>
<span class="sd">        :param axis: concatenate by rows (0) or by columns (1)</span>
<span class="sd">        :return: see :class:`StreamingDataFrame</span>
<span class="sd">            &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concath</span><span class="p">(</span><span class="n">others</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concatv</span><span class="p">(</span><span class="n">others</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;axis must be 0 or 1&quot;</span><span class="p">)</span>  <span class="c1"># pragma: no cover</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_concath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">others</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">others</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">others</span> <span class="o">=</span> <span class="p">[</span><span class="n">others</span><span class="p">]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">iterateh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">others</span><span class="p">):</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">others</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dfs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">cols</span><span class="p">):</span>
                <span class="n">nrows</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">nrows</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">max</span><span class="p">(</span><span class="n">nrows</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="s2">&quot;StreamingDataFram cannot merge DataFrame &quot;</span>
                        <span class="s2">&quot;with different size or chunksize&quot;</span>
                    <span class="p">)</span>
                <span class="k">yield</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dfs</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">iterateh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">others</span><span class="p">),</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_concatv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">others</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">iterator_concat</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">lothers</span><span class="p">):</span>
            <span class="s2">&quot;iterator on dataframes&quot;</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">dtypes</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">this</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
                    <span class="n">dtypes</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dtypes</span>
                <span class="k">yield</span> <span class="n">df</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">lothers</span><span class="p">:</span>
                <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Frame others[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] do not have the &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;same column names or the same order.&quot;</span>
                            <span class="p">)</span>
                        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">dtypes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Frame others[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] do not have the same column types.&quot;</span>
                            <span class="p">)</span>
                        <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">yield</span> <span class="n">df</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">others</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">others</span> <span class="o">=</span> <span class="p">[</span><span class="n">others</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">others</span><span class="p">,</span> <span class="n">StreamingDataFrame</span><span class="p">):</span>
            <span class="n">others</span> <span class="o">=</span> <span class="p">[</span><span class="n">others</span><span class="p">]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">change_type</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="s2">&quot;change column type&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="o">.</span><span class="n">read_df</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">obj</span>

        <span class="n">others</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">change_type</span><span class="p">,</span> <span class="n">others</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">iterator_concat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">others</span><span class="p">),</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs</span><span class="p">()</span>
        <span class="p">)</span>

<div class="viewcode-block" id="StreamingDataFrame.groupby">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.groupby">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">groupby</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lambda_agg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lambda_agg_agg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">in_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implements the streaming :epkg:`pandas:DataFrame:groupby`.</span>
<span class="sd">        We assume the result holds in memory. The out-of-memory is</span>
<span class="sd">        not implemented yet.</span>

<span class="sd">        :param by: see :epkg:`pandas:DataFrame:groupby`</span>
<span class="sd">        :param in_memory: in-memory algorithm</span>
<span class="sd">        :param lambda_agg: aggregation function, *sum* by default</span>
<span class="sd">        :param lambda_agg_agg: to aggregate the aggregations, *sum* by default</span>
<span class="sd">        :param kwargs: additional parameters for :epkg:`pandas:DataFrame:groupby`</span>
<span class="sd">        :return: :epkg:`pandas:DataFrame`</span>

<span class="sd">        As the input see :class:`StreamingDataFrame</span>
<span class="sd">        &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;` does not necessarily hold</span>
<span class="sd">        in memory, the aggregation must be done at every iteration.</span>
<span class="sd">        There are two levels of aggregation: one to reduce every iterated</span>
<span class="sd">        :epkg:`dataframe`, another one to combine all the reduced :epkg:`dataframes`.</span>
<span class="sd">        This second one is always a **sum**.</span>
<span class="sd">        As a consequence, this function should not compute any *mean* or *count*,</span>
<span class="sd">        only *sum* because we do not know the size of each iterated</span>
<span class="sd">        :epkg:`dataframe`. To compute an average, sum and weights must be</span>
<span class="sd">        aggregated.</span>

<span class="sd">        Parameter *lambda_agg* is ``lambda gr: gr.sum()`` by default.</span>
<span class="sd">        It could also be ``lambda gr: gr.max()`` or</span>
<span class="sd">        ``lambda gr: gr.min()`` but not ``lambda gr: gr.mean()``</span>
<span class="sd">        as it would lead to incoherent results.</span>

<span class="sd">        .. exref::</span>
<span class="sd">            :title: StreamingDataFrame and groupby</span>
<span class="sd">            :tag: streaming</span>

<span class="sd">            Here is an example which shows how to write a simple *groupby*</span>
<span class="sd">            with :epkg:`pandas` and see :class:`StreamingDataFrame</span>
<span class="sd">            &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;`.</span>

<span class="sd">            .. runpython::</span>
<span class="sd">                :showcode:</span>

<span class="sd">                from pandas import DataFrame</span>
<span class="sd">                from pandas_streaming.df import StreamingDataFrame</span>

<span class="sd">                df = DataFrame(dict(A=[3, 4, 3], B=[5,6, 7]))</span>
<span class="sd">                sdf = StreamingDataFrame.read_df(df)</span>

<span class="sd">                # The following:</span>
<span class="sd">                print(sdf.groupby(&quot;A&quot;, lambda gr: gr.sum()))</span>

<span class="sd">                # Is equivalent to:</span>
<span class="sd">                print(df.groupby(&quot;A&quot;).sum())</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_memory</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Out-of-memory group by is not implemented.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lambda_agg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">lambda_agg_</span><span class="p">(</span><span class="n">gr</span><span class="p">):</span>
                <span class="s2">&quot;sum&quot;</span>
                <span class="k">return</span> <span class="n">gr</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="n">lambda_agg</span> <span class="o">=</span> <span class="n">lambda_agg_</span>
        <span class="k">if</span> <span class="n">lambda_agg_agg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">lambda_agg_agg_</span><span class="p">(</span><span class="n">gr</span><span class="p">):</span>
                <span class="s2">&quot;sum&quot;</span>
                <span class="k">return</span> <span class="n">gr</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="n">lambda_agg_agg</span> <span class="o">=</span> <span class="n">lambda_agg_agg_</span>
        <span class="n">ckw</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ckw</span><span class="p">[</span><span class="s2">&quot;as_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">agg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">gr</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">by</span><span class="p">,</span> <span class="o">**</span><span class="n">ckw</span><span class="p">)</span>
            <span class="n">agg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lambda_agg</span><span class="p">(</span><span class="n">gr</span><span class="p">))</span>
        <span class="n">conc</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">agg</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lambda_agg_agg</span><span class="p">(</span><span class="n">conc</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">by</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span></div>


<div class="viewcode-block" id="StreamingDataFrame.groupby_streaming">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.groupby_streaming">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">groupby_streaming</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">lambda_agg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">lambda_agg_agg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">in_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;cum&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implements the streaming :epkg:`pandas:DataFrame:groupby`.</span>
<span class="sd">        We assume the result holds in memory. The out-of-memory is</span>
<span class="sd">        not implemented yet.</span>

<span class="sd">        :param by: see :epkg:`pandas:DataFrame:groupby`</span>
<span class="sd">        :param in_memory: in-memory algorithm</span>
<span class="sd">        :param lambda_agg: aggregation function, *sum* by default</span>
<span class="sd">        :param lambda_agg_agg: to aggregate the aggregations, *sum* by default</span>
<span class="sd">        :param kwargs: additional parameters for :epkg:`pandas:DataFrame:groupby`</span>
<span class="sd">        :param strategy: ``&#39;cum&#39;``, or ``&#39;streaming&#39;``, see below</span>
<span class="sd">        :return: :epkg:`pandas:DataFrame`</span>

<span class="sd">        As the input see :class:`StreamingDataFrame</span>
<span class="sd">        &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;` does not necessarily hold</span>
<span class="sd">        in memory, the aggregation must be done at every iteration.</span>
<span class="sd">        There are two levels of aggregation: one to reduce every iterated</span>
<span class="sd">        :epkg:`dataframe`, another one to combine all the reduced :epkg:`dataframes`.</span>
<span class="sd">        This second one is always a **sum**.</span>
<span class="sd">        As a consequence, this function should not compute any *mean* or *count*,</span>
<span class="sd">        only *sum* because we do not know the size of each iterated</span>
<span class="sd">        :epkg:`dataframe`. To compute an average, sum and weights must be</span>
<span class="sd">        aggregated.</span>

<span class="sd">        Parameter *lambda_agg* is ``lambda gr: gr.sum()`` by default.</span>
<span class="sd">        It could also be ``lambda gr: gr.max()`` or</span>
<span class="sd">        ``lambda gr: gr.min()`` but not ``lambda gr: gr.mean()``</span>
<span class="sd">        as it would lead to incoherent results.</span>

<span class="sd">        Parameter *strategy* allows three scenarios.</span>
<span class="sd">        First one if ``strategy is None`` goes through</span>
<span class="sd">        the whole datasets to produce a final :epkg:`DataFrame`.</span>
<span class="sd">        Second if ``strategy==&#39;cum&#39;`` returns a</span>
<span class="sd">        see :class:`StreamingDataFrame</span>
<span class="sd">        &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;`,</span>
<span class="sd">        each iteration produces</span>
<span class="sd">        the current status of the *group by*. Last case,</span>
<span class="sd">        ``strategy==&#39;streaming&#39;`` produces :epkg:`DataFrame`</span>
<span class="sd">        which must be concatenated into a single :epkg:`DataFrame`</span>
<span class="sd">        and grouped again to get the results.</span>

<span class="sd">        .. exref::</span>
<span class="sd">            :title: StreamingDataFrame and groupby</span>
<span class="sd">            :tag: streaming</span>

<span class="sd">            Here is an example which shows how to write a simple *groupby*</span>
<span class="sd">            with :epkg:`pandas` and see :class:`StreamingDataFrame</span>
<span class="sd">            &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;`.</span>

<span class="sd">            .. runpython::</span>
<span class="sd">                :showcode:</span>

<span class="sd">                from pandas import DataFrame</span>
<span class="sd">                from pandas_streaming.df import StreamingDataFrame</span>
<span class="sd">                from pandas_streaming.data import dummy_streaming_dataframe</span>

<span class="sd">                df20 = dummy_streaming_dataframe(20).to_dataframe()</span>
<span class="sd">                df20[&quot;key&quot;] = df20[&quot;cint&quot;].apply(lambda i: i % 3 == 0)</span>
<span class="sd">                sdf20 = StreamingDataFrame.read_df(df20, chunksize=5)</span>
<span class="sd">                sgr = sdf20.groupby_streaming(&quot;key&quot;, lambda gr: gr.sum(),</span>
<span class="sd">                                              strategy=&#39;cum&#39;, as_index=False)</span>
<span class="sd">                for gr in sgr:</span>
<span class="sd">                    print()</span>
<span class="sd">                    print(gr)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_memory</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Out-of-memory group by is not implemented.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lambda_agg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">lambda_agg_</span><span class="p">(</span><span class="n">gr</span><span class="p">):</span>
                <span class="s2">&quot;sum&quot;</span>
                <span class="k">return</span> <span class="n">gr</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="n">lambda_agg</span> <span class="o">=</span> <span class="n">lambda_agg_</span>
        <span class="k">if</span> <span class="n">lambda_agg_agg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">lambda_agg_agg_</span><span class="p">(</span><span class="n">gr</span><span class="p">):</span>
                <span class="s2">&quot;sum&quot;</span>
                <span class="k">return</span> <span class="n">gr</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="n">lambda_agg_agg</span> <span class="o">=</span> <span class="n">lambda_agg_agg_</span>
        <span class="n">ckw</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ckw</span><span class="p">[</span><span class="s2">&quot;as_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;cum&quot;</span><span class="p">:</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">iterate_cum</span><span class="p">():</span>
                <span class="n">agg</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="n">gr</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">by</span><span class="p">,</span> <span class="o">**</span><span class="n">ckw</span><span class="p">)</span>
                    <span class="n">gragg</span> <span class="o">=</span> <span class="n">lambda_agg</span><span class="p">(</span><span class="n">gr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">agg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">lambda_agg_agg</span><span class="p">(</span><span class="n">gragg</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">by</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
                        <span class="n">agg</span> <span class="o">=</span> <span class="n">gragg</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lagg</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">agg</span><span class="p">,</span> <span class="n">gragg</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">yield</span> <span class="n">lambda_agg_agg</span><span class="p">(</span><span class="n">lagg</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">by</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
                        <span class="n">agg</span> <span class="o">=</span> <span class="n">lagg</span>

            <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">iterate_cum</span><span class="p">(),</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;streaming&quot;</span><span class="p">:</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">iterate_streaming</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="n">gr</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">by</span><span class="p">,</span> <span class="o">**</span><span class="n">ckw</span><span class="p">)</span>
                    <span class="n">gragg</span> <span class="o">=</span> <span class="n">lambda_agg</span><span class="p">(</span><span class="n">gr</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">lambda_agg</span><span class="p">(</span><span class="n">gragg</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">by</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">iterate_streaming</span><span class="p">(),</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs</span><span class="p">())</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown strategy &#39;</span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>  <span class="c1"># pragma: no cover</span></div>


<div class="viewcode-block" id="StreamingDataFrame.ensure_dtype">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.ensure_dtype">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">ensure_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensures the :epkg:`dataframe` *df* has types indicated in dtypes.</span>
<span class="sd">        Changes it if not.</span>

<span class="sd">        :param df: dataframe</span>
<span class="sd">        :param dtypes: list of types</span>
<span class="sd">        :return: updated?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">has</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">has</span> <span class="o">!=</span> <span class="n">exp</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">df</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
                <span class="n">ch</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">ch</span></div>


<div class="viewcode-block" id="StreamingDataFrame.__getitem__">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.__getitem__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implements some of the functionalities :epkg:`pandas`</span>
<span class="sd">        offers for the operator ``[]``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>  <span class="c1"># pragma: no cover</span>
                <span class="s2">&quot;Only a list of columns is supported.&quot;</span>
            <span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># One column.</span>
            <span class="n">iter_creation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_creation</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">iterate_col</span><span class="p">():</span>
                <span class="s2">&quot;iterate on one column&quot;</span>
                <span class="n">one_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">cols</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">iter_creation</span><span class="p">():</span>
                    <span class="k">yield</span> <span class="n">df</span><span class="p">[</span><span class="n">one_col</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">StreamingSeries</span><span class="p">(</span><span class="n">iterate_col</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs</span><span class="p">())</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only a list of columns is supported.&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">iterate_cols</span><span class="p">(</span><span class="n">sdf</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Iterate on columns.&quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">sdf</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">iterate_cols</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs</span><span class="p">())</span></div>


<div class="viewcode-block" id="StreamingDataFrame.__setitem__">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.__setitem__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Limited set of operators are supported.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Only column affected are supported but index=</span><span class="si">{</span><span class="n">index</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="c1"># Is is equivalent to add_column.</span>
            <span class="n">iter_creation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_creation</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">iterate_fct</span><span class="p">():</span>
                <span class="s2">&quot;iterate on rows&quot;</span>
                <span class="n">iters</span> <span class="o">=</span> <span class="n">iter_creation</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">iters</span><span class="p">:</span>
                    <span class="n">dfc</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">dfc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">yield</span> <span class="n">dfc</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">iter_creation</span> <span class="o">=</span> <span class="n">iterate_fct</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">StreamingSeries</span><span class="p">):</span>
            <span class="n">iter_creation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_creation</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">iterate_fct</span><span class="p">():</span>
                <span class="s2">&quot;iterate on rows&quot;</span>
                <span class="n">iters</span> <span class="o">=</span> <span class="n">iter_creation</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">df</span><span class="p">,</span> <span class="n">dfs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">iters</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                            <span class="s2">&quot;Chunksize or shape are different when &quot;</span>
                            <span class="s2">&quot;iterating on two StreamDataFrame at the same &quot;</span>
                            <span class="s2">&quot;time: </span><span class="si">%r</span><span class="s2"> != </span><span class="si">%r</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="p">)</span>
                    <span class="n">dfc</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">dfc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfs</span>
                    <span class="k">yield</span> <span class="n">dfc</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">iter_creation</span> <span class="o">=</span> <span class="n">iterate_fct</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Not implemented for type(index)=</span><span class="si">%r</span><span class="s2"> and type(value)=</span><span class="si">%r</span><span class="s2">.&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="StreamingDataFrame.add_column">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.add_column">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implements some of the functionalities :epkg:`pandas`</span>
<span class="sd">        offers for the operator ``[]``.</span>

<span class="sd">        :param col: new column</span>
<span class="sd">        :param value: see :class:`StreamingDataFrame</span>
<span class="sd">            &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;` or a lambda function</span>
<span class="sd">        :return: see :class:`StreamingDataFrame</span>
<span class="sd">            &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;`</span>

<span class="sd">        ..note::</span>

<span class="sd">            If value is a see :class:`StreamingDataFrame</span>
<span class="sd">            &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;`,</span>
<span class="sd">            *chunksize* must be the same for both.</span>

<span class="sd">        .. exref::</span>
<span class="sd">            :title: Add a new column to a StreamingDataFrame</span>
<span class="sd">            :tag: streaming</span>

<span class="sd">            .. runpython::</span>
<span class="sd">                :showcode:</span>

<span class="sd">                from pandas import DataFrame</span>
<span class="sd">                from pandas_streaming.df import StreamingDataFrame</span>

<span class="sd">                df = DataFrame(data=dict(X=[4.5, 6, 7], Y=[&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]))</span>
<span class="sd">                sdf = StreamingDataFrame.read_df(df)</span>
<span class="sd">                sdf2 = sdf.add_column(&quot;d&quot;, lambda row: int(1))</span>
<span class="sd">                print(sdf2.to_dataframe())</span>

<span class="sd">                sdf2 = sdf.add_column(&quot;d&quot;, lambda row: int(1))</span>
<span class="sd">                print(sdf2.to_dataframe())</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>  <span class="c1"># pragma: no cover</span>
                <span class="s2">&quot;Only a column as a string is supported.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">isfunction</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">iterate_fct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
                <span class="s2">&quot;iterate on rows&quot;</span>
                <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="n">dfc</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">dfc</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">col</span><span class="p">,</span> <span class="n">dfc</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                    <span class="k">yield</span> <span class="n">dfc</span>

            <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">iterate_fct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">col</span><span class="p">),</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs</span><span class="p">()</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">StreamingDataFrame</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Unable set a new column based on a datadframe.&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">iterate_cst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
            <span class="s2">&quot;iterate on rows&quot;</span>
            <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="n">dfc</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">dfc</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">yield</span> <span class="n">dfc</span>

        <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">iterate_cst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">col</span><span class="p">),</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="StreamingDataFrame.fillna">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.fillna">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fillna</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Replaces the missing values, calls</span>
<span class="sd">        :epkg:`pandas:DataFrame:fillna`.</span>

<span class="sd">        :param kwargs: see :meth:`pandas.DataFrame.fillna`</span>
<span class="sd">        :return: see :class:`StreamingDataFrame</span>
<span class="sd">            &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;`</span>

<span class="sd">        .. warning::</span>
<span class="sd">            The function does not check what happens at the</span>
<span class="sd">            limit of every chunk of data. Anything but a constant value</span>
<span class="sd">            will probably have an inconsistent behaviour.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">iterate_na</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="s2">&quot;iterate on rows&quot;</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;inplace&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;inplace&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">df</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">StreamingDataFrame</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">iterate_na</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="StreamingDataFrame.describe">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.describe">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">percentiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls :epkg:`pandas:DataFrame:describe` on every piece</span>
<span class="sd">        of the datasets. *percentiles* are not really accurate</span>
<span class="sd">        but just an indication.</span>

<span class="sd">        :param percentiles: see :epkg:`pandas:DataFrame:describe`</span>
<span class="sd">        :param include: see :epkg:`pandas:DataFrame:describe`</span>
<span class="sd">        :param exclude: see :epkg:`pandas:DataFrame:describe`</span>
<span class="sd">        :return: :epkg:`pandas:DataFrame:describe`</span>

<span class="sd">        .. versionchanged:: 0.3.219</span>

<span class="sd">            Parameter *datetime_is_numeric* was removed</span>
<span class="sd">            (see :epkg:`pandas:DataFrame:describe`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">notper</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span>
                <span class="n">percentiles</span><span class="o">=</span><span class="n">percentiles</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span>
            <span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">desc</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">notper</span><span class="p">]</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">desc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rows</span><span class="p">,</span> <span class="p">:])</span>
            <span class="k">if</span> <span class="n">merged</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">merged</span> <span class="o">=</span> <span class="n">desc</span>
                <span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="p">)</span> <span class="o">*</span> <span class="n">count</span>
                <span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="n">count</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">desc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">desc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">count</span>
                <span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="n">desc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">desc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="p">)</span> <span class="o">*</span> <span class="n">count</span>
                <span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                    <span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="p">:],</span> <span class="n">desc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">)</span>
                <span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                    <span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="p">:],</span> <span class="n">desc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">)</span>
        <span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/=</span> <span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="n">percentiles</span><span class="p">)</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">notper</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">summary</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">notper</span><span class="p">]</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rows</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">merged</span><span class="p">,</span> <span class="n">summary</span><span class="p">])</span></div>


<div class="viewcode-block" id="StreamingDataFrame.sort_values">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.sort_values">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sort_values</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">by</span><span class="p">,</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;quicksort&quot;</span><span class="p">,</span>
        <span class="n">na_position</span><span class="o">=</span><span class="s2">&quot;last&quot;</span><span class="p">,</span>
        <span class="n">temp_file</span><span class="o">=</span><span class="s2">&quot;_pandas_streaming_sort_values_&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sorts the streaming dataframe by values.</span>

<span class="sd">        :param by: one column</span>
<span class="sd">        :param ascending: order</span>
<span class="sd">        :param kind: see :meth:`pandas.DataFrame.sort_values`</span>
<span class="sd">        :param na_position: see :meth:`pandas.DataFrame.sort_values`</span>
<span class="sd">        :param temp_file: sorting a whole database is impossible</span>
<span class="sd">            without storing intermediate results on disk</span>
<span class="sd">            unless it can fit into the memory, but in that case,</span>
<span class="sd">            it is easier to convert the streaming database into</span>
<span class="sd">            a dataframe and sort it</span>
<span class="sd">        :return: streaming database</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">by</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>  <span class="c1"># pragma: no cover</span>
                <span class="sa">f</span><span class="s2">&quot;Only one column can be used to sort not </span><span class="si">{</span><span class="n">by</span><span class="si">!r}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">nans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="n">dfs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
                    <span class="n">by</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="n">ascending</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">na_position</span><span class="o">=</span><span class="n">na_position</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">tu</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">[</span><span class="n">by</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tu</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tu</span><span class="p">):</span>
                        <span class="n">nans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">tu</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                            <span class="n">keys</span><span class="p">[</span><span class="n">tu</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">keys</span><span class="p">[</span><span class="n">tu</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span>
                <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
                <span class="n">st</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">st</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

            <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>

        <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">keys</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">values</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="ow">not</span> <span class="n">ascending</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">iterate</span><span class="p">():</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">na_position</span> <span class="o">==</span> <span class="s2">&quot;first&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">nans</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>
                        <span class="n">length</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">indices</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                        <span class="n">pkl</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
                        <span class="n">dfs</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">pkl</span><span class="p">))</span>
                        <span class="n">sub</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dfs</span><span class="p">[</span><span class="n">by</span><span class="p">])]</span>
                        <span class="k">yield</span> <span class="n">sub</span>

                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">positions</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>
                        <span class="n">length</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">indices</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                        <span class="n">pkl</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
                        <span class="n">dfs</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">pkl</span><span class="p">))</span>
                        <span class="n">sub</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="n">dfs</span><span class="p">[</span><span class="n">by</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
                        <span class="k">yield</span> <span class="n">sub</span>

                <span class="k">if</span> <span class="n">na_position</span> <span class="o">==</span> <span class="s2">&quot;last&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">nans</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>
                        <span class="n">length</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">indices</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                        <span class="n">pkl</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
                        <span class="n">dfs</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">pkl</span><span class="p">))</span>
                        <span class="n">sub</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dfs</span><span class="p">[</span><span class="n">by</span><span class="p">])]</span>
                        <span class="k">yield</span> <span class="n">sub</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">StreamingDataFrame</span><span class="p">(</span><span class="n">iterate</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs</span><span class="p">())</span>
        <span class="n">res</span><span class="o">.</span><span class="n">_delete_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_file</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="StreamingDataFrame.__del__">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingDataFrame.__del__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls every function in `_delete_`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delete_</span><span class="p">:</span>
            <span class="n">f</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="StreamingSeries">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingSeries">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">StreamingSeries</span><span class="p">(</span><span class="n">StreamingDataFrame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Seens as a see :class:`StreamingDataFrame</span>
<span class="sd">    &lt;pandas_streaming.df.dataframe.StreamingDataFrame&gt;` of one column.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iter_creation</span><span class="p">,</span> <span class="n">check_schema</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stable</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">StreamingDataFrame</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">iter_creation</span><span class="p">,</span> <span class="n">check_schema</span><span class="o">=</span><span class="n">check_schema</span><span class="p">,</span> <span class="n">stable</span><span class="o">=</span><span class="n">stable</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>  <span class="c1"># pragma: no cover</span>
                <span class="sa">f</span><span class="s2">&quot;A series can contain only one column not </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">!r}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

<div class="viewcode-block" id="StreamingSeries.apply">
<a class="viewcode-back" href="../../../api/dataframe.html#pandas_streaming.df.dataframe.StreamingSeries.apply">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StreamingDataFrame&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies :epkg:`pandas:Series:apply`.</span>
<span class="sd">        This function returns a @see cl StreamingSeries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">StreamingSeries</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="bp">self</span><span class="p">),</span>  <span class="c1"># noqa: C417</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs</span><span class="p">(),</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Does an addition on every value hoping that has a meaning.</span>

<span class="sd">        :param value: any value which makes sense</span>
<span class="sd">        :return: a new series</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">iterate</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">df</span> <span class="o">+</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">StreamingSeries</span><span class="p">(</span><span class="n">iterate</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs</span><span class="p">())</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2017-2024, Xavier Dupré
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../../_static/documentation_options.js?v=5f152624"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/scripts/furo.js?v=46bd48cc"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    </body>
</html>
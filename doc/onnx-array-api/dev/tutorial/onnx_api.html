<!doctype html>
<html class="no-js" lang="en" data-content_root="">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Light API for ONNX: everything in one line" href="light_api.html" /><link rel="prev" title="Tutorial" href="index.html" />

    <!-- Generated with Sphinx 7.1.2 and Furo 2023.09.10 -->
        <title>Many ways to implement a custom graph in ONNX - onnx-array-api 0.1.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b76e3c8a" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css?v=7f9a90b1" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=61a4c737" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">onnx-array-api 0.1.2 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/logo.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">onnx-array-api 0.1.2 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Tutorial</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Tutorial</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Many ways to implement a custom graph in ONNX</a></li>
<li class="toctree-l2"><a class="reference internal" href="light_api.html">Light API for ONNX: everything in one line</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="numpy_api.html">Numpy API for ONNX</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Numpy API for ONNX</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../auto_examples/plot_first_example.html">First examples with onnx-array-api</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auto_examples/plot_onnxruntime.html">First examples with onnxruntime</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="benchmarks.html">Benchmarks</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Benchmarks</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../auto_examples/plot_benchmark_rf.html">Benchmark of TreeEnsemble implementation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api/index.html">API</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of API</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/array_api.html">onnx_array_api.array_api</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of onnx_array_api.array_api</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/array_api_numpy.html">onnx_array_api.array_api.onnx_numpy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/array_api_ort.html">onnx_array_api.array_api.onnx_ort</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/npx_array_api.html">onnx_array_api.npx.npx_array_api</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/light_api.html">onnx_array_api.light_api</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/npx_core_api.html">npx_core_api</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/npx_functions.html">npx.npx_functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/npx_jit_eager.html">npx_jit_eager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/npx_numpy.html">npx.npx_numpy_tensors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/npx_tensors.html">npx_tensors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/npx_types.html">npx.npx_types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/npx_types.html#shortcuts">Shortcuts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/npx_var.html">npx.npx_var</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/onnx_tools.html">onnx tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/ort.html">ort</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/plotting.html">plotting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/reference.html">reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/tools.html">tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/profiling.html">profiling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/f8.html">Float 8</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/docs.html">validation.docs</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tech/index.html">Technical Details</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Technical Details</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../tech/aapi.html">Difficulty to implement an Array API for ONNX</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../auto_examples/index.html">Example gallery</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of Example gallery</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../auto_examples/plot_f8.html">About float 8</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auto_examples/plot_first_example.html">First examples with onnx-array-api</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auto_examples/plot_onnxruntime.html">First examples with onnxruntime</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auto_examples/plot_optimization.html">Optimization with onnxruntime</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auto_examples/plot_profiling.html">Profiling with onnxruntime</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auto_examples/plot_benchmark_rf.html">Benchmark of TreeEnsemble implementation</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">More</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../CHANGELOGS.html">Change Logs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">License</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="many-ways-to-implement-a-custom-graph-in-onnx">
<h1>Many ways to implement a custom graph in ONNX<a class="headerlink" href="#many-ways-to-implement-a-custom-graph-in-onnx" title="Permalink to this heading">#</a></h1>
<p><a class="reference external" href="https://onnx.ai/">ONNX</a> defines a long list of operators used in machine learning models.
They are used to implement functions. This step is usually taken care of
by converting libraries: <a class="reference external" href="https://onnx.ai/sklearn-onnx/">sklearn-onnx</a> for <a class="reference external" href="https://scikit-learn.org/stable/">scikit-learn</a>,
<a class="reference external" href="https://pytorch.org/docs/stable/onnx.html">torch.onnx</a> for <a class="reference external" href="https://pytorch.org/">pytorch</a>, <a class="reference external" href="https://github.com/onnx/tensorflow-onnx">tensorflow-onnx</a> for <a class="reference external" href="https://www.tensorflow.org/">tensorflow</a>.
Both <a class="reference external" href="https://pytorch.org/docs/stable/onnx.html">torch.onnx</a> and <a class="reference external" href="https://github.com/onnx/tensorflow-onnx">tensorflow-onnx</a> converts any function expressed
with the available function in those packages and that works because
there is usually no need to mix packages.
But in some occasions, there is a need to directly write functions with the
onnx syntax. <a class="reference external" href="https://scikit-learn.org/stable/">scikit-learn</a> is implemented with <a class="reference external" href="https://numpy.org/">numpy</a> and there
is no converter from numpy to onnx. Sometimes, it is needed to extend
an existing onnx models or to merge models coming from different packages.
Sometimes, they are just not available, only onnx is.
Let’s see how it looks like a very simply example.</p>
<section id="euclidian-distance">
<h2>Euclidian distance<a class="headerlink" href="#euclidian-distance" title="Permalink to this heading">#</a></h2>
<p>For example, the well known Euclidian distance
<img class="math" src="../_images/math/7bf0fb1c4ccff5eb925241f664ba47f60b75de41.svg" alt="f(X,Y)=\sum_{i=1}^n (X_i - Y_i)^2"/> can be expressed with numpy as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">euclidan</span><span class="p">(</span><span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">Y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">Y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
<p>The mathematical function must first be translated with <a class="reference external" href="https://onnx.ai/onnx/operators/">ONNX Operators</a> or
primitives. It is usually easy because the primitives are very close to what
numpy defines. It can be expressed as (the syntax is just for illustration).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">onnx</span>

<span class="n">onnx</span><span class="o">-</span><span class="k">def</span> <span class="nf">euclidian</span><span class="p">(</span><span class="n">X</span><span class="p">:</span> <span class="n">onnx</span><span class="o">.</span><span class="n">TensorProto</span><span class="p">[</span><span class="n">FLOAT</span><span class="p">],</span> <span class="n">X</span><span class="p">:</span> <span class="n">onnx</span><span class="o">.</span><span class="n">TensorProto</span><span class="p">[</span><span class="n">FLOAT</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">onnx</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">:</span>
    <span class="n">dxy</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="n">sxy</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">Pow</span><span class="p">(</span><span class="n">dxy</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">ReduceSum</span><span class="p">(</span><span class="n">sxy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span>
</pre></div>
</div>
<p>This example is short but does not work as it is.
The <a class="reference external" href="https://onnx.ai/onnx/intro/python.html">inner API</a> defined in <a class="reference external" href="https://onnx.ai/onnx/api/helper.html">onnx.helper</a> is quite verbose and
the true implementation would be the following.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">onnx</span>
<span class="kn">import</span> <span class="nn">onnx.helper</span> <span class="k">as</span> <span class="nn">oh</span>


<span class="k">def</span> <span class="nf">make_euclidean</span><span class="p">(</span>
    <span class="n">input_names</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">),</span>
    <span class="n">output_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Z&quot;</span><span class="p">,</span>
    <span class="n">elem_type</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span>
    <span class="n">opset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">onnx</span><span class="o">.</span><span class="n">ModelProto</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">opset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">opset</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">onnx_opset_version</span><span class="p">()</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">oh</span><span class="o">.</span><span class="n">make_tensor_value_info</span><span class="p">(</span><span class="n">input_names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">elem_type</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">oh</span><span class="o">.</span><span class="n">make_tensor_value_info</span><span class="p">(</span><span class="n">input_names</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">elem_type</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">oh</span><span class="o">.</span><span class="n">make_tensor_value_info</span><span class="p">(</span><span class="n">output_name</span><span class="p">,</span> <span class="n">elem_type</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">two</span> <span class="o">=</span> <span class="n">oh</span><span class="o">.</span><span class="n">make_tensor</span><span class="p">(</span><span class="s2">&quot;two&quot;</span><span class="p">,</span> <span class="n">onnx</span><span class="o">.</span><span class="n">TensorProto</span><span class="o">.</span><span class="n">INT64</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="n">oh</span><span class="o">.</span><span class="n">make_node</span><span class="p">(</span><span class="s2">&quot;Sub&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;dxy&quot;</span><span class="p">])</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="n">oh</span><span class="o">.</span><span class="n">make_node</span><span class="p">(</span><span class="s2">&quot;Pow&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;dxy&quot;</span><span class="p">,</span> <span class="s2">&quot;two&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;dxy2&quot;</span><span class="p">])</span>
        <span class="n">n3</span> <span class="o">=</span> <span class="n">oh</span><span class="o">.</span><span class="n">make_node</span><span class="p">(</span><span class="s2">&quot;ReduceSum&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;dxy2&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">output_name</span><span class="p">])</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">oh</span><span class="o">.</span><span class="n">make_graph</span><span class="p">([</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">],</span> <span class="s2">&quot;euclidian&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">],</span> <span class="p">[</span><span class="n">Z</span><span class="p">],</span> <span class="p">[</span><span class="n">two</span><span class="p">])</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">oh</span><span class="o">.</span><span class="n">make_model</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">opset_imports</span><span class="o">=</span><span class="p">[</span><span class="n">oh</span><span class="o">.</span><span class="n">make_opsetid</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">opset</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">model</span>


<span class="n">model</span> <span class="o">=</span> <span class="n">make_euclidean</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">ir_version</span><span class="p">:</span> <span class="mi">9</span>
    <span class="n">opset_import</span> <span class="p">{</span>
      <span class="n">domain</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
      <span class="n">version</span><span class="p">:</span> <span class="mi">21</span>
    <span class="p">}</span>
    <span class="n">graph</span> <span class="p">{</span>
      <span class="n">node</span> <span class="p">{</span>
        <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span>
        <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span>
        <span class="n">output</span><span class="p">:</span> <span class="s2">&quot;dxy&quot;</span>
        <span class="n">op_type</span><span class="p">:</span> <span class="s2">&quot;Sub&quot;</span>
      <span class="p">}</span>
      <span class="n">node</span> <span class="p">{</span>
        <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;dxy&quot;</span>
        <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;two&quot;</span>
        <span class="n">output</span><span class="p">:</span> <span class="s2">&quot;dxy2&quot;</span>
        <span class="n">op_type</span><span class="p">:</span> <span class="s2">&quot;Pow&quot;</span>
      <span class="p">}</span>
      <span class="n">node</span> <span class="p">{</span>
        <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;dxy2&quot;</span>
        <span class="n">output</span><span class="p">:</span> <span class="s2">&quot;Z&quot;</span>
        <span class="n">op_type</span><span class="p">:</span> <span class="s2">&quot;ReduceSum&quot;</span>
      <span class="p">}</span>
      <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;euclidian&quot;</span>
      <span class="n">initializer</span> <span class="p">{</span>
        <span class="n">dims</span><span class="p">:</span> <span class="mi">1</span>
        <span class="n">data_type</span><span class="p">:</span> <span class="mi">7</span>
        <span class="n">int64_data</span><span class="p">:</span> <span class="mi">2</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;two&quot;</span>
      <span class="p">}</span>
      <span class="nb">input</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span>
        <span class="nb">type</span> <span class="p">{</span>
          <span class="n">tensor_type</span> <span class="p">{</span>
            <span class="n">elem_type</span><span class="p">:</span> <span class="mi">1</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nb">input</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span>
        <span class="nb">type</span> <span class="p">{</span>
          <span class="n">tensor_type</span> <span class="p">{</span>
            <span class="n">elem_type</span><span class="p">:</span> <span class="mi">1</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">output</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;Z&quot;</span>
        <span class="nb">type</span> <span class="p">{</span>
          <span class="n">tensor_type</span> <span class="p">{</span>
            <span class="n">elem_type</span><span class="p">:</span> <span class="mi">1</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>Since it is a second implementation of an existing function, it is necessary to
check the output is the same.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_allclose</span>
<span class="kn">from</span> <span class="nn">onnx.reference</span> <span class="kn">import</span> <span class="n">ReferenceEvaluator</span>
<span class="kn">from</span> <span class="nn">onnx_array_api.ext_test_case</span> <span class="kn">import</span> <span class="n">ExtTestCase</span>

<span class="c1"># This is the same function.</span>
<span class="kn">from</span> <span class="nn">onnx_array_api.validation.docs</span> <span class="kn">import</span> <span class="n">make_euclidean</span>


<span class="k">def</span> <span class="nf">test_make_euclidean</span><span class="p">():</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">make_euclidean</span><span class="p">()</span>

    <span class="n">ref</span> <span class="o">=</span> <span class="n">ReferenceEvaluator</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">Y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">got</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">Y</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">assert_allclose</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>


<span class="n">test_make_euclidean</span><span class="p">()</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    
</pre></div>
</div>
<p>But the reference implementation in onnx is not the runtime used to deploy the model.
A second unit test must be added to check this one as well.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_allclose</span>
<span class="kn">from</span> <span class="nn">onnx_array_api.ext_test_case</span> <span class="kn">import</span> <span class="n">ExtTestCase</span>

<span class="c1"># This is the same function.</span>
<span class="kn">from</span> <span class="nn">onnx_array_api.validation.docs</span> <span class="kn">import</span> <span class="n">make_euclidean</span>


<span class="k">def</span> <span class="nf">test_make_euclidean_ort</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">onnxruntime</span> <span class="kn">import</span> <span class="n">InferenceSession</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">make_euclidean</span><span class="p">()</span>

    <span class="n">ref</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span>
        <span class="n">model</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">(),</span> <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CPUExecutionProvider&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">Y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">got</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">Y</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">assert_allclose</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>


<span class="k">try</span><span class="p">:</span>
    <span class="n">test_make_euclidean_ort</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="p">[</span><span class="n">ONNXRuntimeError</span><span class="p">]</span> <span class="p">:</span> <span class="mi">2</span> <span class="p">:</span> <span class="n">INVALID_ARGUMENT</span> <span class="p">:</span> <span class="n">Failed</span> <span class="n">to</span> <span class="n">load</span> <span class="n">model</span> <span class="k">with</span> <span class="n">error</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">xadupre</span><span class="o">/</span><span class="n">github</span><span class="o">/</span><span class="n">onnxruntime</span><span class="o">/</span><span class="n">onnxruntime</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">graph</span><span class="o">/</span><span class="n">model_load_utils</span><span class="o">.</span><span class="n">h</span><span class="p">:</span><span class="mi">46</span> <span class="n">void</span> <span class="n">onnxruntime</span><span class="p">::</span><span class="n">model_load_utils</span><span class="p">::</span><span class="n">ValidateOpsetForDomain</span><span class="p">(</span><span class="n">const</span> <span class="n">std</span><span class="p">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">std</span><span class="p">::</span><span class="n">__cxx11</span><span class="p">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="n">char</span><span class="o">&gt;</span><span class="p">,</span> <span class="nb">int</span><span class="o">&gt;&amp;</span><span class="p">,</span> <span class="n">const</span> <span class="n">onnxruntime</span><span class="p">::</span><span class="n">logging</span><span class="p">::</span><span class="n">Logger</span><span class="o">&amp;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">const</span> <span class="n">string</span><span class="o">&amp;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="n">ONNX</span> <span class="n">Runtime</span> <span class="n">only</span> <span class="o">*</span><span class="n">guarantees</span><span class="o">*</span> <span class="n">support</span> <span class="k">for</span> <span class="n">models</span> <span class="n">stamped</span> <span class="k">with</span> <span class="n">official</span> <span class="n">released</span> <span class="n">onnx</span> <span class="n">opset</span> <span class="n">versions</span><span class="o">.</span> <span class="n">Opset</span> <span class="mi">21</span> <span class="ow">is</span> <span class="n">under</span> <span class="n">development</span> <span class="ow">and</span> <span class="n">support</span> <span class="k">for</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">limited</span><span class="o">.</span> <span class="n">The</span> <span class="n">operator</span> <span class="n">schemas</span> <span class="ow">and</span> <span class="ow">or</span> <span class="n">other</span> <span class="n">functionality</span> <span class="n">may</span> <span class="n">change</span> <span class="n">before</span> <span class="nb">next</span> <span class="n">ONNX</span> <span class="n">release</span> <span class="ow">and</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">case</span> <span class="n">ONNX</span> <span class="n">Runtime</span> <span class="n">will</span> <span class="ow">not</span> <span class="n">guarantee</span> <span class="n">backward</span> <span class="n">compatibility</span><span class="o">.</span> <span class="n">Current</span> <span class="n">official</span> <span class="n">support</span> <span class="k">for</span> <span class="n">domain</span> <span class="n">ai</span><span class="o">.</span><span class="n">onnx</span> <span class="ow">is</span> <span class="n">till</span> <span class="n">opset</span> <span class="mf">20.</span>
</pre></div>
</div>
<p>The list of operators is constantly evolving: onnx is versioned.
The function may fail because the model says it is using a version
a runtime does not support. Let’s change it.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_allclose</span>
<span class="kn">from</span> <span class="nn">onnx_array_api.ext_test_case</span> <span class="kn">import</span> <span class="n">ExtTestCase</span>

<span class="c1"># This is the same function.</span>
<span class="kn">from</span> <span class="nn">onnx_array_api.validation.docs</span> <span class="kn">import</span> <span class="n">make_euclidean</span>


<span class="k">def</span> <span class="nf">test_make_euclidean_ort</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">onnxruntime</span> <span class="kn">import</span> <span class="n">InferenceSession</span>

    <span class="c1"># opset=18: it uses the opset version 18, this number</span>
    <span class="c1"># is incremented at every minor release.</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">make_euclidean</span><span class="p">(</span><span class="n">opset</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

    <span class="n">ref</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span>
        <span class="n">model</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">(),</span> <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CPUExecutionProvider&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">Y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">got</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">Y</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">assert_allclose</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>


<span class="n">test_make_euclidean_ort</span><span class="p">()</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    
</pre></div>
</div>
<p>But the runtime must support many versions and the unit tests may look like
the following:</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_allclose</span>
<span class="kn">import</span> <span class="nn">onnx.defs</span>
<span class="kn">from</span> <span class="nn">onnx_array_api.ext_test_case</span> <span class="kn">import</span> <span class="n">ExtTestCase</span>

<span class="c1"># This is the same function.</span>
<span class="kn">from</span> <span class="nn">onnx_array_api.validation.docs</span> <span class="kn">import</span> <span class="n">make_euclidean</span>


<span class="k">def</span> <span class="nf">test_make_euclidean_ort</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">onnxruntime</span> <span class="kn">import</span> <span class="n">InferenceSession</span>

    <span class="c1"># opset=18: it uses the opset version 18, this number</span>
    <span class="c1"># is incremented at every minor release.</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">Y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">opset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">onnx</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">onnx_opset_version</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">make_euclidean</span><span class="p">(</span><span class="n">opset</span><span class="o">=</span><span class="n">opset</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span>
                <span class="n">model</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">(),</span> <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CPUExecutionProvider&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">got</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">Y</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fail opset=</span><span class="si">{</span><span class="n">opset</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">opset</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="n">assert_allclose</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>


<span class="n">test_make_euclidean_ort</span><span class="p">()</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">fail</span> <span class="n">opset</span><span class="o">=</span><span class="mi">6</span> <span class="p">[</span><span class="n">ONNXRuntimeError</span><span class="p">]</span> <span class="p">:</span> <span class="mi">10</span> <span class="p">:</span> <span class="n">INVALID_GRAPH</span> <span class="p">:</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">invalid</span> <span class="n">model</span><span class="o">.</span> <span class="n">Type</span> <span class="n">Error</span><span class="p">:</span> <span class="n">Type</span> <span class="s1">&#39;tensor(int64)&#39;</span> <span class="n">of</span> <span class="nb">input</span> <span class="n">parameter</span> <span class="p">(</span><span class="n">two</span><span class="p">)</span> <span class="n">of</span> <span class="n">operator</span> <span class="p">(</span><span class="n">Pow</span><span class="p">)</span> <span class="ow">in</span> <span class="n">node</span> <span class="p">()</span> <span class="ow">is</span> <span class="n">invalid</span><span class="o">.</span>
    <span class="n">fail</span> <span class="n">opset</span><span class="o">=</span><span class="mi">7</span> <span class="p">[</span><span class="n">ONNXRuntimeError</span><span class="p">]</span> <span class="p">:</span> <span class="mi">10</span> <span class="p">:</span> <span class="n">INVALID_GRAPH</span> <span class="p">:</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">invalid</span> <span class="n">model</span><span class="o">.</span> <span class="n">Type</span> <span class="n">Error</span><span class="p">:</span> <span class="n">Type</span> <span class="s1">&#39;tensor(int64)&#39;</span> <span class="n">of</span> <span class="nb">input</span> <span class="n">parameter</span> <span class="p">(</span><span class="n">two</span><span class="p">)</span> <span class="n">of</span> <span class="n">operator</span> <span class="p">(</span><span class="n">Pow</span><span class="p">)</span> <span class="ow">in</span> <span class="n">node</span> <span class="p">()</span> <span class="ow">is</span> <span class="n">invalid</span><span class="o">.</span>
    <span class="n">fail</span> <span class="n">opset</span><span class="o">=</span><span class="mi">8</span> <span class="p">[</span><span class="n">ONNXRuntimeError</span><span class="p">]</span> <span class="p">:</span> <span class="mi">10</span> <span class="p">:</span> <span class="n">INVALID_GRAPH</span> <span class="p">:</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">invalid</span> <span class="n">model</span><span class="o">.</span> <span class="n">Type</span> <span class="n">Error</span><span class="p">:</span> <span class="n">Type</span> <span class="s1">&#39;tensor(int64)&#39;</span> <span class="n">of</span> <span class="nb">input</span> <span class="n">parameter</span> <span class="p">(</span><span class="n">two</span><span class="p">)</span> <span class="n">of</span> <span class="n">operator</span> <span class="p">(</span><span class="n">Pow</span><span class="p">)</span> <span class="ow">in</span> <span class="n">node</span> <span class="p">()</span> <span class="ow">is</span> <span class="n">invalid</span><span class="o">.</span>
    <span class="n">fail</span> <span class="n">opset</span><span class="o">=</span><span class="mi">9</span> <span class="p">[</span><span class="n">ONNXRuntimeError</span><span class="p">]</span> <span class="p">:</span> <span class="mi">10</span> <span class="p">:</span> <span class="n">INVALID_GRAPH</span> <span class="p">:</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">invalid</span> <span class="n">model</span><span class="o">.</span> <span class="n">Type</span> <span class="n">Error</span><span class="p">:</span> <span class="n">Type</span> <span class="s1">&#39;tensor(int64)&#39;</span> <span class="n">of</span> <span class="nb">input</span> <span class="n">parameter</span> <span class="p">(</span><span class="n">two</span><span class="p">)</span> <span class="n">of</span> <span class="n">operator</span> <span class="p">(</span><span class="n">Pow</span><span class="p">)</span> <span class="ow">in</span> <span class="n">node</span> <span class="p">()</span> <span class="ow">is</span> <span class="n">invalid</span><span class="o">.</span>
    <span class="n">fail</span> <span class="n">opset</span><span class="o">=</span><span class="mi">10</span> <span class="p">[</span><span class="n">ONNXRuntimeError</span><span class="p">]</span> <span class="p">:</span> <span class="mi">10</span> <span class="p">:</span> <span class="n">INVALID_GRAPH</span> <span class="p">:</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">invalid</span> <span class="n">model</span><span class="o">.</span> <span class="n">Type</span> <span class="n">Error</span><span class="p">:</span> <span class="n">Type</span> <span class="s1">&#39;tensor(int64)&#39;</span> <span class="n">of</span> <span class="nb">input</span> <span class="n">parameter</span> <span class="p">(</span><span class="n">two</span><span class="p">)</span> <span class="n">of</span> <span class="n">operator</span> <span class="p">(</span><span class="n">Pow</span><span class="p">)</span> <span class="ow">in</span> <span class="n">node</span> <span class="p">()</span> <span class="ow">is</span> <span class="n">invalid</span><span class="o">.</span>
    <span class="n">fail</span> <span class="n">opset</span><span class="o">=</span><span class="mi">11</span> <span class="p">[</span><span class="n">ONNXRuntimeError</span><span class="p">]</span> <span class="p">:</span> <span class="mi">10</span> <span class="p">:</span> <span class="n">INVALID_GRAPH</span> <span class="p">:</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">invalid</span> <span class="n">model</span><span class="o">.</span> <span class="n">Type</span> <span class="n">Error</span><span class="p">:</span> <span class="n">Type</span> <span class="s1">&#39;tensor(int64)&#39;</span> <span class="n">of</span> <span class="nb">input</span> <span class="n">parameter</span> <span class="p">(</span><span class="n">two</span><span class="p">)</span> <span class="n">of</span> <span class="n">operator</span> <span class="p">(</span><span class="n">Pow</span><span class="p">)</span> <span class="ow">in</span> <span class="n">node</span> <span class="p">()</span> <span class="ow">is</span> <span class="n">invalid</span><span class="o">.</span>
</pre></div>
</div>
<p>This work is quite long even for a simple function. For a longer one,
due to the verbosity of the inner API, it is quite difficult to write
the correct implementation on the first try. The unit test cannot be avoided.
The inner API is usually enough when the translation from python to onnx
does not happen often. When it is, almost every library implements
its own simplified way to create onnx graphs and because creating its own
API is not difficult, many times, the decision was made to create a new one
rather than using an existing one.</p>
</section>
<section id="existing-api">
<h2>Existing API<a class="headerlink" href="#existing-api" title="Permalink to this heading">#</a></h2>
<p>Many existing options are available to write custom onnx graphs.
The development is usually driven by what they are used for. Each of them
may not fully support all your needs and it is not always easy to understand
the error messages they provide when something goes wrong.
It is better to understand its own need before choosing one.
Here are some of the questions which may need to be answered.</p>
<ul class="simple">
<li><p>ability to easily write loops and tests (control flow)</p></li>
<li><p>ability to debug (eager mode)</p></li>
<li><p>ability to use the same function to produce different implementations
based on the same version</p></li>
<li><p>ability to interact with other frameworks</p></li>
<li><p>ability to merge existing onnx graph</p></li>
<li><p>ability to describe an existing graph with this API</p></li>
<li><p>ability to easily define constants</p></li>
<li><p>ability to handle multiple domains</p></li>
<li><p>ability to support local functions</p></li>
<li><p>easy error messages</p></li>
<li><p>is it actively maintained?</p></li>
</ul>
<section id="onnxscript">
<h3>onnxscript<a class="headerlink" href="#onnxscript" title="Permalink to this heading">#</a></h3>
<p><a class="reference external" href="https://github.com/microsoft/onnxscript">onnxscript</a> is used in <a class="reference external" href="https://pytorch.org/tutorials//beginner/onnx/export_simple_model_to_onnx_tutorial.html">Torch Export to ONNX</a>.
It converts python code to onnx code by analyzing the python code
(through <a class="reference external" href="https://docs.python.org/3/library/ast.html">ast</a>). The package makes it very easy to use loops and tests in onnx.
It is very close to onnx syntax. It is not easy to support multiple
implementation depending on the opset version required by the user.</p>
<p>Example taken from the documentation :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">onnx</span>

<span class="c1"># We use ONNX opset 15 to define the function below.</span>
<span class="kn">from</span> <span class="nn">onnxscript</span> <span class="kn">import</span> <span class="n">FLOAT</span>
<span class="kn">from</span> <span class="nn">onnxscript</span> <span class="kn">import</span> <span class="n">opset15</span> <span class="k">as</span> <span class="n">op</span>
<span class="kn">from</span> <span class="nn">onnxscript</span> <span class="kn">import</span> <span class="n">script</span>


<span class="c1"># We use the script decorator to indicate that</span>
<span class="c1"># this is meant to be translated to ONNX.</span>
<span class="nd">@script</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">onnx_hardmax</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Hardmax is similar to ArgMax, with the result being encoded OneHot style.&quot;&quot;&quot;</span>

    <span class="c1"># The type annotation on X indicates that it is a float tensor of</span>
    <span class="c1"># unknown rank. The type annotation on axis indicates that it will</span>
    <span class="c1"># be treated as an int attribute in ONNX.</span>
    <span class="c1">#</span>
    <span class="c1"># Invoke ONNX opset 15 op ArgMax.</span>
    <span class="c1"># Use unnamed arguments for ONNX input parameters, and named</span>
    <span class="c1"># arguments for ONNX attribute parameters.</span>
    <span class="n">argmax</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">ArgMax</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">xshape</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">Shape</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="c1"># use the Constant operator to create constant tensors</span>
    <span class="n">zero</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">value_ints</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">GatherElements</span><span class="p">(</span><span class="n">xshape</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
    <span class="n">empty_shape</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">value_ints</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">Reshape</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">empty_shape</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">value_ints</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">cast_values</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">CastLike</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">OneHot</span><span class="p">(</span><span class="n">argmax</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">cast_values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>


<span class="c1"># We use the script decorator to indicate that</span>
<span class="c1"># this is meant to be translated to ONNX.</span>
<span class="nd">@script</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">sample_model</span><span class="p">(</span><span class="n">X</span><span class="p">:</span> <span class="n">FLOAT</span><span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="n">Wt</span><span class="p">:</span> <span class="n">FLOAT</span><span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">Bias</span><span class="p">:</span> <span class="n">FLOAT</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">FLOAT</span><span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">10</span><span class="p">]:</span>
    <span class="n">matmul</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">MatMul</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Wt</span><span class="p">)</span> <span class="o">+</span> <span class="n">Bias</span>
    <span class="k">return</span> <span class="n">onnx_hardmax</span><span class="p">(</span><span class="n">matmul</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="c1"># onnx_model is an in-memory ModelProto</span>
<span class="n">onnx_model</span> <span class="o">=</span> <span class="n">sample_model</span><span class="o">.</span><span class="n">to_model_proto</span><span class="p">()</span>

<span class="c1"># Save the ONNX model at a given path</span>
<span class="n">onnx</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">onnx_model</span><span class="p">,</span> <span class="s2">&quot;sample_model.onnx&quot;</span><span class="p">)</span>

<span class="c1"># Check the model</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">onnx</span><span class="o">.</span><span class="n">checker</span><span class="o">.</span><span class="n">check_model</span><span class="p">(</span><span class="n">onnx_model</span><span class="p">)</span>
<span class="k">except</span> <span class="n">onnx</span><span class="o">.</span><span class="n">checker</span><span class="o">.</span><span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The model is invalid: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The model is valid!&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>An Eager mode is available to debug what the code does.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">Hardmax</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="spox">
<h3>spox<a class="headerlink" href="#spox" title="Permalink to this heading">#</a></h3>
<p>The syntax of <a class="reference external" href="https://github.com/Quantco/spox">spox</a> is similar but it does not use <a class="reference external" href="https://docs.python.org/3/library/ast.html">ast</a>.
Therefore, <a class="reference external" href="https://spox.readthedocs.io/en/latest/guides/advanced.html#Control-flow">loops and tests</a>
are expressed in a very different way. The tricky part with it is to handle
the local context. A variable created in the main graph is known by any
of its subgraphs.</p>
<p>Example taken from the documentation :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">onnx</span>

<span class="kn">from</span> <span class="nn">spox</span> <span class="kn">import</span> <span class="n">argument</span><span class="p">,</span> <span class="n">build</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">Var</span>
<span class="c1"># Import operators from the ai.onnx domain at version 17</span>
<span class="kn">from</span> <span class="nn">spox.opset.ai.onnx</span> <span class="kn">import</span> <span class="n">v17</span> <span class="k">as</span> <span class="n">op</span>

<span class="k">def</span> <span class="nf">geometric_mean</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Var</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">Var</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Var</span><span class="p">:</span>
    <span class="c1"># use the standard Sqrt and Mul</span>
    <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>

<span class="c1"># Create typed model inputs. Each tensor is of rank 1</span>
<span class="c1"># and has the runtime-determined length &#39;N&#39;.</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">argument</span><span class="p">(</span><span class="n">Tensor</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">,)))</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">argument</span><span class="p">(</span><span class="n">Tensor</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">,)))</span>

<span class="c1"># Perform operations on `Var`s</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">geometric_mean</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="c1"># Build an `onnx.ModelProto` for the given inputs and outputs.</span>
<span class="n">model</span><span class="p">:</span> <span class="n">onnx</span><span class="o">.</span><span class="n">ModelProto</span> <span class="o">=</span> <span class="n">build</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">b</span><span class="p">},</span> <span class="n">outputs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">})</span>
</pre></div>
</div>
<p>The function can be tested with a mechanism called
<a class="reference external" href="https://spox.readthedocs.io/en/latest/guides/inference.html#Value-propagation">value propagation</a>.</p>
</section>
<section id="sklearn-onnx">
<h3>sklearn-onnx<a class="headerlink" href="#sklearn-onnx" title="Permalink to this heading">#</a></h3>
<p><a class="reference external" href="https://onnx.ai/sklearn-onnx/">sklearn-onnx</a> also implements its own API to add custom graphs.
It was designed to shorten the time spent in reimplementing <a class="reference external" href="https://scikit-learn.org/stable/">scikit-learn</a>
code into <a class="reference external" href="https://onnx.ai/onnx/">onnx</a> code. It can be used to implement a new converter
mapped a custom model as described in this example:
<a class="reference external" href="https://onnx.ai/sklearn-onnx/auto_tutorial/plot_icustom_converter.html">Implement a new converter</a>.
But it can also be used to build standalone models.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">onnx</span>
<span class="kn">import</span> <span class="nn">onnx.helper</span> <span class="k">as</span> <span class="nn">oh</span>
<span class="kn">from</span> <span class="nn">onnx_array_api.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>


<span class="k">def</span> <span class="nf">make_euclidean_skl2onnx</span><span class="p">(</span>
    <span class="n">input_names</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">),</span>
    <span class="n">output_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Z&quot;</span><span class="p">,</span>
    <span class="n">elem_type</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span>
    <span class="n">opset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">onnx</span><span class="o">.</span><span class="n">ModelProto</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">opset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">opset</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">onnx_opset_version</span><span class="p">()</span>

    <span class="kn">from</span> <span class="nn">skl2onnx.algebra.onnx_ops</span> <span class="kn">import</span> <span class="n">OnnxSub</span><span class="p">,</span> <span class="n">OnnxPow</span><span class="p">,</span> <span class="n">OnnxReduceSum</span>

    <span class="n">dxy</span> <span class="o">=</span> <span class="n">OnnxSub</span><span class="p">(</span><span class="n">input_names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">input_names</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">op_version</span><span class="o">=</span><span class="n">opset</span><span class="p">)</span>
    <span class="n">dxy2</span> <span class="o">=</span> <span class="n">OnnxPow</span><span class="p">(</span><span class="n">dxy</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="n">op_version</span><span class="o">=</span><span class="n">opset</span><span class="p">)</span>
    <span class="n">final</span> <span class="o">=</span> <span class="n">OnnxReduceSum</span><span class="p">(</span><span class="n">dxy2</span><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="n">opset</span><span class="p">,</span> <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="n">output_name</span><span class="p">])</span>

    <span class="n">np_type</span> <span class="o">=</span> <span class="n">oh</span><span class="o">.</span><span class="n">tensor_dtype_to_np_dtype</span><span class="p">(</span><span class="n">elem_type</span><span class="p">)</span>
    <span class="n">dummy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">np_type</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">final</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">({</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">dummy</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">dummy</span><span class="p">})</span>


<span class="n">model</span> <span class="o">=</span> <span class="n">make_euclidean_skl2onnx</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">15</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Po_Powcst&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">Sub</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Su_C0</span>
      <span class="n">Pow</span><span class="p">(</span><span class="n">Su_C0</span><span class="p">,</span> <span class="n">Po_Powcst</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Po_Z0</span>
        <span class="n">ReduceSum</span><span class="p">(</span><span class="n">Po_Z0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Z</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Z&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="onnxblocks">
<h3>onnxblocks<a class="headerlink" href="#onnxblocks" title="Permalink to this heading">#</a></h3>
<p><a class="reference external" href="https://onnxruntime.ai/docs/api/python/on_device_training/training_artifacts.html#prepare-for-training">onnxblocks</a>
was introduced in onnxruntime to define custom losses in order to train
a model with <a class="reference external" href="https://onnxruntime.ai/docs/get-started/training-on-device.html">onnxruntime-training</a>. It is mostly used for this usage.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">onnxruntime.training.onnxblock</span> <span class="k">as</span> <span class="nn">onnxblock</span>
<span class="kn">from</span> <span class="nn">onnxruntime.training</span> <span class="kn">import</span> <span class="n">artifacts</span>

<span class="c1"># Define a custom loss block that takes in two inputs</span>
<span class="c1"># and performs a weighted average of the losses from these</span>
<span class="c1"># two inputs.</span>
<span class="k">class</span> <span class="nc">WeightedAverageLoss</span><span class="p">(</span><span class="n">onnxblock</span><span class="o">.</span><span class="n">Block</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loss1</span> <span class="o">=</span> <span class="n">onnxblock</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loss2</span> <span class="o">=</span> <span class="n">onnxblock</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_w1</span> <span class="o">=</span> <span class="n">onnxblock</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_w2</span> <span class="o">=</span> <span class="n">onnxblock</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mf">0.6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add</span> <span class="o">=</span> <span class="n">onnxblock</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">Add</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mul</span> <span class="o">=</span> <span class="n">onnxblock</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">Mul</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss_input_name1</span><span class="p">,</span> <span class="n">loss_input_name2</span><span class="p">):</span>
        <span class="c1"># The build method defines how the block should be stacked on top of</span>
        <span class="c1"># loss_input_name1 and loss_input_name2</span>

        <span class="c1"># Returns weighted average of the two losses</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_w1</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loss1</span><span class="p">(</span><span class="n">loss_input_name1</span><span class="p">,</span> <span class="n">target_name</span><span class="o">=</span><span class="s2">&quot;target1&quot;</span><span class="p">)),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_w2</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loss2</span><span class="p">(</span><span class="n">loss_input_name2</span><span class="p">,</span> <span class="n">target_name</span><span class="o">=</span><span class="s2">&quot;target2&quot;</span><span class="p">))</span>
        <span class="p">)</span>

<span class="n">my_custom_loss</span> <span class="o">=</span> <span class="n">WeightedAverageLoss</span><span class="p">()</span>

<span class="c1"># Load the onnx model</span>
<span class="n">model_path</span> <span class="o">=</span> <span class="s2">&quot;model.onnx&quot;</span>
<span class="n">base_model</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>

<span class="c1"># Define the parameters that need their gradient computed</span>
<span class="n">requires_grad</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;weight1&quot;</span><span class="p">,</span> <span class="s2">&quot;bias1&quot;</span><span class="p">,</span> <span class="s2">&quot;weight2&quot;</span><span class="p">,</span> <span class="s2">&quot;bias2&quot;</span><span class="p">]</span>
<span class="n">frozen_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;weight3&quot;</span><span class="p">,</span> <span class="s2">&quot;bias3&quot;</span><span class="p">]</span>

<span class="c1"># Now, we can invoke generate_artifacts with this custom loss function</span>
<span class="n">artifacts</span><span class="o">.</span><span class="n">generate_artifacts</span><span class="p">(</span><span class="n">base_model</span><span class="p">,</span> <span class="n">requires_grad</span> <span class="o">=</span> <span class="n">requires_grad</span><span class="p">,</span> <span class="n">frozen_params</span> <span class="o">=</span> <span class="n">frozen_params</span><span class="p">,</span>
                            <span class="n">loss</span> <span class="o">=</span> <span class="n">my_custom_loss</span><span class="p">,</span> <span class="n">optimizer</span> <span class="o">=</span> <span class="n">artifacts</span><span class="o">.</span><span class="n">OptimType</span><span class="o">.</span><span class="n">AdamW</span><span class="p">)</span>

<span class="c1"># Successful completion of the above call will generate 4 files in the current working directory,</span>
<span class="c1"># one for each of the artifacts mentioned above (training_model.onnx, eval_model.onnx, checkpoint, op)</span>
</pre></div>
</div>
</section>
<section id="numpy-api-for-onnx">
<h3>numpy API for onnx<a class="headerlink" href="#numpy-api-for-onnx" title="Permalink to this heading">#</a></h3>
<p>See <a class="reference internal" href="numpy_api.html#l-numpy-api-onnx"><span class="std std-ref">Numpy API for ONNX</span></a>. This API was introduced to create graphs
by using numpy API. If a function is defined only with numpy,
it should be possible to use the exact same code to create the
corresponding onnx graph. That’s what this API tries to achieve.
It works with the exception of control flow. In that case, the function
produces different onnx graphs depending on the execution path.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">onnx_array_api.npx</span> <span class="kn">import</span> <span class="n">jit_onnx</span>
<span class="kn">from</span> <span class="nn">onnx_array_api.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>


<span class="k">def</span> <span class="nf">l2_loss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="n">jitted_myloss</span> <span class="o">=</span> <span class="n">jit_onnx</span><span class="p">(</span><span class="n">l2_loss</span><span class="p">)</span>
<span class="n">dummy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># The function is executed. Only then a onnx graph is created.</span>
<span class="c1"># One is created depending on the input type.</span>
<span class="n">jitted_myloss</span><span class="p">(</span><span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">)</span>

<span class="c1"># get_onnx only works if it was executed once or at least with</span>
<span class="c1"># the same input type</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">jitted_myloss</span><span class="o">.</span><span class="n">get_onnx</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">18</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;x0&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;x1&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="n">Constant</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">r__1</span>
    <span class="n">Sub</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">r__0</span>
      <span class="n">CastLike</span><span class="p">(</span><span class="n">r__1</span><span class="p">,</span> <span class="n">r__0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">r__2</span>
      <span class="n">Pow</span><span class="p">(</span><span class="n">r__0</span><span class="p">,</span> <span class="n">r__2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">r__3</span>
        <span class="n">ReduceSum</span><span class="p">(</span><span class="n">r__3</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">r__4</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;r__4&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="light-api">
<h3>light API<a class="headerlink" href="#light-api" title="Permalink to this heading">#</a></h3>
<p>See <a class="reference internal" href="light_api.html#l-light-api"><span class="std std-ref">Light API for ONNX: everything in one line</span></a>. This API was created to be able to write an onnx graph
in one instruction. It is inspired from the <a class="reference external" href="https://en.wikipedia.org/wiki/Reverse_Polish_notation">reverse Polish notation</a>.
There is no eager mode.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">onnx_array_api.light_api</span> <span class="kn">import</span> <span class="n">start</span>
<span class="kn">from</span> <span class="nn">onnx_array_api.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>

<span class="n">model</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">start</span><span class="p">()</span>
    <span class="o">.</span><span class="n">vin</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">vin</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">bring</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">Sub</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;dxy&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cst</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="s2">&quot;two&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">bring</span><span class="p">(</span><span class="s2">&quot;dxy&quot;</span><span class="p">,</span> <span class="s2">&quot;two&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">Pow</span><span class="p">()</span>
    <span class="o">.</span><span class="n">ReduceSum</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">vout</span><span class="p">()</span>
    <span class="o">.</span><span class="n">to_onnx</span><span class="p">()</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">20</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;two&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">Sub</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dxy</span>
      <span class="n">Pow</span><span class="p">(</span><span class="n">dxy</span><span class="p">,</span> <span class="n">two</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">r1_0</span>
        <span class="n">ReduceSum</span><span class="p">(</span><span class="n">r1_0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">noop_with_empty_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Z</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Z&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="light_api.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Light API for ONNX: everything in one line</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="index.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Tutorial</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023, Xavier Dupré
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Many ways to implement a custom graph in ONNX</a><ul>
<li><a class="reference internal" href="#euclidian-distance">Euclidian distance</a></li>
<li><a class="reference internal" href="#existing-api">Existing API</a><ul>
<li><a class="reference internal" href="#onnxscript">onnxscript</a></li>
<li><a class="reference internal" href="#spox">spox</a></li>
<li><a class="reference internal" href="#sklearn-onnx">sklearn-onnx</a></li>
<li><a class="reference internal" href="#onnxblocks">onnxblocks</a></li>
<li><a class="reference internal" href="#numpy-api-for-onnx">numpy API for onnx</a></li>
<li><a class="reference internal" href="#light-api">light API</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=64072c33"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/scripts/furo.js?v=32e29ea5"></script>
    </body>
</html>